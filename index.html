<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">






  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="WSWvVPyzUsUM54ydNcrE1pUzdYt5xGKnqD1i7XpWVF8" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/safari-pinned-tab.svg?v=5.1.4" color="#222">


  <link rel="manifest" href="/images/site.webmanifest">


  <meta name="msapplication-config" content="/images/browserconfig.xml" />



  <meta name="keywords" content="Welcome" />










<meta name="description" content="学习、生活、闲谈、足球">
<meta property="og:type" content="website">
<meta property="og:title" content="一只病猫">
<meta property="og:url" content="https://dinghuang.github.io/index.html">
<meta property="og:site_name" content="一只病猫">
<meta property="og:description" content="学习、生活、闲谈、足球">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一只病猫">
<meta name="twitter:description" content="学习、生活、闲谈、足球">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dinghuang.github.io/"/>





  <title>一只病猫</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-108021384-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?00a1ba3f5c477c92d7c1ccbb00c6427b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一只病猫</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">静坐常思己过，闲谈莫论人非</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'HcRPHRrBuwozvgUoLNyX','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2019/02/18/分布式应用监控/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/18/分布式应用监控/" itemprop="url">分布式应用监控</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-18T15:47:00+08:00">
                2019-02-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/18/分布式应用监控/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/02/18/分布式应用监控/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="分布式应用监控"><a href="#分布式应用监控" class="headerlink" title="分布式应用监控"></a>分布式应用监控</h1><p><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0ankzojyuj20my0dqgqa.jpg" alt="image"><br>分布式系统已经诞生了很长时间，现代互联网公司规模都变得异常庞大，系统也变得越来越复杂，给监控工作带来了极大的难度：海量日志数据如何处理，服务如何追踪，如何高效定位故障缩短故障时常，常见的监控手段可以分为集中式日志系统（Logging），集中式度量系统（Metrics）和分布式追踪系统（Tracing）。</p>
<h2 id="集中式日志系统"><a href="#集中式日志系统" class="headerlink" title="集中式日志系统"></a>集中式日志系统</h2><p>集中式日志系统，选取了最具代表性的<a href="https://www.elastic.co/elk-stack" target="_blank" rel="noopener">ELK</a><br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0anmng640j20t20u0qb9.jpg" alt="image"></p>
<h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><p>Elasticsearch是个开源的分布式搜索引擎，提供搜索、分析、存储数据三大功能。它的特点有：分布式、自动发现、索引自动分片、索引副本机制、RESTful 风格接口、多数据源以及自动搜索负载等。<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0anngzbwsj20ge06cmxi.jpg" alt="image"></p>
<h3 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h3><p>Logstash 是一个开源的动态数据收集处理管道，它可以同时从多个源中提取数据，对其进行转换，并且拥有可扩展的插件生态系统，能够与 Elasticsearch 产生强大的协同作用。<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0ano9kvhpj20ae0fidh8.jpg" alt="image"></p>
<h3 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h3><p>Kibana是一个开源的分析与可视化平台，设计出来用于和Elasticsearch一起使用的。你可以用kibana搜索、查看存放在Elasticsearch中的数据。Kibana与Elasticsearch的交互方式是各种不同的图表、表格、地图等，直观的展示数据，从而达到高级的数据分析与可视化的目的。<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0anos2ri4j20u00ioaoe.jpg" alt="image"></p>
<h3 id="Beats"><a href="#Beats" class="headerlink" title="Beats"></a>Beats</h3><p>Beats 是 ELK Stack 技术栈中负责单一用途数据采集并推送给 Logstash 或 Elasticsearch 的轻量级产品。包括：</p>
<ul>
<li>Filebeats：应用于日志收集场景的实现。</li>
<li>Metricbeat：轻量级的系统级性能指标监控工具。</li>
<li>Packetbeat：轻量级的网络数据包分析工具。</li>
<li>Winlogbeat：轻量级的 Windows 事件日志收集工具。</li>
<li>Heartbeat：心跳检测工具，主要监控服务的可用性。</li>
</ul>
<p><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0anqgzyihj20rs0jkq8b.jpg" alt="image"></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>修改虚拟机的内存限制<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /etc/sysctl.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure></p>
<p>加入<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.<span class="attribute">max_map_count</span>=262144</span><br></pre></td></tr></table></figure></p>
<p><code>sysctl -p</code>查看设置</p>
<p>docker安装ELK<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull sebp/elk</span><br><span class="line">docker <span class="builtin-name">run</span> -p 5601:5601 -p 9200:9200 -p 5044:5044 -e <span class="attribute">ES_MIN_MEM</span>=128m  -e <span class="attribute">ES_MAX_MEM</span>=1024m -it --name elk sebp/elk</span><br></pre></td></tr></table></figure></p>
<p>输入网址<code>http://&lt;your-host&gt;:5601</code>可以看到下面的界面，则说明安装成功<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0anujxybgj22la1ac7e1.jpg" alt="image"></p>
<h4 id="配置使用"><a href="#配置使用" class="headerlink" title="配置使用"></a>配置使用</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -<span class="keyword">it</span> &lt;container-<span class="built_in">name</span>&gt; /bin/bash</span><br></pre></td></tr></table></figure>
<p>进入容器，执行命令<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/opt/</span>logstash<span class="regexp">/bin/</span>logstash -e <span class="string">'input &#123; stdin &#123; &#125; &#125; output &#123; elasticsearch &#123; hosts =&gt; ["localhost"] &#125; &#125;'</span></span><br></pre></td></tr></table></figure></p>
<p>如果有错误信息<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service logstash <span class="built_in">stop</span></span><br></pre></td></tr></table></figure></p>
<p>当命令成功被执行后，看到：<code>Successfully started Logstash API endpoint {:port=&gt;9600}</code>信息后，输入：<code>this is a dummy entry</code>然后回车，模拟一条日志进行测试。</p>
<p>打开浏览器<code>http://&lt;your-host&gt;:9200/_search?pretty</code>，如图所示<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0anxotbydj22k419y475.jpg" alt="image"></p>
<p>打开浏览器，输入：<code>http://&lt;your-host&gt;:5601</code> 点击创建<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0anykdlefj20yn0maacx.jpg" alt="image"></p>
<p>看到如下界面，到此安装结束。<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0anujxybgj22la1ac7e1.jpg" alt="image"></p>
<p>与java应用结合的日志分析系统可以通过Beats的Filebeats来实现，通过log4j将运行日志输出在文件中，通过Filebeats插件利用Logstash过滤并导入到Elasticsearch中，最后通过Kibana展示。</p>
<h2 id="集中式度量系统"><a href="#集中式度量系统" class="headerlink" title="集中式度量系统"></a>集中式度量系统</h2><h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><p><a href="https://prometheus.io/" target="_blank" rel="noopener">Prometheus</a>是一个基于时间序列的数值数据的监控解决方案，这是一个开源项目，由前Google员工在SoundCloud启动，他们希望监控一个高度动态的容器环境，因为对传统的监控工具不甚满意，所以开发出Prometheus，并在上面进行工作。Prometheus解决了Devs如何监控高动态容器环境的问题。</p>
<p>例如我们想要获取所有的服务器上node_exporter暴露出来的数据，就必须有个程序去定时访问这些接口，如果想要增加或者修改这些接口，那么就需要有个配置文件来记录这些服务器的地址，如果想要访问历史的某个时间点的数据，那么就必须按照时间顺序存储获取到的指标和值。而如果想要将值绘制成图，也需要有代码去查询、计算和渲染。最后你可能还希望当服务器的某个指标超过一定的阈值时，向指定的接口发出告警信息。一切的一切其实都可以使用Prometheus来解决。</p>
<p><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0ao1npp86j20z00kc0wk.jpg" alt="image"></p>
<h3 id="Prometheus检测mysql相关指标"><a href="#Prometheus检测mysql相关指标" class="headerlink" title="Prometheus检测mysql相关指标"></a>Prometheus检测mysql相关指标</h3><p>前提：本地安装了mysql</p>
<h4 id="安装node-exporter"><a href="#安装node-exporter" class="headerlink" title="安装node-exporter"></a>安装node-exporter</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull <span class="keyword">node</span><span class="title">-exporter</span></span><br><span class="line">docker run -d -p <span class="number">9100</span>:<span class="number">9100</span> --cap-add SYS_TIME --<span class="attr">net=</span><span class="string">"host"</span> --<span class="attr">pid=</span><span class="string">"host"</span> -v <span class="string">"/:/host:ro,rslave"</span>quay.io/prometheus/<span class="keyword">node</span><span class="title">-exporter</span> --<span class="attr">cap-add=</span>SYS_TIME --path.rootfs /host</span><br></pre></td></tr></table></figure>
<h4 id="安装mysqld-exporter"><a href="#安装mysqld-exporter" class="headerlink" title="安装mysqld-exporter"></a>安装mysqld-exporter</h4><p>通过mysql命令界面创建相应角色并赋予权限<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'mysql_monitor'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'XXXXXXXX'</span> <span class="keyword">WITH</span> MAX_USER_CONNECTIONS <span class="number">3</span>;</span><br><span class="line"><span class="keyword">GRANT</span> PROCESS, <span class="keyword">REPLICATION</span> <span class="keyword">CLIENT</span>, <span class="keyword">SELECT</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'mysql_monitor'</span>@<span class="string">'localhost'</span>;</span><br></pre></td></tr></table></figure></p>
<p>docker安装<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysqld-exporter</span><br><span class="line">docker <span class="builtin-name">run</span> -d -p 9104:9104 -e <span class="attribute">DATA_SOURCE_NAME</span>=<span class="string">"mysql_monitor:root@(127.0.0.1:3306)/"</span> prom/mysqld-exporter</span><br></pre></td></tr></table></figure></p>
<h4 id="安装Prometheus"><a href="#安装Prometheus" class="headerlink" title="安装Prometheus"></a>安装Prometheus</h4><p>创建文件<code>prometheus.yml</code><br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">global</span>:</span><br><span class="line">  <span class="attribute">scrape_interval</span>:     <span class="number">60s</span></span><br><span class="line">  <span class="attribute">evaluation_interval</span>: <span class="number">60s</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">scrape_configs</span>:</span><br><span class="line">  - <span class="attribute">job_name</span>: prometheus</span><br><span class="line">    <span class="attribute">static_configs</span>:</span><br><span class="line">      - <span class="attribute">targets</span>: [<span class="string">'106.15.226.184:9090'</span>]</span><br><span class="line">        <span class="attribute">labels</span>:</span><br><span class="line">          <span class="attribute">instance</span>: prometheus</span><br><span class="line"></span><br><span class="line">  - <span class="attribute">job_name</span>: linux</span><br><span class="line">    <span class="attribute">static_configs</span>:</span><br><span class="line">      - <span class="attribute">targets</span>: [<span class="string">'106.15.226.184:9100'</span>]</span><br><span class="line">        <span class="attribute">labels</span>:</span><br><span class="line">          <span class="attribute">instance</span>: db1</span><br><span class="line"></span><br><span class="line">  - <span class="attribute">job_name</span>: mysql</span><br><span class="line">    <span class="attribute">static_configs</span>:</span><br><span class="line">      - <span class="attribute">targets</span>: [<span class="string">'106.15.226.184:9104'</span>]</span><br><span class="line">        <span class="attribute">labels</span>:</span><br><span class="line">          <span class="attribute">instance</span>: db1</span><br></pre></td></tr></table></figure></p>
<p>docker启动<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull prometheus</span><br><span class="line">sudo docker run -d -p <span class="number">9090</span>:<span class="number">9090</span> -v <span class="regexp">/root/</span>conf<span class="regexp">/prometheus.yml:/u</span>sr<span class="regexp">/local/</span>src<span class="regexp">/file/</span>prometheus.yml quay.io<span class="regexp">/prometheus/</span>prometheus --config.<span class="keyword">file</span>=<span class="regexp">/usr/</span>local<span class="regexp">/src/</span><span class="keyword">file</span><span class="regexp">/prometheus.yml</span></span><br></pre></td></tr></table></figure></p>
<h4 id="安装Grafana"><a href="#安装Grafana" class="headerlink" title="安装Grafana"></a>安装Grafana</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull grafana/grafana</span><br><span class="line">docker <span class="builtin-name">run</span> -d <span class="attribute">--name</span>=grafana -p 3000:3000 grafana/grafana</span><br></pre></td></tr></table></figure>
<p>打开<code>http:x.x.x.x:9090</code><br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aocmau0ej22l812ogqo.jpg" alt="image"><br>如图所示，说明数据源管道agent启动成功</p>
<p>打开<code>http://x.x.x.x:3000</code>，配置Prometheus数据源<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aoe1u94dj20pp0qv78x.jpg" alt="image"></p>
<p>配置好数据源后，下载<a href="https://codeload.github.com/percona/grafana-dashboards/zip/v1.17.0" target="_blank" rel="noopener">mysql监控模板</a>，<br>解压后，找到mysql开头的模板，导入，最后如图所示：<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aog1imivj22jc19e46g.jpg" alt="image"></p>
<p><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aogngitwj22ki19g11f.jpg" alt="image"></p>
<h3 id="Cat"><a href="#Cat" class="headerlink" title="Cat"></a>Cat</h3><p><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aoibi3egj20qo0eujsb.jpg" alt="image"><br><a href="https://github.com/dianping/cat" target="_blank" rel="noopener">CAT</a>（Central Application Tracking）是一个实时和接近全量的监控系统，它侧重于对Java应用的监控，基本接入了美团上海侧所有核心应用。目前在中间件（MVC、RPC、数据库、缓存等）框架中得到广泛应用，为美团各业务线提供系统的性能指标、健康状况、监控告警等。</p>
<p><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aoim0nuwj20zy0lwk41.jpg" alt="image"></p>
<p>监控整体要求就是快速发现故障、快速定位故障以及辅助进行程序性能优化。为了做到这些，我们对监控系统的一些非功能做了如下的要求：</p>
<p>实时处理：信息的价值会随时间锐减，尤其是事故处理过程中。<br>全量数据：最开始的设计目标就是全量采集，全量的好处有很多。<br>高可用：所有应用都倒下了，需要监控还站着，并告诉工程师发生了什么，做到故障还原和问题定位。<br>故障容忍：CAT本身故障不应该影响业务正常运转，CAT挂了，应用不该受影响，只是监控能力暂时减弱。<br>高吞吐：要想还原真相，需要全方位地监控和度量，必须要有超强的处理吞吐能力。<br>可扩展：支持分布式、跨IDC部署，横向扩展的监控系统。<br>不保证可靠：允许消息丢失，这是一个很重要的trade-off，目前CAT服务端可以做到4个9的可靠性，可靠系统和不可靠性系统的设计差别非常大。<br>CAT从开发至今，一直秉承着简单的架构就是最好的架构原则，主要分为三个模块：CAT-client、CAT-consumer、CAT-home。</p>
<p>Cat-client 提供给业务以及中间层埋点的底层SDK。<br>Cat-consumer 用于实时分析从客户端提供的数据。<br>Cat-home 作为用户给用户提供展示的控制端。<br>在实际开发和部署中，Cat-consumer和Cat-home是部署在一个JVM内部，每个CAT服务端都可以作为consumer也可以作为home，这样既能减少整个层级结构，也可以增加系统稳定性。<br>上图是CAT目前多机房的整体结构图，图中可见：</p>
<p>路由中心是根据应用所在机房信息来决定客户端上报的CAT服务端地址，目前美团有广州、北京、上海三地机房。<br>每个机房内部都有独立的原始信息存储集群HDFS。<br>CAT-home可以部署在一个机房也可以部署在多个机房，在最后做展示的时候，home会从consumer中进行跨机房的调用，将所有的数据合并展示给用户。<br>实际过程中，consumer、home以及路由中心都是部署在一起的，每个服务端节点都可以充当任何一个角色。</p>
<h4 id="安装使用Cat"><a href="#安装使用Cat" class="headerlink" title="安装使用Cat"></a>安装使用Cat</h4><p>本文演示单机集群安装部署<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/dianping/<span class="keyword">cat</span>.git</span><br><span class="line"><span class="keyword">cd</span> docker</span><br><span class="line">docker-compose <span class="keyword">up</span></span><br></pre></td></tr></table></figure></p>
<p>第一次运行以后，数据库中没有表结构，需要通过下面的命令创建表：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> exec &lt;container_id&gt; <span class="keyword">bash </span>-c <span class="string">"mysql -uroot -Dcat &lt; /init.sql"</span></span><br></pre></td></tr></table></figure></p>
<p>依赖配置说明</p>
<ul>
<li>datasources.xml<ul>
<li>CAT数据库配置，默认配置是mysql镜像，可以按需替换</li>
</ul>
</li>
<li>docker-compose.yml<ul>
<li>通过docker-compose启动的编排文件，文件中包含cat和mysql。可以屏蔽掉mysql的部分，并且修改cat的环境变量，改为真实的mysql连接信息。</li>
</ul>
</li>
<li>client.xml<ul>
<li>CAT 初始化默认的路由列表，配置此文件可以将客户端数据上报指向到不同环境。</li>
</ul>
</li>
<li>datasources.sh<ul>
<li>辅助脚本，脚本作用时修改datasources.xml，使用环境变量中制定的mysql连接信息。（通过sed命令替换）</li>
</ul>
</li>
</ul>
<h4 id="Java-应用的集成"><a href="#Java-应用的集成" class="headerlink" title="Java 应用的集成"></a>Java 应用的集成</h4><p><a href="https://blog.csdn.net/kefengwang/article/details/81213031" target="_blank" rel="noopener">参考博客</a><br>需要指定 cat 专用的远程仓库<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- %MAVEN_HOME%\conf\settings.xml --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">id</span>&gt;</span>central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">layout</span>&gt;</span>default<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo1.maven.org/maven2<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">id</span>&gt;</span>unidal.nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://unidal.org/nexus/content/repositories/releases/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>加入依赖(pom.xml)<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dianping.cat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cat-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>添加过滤器 CatFilter<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatFilterConfigure</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">catFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean registration = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        registration.setFilter(<span class="keyword">new</span> CatFilter());</span><br><span class="line">        registration.addUrlPatterns(<span class="string">"/*"</span>);</span><br><span class="line">        registration.setName(<span class="string">"cat-filter"</span>);</span><br><span class="line">        registration.setOrder(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>添加注解<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CatCacheTransaction</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line"><span class="meta">@CatHttpRequestTransaction</span>(type = <span class="string">"URL"</span>, name = <span class="string">"/hello"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function">String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aoqxnurij20qp0d3k4h.jpg" alt="image"></p>
<p>更多集成<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aos0a6q6j20rl0fdwvn.jpg" alt="image"></p>
<h5 id="管理平台的使用"><a href="#管理平台的使用" class="headerlink" title="管理平台的使用"></a>管理平台的使用</h5><p>控制台<br><a href="http://192.168.126.101:8080/cat" target="_blank" rel="noopener">http://192.168.126.101:8080/cat</a><br>帐号/密码: catadmin/catadmin</p>
<p>项目配置<br><a href="http://192.168.126.101:8080/cat/s/config?op=projects" target="_blank" rel="noopener">http://192.168.126.101:8080/cat/s/config?op=projects</a></p>
<p>相关文档<br>部署文档: <a href="http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=deploy" target="_blank" rel="noopener">http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=deploy</a><br>用户文档：<a href="http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=user" target="_blank" rel="noopener">http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=user</a><br>告警文档：<a href="http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=alert" target="_blank" rel="noopener">http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=alert</a><br>集成文档：<a href="http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=integration" target="_blank" rel="noopener">http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=integration</a><br>开发文档：<a href="http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=develop" target="_blank" rel="noopener">http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=develop</a><br>设计文档：<a href="http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=design" target="_blank" rel="noopener">http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=design</a><br>常见问题：<a href="http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=problem" target="_blank" rel="noopener">http://192.168.126.101:8080/cat/r/home?op=view&amp;docName=problem</a></p>
<p>实时查看<br><a href="http://192.168.126.101:8080/cat/r/t" target="_blank" rel="noopener">http://192.168.126.101:8080/cat/r/t</a><br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aov6vr6mj21gw0o8147.jpg" alt="image"></p>
<h2 id="分布式追踪系统"><a href="#分布式追踪系统" class="headerlink" title="分布式追踪系统"></a>分布式追踪系统</h2><h3 id="Zipkin"><a href="#Zipkin" class="headerlink" title="Zipkin"></a>Zipkin</h3><p><a href="https://zipkin.io/" target="_blank" rel="noopener">Zipkin</a>是一种分布式跟踪系统。它有助于收集解决微服务架构中的延迟问题所需的时序数据。它管理这些数据的收集和查找。Zipkin的设计基于Google Dapper论文。<br>应用程序用于向Zipkin报告时序数据。Zipkin UI还提供了一个依赖关系图，显示了每个应用程序通过的跟踪请求数。如果要解决延迟问题或错误，可以根据应用程序，跟踪长度，注释或时间戳对所有跟踪进行筛选或排序。选择跟踪后，您可以看到每个跨度所需的总跟踪时间百分比，从而可以识别问题应用程序。<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aox97889j20u20ewn0o.jpg" alt="image"></p>
<h3 id="Pinpoint"><a href="#Pinpoint" class="headerlink" title="Pinpoint"></a>Pinpoint</h3><p><a href="https://naver.github.io/pinpoint/" target="_blank" rel="noopener">Pinpoint</a>是一个开源的APM监控工具，我们可以通过pinpoint实时跟踪应用之间的调用、程序的响应时间以及服务器资源使用状态，可以在分布式环境中为没个调用生成代码级别的可视图并定位瓶颈点和失败点。Pinpoint的设计也是基于Google Dapper论文<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aoyo8a04j20ru0ietcq.jpg" alt="image"></p>
<h3 id="Skywalking"><a href="#Skywalking" class="headerlink" title="Skywalking"></a>Skywalking</h3><p><a href="http://skywalking.apache.org/" target="_blank" rel="noopener">Skywalking</a>是一款优秀的国产 APM 工具，包括了分布式追踪、性能指标分析、应用和服务依赖分析等。通过在应用程序中添加 SkyWalking Agent，就可以将接口、服务、数据库、MQ等进行追踪，将追踪结果通过 HTTP 或 gRPC 发送到 SkyWalking Collecter，SkyWalking Collecter 经过分析和聚合，将结果存储到 Elasticsearch 或 H2，SkyWalking 同时提供了一个 SkyWalking UI 的可视化界面，UI 以 GraphQL + HTTP 方式获取存储数据进行展示。<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0aozn4exyj20uk0f6wif.jpg" alt="image"></p>
<h3 id="Jaeger"><a href="#Jaeger" class="headerlink" title="Jaeger"></a>Jaeger</h3><p><a href="https://www.jaegertracing.io/" target="_blank" rel="noopener">Jaeger</a>用于监控和排除基于微服务的分布式系统，包括：</p>
<ul>
<li>分布式上下文传播</li>
<li>分布式事务监控</li>
<li>根本原因分析</li>
<li>服务依赖性分析</li>
<li>性能/延迟优化</li>
</ul>
<p><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0ap1ca1x2j20um0gi78o.jpg" alt="image"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2019/01/12/Kubernetes学习（一）之认识Kubernetes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/12/Kubernetes学习（一）之认识Kubernetes/" itemprop="url">Kubernetes学习（一）之认识Kubernetes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-12T15:47:00+08:00">
                2019-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/12/Kubernetes学习（一）之认识Kubernetes/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/01/12/Kubernetes学习（一）之认识Kubernetes/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Kubernetes学习（一）之认识Kubernetes"><a href="#Kubernetes学习（一）之认识Kubernetes" class="headerlink" title="Kubernetes学习（一）之认识Kubernetes"></a>Kubernetes学习（一）之认识Kubernetes</h1><h2 id="Kubernetes概念"><a href="#Kubernetes概念" class="headerlink" title="Kubernetes概念"></a>Kubernetes概念</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><a href="https://kubernetes.io" target="_blank" rel="noopener">Kubernetes</a>是一个跨主机集群的 开源的容器调度平台，它可以自动化应用容器的部署、扩展和操作 , 提供以容器为中心的基础架构。结合<code>docker</code>可以提供持续开发，持续部署的功能，我现在所从事开发的<a href="https://choerodon.io/zh/" target="_blank" rel="noopener">Choerodon</a>就是基于这一套架构开发的企业级数字服务平台，具有敏捷化的应用交付和自动化的运营管理的特点。这里介绍的版本是<code>v1.13</code></p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/e7b766e0175f30ae37f7e0e349b87cfe2034a1ae/3e391/images/docs/why_containers.svg" alt="image"></p>
<p>新的方式是通过部署容器方式实现，每个容器之间互相隔离，每个容器有自己的文件系统 ，容器之间进程不会相互影响，能区分计算资源。相对于虚拟机，容器能快速部署，由于容器与底层设施、机器文件系统解耦的，所以它能在不同云、不同版本操作系统间进行迁移。</p>
<p>容器占用资源少、部署快，每个应用可以被打包成一个容器镜像，每个应用与容器间成一对一关系也使容器有更大优势，使用容器可以在build或release 的阶段，为应用创建容器镜像，因为每个应用不需要与其余的应用堆栈组合，也不依赖于生产环境基础结构，这使得从研发到测试、生产能提供一致环境。类似地，容器比虚机轻量、更“透明”，这更便于监控和管理。</p>
<h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><p><img src="https://blobscdn.gitbook.com/v0/b/gitbook-28427.appspot.com/o/assets%2F-LDAOok5ngY4pc1lEDes%2F-LM_rqip-tinVoiFZE0I%2F-LM_sFnwCik1PPfAm7xB%2Farchitecture.png?generation=1537160056980734&amp;alt=media" alt="image"></p>
<h4 id="Master组件"><a href="#Master组件" class="headerlink" title="Master组件"></a>Master组件</h4><p>Kubernetes 主要由以下几个核心（Master）组件组成，Master组件提供集群的管理控制中心。Master组件可以在集群中任何节点上运行。但是为了简单起见，通常在一台VM/机器上启动所有Master组件，并且不会在此VM/机器上运行用户容器。请参考<a href="https://kubernetes.io/docs/admin/high-availability/" target="_blank" rel="noopener">构建高可用群集以来构建multi-master-VM</a>。</p>
<h5 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h5><p><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/用于暴露Kubernetes API。任何的资源请求/调用操作都是通过kube-apiserver提供的接口进行，并提供认证、授权、访问控制、API 注册和发现等机制。例如kubectl CLI命令行就是与kube-apiserver通讯查询节点信息的。请参阅[构建高可用群集](https://kubernetes.io/docs/admin/high-availability/" target="_blank" rel="noopener">kube-apiserver</a>。</p>
<h5 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h5><p><a href="https://github.com/coreos/etcd/blob/master/Documentation/docs.md" target="_blank" rel="noopener">etcd</a>是Kubernetes提供默认的存储系统，保存所有集群数据，使用时需要为etcd数据提供备份计划。</p>
<h5 id="kube-scheduler"><a href="#kube-scheduler" class="headerlink" title="kube-scheduler"></a>kube-scheduler</h5><p>主服务器上的组件，用于监视未创建节点的新创建的pod，并选择一个节点供其运行。 调度决策所考虑的因素包括个人和集体资源需求，硬件/软件/策略约束，亲和力和反亲和性规范，数据位置，工作负载间干扰和最后期限。</p>
<h5 id="kube-controller-manager"><a href="#kube-controller-manager" class="headerlink" title="kube-controller-manager"></a>kube-controller-manager</h5><p><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/" target="_blank" rel="noopener">kube-controller-manager</a>运行管理控制器，它们是集群中处理常规任务的后台线程。逻辑上，每个控制器是一个单独的进程，但为了降低复杂性，它们都被编译成单个二进制文件，并在单个进程中运行。负责维护集群的状态，比如故障检测、自动扩展、滚动更新等。</p>
<p>这些控制器包括：</p>
<ul>
<li><a href="http://docs.kubernetes.org.cn/304.html" target="_blank" rel="noopener">节点（Node</a>）控制器。</li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/" target="_blank" rel="noopener">副本（Replication）控制器</a>：负责维护系统中每个副本中的pod。</li>
<li>端点（Endpoints）控制器：填充Endpoints对象（即连接Services＆Pods）。<br>-<a href="http://docs.kubernetes.org.cn/84.html" target="_blank" rel="noopener"> Service Account</a>和Token控制器：为新的<a href="http://docs.kubernetes.org.cn/242.html" target="_blank" rel="noopener">Namespace</a> 创建默认帐户访问API Token。</li>
</ul>
<h5 id="cloud-controller-manager"><a href="#cloud-controller-manager" class="headerlink" title="cloud-controller-manager"></a>cloud-controller-manager</h5><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/running-cloud-controller/" target="_blank" rel="noopener">云控制器管理器</a>负责与底层云提供商的平台交互。云控制器管理器是Kubernetes版本1.6中引入的，目前还是Alpha的功能。</p>
<p>云控制器管理器仅运行云提供商特定的（controller loops）控制器循环。可以通过将<code>--cloud-provider</code> flag设置为<code>external</code>启动kube-controller-manager ，来禁用控制器循环。</p>
<p>cloud-controller-manager 具体功能：</p>
<ul>
<li>节点（Node）控制器</li>
<li>路由（Route）控制器</li>
<li>Service控制器</li>
<li>卷（Volume）控制器</li>
</ul>
<h4 id="节点（Node）组件"><a href="#节点（Node）组件" class="headerlink" title="节点（Node）组件"></a>节点（Node）组件</h4><p>节点组件运行在<a href="http://docs.kubernetes.org.cn/304.html" target="_blank" rel="noopener">Node</a>，提供Kubernetes运行时环境，以及维护Pod。</p>
<h5 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h5><p>kubelet是主要的节点代理，它会监视已分配给节点的pod，负责维护容器的生命周期，同时也负责 Volume（CVI）和网络（CNI）的管理，具体功能：</p>
<ul>
<li>安装Pod所需的volume。</li>
<li>下载Pod的Secrets。</li>
<li>Pod中运行的 docker（或experimentally，rkt）容器。</li>
<li>定期执行容器健康检查。</li>
<li>通过在必要时创建镜像pod，将pod状态报告回系统的其余部分。</li>
<li>将节点的状态返回到系统的其余部分。</li>
</ul>
<h5 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h5><p><a href="https://kubernetes.io/docs/admin/kube-proxy/" target="_blank" rel="noopener">kube-proxy</a>通过在主机上维护网络规则并执行连接转发来实现Kubernetes服务抽象。负责为 Service 提供 cluster 内部的服务发现和负载均衡。</p>
<h5 id="Container-Runtime"><a href="#Container-Runtime" class="headerlink" title="Container Runtime"></a>Container Runtime</h5><p>容器运行时是负责运行容器的软件。 Kubernetes支持多种运行时：<a href="http://www.docker.com/" target="_blank" rel="noopener">Docker</a>，<a href="https://coreos.com/rkt/" target="_blank" rel="noopener">rkt</a>，<a href="https://github.com/opencontainers/runc" target="_blank" rel="noopener">runc</a>和任何OCI运行时规范实现。</p>
<h4 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h4><p>插件（addon）是实现集群pod和Services功能的 。PodDeployments，ReplicationController等进行管理。Namespace 插件对象是在<code>kube-system</code> Namespace中创建。有关可用插件的扩展列表，请参阅<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">插件</a>。</p>
<h5 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h5><p>虽然不严格要求使用插件，但Kubernetes集群都应该具有<a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="noopener">DNS集群</a>。<br>群集 DNS是一个DNS服务器，能够为 Kubernetes services提供 DNS记录。<br>由Kubernetes启动的容器自动将这个DNS服务器包含在他们的DNS searches中。</p>
<h5 id="用户界面"><a href="#用户界面" class="headerlink" title="用户界面"></a>用户界面</h5><p><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener">仪表板</a>是Kubernetes集群的基于Web的通用UI。它允许用户管理和解决群集中运行的应用程序以及群集本身。</p>
<h5 id="容器资源监测"><a href="#容器资源监测" class="headerlink" title="容器资源监测"></a>容器资源监测</h5><p><a href="https://kubernetes.io/docs/tasks/debug-application-cluster/resource-usage-monitoring/" target="_blank" rel="noopener">容器资源监控</a>提供一个UI浏览监控数据。</p>
<h5 id="Cluster-level-Logging"><a href="#Cluster-level-Logging" class="headerlink" title="Cluster-level Logging"></a>Cluster-level Logging</h5><p><a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/" target="_blank" rel="noopener">Cluster-level logging</a>，负责保存容器日志，搜索/查看日志。</p>
<h5 id="supervisord"><a href="#supervisord" class="headerlink" title="supervisord"></a>supervisord</h5><p>supervisord是一个轻量级的监控系统，用于保障kubelet和docker运行。</p>
<h5 id="fluentd"><a href="#fluentd" class="headerlink" title="fluentd"></a>fluentd</h5><p>fluentd是一个守护进程，可提供<a href="https://kubernetes.io/docs/concepts/overview/components/#cluster-level-logging" target="_blank" rel="noopener">cluster-level logging</a>。</p>
<h3 id="The-Kubernetes-API"><a href="#The-Kubernetes-API" class="headerlink" title="The Kubernetes API"></a>The Kubernetes API</h3><p><a href="https://git.k8s.io/community/contributors/devel/api-conventions.md" target="_blank" rel="noopener">API约定文档</a>中描述了总体API约定</p>
<p><a href="https://kubernetes.io/docs/reference" target="_blank" rel="noopener">API参考</a>中描述了API端点，资源类型和示例。</p>
<p><a href="https://kubernetes.io/docs/reference/access-authn-authz/controlling-access/" target="_blank" rel="noopener">Controlling API Access</a>文档中讨论了对API的远程访问。</p>
<p>Kubernetes API还可用作系统声明性配置架构的基础。 kubectl命令行工具可用于创建，更新，删除和获取API对象。</p>
<p>Kubernetes还根据API资源存储其序列化状态（当前在<a href="https://coreos.com/docs/distributed-configuration/getting-started-with-etcd/" target="_blank" rel="noopener">etcd</a>中）。</p>
<p>Kubernetes本身被分解为多个组件，通过其API进行交互。</p>
<ul>
<li>API更改 </li>
<li>OpenAPI和Swagger定义 </li>
<li>API版本控制</li>
<li>API组 </li>
<li>启用API组 </li>
<li>启用组中的资源</li>
</ul>
<h4 id="API更改"><a href="#API更改" class="headerlink" title="API更改"></a>API更改</h4><p>根据我们的经验，任何成功的系统都需要随着新用例的出现或现有用例的变化而增长和变化。因此，我们希望Kubernetes API能够不断变化和发展。但是，我们打算在很长一段时间内不破坏与现有客户端的兼容性。通常，可以预期频繁添加新的API资源和新的资源字段。消除资源或字段将需要遵循<a href="https://kubernetes.io/docs/reference/using-api/deprecation-policy/" target="_blank" rel="noopener">API弃用策略</a>。</p>
<h4 id="OpenAPI和Swagger定义"><a href="#OpenAPI和Swagger定义" class="headerlink" title="OpenAPI和Swagger定义"></a>OpenAPI和Swagger定义</h4><p>使用<a href="https://www.openapis.org/" target="_blank" rel="noopener">OpenAPI</a>记录完整的API详细信息。 从Kubernetes 1.10开始，Kubernetes API服务器通过<code>/openapi/ v2</code>端点提供OpenAPI规范。通过设置HTTP标头指定请求的格式：</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Possible Values</th>
</tr>
</thead>
<tbody>
<tr>
<td>Accept</td>
<td>application/json, <a href="mailto:application/com.github.proto-openapi.spec.v2@v1.0" target="_blank" rel="noopener">application/com.github.proto-openapi.spec.v2@v1.0</a>+protobuf (the default content-type is application/json for <em>/</em> or not passing this header)</td>
</tr>
<tr>
<td>Accept-Encoding</td>
<td>gzip (not passing this header is acceptable)</td>
</tr>
</tbody>
</table>
<p>在1.14之前，格式分离的端点（<code>/swagger.json</code>,<code>/swagger-2.0.0.json</code>,<code>/swagger-2.0.0.pb-v1</code>,<code>/swagger-2.0.0.pb-v1.gz</code>）为OpenAPI提供服务不同格式的规范。这些端点已弃用，将在Kubernetes 1.14中删除。</p>
<p>获取OpenAPI规范的示例：</p>
<table>
<thead>
<tr>
<th>Before 1.10</th>
<th>Starting with Kubernetes 1.10</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET /swagger.json</td>
<td>GET /openapi/v2 Accept: application/json</td>
</tr>
<tr>
<td>GET /swagger-2.0.0.pb-v1</td>
<td>GET /openapi/v2 Accept: <a href="mailto:application/com.github.proto-openapi.spec.v2@v1.0" target="_blank" rel="noopener">application/com.github.proto-openapi.spec.v2@v1.0</a>+protobuf</td>
</tr>
<tr>
<td>GET /swagger-2.0.0.pb-v1.gz</td>
<td>GET /openapi/v2 Accept: <a href="mailto:application/com.github.proto-openapi.spec.v2@v1.0" target="_blank" rel="noopener">application/com.github.proto-openapi.spec.v2@v1.0</a>+protobuf Accept-Encoding: gzip</td>
</tr>
</tbody>
</table>
<p>Kubernetes为API实现了另一种基于Protobuf的序列化格式，主要用于集群内通信，在<a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/api-machinery/protobuf.md" target="_blank" rel="noopener">设计提案</a>中有记录，每个模式的IDL文件都位于定义API对象的Go包中。</p>
<p>在1.14之前，Kubernetes apiserver还公开了一个API，可用于检索/ swaggerapi上的<a href="http://swagger.io/" target="_blank" rel="noopener">Swagger v1.2</a> Kubernetes API规范。该端点已弃用，将在Kubernetes 1.14中删除。</p>
<h4 id="API版本控制"><a href="#API版本控制" class="headerlink" title="API版本控制"></a>API版本控制</h4><p>为了更容易消除字段或重构资源表示，Kubernetes支持多个API版本，每个API版本位于不同的API路径，例如<code>/api/v1</code>或<code>/apis/extensions/v1beta1</code>。</p>
<p>我们选择在API级别而不是在资源或字段级别进行版本化，以确保API提供清晰，一致的系统资源和行为视图，并允许控制对生命末端和/或实验API的访问。 JSON和Protobuf序列化模式遵循相同的模式更改指南 - 以下所有描述都涵盖两种格式。</p>
<p>请注意，API版本控制和软件版本控制仅间接相关。 <a href="https://git.k8s.io/community/contributors/design-proposals/release/versioning.md" target="_blank" rel="noopener">API和发布版本控制提议</a>描述了API版本控制和软件版本控制之间的关系。</p>
<p>不同的API版本意味着不同级别的稳定性和支持。 <a href="https://git.k8s.io/community/contributors/devel/api_changes.md#alpha-beta-and-stable-versions" target="_blank" rel="noopener">API更改文档</a>中更详细地描述了每个级别的标准。他们总结在这里：</p>
<h5 id="Alpha-level"><a href="#Alpha-level" class="headerlink" title="Alpha level:"></a>Alpha level:</h5><ul>
<li>版本名称包含alpha（例如v1alpha1）。</li>
<li>可能是马车。启用该功能可能会暴露错误。默认情况下禁用。</li>
<li>可随时删除对功能的支持，恕不另行通知。</li>
<li>API可能会在以后的软件版本中以不兼容的方式更改，恕不另行通知。</li>
<li>由于错误风险增加和缺乏长期支持，建议仅在短期测试集群中使用。</li>
</ul>
<h5 id="Beta-level"><a href="#Beta-level" class="headerlink" title="Beta level::"></a>Beta level::</h5><ul>
<li>版本名称包含beta（例如v2beta3）。</li>
<li>代码经过了充分测试。启用该功能被认为是安全的。默认情况下启用。</li>
<li>虽然细节可能会有所变化，但不会删除对整体功能的支持。</li>
<li>在随后的beta版或稳定版中，对象的模式和/或语义可能以不兼容的方式发生变化。发生这种情况时，我们将提供迁移到下一版本的说明。这可能需要删除，编辑和重新创建API对象。编辑过程可能需要一些思考。对于依赖该功能的应用程序，这可能需要停机时间。</li>
<li>建议仅用于非关键业务用途，因为后续版本中可能存在不兼容的更改。如果您有多个可以独立升级的群集，您可以放宽此限制。</li>
<li>请尝试我们的测试版功能并提供反馈！一旦他们退出测试版，我们可能无法进行更多更改。</li>
</ul>
<h5 id="Stable-level"><a href="#Stable-level" class="headerlink" title="Stable level:"></a>Stable level:</h5><ul>
<li>该版本名称是vX这里X是一个整数。</li>
<li>许多后续版本的已发布软件中将出现稳定版本的功能。</li>
</ul>
<h4 id="API组"><a href="#API组" class="headerlink" title="API组"></a>API组</h4><p>为了更容易扩展Kubernetes API，我们实现了<a href="https://git.k8s.io/community/contributors/design-proposals/api-machinery/api-group.md" target="_blank" rel="noopener">API组</a>。API组在REST路径和<code>apiVersion</code>序列化对象的字段中指定。</p>
<p>目前有几个API组正在使用中：</p>
<ol>
<li>核心组，常常被称为遗留组，是在REST路径<code>/api/v1</code>和用途<code>apiVersion: v1</code>。</li>
<li>命名组处于REST路径<code>/apis/$GROUP_NAME/$VERSION</code>，并使用<code>apiVersion: $GROUP_NAME/$VERSION</code> （例如<code>apiVersion: batch/v1</code>）。在<a href="https://kubernetes.io/docs/reference/" target="_blank" rel="noopener">Kubernetes API参考</a>中可以看到支持的API组的完整列表。</li>
</ol>
<p>使用<a href="https://kubernetes.io/docs/concepts/api-extension/custom-resources/" target="_blank" rel="noopener">自定义资源</a>扩展API有两种受支持的路径：</p>
<ol>
<li><a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/extend-api-custom-resource-definitions/" target="_blank" rel="noopener">CustomResourceDefinition</a> 适用于具有非常基本CRUD需求的用户。</li>
<li>需要完整Kubernetes API语义的用户可以实现自己的apiserver并使用<a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/configure-aggregation-layer/" target="_blank" rel="noopener">聚合器</a> 使其无缝地为客户端。</li>
</ol>
<h4 id="启用API组"><a href="#启用API组" class="headerlink" title="启用API组"></a>启用API组</h4><p>默认情况下启用某些资源和API组。可以通过设置<code>--runtime-config apiserver</code> 来启用或禁用它们。<code>--runtime-config</code>接受逗号分隔值。例如：要禁用批处理/ v1，请设置 <code>--runtime-config=batch/v1=false</code>，以启用批处理/ v2alpha1，设置<code>--runtime-config=batch/v2alpha1</code>。该标志接受逗号分隔的一组key = value对，描述了apiserver的运行时配置。</p>
<p>重要信息：启用或禁用组或资源需要重新启动apiserver和controller-manager以获取<code>--runtime-config</code>更改。</p>
<h4 id="启用组中的资源"><a href="#启用组中的资源" class="headerlink" title="启用组中的资源"></a>启用组中的资源</h4><p>默认情况下启用DaemonSet，Deployments，HorizontalPodAutoscalers，Ingresses，Jobs和ReplicaSet。可以通过设置<code>--runtime-configapiserver</code> 来启用其他扩展资源。<code>--runtime-config</code>接受逗号分隔值。例如：要禁用部署和入口，请设置 <code>--runtime-config=extensions/v1beta1/deployments=false,extensions/v1beta1/ingresses=false</code></p>
<h3 id="与Kubernetes对象一起工作"><a href="#与Kubernetes对象一起工作" class="headerlink" title="与Kubernetes对象一起工作"></a>与Kubernetes对象一起工作</h3><h4 id="了解Kubernetes对象"><a href="#了解Kubernetes对象" class="headerlink" title="了解Kubernetes对象"></a><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects/" target="_blank" rel="noopener">了解Kubernetes对象</a></h4><h5 id="了解Kubernetes对象-1"><a href="#了解Kubernetes对象-1" class="headerlink" title="了解Kubernetes对象"></a>了解Kubernetes对象</h5><p>Kubernetes对象是Kubernetes系统中的持久实体。Kubernetes使用这些实体来表示集群的状态。具体来说，他们可以描述：</p>
<ul>
<li>容器化应用正在运行(以及在哪些节点上)</li>
<li>这些应用可用的资源</li>
<li>关于这些应用如何运行的策略，如重新策略，升级和容错<br>Kubernetes对象是“record of intent”，一旦创建了对象，Kubernetes系统会确保对象存在。通过创建对象，可以有效地告诉Kubernetes系统你希望集群的工作负载是什么样的。</li>
</ul>
<p>要使用Kubernetes对象（无论是创建，修改还是删除），都需要使用<a href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/" target="_blank" rel="noopener">Kubernetes API</a>。例如，当使用<a href="http://docs.kubernetes.org.cn/61.html" target="_blank" rel="noopener">kubectl命令管理工具</a>时，CLI会为提供Kubernetes API调用。你也可以直接在自己的程序中使用Kubernetes API，您还可以使用其中一个<a href="https://kubernetes.io/docs/reference/using-api/client-libraries/" target="_blank" rel="noopener">客户端库</a>在您自己的程序中直接使用Kubernetes API。</p>
<h5 id="对象（Object）规范和状态"><a href="#对象（Object）规范和状态" class="headerlink" title="对象（Object）规范和状态"></a>对象（Object）规范和状态</h5><p>每个Kubernetes对象都包含两个嵌套对象字段，用于管理Object的配置：Object Spec和Object Status。Spec描述了对象所需的状态 - 希望Object具有的特性，Status描述了对象的实际状态，并由Kubernetes系统提供和更新。</p>
<p>例如，通过Kubernetes Deployment 来表示在集群上运行的应用的对象。创建Deployment时，可以设置Deployment Spec，来指定要运行应用的三个副本。Kubernetes系统将读取Deployment Spec，并启动你想要的三个应用实例 - 来更新状态以符合之前设置的Spec。如果这些实例中有任何一个失败（状态更改），Kuberentes系统将响应Spec和当前状态之间差异来调整，这种情况下，将会开始替代实例。</p>
<p>有关object spec、status和metadata更多信息，请参考<a href="https://git.k8s.io/community/contributors/devel/api-conventions.md" target="_blank" rel="noopener">“Kubernetes API Conventions”</a>。</p>
<h5 id="描述Kubernetes对象"><a href="#描述Kubernetes对象" class="headerlink" title="描述Kubernetes对象"></a>描述Kubernetes对象</h5><p>在Kubernetes中创建对象时，必须提供描述其所需Status的对象Spec，以及关于对象（如name）的一些基本信息。当使用Kubernetes API创建对象（直接或通过kubectl）时，该API请求必须将该信息作为JSON包含在请求body中。通常，可以将信息提供给kubectl .yaml文件，在进行API请求时，kubectl将信息转换为JSON。</p>
<p>以下示例是一个.yaml文件，显示Kubernetes Deployment所需的字段和对象Spec：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#application/deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># for versions before 1.9.0 use apps/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span> <span class="comment"># tells deployment to run 2 pods matching the template</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">nginx:1.7.9</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></p>
<p>使用上述.yaml文件创建Deployment，是通过在kubectl中使用<a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#create" target="_blank" rel="noopener">kubectl create</a>命令来实现。将该.yaml文件作为参数传递。如下例子：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>kubectl create -f <span class="symbol">https:</span>/<span class="regexp">/k8s.io/examples</span><span class="regexp">/application/deployment</span>.yaml --record</span><br><span class="line">deployment.apps/nginx-deployment created</span><br></pre></td></tr></table></figure></p>
<h5 id="必填字段"><a href="#必填字段" class="headerlink" title="必填字段"></a>必填字段</h5><p>对于要创建的Kubernetes对象的yaml文件，需要为以下字段设置值：</p>
<ul>
<li>apiVersion - 创建对象的Kubernetes API 版本</li>
<li>kind - 要创建什么样的对象？</li>
<li>metadata- 具有唯一标示对象的数据，包括 name（字符串）、UID和Namespace（可选项）<br>您还需要提供对象规范字段。对象规范的精确格式对于每个Kubernetes对象都是不同的，并且包含特定于该对象的嵌套字段。 <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/" target="_blank" rel="noopener">Kubernetes API Reference</a>可以帮助您找到可以使用Kubernetes创建的所有对象的规范格式。例如，可以在<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#podspec-v1-core" target="_blank" rel="noopener">此处</a>找到Pod对象的spec格式，可以在<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#deploymentspec-v1-apps" target="_blank" rel="noopener">此处</a>找到Deployment对象的spec格式。</li>
</ul>
<h4 id="name"><a href="#name" class="headerlink" title="name"></a>name</h4><p>Kubernetes REST API中的所有对象都由Name和UID明确标识。</p>
<p>对于非唯一的用户提供的属性，Kubernetes提供<a href="https://kubernetes.io/docs/user-guide/labels" target="_blank" rel="noopener">标签</a>和<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/" target="_blank" rel="noopener">注释</a>。</p>
<p>有关名称和UID的精确语法规则，请参阅<a href="https://git.k8s.io/community/contributors/design-proposals/architecture/identifiers.md" target="_blank" rel="noopener">标识符设计文档</a>。</p>
<ul>
<li>Names</li>
<li>UIDs</li>
</ul>
<h5 id="Names"><a href="#Names" class="headerlink" title="Names"></a>Names</h5><p>客户端提供的字符串，用于引用资源URL中的对象，例如<code>/api/v1/pods/some-name</code>。</p>
<p>只有给定类型的一个对象一次可以有一个给定的名称。但是，如果删除该对象，则可以创建具有相同名称的新对象。</p>
<p>按照惯例，Kubernetes资源的名称应最多为253个字符，并且由小写字母数字字符组成-，并且.，但某些资源具有更具体的限制。</p>
<h5 id="UIDs"><a href="#UIDs" class="headerlink" title="UIDs"></a>UIDs</h5><p>Kubernetes系统生成的字符串，用于唯一标识对象。</p>
<p>在Kubernetes集群的整个生命周期中创建的每个对象都具有不同的UID。它旨在区分类似实体的历史事件。</p>
<h4 id="Namespaces"><a href="#Namespaces" class="headerlink" title="Namespaces"></a>Namespaces</h4><p>Kubernetes支持由同一物理集群支持的多个虚拟集群。这些虚拟集群称为名称空间。</p>
<ul>
<li>何时使用多个命名空间</li>
<li>使用命名空间</li>
<li>命名空间和DNS</li>
<li>并非所有对象都在命名空间中</li>
</ul>
<h5 id="何时使用多个命名空间"><a href="#何时使用多个命名空间" class="headerlink" title="何时使用多个命名空间"></a>何时使用多个命名空间</h5><p>命名空间旨在用于多个用户分布在多个团队或项目中的环境中。对于具有几个到几十个用户的集群，您根本不需要创建或考虑名称空间。当您需要它们提供的功能时，请开始使用命名空间。</p>
<p>命名空间提供名称范围。资源名称在名称空间中必须是唯一的，而不是跨名称空间。</p>
<p>命名空间是一种在多个用户之间划分群集资源的方法（通过<a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/" target="_blank" rel="noopener">资源配额</a>）。</p>
<p>在Kubernetes的未来版本中，默认情况下，同一名称空间中的对象将具有相同的访问控制策略。</p>
<p>没有必要使用多个名称空间来分隔略有不同的资源，例如同一软件的不同版本：使用<a href="https://kubernetes.io/docs/user-guide/labels" target="_blank" rel="noopener">标签</a>来区分同一名称空间中的资源。</p>
<h5 id="使用命名空间"><a href="#使用命名空间" class="headerlink" title="使用命名空间"></a>使用命名空间</h5><p>名称空间的<a href="https://kubernetes.io/docs/admin/namespaces" target="_blank" rel="noopener">管理指南文档</a>中描述了名称空间的创建和删除。</p>
<h6 id="查看名称空间"><a href="#查看名称空间" class="headerlink" title="查看名称空间"></a>查看名称空间</h6><p>您可以使用以下命令列出集群中的当前名称空间：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> namespaces</span><br><span class="line">NAME          STATUS    AGE</span><br><span class="line">default       Active    1d</span><br><span class="line">kube-system   Active    1d</span><br><span class="line">kube-public   Active    1d</span><br></pre></td></tr></table></figure></p>
<p>Kubernetes以三个初始名称空间开头：</p>
<ul>
<li><code>default</code> 没有其他命名空间的对象的默认命名空间</li>
<li><code>kube-system</code> Kubernetes系统创建的对象的命名空间</li>
<li><code>kube-public</code>此命名空间是自动创建的，并且所有用户（包括未经过身份验证的用户）都可以读取。此命名空间主要用于群集使用，以防某些资源在整个群集中可见且可公开读取。此命名空间的公共方面只是一个约定，而不是一个要求。</li>
</ul>
<h6 id="设置请求的命名空间"><a href="#设置请求的命名空间" class="headerlink" title="设置请求的命名空间"></a>设置请求的命名空间</h6><p>要临时设置请求的命名空间，请使用该<code>--namespace</code>标志。</p>
<p>例如：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="attribute">--namespace</span>=&lt;insert-namespace-name-here&gt; <span class="builtin-name">run</span> nginx <span class="attribute">--image</span>=nginx</span><br><span class="line">$ kubectl <span class="attribute">--namespace</span>=&lt;insert-namespace-name-here&gt; <span class="builtin-name">get</span> pods</span><br></pre></td></tr></table></figure></p>
<h6 id="设置命名空间首选项"><a href="#设置命名空间首选项" class="headerlink" title="设置命名空间首选项"></a>设置命名空间首选项</h6><p>您可以在该上下文中为所有后续kubectl命令永久保存命名空间。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl<span class="built_in"> config </span>set-context $(kubectl<span class="built_in"> config </span>current-context) <span class="attribute">--namespace</span>=&lt;insert-namespace-name-here&gt;</span><br><span class="line"><span class="comment"># Validate it</span></span><br><span class="line">$ kubectl<span class="built_in"> config </span>view | grep namespace:</span><br></pre></td></tr></table></figure>
<h5 id="命名空间和DNS"><a href="#命名空间和DNS" class="headerlink" title="命名空间和DNS"></a>命名空间和DNS</h5><p>创建<a href="https://kubernetes.io/docs/user-guide/services" target="_blank" rel="noopener">服务</a>时，它会创建相应的<a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="noopener">DNS条目</a>。此条目是表单<code>&lt;service-name&gt;.&lt;namespace-name&gt;.svc.cluster.local</code>，这意味着如果容器只是使用<code>&lt;service-name&gt;</code>，它将解析为命名空间本地的服务。这对于在多个名称空间（如开发，分段和生产）中使用相同的配置非常有用。如果要跨命名空间访问，则需要使用完全限定的域名（FQDN）。</p>
<h5 id="并非所有对象都在命名空间中"><a href="#并非所有对象都在命名空间中" class="headerlink" title="并非所有对象都在命名空间中"></a>并非所有对象都在命名空间中</h5><p>大多数Kubernetes资源（例如pod，服务，复制控制器等）都在某些名称空间中。但是，命名空间资源本身并不在命名空间中。并且低级资源（例如节点和persistentVolumes）不在任何名称空间中。</p>
<p>要查看哪些Kubernetes资源在命名空间中，哪些不在：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> In a namespace</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl api-resources --namespaced=<span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Not <span class="keyword">in</span> a namespace</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl api-resources --namespaced=<span class="literal">false</span></span></span><br></pre></td></tr></table></figure></p>
<h4 id="Labels-and-Selectors"><a href="#Labels-and-Selectors" class="headerlink" title="Labels and Selectors"></a>Labels and Selectors</h4><p>标签是附加到对象（例如pod）的键/值对。标签旨在用于指定对用户有意义且相关的对象的标识属性，但不直接暗示核心系统的语义。标签可用于组织和选择对象的子集。标签可以在创建时附加到对象，随后可以随时添加和修改。每个对象都可以定义一组键/值标签。每个Key对于给定对象必须是唯一的。<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"metadata"</span>: &#123;</span><br><span class="line">  <span class="string">"labels"</span>: &#123;</span><br><span class="line">    <span class="string">"key1"</span> : <span class="string">"value1"</span>,</span><br><span class="line">    <span class="string">"key2"</span> : <span class="string">"value2"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>标签允许高效的查询和监视，非常适合在UI和CLI中使用。应使用<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/" target="_blank" rel="noopener">注释</a>记录非识别信息。</p>
<ul>
<li>动机</li>
<li>语法和字符集</li>
<li>标签选择器</li>
<li>API</li>
</ul>
<h5 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h5><p>标签使用户能够以松散耦合的方式将他们自己的组织结构映射到系统对象，而无需客户端存储这些映射。</p>
<p>服务部署和批处理流水线通常是多维实体（例如，多个分区或部署，多个释放轨道，多个层，每层多个微服务）。管理通常需要交叉操作，这打破了严格的层次表示的封装，特别是由基础设施而不是用户确定的严格的层次结构。</p>
<p>示例标签：</p>
<ul>
<li><code>&quot;release&quot; : &quot;stable&quot;</code>，<code>&quot;release&quot; : &quot;canary&quot;</code></li>
<li><code>&quot;environment&quot; : &quot;dev&quot;</code>，<code>&quot;environment&quot; : &quot;qa&quot;</code>，<code>&quot;environment&quot; : &quot;production&quot;</code></li>
<li><code>&quot;tier&quot; : &quot;frontend&quot;</code>，<code>&quot;tier&quot; : &quot;backend&quot;</code>，<code>&quot;tier&quot; : &quot;cache&quot;</code></li>
<li><code>&quot;partition&quot; : &quot;customerA&quot;</code>， <code>&quot;partition&quot; : &quot;customerB&quot;</code></li>
<li><code>&quot;track&quot; : &quot;daily&quot;</code>， <code>&quot;track&quot; : &quot;weekly&quot;</code><br>这些只是常用标签的例子; 你可以自由地制定自己的约定。请记住，标签Key对于给定对象必须是唯一的。</li>
</ul>
<h5 id="语法和字符集"><a href="#语法和字符集" class="headerlink" title="语法和字符集"></a>语法和字符集</h5><p>标签是键/值对。有效标签键有两个段：可选前缀和名称，用斜杠（<code>/</code>）分隔。名称段是必需的，必须是63个字符或更少，以字母数字字符（<code>[a-z0-9A-Z]</code>）开头和结尾，带有破折号（<code>-</code>），下划线（<code>_</code>），点（<code>.</code>）和字母数字之间。前缀是可选的。如果指定，前缀必须是DNS子域：由点（<code>.</code>）分隔的一系列DNS标签，总共不超过253个字符，后跟斜杠（<code>/</code>）。</p>
<p>如果省略前缀，则假定标签Key对用户是私有的。自动化系统组件（例如<code>kube-scheduler</code>，<code>kube-controller-manager</code>，<code>kube-apiserver</code>，<code>kubectl</code>，或其他第三方自动化），它添加标签终端用户对象都必须指定一个前缀。</p>
<p>在<code>kubernetes.io/</code>和<code>k8s.io/</code>前缀保留给Kubernetes核心组件。</p>
<p>有效标签值必须为63个字符或更少，并且必须为空或以字母数字字符（<code>[a-z0-9A-Z]</code>）开头和结尾，并带有短划线（<code>-</code>），下划线（<code>_</code>），点（<code>.</code>）和字母数字。</p>
<h5 id="标签选择器"><a href="#标签选择器" class="headerlink" title="标签选择器"></a>标签选择器</h5><p>与名称和UID不同，标签不提供唯一性。通常，我们希望许多对象携带相同的标签。</p>
<p>通过标签选择器，客户端/用户可以识别一组对象。标签选择器是Kubernetes中的核心分组原语。</p>
<p>目前，API支持两种类型的选择：基于平等，和基于集的。标签选择器可以由逗号分隔的多个要求组成。在多个要求的情况下，必须满足所有要求，因此逗号分隔符充当逻辑AND（<code>&amp;&amp;</code>）运算符。</p>
<p>空或非指定选择器的语义取决于上下文，使用选择器的API类型应记录它们的有效性和含义。</p>
<blockquote>
<p>注意：对于某些API类型（例如ReplicaSet），两个实例的标签选择器不得在命名空间内重叠，或者控制器可以将其视为冲突的指令，并且无法确定应存在多少副本。</p>
</blockquote>
<h6 id="基于平等的要求"><a href="#基于平等的要求" class="headerlink" title="基于平等的要求"></a>基于平等的要求</h6><p>基于平等或不平等的要求允许按标签键和值进行过滤。匹配对象必须满足所有指定的标签约束，尽管它们也可能有其他标签。三种操作都承认<code>=</code>，<code>==</code>，<code>!=</code>。前两个代表平等（简单地说是同义词），而后者代表不平等。例如：<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">environment = production</span><br><span class="line">tier != frontend</span><br></pre></td></tr></table></figure></p>
<p>前者选择密钥等于<code>environment</code>和值等于的所有资源<code>production</code>。后者选择密钥等于<code>tier</code>和值不同的<code>frontend</code>所有资源，以及没有带<code>tier</code>密钥标签的所有资源。可以过滤使用逗号运算符<code>production</code>排除的资源<code>frontend</code>：<code>environment=production,tier!=frontend</code></p>
<p>基于等同的标签要求的一种使用场景是Pods指定节点选择标准。例如，下面的示例Pod选择标签为“ <code>accelerator=nvidia-tesla-p100</code>”的节点。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: Pod</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: cuda-test</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">containers</span>:</span><br><span class="line">    - <span class="attribute">name</span>: cuda-test</span><br><span class="line">      <span class="attribute">image</span>: <span class="string">"k8s.gcr.io/cuda-vector-add:v0.1"</span></span><br><span class="line">      <span class="attribute">resources</span>:</span><br><span class="line">        <span class="attribute">limits</span>:</span><br><span class="line">          nvidia.com/<span class="attribute">gpu</span>: <span class="number">1</span></span><br><span class="line">  <span class="attribute">nodeSelector</span>:</span><br><span class="line">    <span class="attribute">accelerator</span>: nvidia-tesla-p100</span><br></pre></td></tr></table></figure></p>
<h6 id="基于集合的要求"><a href="#基于集合的要求" class="headerlink" title="基于集合的要求"></a>基于集合的要求</h6><p>基于集合的标签要求允许根据一组值过滤密钥。三种操作的支持：<code>in</code>，<code>notin</code>和<code>exists</code>（仅密钥标识符）。例如：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">environment <span class="keyword">in</span> (production, qa)</span><br><span class="line">tier notin (frontend, backend)</span><br><span class="line"><span class="built_in">partition</span></span><br><span class="line">!<span class="built_in">partition</span></span><br></pre></td></tr></table></figure></p>
<p>第一个示例选择键等于<code>environment</code>和值等于<code>production</code>或的所有资源<code>qa</code>。第二个示例选择密钥等于<code>tier</code>和除了<code>frontend</code>和之外的值的<code>backend</code>所有资源，以及没有带<code>tier</code>密钥标签的所有资源。第三个例子选择所有资源，包括带密钥的标签<code>partition</code>; 没有检查值。第四个示例选择没有带键的标签的所有资源<code>partition</code>; 没有检查值。类似地，逗号分隔符充当AND运算符。因此，使用<code>partition</code>密钥（无论值）和<code>environment</code>不同的  过滤资源<code>qa</code>都可以实现<code>partition</code>,<code>environment notin (qa)</code>。基于集合标签选择器是一种平等的一般形式，因为<code>environment=production</code>它等同于<code>environment in (production)</code>; 同样的<code>!=</code>和<code>notin</code>。</p>
<p>基于集合的需求可以与基于相等的需求相结合。例如：<code>partition in (customerA, customerB),environment!=qa</code>。</p>
<h5 id="API"><a href="#API" class="headerlink" title="API"></a>API</h5><h6 id="LIST和WATCH过滤"><a href="#LIST和WATCH过滤" class="headerlink" title="LIST和WATCH过滤"></a>LIST和WATCH过滤</h6><p>LIST和WATCH操作可以指定标签选择器来过滤使用查询参数返回的对象集。这两个要求都是允许的（在此处显示为出现在URL查询字符串中）：</p>
<ul>
<li>基于平等的要求：<code>?labelSelector=environment%3Dproduction,tier%3Dfrontend</code></li>
<li>基于集合的要求：<code>?labelSelector=environment+in+%28production%2Cqa%29%2Ctier+in+%28frontend%29</code></li>
</ul>
<p>两种标签选择器样式都可用于通过REST客户端列出或查看资源。例如，靶向<code>apiserver</code>与<code>kubectl</code>和使用基于平等-一个可写：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> pods -l <span class="attribute">environment</span>=production,tier=frontend</span><br></pre></td></tr></table></figure></p>
<p>或使用基于集合的要求：<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -l <span class="symbol">'environment</span> <span class="keyword">in</span> (production),tier <span class="keyword">in</span> (frontend)'</span><br></pre></td></tr></table></figure></p>
<p>如前所述，基于集合的要求更具表现力。例如，他们可以在值上实现OR运算符：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods -l <span class="string">'environment in (production, qa)'</span></span></span><br></pre></td></tr></table></figure></p>
<p>或限制负匹配通过存在操作者：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get pods -l <span class="string">'environment,environment notin (frontend)'</span></span></span><br></pre></td></tr></table></figure></p>
<p>在API对象中设置引用</p>
<p>某些Kubernetes对象（例如<a href="https://kubernetes.io/docs/user-guide/services" target="_blank" rel="noopener">services</a>和<a href="https://kubernetes.io/docs/user-guide/replication-controller" target="_blank" rel="noopener">replicationcontrollers</a>）也使用标签选择器来指定其他资源集，例如<a href="https://kubernetes.io/docs/user-guide/pods" target="_blank" rel="noopener">pod</a>。</p>
<h5 id="服务和ReplicationController"><a href="#服务和ReplicationController" class="headerlink" title="服务和ReplicationController"></a>服务和ReplicationController</h5><p><code>service</code>使用标签选择器定义目标的一组pod 。类似地<code>，replicationcontroller</code>应该管理的pod的数量也用标签选择器定义。</p>
<p>两个对象的标签选择器在使用映射定义<code>json</code>或<code>yaml</code>文件中定义，并且仅支持基于等同的需求选择器：<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"selector"</span>: &#123;</span><br><span class="line">    <span class="string">"component"</span> : <span class="string">"redis"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>要么<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">selector:</span></span><br><span class="line"><span class="symbol">    component:</span> redis</span><br></pre></td></tr></table></figure></p>
<p>这个选择器（分别以<code>json</code>或<code>yaml</code>格式）相当于<code>component=redis</code>或<code>component in (redis)</code>。</p>
<h5 id="支持基于集合的需求的资源"><a href="#支持基于集合的需求的资源" class="headerlink" title="支持基于集合的需求的资源"></a>支持基于集合的需求的资源</h5><p>较新的资源，如<a href="https://kubernetes.io/docs/concepts/jobs/run-to-completion-finite-workloads/" target="_blank" rel="noopener">Job</a>，<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">Deployment</a>，<a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/" target="_blank" rel="noopener">Replica Set</a>，和<a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/" target="_blank" rel="noopener">Daemon Set</a>，支持基于集合的要求也是如此。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">selector</span>:</span><br><span class="line">  <span class="attribute">matchLabels</span>:</span><br><span class="line">    <span class="attribute">component</span>: redis</span><br><span class="line">  <span class="attribute">matchExpressions</span>:</span><br><span class="line">    - &#123;<span class="attribute">key</span>: tier, <span class="attribute">operator</span>: In, <span class="attribute">values</span>: [cache]&#125;</span><br><span class="line">    <span class="selector-tag">-</span> &#123;<span class="attribute">key</span>: environment, <span class="attribute">operator</span>: NotIn, <span class="attribute">values</span>: [dev]&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>matchLabels</code>是对的地图<code>{key,value}</code>。一个单一的<code>{key,value}</code>在<code>matchLabels</code>地图相当于一个元件<code>matchExpressions</code>，其key字段是“key”，则<code>operator</code>是“In”和values阵列仅包含“value”。<code>matchExpressions</code>是一个pod选择器要求列表。有效的运算符包括In，NotIn，Exists和DoesNotExist。在In和NotIn的情况下，设置的值必须是非空的。所有的要求，从两者<code>matchLabels</code>和<code>matchExpressionsAND</code>一起 - 他们必须满足，以匹配。</p>
<h5 id="选择节点集"><a href="#选择节点集" class="headerlink" title="选择节点集"></a>选择节点集</h5><p>用于选择标签的一个用例是约束pod可以调度的节点集。有关更多信息，请参阅有关节点选择的文档。</p>
<h4 id="Annotations"><a href="#Annotations" class="headerlink" title="Annotations"></a>Annotations</h4><p>您可以使用Kubernetes注释将任意非标识元数据附加到对象。工具和库等客户端可以检索此元数据。</p>
<ul>
<li>将元数据附加到对象</li>
<li>语法和字符集</li>
</ul>
<h5 id="将元数据附加到对象"><a href="#将元数据附加到对象" class="headerlink" title="将元数据附加到对象"></a>将元数据附加到对象</h5><p>您可以使用标签或注释将元数据附加到Kubernetes对象。标签可用于选择对象和查找满足特定条件的对象集合。相反，注释不用于识别和选择对象。注释中的元数据可以是小的或大的，结构化的或非结构化的，并且可以包括标签不允许的字符。</p>
<p>注释（如标签）是键/值映射<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"metadata"</span>: &#123;</span><br><span class="line">  <span class="string">"annotations"</span>: &#123;</span><br><span class="line">    <span class="string">"key1"</span> : <span class="string">"value1"</span>,</span><br><span class="line">    <span class="string">"key2"</span> : <span class="string">"value2"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以下是可以在注释中记录的一些信息示例：</p>
<ul>
<li>由声明性配置层管理的字段。将这些字段作为注释附加，可以将它们与客户端或服务器设置的默认值以及自动生成的字段和自动调整大小或自动调整系统设置的字段区分开来。</li>
<li>构建，发布或映像信息，如时间戳，版本ID，git分支，PR编号，镜像哈希和仓库地址。</li>
<li>指向日志记录，监视，分析或审计存储库的指针。</li>
<li>可用于调试目的的客户端库或工具信息：例如，名称，版本和构建信息。</li>
<li>用户或工具/系统出处信息，例如来自其他生态系统组件的相关对象的URL。</li>
<li>轻量推出工具元数据：例如，配置或检查点。</li>
<li>负责人的电话或寻呼机号码，或指定可在何处找到该信息的目录条目，例如团队网站。</li>
<li>从最终用户到实现的指令，用于修改行为或使用非标准功能。</li>
</ul>
<p>您可以将此类信息存储在外部数据库或目录中，而不是使用注释，但这会使生成用于部署，管理，内省等的共享客户端库和工具变得更加困难。</p>
<h5 id="语法和字符集-1"><a href="#语法和字符集-1" class="headerlink" title="语法和字符集"></a>语法和字符集</h5><p>注释是键/值对。有效的注释键有两个段：可选的前缀和名称，用斜杠（<code>/</code>）分隔。名称段是必需的，必须是63个字符或更少，以字母数字字符（<code>[a-z0-9A-Z]</code>）开头和结尾，带有破折号（<code>-</code>），下划线（<code>_</code>），点（<code>.</code>）和字母数字之间。前缀是可选的。如果指定，前缀必须是DNS子域：由点（<code>.</code>）分隔的一系列DNS标签，总共不超过253个字符，后跟斜杠（<code>/</code>）。</p>
<p>如果省略前缀，则假定注释密钥对用户是私有的。自动化系统组件（例如<code>kube-scheduler</code>，<code>kube-controller-manager</code>，<code>kube-apiserver</code>，<code>kubectl</code>，或其他第三方自动化）的添加注释到最终用户的对象都必须指定一个前缀。</p>
<p>在<code>kubernetes.io/</code>和<code>k8s.io/</code>前缀保留给Kubernetes核心组件。</p>
<h4 id="Field-Selectors"><a href="#Field-Selectors" class="headerlink" title="Field Selectors"></a>Field Selectors</h4><ul>
<li>支持的字段</li>
<li>支持操作</li>
<li>链式选择器</li>
<li>多种资源类型</li>
</ul>
<p>字段选择器允许您根据一个或多个资源字段的值<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects" target="_blank" rel="noopener">选择Kubernetes资源</a>。以下是一些示例字段选择器查询：</p>
<ul>
<li><code>metadata.name=my-service</code></li>
<li><code>metadata.namespace!=default</code></li>
<li><code>status.phase=Pending</code>  </li>
</ul>
<p>此<code>kubectl</code>命令选择<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-phase" target="_blank" rel="noopener">status.phase</a>字段值为的所有Pod <code>Running</code>：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> pods --field-selector status.<span class="attribute">phase</span>=Running</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：<br>字段选择器本质上是资源过滤器。默认情况下，不应用选择器/过滤器，这意味着将选择指定类型的所有资源。这使以下kubectl查询等效：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="meta">get</span> pods</span><br><span class="line">$ kubectl <span class="meta">get</span> pods --<span class="meta">field</span>-<span class="keyword">selector </span><span class="string">""</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h5 id="支持的字段"><a href="#支持的字段" class="headerlink" title="支持的字段"></a>支持的字段</h5><p>支持的字段选择器因Kubernetes资源类型而异。所有资源类型都支持<code>metadata.name</code>和<code>metadata.namespace</code>字段。使用不受支持的字段选择器会产生错误。例如：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> ingress --field-selector foo.<span class="attribute">bar</span>=baz</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(BadRequest): Unable <span class="keyword">to</span> <span class="builtin-name">find</span> <span class="string">"ingresses"</span> that match label selector <span class="string">""</span>, field selector <span class="string">"foo.bar=baz"</span>: <span class="string">"foo.bar"</span> is <span class="keyword">not</span> a known field selector: only <span class="string">"metadata.name"</span>, <span class="string">"metadata.namespace"</span></span><br></pre></td></tr></table></figure></p>
<h5 id="支持操作"><a href="#支持操作" class="headerlink" title="支持操作"></a>支持操作</h5><p>您可以使用<code>=</code>，<code>==</code>以及<code>!=</code>与现场选择操作（<code>=</code>和<code>==</code>意思是一样的）。<code>kubectl</code>例如，此命令选择不在<code>default</code>命名空间中的所有Kubernetes服务：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">get</span> services --field-selector metadata.<span class="keyword">namespace</span>!=<span class="built_in">default</span></span><br></pre></td></tr></table></figure></p>
<h5 id="链式选择器"><a href="#链式选择器" class="headerlink" title="链式选择器"></a>链式选择器</h5><p>与<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels" target="_blank" rel="noopener">标签</a>和其他选择器一样，字段选择器可以作为逗号分隔列表链接在一起。此<code>kubectl</code>命令选择<code>status.phase</code>不相等<code>Running</code>且<code>spec.restartPolicy</code>字段等于的所有Pod <code>Always</code>：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> pods <span class="attribute">--field-selector</span>=status.phase!=Running,spec.restartPolicy=Always</span><br></pre></td></tr></table></figure></p>
<h5 id="多种资源类型"><a href="#多种资源类型" class="headerlink" title="多种资源类型"></a>多种资源类型</h5><p>您可以跨多种资源类型使用字段选择器。此<code>kubectl</code>命令选择不在<code>default</code>命名空间中的所有Statefulsets和Services ：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">get</span> statefulsets,services --field-selector metadata.<span class="keyword">namespace</span>!=<span class="built_in">default</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Recommended-Labels"><a href="#Recommended-Labels" class="headerlink" title="Recommended Labels"></a>Recommended Labels</h4><p>您可以使用比kubectl和仪表板更多的工具来可视化和管理Kubernetes对象。一组通用的标签允许工具以互操作的方式工作，以所有工具都能理解的通用方式描述对象。</p>
<p>除支持工具外，推荐标签还以可查询的方式描述应用程序。</p>
<ul>
<li>标签</li>
<li>应用程序和应用程序实例</li>
<li>例子<br>元数据围绕应用程序的概念进行组织。Kubernetes不是一个服务平台（PaaS），也没有或强制执行正式的应用程序概念。相反，应用程序是非正式的，并使用元数据进 应用程序包含的内容的定义是松散的。</li>
</ul>
<blockquote>
<p>注意：这些是推荐标签。它们使管理应用程序变得更容易，但对于任何核心工具都不是必需的。</p>
</blockquote>
<p>共享标签和注释共享一个共同的前缀：<code>app.kubernetes.io</code>。没有前缀的标签对用户是私有的。共享前缀可确保共享标签不会干扰自定义用户标签。</p>
<h5 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h5><p>为了充分利用这些标签，应将它们应用于每个资源对象。</p>
<table>
<thead>
<tr>
<th>键</th>
<th>描述</th>
<th>例</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>app.kubernetes.io/name</td>
<td>应用程序的名称</td>
<td>string</td>
<td>mysql</td>
</tr>
<tr>
<td>app.kubernetes.io/instance</td>
<td>标识应用程序实例的唯一名称</td>
<td>string</td>
<td>wordpress-abcxzy</td>
</tr>
<tr>
<td>app.kubernetes.io/version</td>
<td>应用程序的当前版本（例如，语义版本，修订版哈希等）</td>
<td>string</td>
<td>5.7.21</td>
</tr>
<tr>
<td>app.kubernetes.io/component</td>
<td>架构中的组件</td>
<td>string</td>
<td>database</td>
</tr>
<tr>
<td>app.kubernetes.io/part-of</td>
<td>此级别的更高级别应用程序的名称</td>
<td>string</td>
<td>wordpress</td>
</tr>
<tr>
<td>app.kubernetes.io/managed-by</td>
<td>该工具用于管理应用程序的操作</td>
<td>string</td>
<td>helm</td>
</tr>
</tbody>
</table>
<p>要说明这些标签的运行情况，请考虑以下StatefulSet对象：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/name: mysql</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/instance: wordpress-abcxzy</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/version: <span class="string">"5.7.21"</span></span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/component: database</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/part-of: wordpress</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/managed-by: helm</span><br></pre></td></tr></table></figure></p>
<h5 id="应用程序和应用程序实例"><a href="#应用程序和应用程序实例" class="headerlink" title="应用程序和应用程序实例"></a>应用程序和应用程序实例</h5><p>应用程序可以一次或多次安装到Kubernetes集群中，在某些情况下，可以安装在同一名称空间中。例如，<code>wordpress</code>可以不止一次安装，其中不同的网站是<code>wordpress</code>的不同安装。</p>
<p>应用程序的名称和实例名称分别记录。例如，在WordPress具有<code>app.kubernetes.io/name</code>的<code>wordpress</code>，同时它有一个实例名，被表示为<code>app.kubernetes.io/instance</code>具有值 <code>wordpress-abcxzy</code>。这使得应用程序的应用程序和实例可以识别。应用程序的每个实例都必须具有唯一的名称。</p>
<h5 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h5><p>为了说明使用这些标签的不同方式，以下示例具有不同的复杂性。</p>
<h6 id="一种简单的无状态服务"><a href="#一种简单的无状态服务" class="headerlink" title="一种简单的无状态服务"></a>一种简单的无状态服务</h6><p>考虑使用<code>Deployment</code>和<code>Service</code>对象部署的简单无状态服务的情况。以下两个代码段表示如何以最简单的形式使用标签。</p>
<p>本<code>Deployment</code>是用来监督运行应用程序本身的豆荚。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: apps/v1</span><br><span class="line"><span class="attribute">kind</span>: Deployment</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    app.kubernetes.io/<span class="attribute">name</span>: myservice</span><br><span class="line">    app.kubernetes.io/<span class="attribute">instance</span>: myservice-abcxzy</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>将<code>Service</code>用于公开应用程序。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: myservice</span><br><span class="line">    app.kubernetes.io/instance: myservice-abcxzy</span><br><span class="line"><span class="built_in">..</span>.</span><br></pre></td></tr></table></figure></p>
<h6 id="使用数据库的Web应用程序"><a href="#使用数据库的Web应用程序" class="headerlink" title="使用数据库的Web应用程序"></a>使用数据库的Web应用程序</h6><p>考虑一个稍微复杂的应用程序：使用Helm安装的使用数据库（MySQL）的Web应用程序（WordPress）。以下代码段说明了用于部署此应用程序的对象的开始。</p>
<p>以下<code>Deployment</code>内容用于WordPress：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/name: wordpress</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/instance: wordpress-abcxzy</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/version: <span class="string">"4.9.4"</span></span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/managed-by: helm</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/component: server</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/part-of: wordpress</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>将<code>Service</code>用于公开WordPress的：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: wordpress</span><br><span class="line">    app.kubernetes.io/instance: wordpress-abcxzy</span><br><span class="line">    app.kubernetes.io/version: <span class="string">"4.9.4"</span></span><br><span class="line">    app.kubernetes.io/managed-by: helm</span><br><span class="line">    app.kubernetes.io/component: server</span><br><span class="line">    app.kubernetes.io/part-of: wordpress</span><br><span class="line"><span class="built_in">..</span>.</span><br></pre></td></tr></table></figure></p>
<p>MySQL作为一个<code>StatefulSet</code>包含它的元数据和它所属的更大的应用程序公开：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/name: mysql</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/instance: wordpress-abcxzy</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/managed-by: helm</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/component: database</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/part-of: wordpress</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/version: <span class="string">"5.7.21"</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>将<code>Service</code>用于公开MySQL作为WordPress的部分：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/name: mysql</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/instance: wordpress-abcxzy</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/managed-by: helm</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/component: database</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/part-of: wordpress</span><br><span class="line">    app<span class="selector-class">.kubernetes</span><span class="selector-class">.io</span>/version: <span class="string">"5.7.21"</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>使用MySQL <code>StatefulSet</code>，<code>Service</code>您会注意到有关MySQL和Wordpress的信息，包括更广泛的应用程序。</p>
<h3 id="对象管理使用kubectl"><a href="#对象管理使用kubectl" class="headerlink" title="对象管理使用kubectl"></a>对象管理使用kubectl</h3><h4 id="Kubernetes对象管理"><a href="#Kubernetes对象管理" class="headerlink" title="Kubernetes对象管理"></a>Kubernetes对象管理</h4><p>该<code>kubectl</code>命令行工具支持多种不同的方法来创建和管理Kubernetes对象。本文档概述了不同的方法。</p>
<ul>
<li>管理技巧</li>
<li>命令式命令</li>
<li>势在必行的对象配置</li>
<li>声明性对象配置</li>
</ul>
<h5 id="管理技巧"><a href="#管理技巧" class="headerlink" title="管理技巧"></a>管理技巧</h5><blockquote>
<p>警告：应仅使用一种技术管理Kubernetes对象。对同一对象的混合和匹配技术会导致未定义的行为。</p>
</blockquote>
<table>
<thead>
<tr>
<th>Management technique</th>
<th>操作</th>
<th>推荐环境</th>
<th>Supported writers</th>
<th>Learning curve</th>
</tr>
</thead>
<tbody>
<tr>
<td>Imperative commands</td>
<td>Live objects</td>
<td>Development projects</td>
<td>1+</td>
<td>Lowest</td>
</tr>
<tr>
<td>Imperative object configuration</td>
<td>Individual files</td>
<td>Production projects</td>
<td>1</td>
<td>Moderate</td>
</tr>
<tr>
<td>Declarative object configuration</td>
<td>Directories of files</td>
<td>Production projects</td>
<td>1+</td>
<td>Highest</td>
</tr>
</tbody>
</table>
<h5 id="命令式命令"><a href="#命令式命令" class="headerlink" title="命令式命令"></a>命令式命令</h5><p>使用命令性命令时，用户直接在群集中的活动对象上操作。用户将<code>kubectl</code>命令的操作作为参数或标志提供。</p>
<p>这是在集群中启动或运行一次性任务的最简单方法。由于此技术直接在活动对象上运行，因此它不提供先前配置的历史记录。</p>
<h6 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h6><p>通过创建Deployment对象来运行nginx容器的实例：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">run</span> nginx <span class="comment">--image nginx</span></span><br></pre></td></tr></table></figure></p>
<p>使用不同的语法执行相同的操作：<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">create</span> deployment nginx <span class="comment">--image nginx</span></span><br></pre></td></tr></table></figure></p>
<h6 id="权衡"><a href="#权衡" class="headerlink" title="权衡"></a>权衡</h6><p>与对象配置相比的优点：</p>
<ul>
<li>命令简单易学，易记。</li>
<li>命令只需要一个步骤即可对集群进行更改。</li>
</ul>
<p>与对象配置相比的缺点：</p>
<ul>
<li>命令不与更改审核过程集成。</li>
<li>命令不提供与更改关联的审计跟踪。</li>
<li>除了活动之外，命令不提供记录源。</li>
<li>命令不提供用于创建新对象的模板。</li>
</ul>
<h5 id="势在必行的对象配置"><a href="#势在必行的对象配置" class="headerlink" title="势在必行的对象配置"></a>势在必行的对象配置</h5><p>在命令式对象配置中，kubectl命令指定操作（创建，替换等），可选标志和至少一个文件名。指定的文件必须包含YAML或JSON格式的对象的完整定义。</p>
<p>有关 对象定义的更多详细信息，请参阅<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/" target="_blank" rel="noopener">API参考</a>。</p>
<blockquote>
<p>警告：<code>replace</code>命令式命令将现有规范替换为新提供的规范，删除对配置文件中缺少的对象的所有更改。此方法不应与其配置文件独立更新的资源类型一起使用。<code>LoadBalancer</code>例如，类型的服务使其<code>externalIPs</code>字段独立于群集的配置而更新。</p>
</blockquote>
<h6 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h6><p>创建配置文件中定义的对象：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kubectl</span> <span class="selector-tag">create</span> <span class="selector-tag">-f</span> <span class="selector-tag">nginx</span><span class="selector-class">.yaml</span></span><br></pre></td></tr></table></figure></p>
<p>删除两个配置文件中定义的对象：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kubectl</span> <span class="selector-tag">delete</span> <span class="selector-tag">-f</span> <span class="selector-tag">nginx</span><span class="selector-class">.yaml</span> <span class="selector-tag">-f</span> <span class="selector-tag">redis</span><span class="selector-class">.yaml</span></span><br></pre></td></tr></table></figure></p>
<p>通过覆盖实时配置来更新配置文件中定义的对象：<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">replace</span> -f nginx.yaml</span><br></pre></td></tr></table></figure></p>
<h6 id="权衡-1"><a href="#权衡-1" class="headerlink" title="权衡"></a>权衡</h6><p>与命令式命令相比的优点：</p>
<ul>
<li>对象配置可以存储在诸如Git的源控制系统中。</li>
<li>对象配置可以与进程集成，例如在推送和审计跟踪之前查看更改。</li>
<li>对象配置提供了用于创建新对象的模板。</li>
</ul>
<p>与命令式命令相比的缺点：</p>
<ul>
<li>对象配置需要对对象模式有基本的了解。</li>
<li>对象配置需要编写YAML文件的附加步骤。</li>
</ul>
<p>与声明对象配置相比的优点：</p>
<ul>
<li>命令式对象配置行为更简单，更易于理解。</li>
<li>从Kubernetes 1.5版开始，命令式对象配置更加成熟。</li>
</ul>
<p>与声明对象配置相比的缺点：</p>
<ul>
<li>命令对象配置最适合文件，而不是目录。</li>
<li>活动对象的更新必须反映在配置文件中，否则在下次更换时会丢失。</li>
</ul>
<h5 id="声明性对象配置"><a href="#声明性对象配置" class="headerlink" title="声明性对象配置"></a>声明性对象配置</h5><p>使用声明性对象配置时，用户对本地存储的对象配置文件进行操作，但是用户不定义要对文件执行的操作。每个对象自动检测创建，更新和删除操作<code>kubectl</code>。这使得能够处理目录，其中可能需要不同对象的不同操作。</p>
<blockquote>
<p>注意：声明性对象配置保留其他编写者所做的更改，即使更改未合并回对象配置文件也是如此。这可以通过使用<code>patch</code>API操作来仅写入观察到的差异，而不是使用<code>replace</code> API操作来替换整个对象配置。</p>
</blockquote>
<h6 id="例子-3"><a href="#例子-3" class="headerlink" title="例子"></a>例子</h6><p>处理目录中的所有对象配置文件<code>configs</code>，并创建或修补活动对象。您可以先<code>diff</code>查看要进行的更改，然后应用：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">diff</span> -f configs/</span><br><span class="line">kubectl <span class="built_in">apply</span> -f configs/</span><br></pre></td></tr></table></figure>
<p>递归处理目录：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">diff</span> -R -f configs/</span><br><span class="line">kubectl <span class="built_in">apply</span> -R -f configs/</span><br></pre></td></tr></table></figure></p>
<h6 id="权衡-2"><a href="#权衡-2" class="headerlink" title="权衡"></a>权衡</h6><p>与命令式对象配置相比的优点：</p>
<ul>
<li>即使它们未合并回配置文件，也会保留直接对活动对象所做的更改。</li>
<li>声明性对象配置更好地支持对目录进行操作并自动检测每个对象的操作类型（创建，修补，删除）。</li>
</ul>
<p>与命令式对象配置相比的缺点：</p>
<ul>
<li>声明性对象配置更难以调试，并在意外时理解结果。</li>
<li>使用diff的部分更新会创建复杂的合并和修补操作。</li>
</ul>
<h4 id="使用命令式命令管理Kubernetes对象"><a href="#使用命令式命令管理Kubernetes对象" class="headerlink" title="使用命令式命令管理Kubernetes对象"></a>使用命令式命令管理Kubernetes对象</h4><p>可以使用命令<code>kubectl</code>行工具中内置的命令性命令直接创建，更新和删除Kubernetes对象。本文档说明了如何组织这些命令以及如何使用它们来管理实时对象。</p>
<ul>
<li>权衡</li>
<li>如何创建对象</li>
<li>如何更新对象</li>
<li>如何删除对象</li>
<li>如何查看对象</li>
<li>使用set命令在创建之前修改对象</li>
<li>使用–edit修改之前创建的对象</li>
</ul>
<h5 id="权衡-3"><a href="#权衡-3" class="headerlink" title="权衡"></a>权衡</h5><p>该<code>kubectl</code>工具支持三种对象管理：</p>
<ul>
<li>命令式命令</li>
<li>势在必行的对象配置</li>
<li>声明性对象配置</li>
</ul>
<p>有关<a href="https://kubernetes.io/docs/concepts/overview/object-management-kubectl/overview/" target="_blank" rel="noopener">每种对象管理</a> 的优缺点的讨论，请参阅<a href="https://kubernetes.io/docs/concepts/overview/object-management-kubectl/overview/" target="_blank" rel="noopener">Kubernetes</a>对象管理。</p>
<h5 id="如何创建对象"><a href="#如何创建对象" class="headerlink" title="如何创建对象"></a>如何创建对象</h5><p>该<code>kubectl</code>工具支持动词驱动的命令，用于创建一些最常见的对象类型。这些命令被命名为不熟悉Kubernetes对象类型的用户可识别。</p>
<ul>
<li><code>run</code>：创建一个新的Deployment对象以在一个或多个Pod中运行Container。</li>
<li><code>expose</code>：创建一个新的服务对象，以跨Pod调整流量负载。</li>
<li><code>autoscale</code>：创建新的Autoscaler对象以自动水平扩展控制器，例如部署。</li>
</ul>
<p>该<code>kubectl</code>工具还支持由对象类型驱动的创建命令。这些命令支持更多对象类型，并且更明确地表达了它们的意图，但要求用户知道他们打算创建的对象的类型。</p>
<ul>
<li><code>create &lt;objecttype&gt; [&lt;subtype&gt;] &lt;instancename&gt;</code></li>
</ul>
<p>某些对象类型具有您可以在<code>create</code>命令中指定的子类型。例如，Service对象有几个子类型，包括ClusterIP，LoadBalancer和NodePort。这是一个使用子类型NodePort创建服务的示例：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create<span class="built_in"> service </span>nodeport &lt;myservicename&gt;</span><br></pre></td></tr></table></figure></p>
<p>在前面的示例中，该<code>create service nodeport</code>命令称为命令的子<code>create service</code>命令。</p>
<p>您可以使用该<code>-h</code>标志来查找子命令支持的参数和标志：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create<span class="built_in"> service </span>nodeport -h</span><br></pre></td></tr></table></figure></p>
<h5 id="如何更新对象"><a href="#如何更新对象" class="headerlink" title="如何更新对象"></a>如何更新对象</h5><p>该<code>kubectl</code>命令支持一些常见更新操作的动词驱动命令。命名这些命令是为了使不熟悉Kubernetes对象的用户能够在不知道必须设置的特定字段的情况下执行更新：</p>
<ul>
<li><code>scale</code>：通过更新控制器的副本计数，水平缩放控制器以添加或删除Pod。</li>
<li><code>annotate</code>：在对象中添加或删除注释。</li>
<li><code>label</code>：在对象中添加或删除标签。</li>
</ul>
<p>该<code>kubectl</code>命令还支持由对象的一个方面驱动的更新命令。设置此方面可以为不同的对象类型设置不同的字段：</p>
<ul>
<li>set ：设置对象的一个方面。</li>
</ul>
<blockquote>
<p>注意：在Kubernetes 1.5版中，并非每个动词驱动的命令都有一个关联的方面驱动命令。</p>
</blockquote>
<p>该<code>kubectl</code>工具支持这些直接更新实时对象的其他方法，但是它们需要更好地理解Kubernetes对象模式。</p>
<ul>
<li><code>edit</code>：通过在编辑器中打开其配置，直接编辑活动对象的原始配置。</li>
<li><code>patch</code>：使用补丁字符串直接修改活动对象的特定字段。有关修补程序字符串的更多详细信息，请参阅API约定中的修补程序部分 。</li>
</ul>
<h5 id="如何删除对象"><a href="#如何删除对象" class="headerlink" title="如何删除对象"></a>如何删除对象</h5><p>您可以使用该<code>delete</code>命令从群集中删除对象：</p>
<ul>
<li><code>delete &lt;type&gt;/&lt;name&gt;</code></li>
</ul>
<blockquote>
<p>注意：您可以使用<code>kubectl delete</code>命令式命令和命令式对象配置。不同之处在于传递给命令的参数。要 <code>kubectl delete</code>用作命令性命令，请将要删除的对象作为参数传递。这是一个传递名为nginx的Deployment对象的示例：</p>
</blockquote>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="keyword">delete</span> deployment/nginx</span><br></pre></td></tr></table></figure>
<h5 id="如何查看对象"><a href="#如何查看对象" class="headerlink" title="如何查看对象"></a>如何查看对象</h5><p>有几个命令用于打印有关对象的信息：</p>
<ul>
<li><code>get</code>：打印有关匹配对象的基本信息。使用<code>get -h</code>查看选项列表。</li>
<li><code>describe</code>：打印有关匹配对象的聚合详细信息。</li>
<li><code>logs</code>：为在Pod中运行的容器打印stdout和stderr。</li>
</ul>
<h5 id="使用set命令在创建之前修改对象"><a href="#使用set命令在创建之前修改对象" class="headerlink" title="使用set命令在创建之前修改对象"></a>使用set命令在创建之前修改对象</h5><p>有些对象字段没有可在<code>create</code>命令中使用的标志。在一些案件中，可以使用的组合 <code>set</code>并<code>create</code>指定对象创建前场的值。这是通过将<code>create</code>命令的输出传递给 <code>set</code>命令，然后返回到<code>create</code>命令来完成的。这是一个例子：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create service clusterip my-svc --clusterip=<span class="string">"None"</span> -o yaml --dry-<span class="keyword">run</span><span class="bash"> | kubectl <span class="built_in">set</span> selector --<span class="built_in">local</span> -f - <span class="string">'environment=qa'</span> -o yaml | kubectl create -f -</span></span><br></pre></td></tr></table></figure>
<ol>
<li>该<code>kubectl create service -o yaml --dry-run</code>命令为服务创建配置，但将其作为YAML打印到stdout，而不是将其发送到Kubernetes API服务器。</li>
<li>该<code>kubectl set selector --local -f - -o yaml</code>命令从stdin读取配置，并将更新的配置作为YAML写入stdout。</li>
<li>该<code>kubectl create -f -</code>命令使用stdin提供的配置创建对象。</li>
</ol>
<h5 id="使用–edit修改之前创建的对象"><a href="#使用–edit修改之前创建的对象" class="headerlink" title="使用–edit修改之前创建的对象"></a>使用–edit修改之前创建的对象</h5><p>您可以<code>kubectl create --edit</code>在创建对象之前对其进行任意更改。这是一个例子：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create<span class="built_in"> service </span>clusterip my-svc <span class="attribute">--clusterip</span>=<span class="string">"None"</span> -o yaml --dry-<span class="builtin-name">run</span> &gt; /tmp/srv.yaml</span><br><span class="line">kubectl create --<span class="builtin-name">edit</span> -f /tmp/srv.yaml</span><br></pre></td></tr></table></figure></p>
<p>该<code>kubectl create service</code>命令为服务创建配置并将其保存到<code>/tmp/srv.yaml</code>。<br>该<code>kubectl create --edit</code>命令在创建对象之前打开配置文件以进行编辑。</p>
<h4 id="使用配置文件管理Kubernetes对象"><a href="#使用配置文件管理Kubernetes对象" class="headerlink" title="使用配置文件管理Kubernetes对象"></a>使用配置文件管理Kubernetes对象</h4><p>可以使用<code>kubectl</code> 命令行工具以及使用YAML或JSON编写的对象配置文件来创建，更新和删除Kubernetes对象。本文档介绍了如何使用配置文件定义和管理对象。</p>
<ul>
<li>权衡</li>
<li>如何创建对象</li>
<li>如何更新对象</li>
<li>如何删除对象</li>
<li>如何查看对象</li>
<li>限制</li>
<li>在不保存配置的情况下从URL创建和编辑对象</li>
<li>从命令式命令迁移到命令式对象配置</li>
<li>定义控制器选择器和PodTemplate标签</li>
</ul>
<h5 id="权衡-4"><a href="#权衡-4" class="headerlink" title="权衡"></a>权衡</h5><p>该<code>kubectl</code>工具支持三种对象管理：</p>
<ul>
<li>命令式命令</li>
<li>势在必行的对象配置</li>
<li>声明性对象配置</li>
</ul>
<p>有关<a href="https://kubernetes.io/docs/concepts/overview/object-management-kubectl/overview/" target="_blank" rel="noopener">每种对象管理</a> 的优缺点的讨论，请参阅<a href="https://kubernetes.io/docs/concepts/overview/object-management-kubectl/overview/" target="_blank" rel="noopener">Kubernetes</a>对象管理。</p>
<h5 id="如何创建对象-1"><a href="#如何创建对象-1" class="headerlink" title="如何创建对象"></a>如何创建对象</h5><p>您可以使用<code>kubectl create -f</code>从配置文件创建对象。 有关详细信息，请参阅<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/" target="_blank" rel="noopener">kubernetes API参考</a>。</p>
<ul>
<li><code>kubectl create -f &lt;filename|url&gt;</code></li>
</ul>
<h5 id="如何更新对象-1"><a href="#如何更新对象-1" class="headerlink" title="如何更新对象"></a>如何更新对象</h5><blockquote>
<p>警告：使用该<code>replace</code>命令更新对象会删除配置文件中未指定的规范的所有部分。这不应该与规范部分由集群管理的对象一起使用，例如类型服务<code>LoadBalancer</code>，其中<code>externalIPs</code>字段独立于配置文件进行管理。必须将独立管理的字段复制到配置文件中以防止<code>replace</code>丢弃它们。</p>
</blockquote>
<p>您可以使用<code>kubectl replace -f</code>根据配置文件更新活动对象。</p>
<ul>
<li><code>kubectl replace -f &lt;filename|url&gt;</code></li>
</ul>
<h5 id="如何删除对象-1"><a href="#如何删除对象-1" class="headerlink" title="如何删除对象"></a>如何删除对象</h5><p>您可以使用<code>kubectl delete -f</code>删除配置文件中描述的对象。</p>
<ul>
<li><code>kubectl delete -f &lt;filename|url&gt;</code></li>
</ul>
<h5 id="如何查看对象-1"><a href="#如何查看对象-1" class="headerlink" title="如何查看对象"></a>如何查看对象</h5><p>您可以使用它<code>kubectl get -f</code>来查看有关配置文件中描述的对象的信息。</p>
<ul>
<li><code>kubectl get -f &lt;filename|url&gt; -o yaml</code></li>
</ul>
<p>该<code>-o yaml</code>标志指定打印完整对象配置。使用<code>kubectl get -h</code>查看选项列表。</p>
<h5 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h5><p><code>create</code>，<code>replace</code>和<code>delete</code>命令工作得很好，当每个对象的配置完全确定并记录在它的配置文件。但是，当更新活动对象并且更新未合并到其配置文件中时，更新将在下次<code>replace</code> 执行时丢失。如果控制器（例如HorizontalPodAutoscaler）直接对活动对象进行更新，则会发生这种情况。这是一个例子：</p>
<ol>
<li>您可以从配置文件创建对象。</li>
<li>另一个源通过更改某个字段来更新对象。</li>
<li>您从配置文件中替换该对象。步骤2中其他来源所做的更改将丢失。</li>
</ol>
<p>如果需要支持同一对象的多个编写器，则可以使用它<code>kubectl apply</code>来管理对象。</p>
<h5 id="在不保存配置的情况下从URL创建和编辑对象"><a href="#在不保存配置的情况下从URL创建和编辑对象" class="headerlink" title="在不保存配置的情况下从URL创建和编辑对象"></a>在不保存配置的情况下从URL创建和编辑对象</h5><p>假设您具有对象配置文件的URL。您可以 <code>kubectl create --edit</code>在创建对象之前用于更改配置。这对于指向可由读者修改的配置文件的教程和任务特别有用。</p>
<figure class="highlight plain"><figcaption><span>create -f <url> --edit```</url></span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### 从命令式命令迁移到命令式对象配置</span><br><span class="line">1. 从命令式命令迁移到命令式对象配置涉及几个手动步骤。</span><br><span class="line">将活动对象导出到本地对象配置文件：</span><br></pre></td></tr></table></figure>
<p>kubectl get <kind>/<name> -o yaml –export &gt; <kind>_<name>.yaml<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">2.</span> 从对象配置文件中手动删除状态字段。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 对于后续对象管理，请``replace``专门使用。</span><br></pre></td></tr></table></figure></name></kind></name></kind></p>
<p>kubectl replace -f <kind>_<name>.yaml<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### 定义控制器选择器和PodTemplate标签</span><br><span class="line"></span><br><span class="line">&gt; 警告：强烈建议不要更新控制器上的选择器。</span><br><span class="line"></span><br><span class="line">推荐的方法是定义一个仅由控制器选择器使用的单个不可变PodTemplate标签，没有其他语义含义。</span><br><span class="line"></span><br><span class="line">示例标签：</span><br></pre></td></tr></table></figure></name></kind></p>
<p>selector:<br>  matchLabels:<br>      controller-selector: “extensions/v1beta1/deployment/nginx”<br>template:<br>  metadata:<br>    labels:<br>      controller-selector: “extensions/v1beta1/deployment/nginx”<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">#### 使用配置文件声明管理Kubernetes对象</span></span><br><span class="line"></span><br><span class="line">可以通过在目录中存储多个对象配置文件并使用<span class="code">``kubectl apply`</span><span class="code">`根据需要递归创建和更新这些对象来创建，更新和删除Kubernetes对象。此方法保留对活动对象的写入，而不将更改合并回对象配置文件。`</span><span class="code">`kubectl diff`</span><span class="code">`还可以预览`</span><span class="code">`apply`</span>`将要进行的更改。</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>权衡</span><br><span class="line"><span class="bullet">- </span>在你开始之前</span><br><span class="line"><span class="bullet">- </span>如何创建对象</span><br><span class="line"><span class="bullet">- </span>如何更新对象</span><br><span class="line"><span class="bullet">- </span>如何删除对象</span><br><span class="line"><span class="bullet">- </span>如何查看对象</span><br><span class="line"><span class="bullet">- </span>如何应用计算差异并合并更改</span><br><span class="line"><span class="bullet">- </span>默认字段值</span><br><span class="line"><span class="bullet">- </span>如何更改配置文件和直接命令式编写器之间字段的所有权</span><br><span class="line"><span class="bullet">- </span>改变管理方法</span><br><span class="line"><span class="bullet">- </span>定义控制器选择器和PodTemplate标签</span><br><span class="line"></span><br><span class="line"><span class="section">##### 权衡</span></span><br><span class="line">该<span class="code">``kubectl`</span>`工具支持三种对象管理：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>命令式命令</span><br><span class="line"><span class="bullet">- </span>势在必行的对象配置</span><br><span class="line"><span class="bullet">- </span>声明性对象配置</span><br><span class="line"></span><br><span class="line">有关[<span class="string">每种对象管理</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/object-management-kubectl/overview/</span>) 的优缺点的讨论，请参阅[<span class="string">Kubernetes</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/object-management-kubectl/overview/</span>)对象管理。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 在你开始之前</span></span><br><span class="line">声明性对象配置需要牢固地理解Kubernetes对象定义和配置。如果您还没有阅读并填写以下文件：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>[<span class="string">使用命令式命令管理Kubernetes对象</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/object-management-kubectl/imperative-command/</span>)</span><br><span class="line"><span class="bullet">- </span>[<span class="string">使用配置文件管理Kubernetes对象</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/object-management-kubectl/imperative-config/</span>)</span><br><span class="line"></span><br><span class="line">以下是本文档中使用的术语的定义：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>对象配置文件/配置文件：定义Kubernetes对象配置的文件。本主题说明如何将配置文件传递给<span class="code">``kubectl apply`</span>`。配置文件通常存储在源代码管理中，例如Git。</span><br><span class="line"><span class="bullet">- </span>实时对象配置/实时配置：Kubernetes集群观察到的对象的实时配置值。这些保存在Kubernetes集群存储中，通常是etcd。</span><br><span class="line"><span class="bullet">- </span>声明性配置writer / declarative writer：对活动对象进行更新的人员或软件组件。本主题中提到的实时编写器会更改对象配置文件并运行<span class="code">``kubectl apply`</span>`以编写更改。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 如何创建对象</span></span><br><span class="line">使用<span class="code">``kubectl apply`</span>`创建的所有对象，除了那些已经存在，通过配置文件在指定的目录中定义：</span><br></pre></td></tr></table></figure></p>
<p>kubectl apply -f <directory>/<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这将``kubectl.kubernetes.io/last-applied-configuration: '<span class="meta">&#123;...&#125;</span>' ``在每个对象上设置注释。注释包含用于创建对象的对象配置文件的内容。</span><br><span class="line"></span><br><span class="line">&gt; 注意：添加-R标志以递归处理目录。</span><br><span class="line"></span><br><span class="line">以下是对象配置文件的示例：</span><br></pre></td></tr></table></figure></directory></p>
<p>#application/simple_deployment.yaml<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nginx-deployment<br>spec:<br>  selector:<br>    matchLabels:<br>      app: nginx<br>  minReadySeconds: 5<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx:1.7.9
  ports:
  - containerPort: 80
</code></pre><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">运行``kubectl diff``以打印将要创建的对象：</span><br></pre></td></tr></table></figure>
<p>kubectl diff -f <a href="https://k8s.io/examples/application/simple_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/simple_deployment.yaml</a><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 注意：`` diff``使用服务器端干运行，需要启用``kube-apiserver``。</span><br><span class="line"></span><br><span class="line">使用``kubectl apply``以下方法创建对象</span><br></pre></td></tr></table></figure></p>
<p>kubectl apply -f <a href="https://k8s.io/examples/application/simple_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/simple_deployment.yaml</a><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用``kubectl get``以下方式打印实时配置</span><br></pre></td></tr></table></figure></p>
<p>kubectl get -f <a href="https://k8s.io/examples/application/simple_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/simple_deployment.yaml</a> -o yaml<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输出显示``kubectl.kubernetes.io/last-applied-configuration``注释已写入实时配置，并且与配置文件匹配：</span><br></pre></td></tr></table></figure></p>
<p>kind: Deployment<br>metadata:<br>  annotations:</p>
<pre><code># ...
# This is the json representation of simple_deployment.yaml
# It was written by kubectl apply when the object was created
kubectl.kubernetes.io/last-applied-configuration: |
  {&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,
  &quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;default&quot;},
  &quot;spec&quot;:{&quot;minReadySeconds&quot;:5,&quot;selector&quot;:{&quot;matchLabels&quot;:{&quot;app&quot;:nginx}},&quot;template&quot;:{&quot;metadata&quot;:{&quot;labels&quot;:{&quot;app&quot;:&quot;nginx&quot;}},
  &quot;spec&quot;:{&quot;containers&quot;:[{&quot;image&quot;:&quot;nginx:1.7.9&quot;,&quot;name&quot;:&quot;nginx&quot;,
  &quot;ports&quot;:[{&quot;containerPort&quot;:80}]}]}}}}
</code></pre><h1 id="…"><a href="#…" class="headerlink" title="…"></a>…</h1><p>spec:</p>
<h1 id="…-1"><a href="#…-1" class="headerlink" title="…"></a>…</h1><p>  minReadySeconds: 5<br>  selector:<br>    matchLabels:</p>
<pre><code># ...
app: nginx
</code></pre><p>  template:<br>    metadata:</p>
<pre><code>  # ...
  labels:
    app: nginx
spec:
  containers:
  - image: nginx:1.7.9
    # ...
    name: nginx
    ports:
    - containerPort: 80
    # ...
  # ...
# ...
</code></pre><h1 id="…-2"><a href="#…-2" class="headerlink" title="…"></a>…</h1><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### 如何更新对象</span><br><span class="line">您还可以使用``kubectl apply``更新目录中定义的所有对象，即使这些对象已存在。此方法可实现以下目标：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 设置实时配置中配置文件中显示的字段。</span><br><span class="line"><span class="number">2.</span> 清除实时配置中从配置文件中删除的字段。</span><br></pre></td></tr></table></figure>
<p>kubectl diff -f <directory>/<br>kubectl apply -f <directory>/<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 注意：添加-R标志以递归处理目录。</span></span><br><span class="line"></span><br><span class="line">这是一个示例配置文件：</span><br></pre></td></tr></table></figure></directory></directory></p>
<p>#application/simple_deployment.yaml<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nginx-deployment<br>spec:<br>  selector:<br>    matchLabels:<br>      app: nginx<br>  minReadySeconds: 5<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx:1.7.9
  ports:
  - containerPort: 80
</code></pre><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">使用``kubectl apply``以下方法创建对象</span><br></pre></td></tr></table></figure>
<p>kubectl apply -f <a href="https://k8s.io/examples/application/simple_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/simple_deployment.yaml</a><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 注意：出于说明的目的，上述命令引用单个配置文件而不是目录。</span><br><span class="line"></span><br><span class="line">使用``kubectl get``以下方式打印实时配置</span><br></pre></td></tr></table></figure></p>
<p>kubectl get -f <a href="https://k8s.io/examples/application/simple_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/simple_deployment.yaml</a> -o yaml<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输出显示``kubectl.kubernetes.io/last-applied-configuration``注释已写入实时配置，并且与配置文件匹配：</span><br></pre></td></tr></table></figure></p>
<p>kind: Deployment<br>metadata:<br>  annotations:</p>
<pre><code># ...
# This is the json representation of simple_deployment.yaml
# It was written by kubectl apply when the object was created
kubectl.kubernetes.io/last-applied-configuration: |
  {&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,
  &quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;default&quot;},
  &quot;spec&quot;:{&quot;minReadySeconds&quot;:5,&quot;selector&quot;:{&quot;matchLabels&quot;:{&quot;app&quot;:nginx}},&quot;template&quot;:{&quot;metadata&quot;:{&quot;labels&quot;:{&quot;app&quot;:&quot;nginx&quot;}},
  &quot;spec&quot;:{&quot;containers&quot;:[{&quot;image&quot;:&quot;nginx:1.7.9&quot;,&quot;name&quot;:&quot;nginx&quot;,
  &quot;ports&quot;:[{&quot;containerPort&quot;:80}]}]}}}}
</code></pre><h1 id="…-3"><a href="#…-3" class="headerlink" title="…"></a>…</h1><p>spec:</p>
<h1 id="…-4"><a href="#…-4" class="headerlink" title="…"></a>…</h1><p>  minReadySeconds: 5<br>  selector:<br>    matchLabels:</p>
<pre><code># ...
app: nginx
</code></pre><p>  template:<br>    metadata:</p>
<pre><code>  # ...
  labels:
    app: nginx
spec:
  containers:
  - image: nginx:1.7.9
    # ...
    name: nginx
    ports:
    - containerPort: 80
    # ...
  # ...
# ...
</code></pre><h1 id="…-5"><a href="#…-5" class="headerlink" title="…"></a>…</h1><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用，直接更新``replicas``实时配置中的字段``kubectl scale``。这不使用``kubectl apply``：</span><br></pre></td></tr></table></figure>
<p>kubectl scale deployment/nginx-deployment –replicas=2<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用``kubectl get``以下方式打印实时配置</span><br></pre></td></tr></table></figure></p>
<p>kubectl get -f <a href="https://k8s.io/examples/application/simple_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/simple_deployment.yaml</a> -o yaml<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输出显示该``replicas``字段已设置为<span class="number">2</span>，并且``last-applied-configuration ``注释不包含``replicas``字段：</span><br></pre></td></tr></table></figure></p>
<p>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  annotations:</p>
<pre><code># ...
# note that the annotation does not contain replicas
# because it was not updated through apply
kubectl.kubernetes.io/last-applied-configuration: |
  {&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,
  &quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;default&quot;},
  &quot;spec&quot;:{&quot;minReadySeconds&quot;:5,&quot;selector&quot;:{&quot;matchLabels&quot;:{&quot;app&quot;:nginx}},&quot;template&quot;:{&quot;metadata&quot;:{&quot;labels&quot;:{&quot;app&quot;:&quot;nginx&quot;}},
  &quot;spec&quot;:{&quot;containers&quot;:[{&quot;image&quot;:&quot;nginx:1.7.9&quot;,&quot;name&quot;:&quot;nginx&quot;,
  &quot;ports&quot;:[{&quot;containerPort&quot;:80}]}]}}}}
</code></pre><h1 id="…-6"><a href="#…-6" class="headerlink" title="…"></a>…</h1><p>spec:<br>  replicas: 2 # written by scale</p>
<h1 id="…-7"><a href="#…-7" class="headerlink" title="…"></a>…</h1><p>  minReadySeconds: 5<br>  selector:<br>    matchLabels:</p>
<pre><code># ...
app: nginx
</code></pre><p>  template:<br>    metadata:</p>
<pre><code>  # ...
  labels:
    app: nginx
spec:
  containers:
  - image: nginx:1.7.9
    # ...
    name: nginx
    ports:
    - containerPort: 80
  # ...
</code></pre><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">更新``simple_deployment.yaml``配置文件以将映像更改 ``nginx:<span class="number">1.7</span><span class="number">.9</span>``为``nginx:<span class="number">1.11</span><span class="number">.9</span>``，并删除该``minReadySeconds``字段：</span><br></pre></td></tr></table></figure>
<p>#application/update_deployment.yaml<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nginx-deployment<br>spec:<br>  selector:<br>    matchLabels:<br>      app: nginx<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx:1.11.9 # update the image
  ports:
  - containerPort: 80
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">应用对配置文件所做的更改：</span><br></pre></td></tr></table></figure>
<p>kubectl diff -f <a href="https://k8s.io/examples/application/update_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/update_deployment.yaml</a><br>kubectl apply -f <a href="https://k8s.io/examples/application/update_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/update_deployment.yaml</a><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用``kubectl get``以下方式打印实时配置</span><br></pre></td></tr></table></figure></p>
<p>kubectl get -f <a href="https://k8s.io/examples/application/simple_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/simple_deployment.yaml</a> -o yaml<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">输出显示实时配置的以下更改：</span><br><span class="line"></span><br><span class="line">该``replicas``字段保留<span class="number">2</span>的值``kubectl scale``。这是可能的，因为它从配置文件中省略。</span><br><span class="line">该``image``场已被更新，以``nginx:<span class="number">1.11</span><span class="number">.9</span>``从``nginx:<span class="number">1.7</span><span class="number">.9</span>``。</span><br><span class="line">该``last-applied-configuration``批注已经更新了新的形象。</span><br><span class="line">该``minReadySeconds``领域已被清除。</span><br><span class="line">该``last-applied-configuration``注释不再包含``minReadySeconds``字段。</span><br></pre></td></tr></table></figure></p>
<p>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  annotations:</p>
<pre><code># ...
# The annotation contains the updated image to nginx 1.11.9,
# but does not contain the updated replicas to 2
kubectl.kubernetes.io/last-applied-configuration: |
  {&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,
  &quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;default&quot;},
  &quot;spec&quot;:{&quot;selector&quot;:{&quot;matchLabels&quot;:{&quot;app&quot;:nginx}},&quot;template&quot;:{&quot;metadata&quot;:{&quot;labels&quot;:{&quot;app&quot;:&quot;nginx&quot;}},
  &quot;spec&quot;:{&quot;containers&quot;:[{&quot;image&quot;:&quot;nginx:1.11.9&quot;,&quot;name&quot;:&quot;nginx&quot;,
  &quot;ports&quot;:[{&quot;containerPort&quot;:80}]}]}}}}
# ...
</code></pre><p>spec:<br>  replicas: 2 # Set by <code>kubectl scale</code>.  Ignored by <code>kubectl apply</code>.</p>
<h1 id="minReadySeconds-cleared-by-kubectl-apply"><a href="#minReadySeconds-cleared-by-kubectl-apply" class="headerlink" title="minReadySeconds cleared by kubectl apply"></a>minReadySeconds cleared by <code>kubectl apply</code></h1><h1 id="…-8"><a href="#…-8" class="headerlink" title="…"></a>…</h1><p>  selector:<br>    matchLabels:</p>
<pre><code># ...
app: nginx
</code></pre><p>  template:<br>    metadata:</p>
<pre><code>  # ...
  labels:
    app: nginx
spec:
  containers:
  - image: nginx:1.11.9 # Set by `kubectl apply`
    # ...
    name: nginx
    ports:
    - containerPort: 80
    # ...
  # ...
# ...
</code></pre><h1 id="…-9"><a href="#…-9" class="headerlink" title="…"></a>…</h1><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 警告：混合``kubectl apply``与势在必行对象配置命令 ``create``和``replace``不支持。这是因为``create`` 并``replace``没有保留``kubectl.kubernetes.io/last-applied-configuration`` 的是``kubectl apply``用来计算更新。</span><br><span class="line"></span><br><span class="line">##### 如何删除对象</span><br><span class="line">删除管理对象有两种方法``kubectl apply``。</span><br><span class="line"></span><br><span class="line">###### 推荐的： ``kubectl delete -f &lt;filename&gt;``</span><br><span class="line"></span><br><span class="line">建议的方法是使用命令式命令手动删除对象，因为它更明确地删除了什么，并且不太可能导致用户无意中删除了某些内容</span><br></pre></td></tr></table></figure>
<p>kubectl delete -f <filename><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">###### 替代方案： ``kubectl apply -f &lt;directory/&gt; --prune -l your=label``</span><br><span class="line"></span><br><span class="line">只有在你知道自己在做什么的情况下才能使用它。</span><br><span class="line"></span><br><span class="line">&gt; 警告： ``kubectl apply --prune``处于alpha状态，后续版本中可能会引入向后不兼容的更改。</span><br><span class="line"></span><br><span class="line">&gt; 警告：使用此命令时必须小心，以免意外删除对象。</span><br><span class="line"></span><br><span class="line">作为替代方法``kubectl delete``，您可以使用它``kubectl apply``来识别从目录中删除配置文件后要删除的对象。``--prune`` 对API服务器应用查询以匹配一组标签的所有对象，并尝试将返回的活动对象配置与对象配置文件进行匹配。如果对象与查询匹配，并且目录中没有配置文件，并且它具有``last-applied-configuration``注释，则会将其删除。</span><br></pre></td></tr></table></figure></filename></p>
<p>kubectl apply -f <directory> –prune -l <labels><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 警告：只应对包含对象配置文件的根目录运行prune。如果对象被指定的标签选择器查询返回-l &lt;labels&gt;并且未出现在子目录中，则对子目录运行会导致无意中删除对象。</span><br><span class="line"></span><br><span class="line">##### 如何查看对象</span><br><span class="line">您可以使用``kubectl getwith -o yaml``来查看活动对象的配置：</span><br></pre></td></tr></table></figure></labels></directory></p>
<p>kubectl get -f &lt;filename|url&gt; -o yaml<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### 如何应用计算差异并合并更改</span><br><span class="line"></span><br><span class="line">&gt; 注意：补丁是一种更新操作，其范围限定为对象的特定字段而不是整个对象。这样可以仅更新对象上的特定字段集，而无需先读取对象。</span><br><span class="line"></span><br><span class="line">当``kubectl apply``一个对象更新实时配置，它通过发送补丁请求API服务器这样做。该补丁定义了作用于活动对象配置的特定字段的更新。该``kubectl apply``命令使用配置文件，实时配置和实时配置中``last-applied-configuration``存储的注释来计算此修补程序请求 。</span><br><span class="line"></span><br><span class="line">###### 合并补丁计算</span><br><span class="line">该``kubectl apply``命令将配置文件的内容写入 ``kubectl.kubernetes.io/last-applied-configuration``注释。这用于标识已从配置文件中删除的字段，需要从实时配置中清除。以下是用于计算应删除或设置哪些字段的步骤：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 计算要删除的字段。这些是``last-applied-configuration``配置文件中存在和丢失的字段。</span><br><span class="line"><span class="number">2.</span> 计算要添加或设置的字段。这些是配置文件中存在的字段，其值与实时配置不匹配。</span><br><span class="line"></span><br><span class="line">这是一个例子。假设这是Deployment对象的配置文件：</span><br></pre></td></tr></table></figure></p>
<p>#application/update_deployment.yaml<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nginx-deployment<br>spec:<br>  selector:<br>    matchLabels:<br>      app: nginx<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx:1.11.9 # update the image
  ports:
  - containerPort: 80
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">另外，假设这是同一Deployment对象的实时配置：</span><br></pre></td></tr></table></figure>
<p>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  annotations:</p>
<pre><code># ...
# note that the annotation does not contain replicas
# because it was not updated through apply
kubectl.kubernetes.io/last-applied-configuration: |
  {&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,
  &quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;default&quot;},
  &quot;spec&quot;:{&quot;minReadySeconds&quot;:5,&quot;selector&quot;:{&quot;matchLabels&quot;:{&quot;app&quot;:nginx}},&quot;template&quot;:{&quot;metadata&quot;:{&quot;labels&quot;:{&quot;app&quot;:&quot;nginx&quot;}},
  &quot;spec&quot;:{&quot;containers&quot;:[{&quot;image&quot;:&quot;nginx:1.7.9&quot;,&quot;name&quot;:&quot;nginx&quot;,
  &quot;ports&quot;:[{&quot;containerPort&quot;:80}]}]}}}}
</code></pre><h1 id="…-10"><a href="#…-10" class="headerlink" title="…"></a>…</h1><p>spec:<br>  replicas: 2 # written by scale</p>
<h1 id="…-11"><a href="#…-11" class="headerlink" title="…"></a>…</h1><p>  minReadySeconds: 5<br>  selector:<br>    matchLabels:</p>
<pre><code># ...
app: nginx
</code></pre><p>  template:<br>    metadata:</p>
<pre><code>  # ...
  labels:
    app: nginx
spec:
  containers:
  - image: nginx:1.7.9
    # ...
    name: nginx
    ports:
    - containerPort: 80
  # ...
</code></pre><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">以下是将通过以下方式执行的合并计算``kubectl apply``：</span><br><span class="line"><span class="number">1.</span> 通过读取值``last-applied-configuration``并将它们与配置文件中的值进行比较来计算要删除的字段 。清除字段在本地对象配置文件中显式设置为null，无论它们是否出现在``last-applied-configuration``。在此示例中，``minReadySeconds``出现在 ``last-applied-configuration``注释中，但未出现在配置文件中。 **Action**：`minReadySeconds``从实时配置中清除。</span><br><span class="line"><span class="number">2.</span> 通过从配置文件中读取值并将它们与实时配置中的值进行比较来计算要设置的字段。在此示例中，``image``配置文件中的值与实时配置中的值不匹配。**Action**：设置image实时配置中的值。</span><br><span class="line"><span class="number">3.</span> 设置``last-applied-configuration``注释以匹配配置文件的值。</span><br><span class="line"><span class="number">4.</span> 将来自<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>的结果合并到API服务器的单个补丁请求中。</span><br><span class="line"></span><br><span class="line">以下是合并的实时配置：</span><br></pre></td></tr></table></figure>
<p>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  annotations:</p>
<pre><code># ...
# The annotation contains the updated image to nginx 1.11.9,
# but does not contain the updated replicas to 2
kubectl.kubernetes.io/last-applied-configuration: |
  {&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,
  &quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;default&quot;},
  &quot;spec&quot;:{&quot;selector&quot;:{&quot;matchLabels&quot;:{&quot;app&quot;:nginx}},&quot;template&quot;:{&quot;metadata&quot;:{&quot;labels&quot;:{&quot;app&quot;:&quot;nginx&quot;}},
  &quot;spec&quot;:{&quot;containers&quot;:[{&quot;image&quot;:&quot;nginx:1.11.9&quot;,&quot;name&quot;:&quot;nginx&quot;,
  &quot;ports&quot;:[{&quot;containerPort&quot;:80}]}]}}}}
# ...
</code></pre><p>spec:<br>  selector:<br>    matchLabels:</p>
<pre><code># ...
app: nginx
</code></pre><p>  replicas: 2 # Set by <code>kubectl scale</code>.  Ignored by <code>kubectl apply</code>.</p>
<h1 id="minReadySeconds-cleared-by-kubectl-apply-1"><a href="#minReadySeconds-cleared-by-kubectl-apply-1" class="headerlink" title="minReadySeconds cleared by kubectl apply"></a>minReadySeconds cleared by <code>kubectl apply</code></h1><h1 id="…-12"><a href="#…-12" class="headerlink" title="…"></a>…</h1><p>  template:<br>    metadata:</p>
<pre><code>  # ...
  labels:
    app: nginx
spec:
  containers:
  - image: nginx:1.11.9 # Set by `kubectl apply`
    # ...
    name: nginx
    ports:
    - containerPort: 80
    # ...
  # ...
# ...
</code></pre><h1 id="…-13"><a href="#…-13" class="headerlink" title="…"></a>…</h1><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">###### 如何合并不同类型的字段</span><br><span class="line"></span><br><span class="line">配置文件中的特定字段如何与实时配置合并取决于字段的类型。有几种类型的字段：</span><br><span class="line"></span><br><span class="line">- primitive：字符串，整数或布尔类型的字段。例如，``image``和``replicas``是原始字段。行动：替换。</span><br><span class="line">- map，也称为object：类型为map的字段或包含子字段的复杂类型。例如``labels``， ``annotations``，``spec``并且``metadata``是所有map。**Action**：合并元素或子字段。</span><br><span class="line">- list：包含可以是基本类型或映射的项列表的字段。例如``containers``，``ports``和``args``是列表。行动：变化。</span><br><span class="line"></span><br><span class="line">当``kubectl apply``更新map或列表字段，它通常不更换整个领域，而是更新各个子元素。例如，在合并``spec``部署时，``spec``不会替换整个部署。相反，比较和合并``spec``诸如的子字段``replicas``。</span><br><span class="line"></span><br><span class="line">###### 将更改合并到基本字段</span><br><span class="line">将更改合并到基本字段</span><br><span class="line"></span><br><span class="line">&gt; 注意： -用于“不适用”，因为未使用该值。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">对象配置文件中的字段 | 实时对象配置中的字段 | 最后应用配置中的字段 | 行动</span><br><span class="line">---|---|---|---|</span><br><span class="line">是 | 是 | - | 设置为配置文件值。</span><br><span class="line">是 | 没有 | - | 将实时设置为本地配置。</span><br><span class="line">没有 | - | - | 从实时配置中清除。</span><br><span class="line">没有 | - | 没有 | 没做什么。保持实时价值。</span><br><span class="line"></span><br><span class="line">###### 合并对地图字段的更改</span><br><span class="line">通过比较地图的每个子字段或元素来合并表示地图的字段：</span><br><span class="line"></span><br><span class="line">&gt; 注意： -用于“不适用”，因为未使用该值。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">键入对象配置文件 | 键入实时对象配置 | 最后应用配置中的字段 | 行动</span><br><span class="line">---|---</span><br><span class="line">是 | 是 | - | 比较子字段值。</span><br><span class="line">是 | 没有 | - | 将实时设置为本地配置。</span><br><span class="line">没有 | - | 是 | 从实时配置中删除。</span><br><span class="line">没有 | - | 没有 | 没做什么。保持实时价值。</span><br><span class="line"></span><br><span class="line">###### 合并类型列表字段的更改</span><br><span class="line">将更改合并到列表使用以下三种策略之一：</span><br><span class="line"></span><br><span class="line">- 替换列表。</span><br><span class="line">- 合并复杂元素列表中的各个元素。</span><br><span class="line">- 合并原始元素列表。</span><br><span class="line"></span><br><span class="line">战略的选择是基于每个领域。</span><br><span class="line"></span><br><span class="line">##### 替换列表</span><br><span class="line">将列表视为与原始字段相同。替换或删除整个列表。这保留了订购。</span><br><span class="line"></span><br><span class="line">**例如**：使用``kubectl apply``更新``args``一个pod里的一个Container的field。这会将``args``实时配置中的值设置为配置文件中的值。``args``之前已添加到实时配置的任何元素都将丢失。``args``配置文件中定义的元素的顺序将保留在实时配置中。</span><br></pre></td></tr></table></figure>
<h1 id="last-applied-configuration-value"><a href="#last-applied-configuration-value" class="headerlink" title="last-applied-configuration value"></a>last-applied-configuration value</h1><pre><code>args: [&quot;a&quot;, &quot;b&quot;]
</code></pre><h1 id="configuration-file-value"><a href="#configuration-file-value" class="headerlink" title="configuration file value"></a>configuration file value</h1><pre><code>args: [&quot;a&quot;, &quot;c&quot;]
</code></pre><h1 id="live-configuration"><a href="#live-configuration" class="headerlink" title="live configuration"></a>live configuration</h1><pre><code>args: [&quot;a&quot;, &quot;b&quot;, &quot;d&quot;]
</code></pre><h1 id="result-after-merge"><a href="#result-after-merge" class="headerlink" title="result after merge"></a>result after merge</h1><pre><code>args: [&quot;a&quot;, &quot;c&quot;]
</code></pre><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">**说明**：合并使用配置文件值作为新列表值。</span><br><span class="line"></span><br><span class="line">##### 合并复杂元素列表中的各个元素：</span><br><span class="line">将列表视为映射，并将每个元素的特定字段视为键。添加，删除或更新单个元素。这不会保留排序。</span><br><span class="line"></span><br><span class="line">此合并策略在每个字段上使用一个名为a的特殊标记``patchMergeKey``。``patchMergeKey``是在Kubernetes源代码中的每个字段中定义： [types.go](https:<span class="comment">//github.com/kubernetes/api/blob/d04500c8c3dda9c980b668c57abc2ca61efcf5c4/core/v1/types.go#L2747) 当合并映射的列表，指定的字段作为``patchMergeKey``对于给定的元素被用于像该元素的映射键。</span></span><br><span class="line"></span><br><span class="line">**例如**：使用``kubectl apply``更新``containers一PodSpec``的field。这将列表合并为好像是每个元素都被键入的映射``name``。</span><br></pre></td></tr></table></figure>
<h1 id="last-applied-configuration-value-1"><a href="#last-applied-configuration-value-1" class="headerlink" title="last-applied-configuration value"></a>last-applied-configuration value</h1><pre><code>containers:
- name: nginx
  image: nginx:1.10
- name: nginx-helper-a # key: nginx-helper-a; will be deleted in result
  image: helper:1.3
- name: nginx-helper-b # key: nginx-helper-b; will be retained
  image: helper:1.3
</code></pre><h1 id="configuration-file-value-1"><a href="#configuration-file-value-1" class="headerlink" title="configuration file value"></a>configuration file value</h1><pre><code>containers:
- name: nginx
  image: nginx:1.10
- name: nginx-helper-b
  image: helper:1.3
- name: nginx-helper-c # key: nginx-helper-c; will be added in result
  image: helper:1.3
</code></pre><h1 id="live-configuration-1"><a href="#live-configuration-1" class="headerlink" title="live configuration"></a>live configuration</h1><pre><code>containers:
- name: nginx
  image: nginx:1.10
- name: nginx-helper-a
  image: helper:1.3
- name: nginx-helper-b
  image: helper:1.3
  args: [&quot;run&quot;] # Field will be retained
- name: nginx-helper-d # key: nginx-helper-d; will be retained
  image: helper:1.3
</code></pre><h1 id="result-after-merge-1"><a href="#result-after-merge-1" class="headerlink" title="result after merge"></a>result after merge</h1><pre><code>containers:
- name: nginx
  image: nginx:1.10
  # Element nginx-helper-a was deleted
- name: nginx-helper-b
  image: helper:1.3
  args: [&quot;run&quot;] # Field was retained
- name: nginx-helper-c # Element was added
  image: helper:1.3
- name: nginx-helper-d # Element was ignored
  image: helper:1.3
</code></pre><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line"></span><br><span class="line">- 名为“nginx-helper-a”的容器已删除，因为配置文件中没有出现名为“nginx-helper-a”的容器。</span><br><span class="line">- 名为“nginx-helper-b”的容器保留``args`` 了实时配置中的更改。``kubectl apply``能够识别实时配置中的“nginx-helper-b”与配置文件中的“nginx-helper-b”相同，即使它们的字段具有不同的值（``args``配置文件中没有）。这是因为``patchMergeKey``字段值（名称）在两者中都是相同的。</span><br><span class="line">- 添加了名为“nginx-helper-c”的容器，因为实时配置中没有出现具有该名称的容器，但配置文件中出现了具有该名称的容器。</span><br><span class="line">- 保留名为“nginx-helper-d”的容器，因为在最后应用的配置中没有出现具有该名称的元素。</span><br><span class="line"></span><br><span class="line">##### 合并原始元素列表</span><br><span class="line">从Kubernetes <span class="number">1.5</span>开始，不支持合并原始元素列表。</span><br><span class="line"></span><br><span class="line">&gt; 注意：为给定字段选择的上述策略中的哪一个由[types.go](https:<span class="comment">//github.com/kubernetes/api/blob/d04500c8c3dda9c980b668c57abc2ca61efcf5c4/core/v1/types.go#L2748)中的``patchStrategy``标记控制。如果没有为类型列表的字段指``定patchStrategy``，则替换列表。</span></span><br><span class="line"></span><br><span class="line">##### 默认字段值</span><br><span class="line">如果在创建对象时未指定某些字段，则API服务器会将某些字段设置为实时配置中的默认值。</span><br><span class="line"></span><br><span class="line">这是部署的配置文件。该文件未指定``strategy``：</span><br></pre></td></tr></table></figure>
<p>#application/simple_deployment.yaml<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nginx-deployment<br>spec:<br>  selector:<br>    matchLabels:<br>      app: nginx<br>  minReadySeconds: 5<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx:1.7.9
  ports:
  - containerPort: 80
</code></pre><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用``kubectl apply``以下方法创建对象</span><br></pre></td></tr></table></figure>
<p>kubectl apply -f <a href="https://k8s.io/examples/application/simple_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/simple_deployment.yaml</a><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用``kubectl get``以下方式打印实时配置</span><br></pre></td></tr></table></figure></p>
<p>kubectl get -f <a href="https://k8s.io/examples/application/simple_deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/application/simple_deployment.yaml</a> -o yaml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输出显示API服务器在实时配置中将多个字段设置为默认值。配置文件中未指定这些字段。</span><br></pre></td></tr></table></figure></p>
<p>apiVersion: apps/v1<br>kind: Deployment</p>
<h1 id="…-14"><a href="#…-14" class="headerlink" title="…"></a>…</h1><p>spec:<br>  selector:<br>    matchLabels:<br>      app: nginx<br>  minReadySeconds: 5<br>  replicas: 1 # defaulted by apiserver<br>  strategy:<br>    rollingUpdate: # defaulted by apiserver - derived from strategy.type<br>      maxSurge: 1<br>      maxUnavailable: 1<br>    type: RollingUpdate # defaulted apiserver<br>  template:<br>    metadata:<br>      creationTimestamp: null<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- image: nginx:1.7.9
  imagePullPolicy: IfNotPresent # defaulted by apiserver
  name: nginx
  ports:
  - containerPort: 80
    protocol: TCP # defaulted by apiserver
  resources: {} # defaulted by apiserver
  terminationMessagePath: /dev/termination-log # defaulted by apiserver
dnsPolicy: ClusterFirst # defaulted by apiserver
restartPolicy: Always # defaulted by apiserver
securityContext: {} # defaulted by apiserver
terminationGracePeriodSeconds: 30 # defaulted by apiserver
</code></pre><h1 id="…-15"><a href="#…-15" class="headerlink" title="…"></a>…</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在修补程序请求中，默认字段不会被重新默认，除非它们作为修补程序请求的一部分被明确清除。这可能会导致基于其他字段的值默认的字段出现意外行为。稍后更改其他字段时，除非明确清除，否则不会更新默认值。</span><br><span class="line"></span><br><span class="line">因此，建议在配置文件中显式定义服务器默认的某些字段，即使所需的值与服务器默认值匹配也是如此。这样可以更轻松地识别不会被服务器重新默认的冲突值。</span><br><span class="line"></span><br><span class="line">例：</span><br></pre></td></tr></table></figure>
<h1 id="last-applied-configuration"><a href="#last-applied-configuration" class="headerlink" title="last-applied-configuration"></a>last-applied-configuration</h1><p>spec:<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx:1.7.9
  ports:
  - containerPort: 80
</code></pre><h1 id="configuration-file"><a href="#configuration-file" class="headerlink" title="configuration file"></a>configuration file</h1><p>spec:<br>  strategy:<br>    type: Recreate # updated value<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx:1.7.9
  ports:
  - containerPort: 80
</code></pre><h1 id="live-configuration-2"><a href="#live-configuration-2" class="headerlink" title="live configuration"></a>live configuration</h1><p>spec:<br>  strategy:<br>    type: RollingUpdate # defaulted value<br>    rollingUpdate: # defaulted value derived from type<br>      maxSurge : 1<br>      maxUnavailable: 1<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx:1.7.9
  ports:
  - containerPort: 80
</code></pre><h1 id="result-after-merge-ERROR"><a href="#result-after-merge-ERROR" class="headerlink" title="result after merge - ERROR!"></a>result after merge - ERROR!</h1><p>spec:<br>  strategy:<br>    type: Recreate # updated value: incompatible with rollingUpdate<br>    rollingUpdate: # defaulted value: incompatible with “type: Recreate”<br>      maxSurge : 1<br>      maxUnavailable: 1<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx:1.7.9
  ports:
  - containerPort: 80
</code></pre><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">说明：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 用户无需定义即可创建部署``strategy.type``。</span><br><span class="line"><span class="number">2.</span> 服务器默认``strategy.type``为``RollingUpdate``默认 ``strategy.rollingUpdate``值。</span><br><span class="line"><span class="number">3.</span> 用户更改``strategy.type``为``Recreate``。该``strategy.rollingUpdate ``值保持在其默认的值，但服务器期望他们被清除。如果``strategy.rollingUpdate``最初在配置文件中定义了值，则更清楚的是它们需要被删除。</span><br><span class="line"><span class="number">4.</span> 应用失败，因为``strategy.rollingUpdate``未清除。该``strategy.rollingupdate`` 字段不能与被定义``strategy.type的Recreate``。</span><br><span class="line"></span><br><span class="line">建议：应在对象配置文件中明确定义这些字段：</span><br><span class="line"></span><br><span class="line">- 工作负载上的选择器和PodTemplate标签，例如Deployment，StatefulSet，Job，DaemonSet，ReplicaSet和ReplicationController</span><br><span class="line">- 部署部署策略</span><br><span class="line"></span><br><span class="line">###### 如何清除其他编写者设置的服务器默认字段或字段</span><br><span class="line">可以通过将其值设置为``null``然后应用配置文件来清除未出现在配置文件中的字段。对于服务器默认的字段，这会触发重新默认值。</span><br><span class="line"></span><br><span class="line">##### 如何更改配置文件和直接命令式编写器之间字段的所有权</span><br><span class="line">这些是您应该用来更改单个对象字段的唯一方法：</span><br><span class="line"></span><br><span class="line">- 使用``kubectl apply``。</span><br><span class="line">- 直接写入实时配置而不修改配置文件：例如，使用``kubectl scale``。</span><br><span class="line"></span><br><span class="line">###### 将所有者从直接命令式编写器更改为配置文件</span><br><span class="line">将该字段添加到配置文件中。对于现场，停止对未经过的实时配置的直接更新``kubectl apply``。</span><br><span class="line"></span><br><span class="line">###### 将所有者从配置文件更改为直接命令式编写器</span><br><span class="line">从Kubernetes <span class="number">1.5</span>开始，将字段的所有权从配置文件更改为命令式编写器需要手动步骤：</span><br><span class="line"></span><br><span class="line">- 从配置文件中删除该字段。</span><br><span class="line">- 从``kubectl.kubernetes.io/last-applied-configuration``活动对象上的注释中删除该字段。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##### 改变管理方法</span><br><span class="line">应该一次只使用一种方法管理Kubernetes对象。可以从一种方法切换到另一种方法，但这是一种手动过程。</span><br><span class="line"></span><br><span class="line">&gt; 注意：使用命令式删除和声明式管理是可以的。</span><br><span class="line"></span><br><span class="line">###### 从命令式命令管理迁移到声明性对象配置</span><br><span class="line">从命令式命令管理迁移到声明性对象配置涉及几个手动步骤：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 将活动对象导出到本地配置文件：</span><br></pre></td></tr></table></figure>
<p>kubectl get <kind>/<name> -o yaml –export &gt; <kind>_<name>.yaml<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span> ``status``从配置文件中手动删除该字段。</span><br><span class="line"></span><br><span class="line">&gt; 注意：此步骤是可选的，因为``kubectl apply``不会更新状态字段 即使它存在于配置文件中。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> ``kubectl.kubernetes.io/last-applied-configuration``在对象上设置注释：</span><br></pre></td></tr></table></figure></name></kind></name></kind></p>
<p>kubectl replace –save-config -f <kind>_<name>.yaml<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4.</span> 更改``kubectl apply``用于专门管理对象的进程。</span><br><span class="line"></span><br><span class="line">###### 从命令式对象配置迁移到声明性对象配置</span><br><span class="line"><span class="number">1.</span> ``kubectl.kubernetes.io/last-applied-configuration``在对象上设置注释：</span><br></pre></td></tr></table></figure></name></kind></p>
<p>kubectl replace –save-config -f <kind>_<name>.yaml<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span> 更改``kubectl apply``用于专门管理对象的进程。</span><br><span class="line"></span><br><span class="line">##### 定义控制器选择器和PodTemplate标签</span><br><span class="line"></span><br><span class="line">&gt; 警告：强烈建议不要更新控制器上的选择器。</span><br><span class="line"></span><br><span class="line">推荐的方法是定义一个仅由控制器选择器使用的单个不可变PodTemplate标签，没有其他语义含义。</span><br><span class="line"></span><br><span class="line">例：</span><br></pre></td></tr></table></figure></name></kind></p>
<p>selector:<br>  matchLabels:<br>      controller-selector: “extensions/v1beta1/deployment/nginx”<br>template:<br>  metadata:<br>    labels:<br>      controller-selector: “extensions/v1beta1/deployment/nginx”<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## Kubernetes Architecture</span><br><span class="line">### 节点</span><br><span class="line">节点是Kubernetes中的工作机器，以前称为一个 ``minion``。节点可以是VM或物理机，具体取决于集群。每个节点都包含运行[pods](https:<span class="comment">//kubernetes.io/docs/concepts/workloads/pods/pod/)所需的服务，并由主组件管理。节点上的服务包括[container runtime](https://kubernetes.io/docs/concepts/overview/components/#node-components)，kubelet和kube-proxy。有关更多详细信息，请参阅 体系结构设计文档中的[Kubernetes节点部分](https://git.k8s.io/community/contributors/design-proposals/architecture/architecture.md#the-kubernetes-node)。</span></span><br><span class="line"></span><br><span class="line">- 节点状态</span><br><span class="line">- 管理</span><br><span class="line">- API对象</span><br><span class="line"></span><br><span class="line">#### 节点状态</span><br><span class="line">节点的状态包含以下信息：</span><br><span class="line"></span><br><span class="line">- 地址</span><br><span class="line">- 条件</span><br><span class="line">- 容量</span><br><span class="line">- 信息</span><br><span class="line"></span><br><span class="line">下面详细描述每个部分。</span><br><span class="line"></span><br><span class="line">##### 地址</span><br><span class="line">这些字段的使用取决于您的云提供商或裸机配置。</span><br><span class="line"></span><br><span class="line">- HostName：节点内核报告的主机名。可以通过kubelet`` --hostname-override``参数覆盖。</span><br><span class="line">- ExternalIP：通常是可从外部路由的节点的IP地址（可从群集外部获得）。</span><br><span class="line">- InternalIP：通常仅在群集内可路由的节点的IP地址。</span><br><span class="line"></span><br><span class="line">##### 条件</span><br><span class="line">该``conditions``字段描述了所有``Running``节点的状态。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">节点条件 | 描述</span><br><span class="line">---|---</span><br><span class="line">``OutOfDisk`` | ``<span class="literal">True</span>`` 如果节点上的可用空间不足以添加新的pod，否则 ``<span class="literal">False</span>``</span><br><span class="line">``Ready`` | `` <span class="literal">True</span>``如果节点是健康的并准备好接受pod，``<span class="literal">False</span>``如果节点不健康且不接受pod，并且``Unknown``节点控制器在最后一次没有从节点听到``node-monitor-grace-period``（默认为<span class="number">40</span>秒）</span><br><span class="line">``MemoryPressure`` | ``<span class="literal">True</span>``如果节点存储器上存在压力 - 即节点存储器是否为低; 除此以外``<span class="literal">False</span>``</span><br><span class="line">``PIDPressure`` | ``<span class="literal">True</span>``如果进程存在压力 - 也就是说，如果节点上有太多进程; 除此以外``<span class="literal">False</span>``</span><br><span class="line">``DiskPressure`` | ``<span class="literal">True</span>``如果磁盘大小存在压力 - 即磁盘容量低; 除此以外``<span class="literal">False</span>``</span><br><span class="line">``NetworkUnavailable`` | ``<span class="literal">True</span>`` 如果没有正确配置节点的网络，否则 ``<span class="literal">False</span>``</span><br><span class="line"></span><br><span class="line">节点条件表示为JSON对象。例如，以下响应描述了健康节点。</span><br></pre></td></tr></table></figure></p>
<p>“conditions”: [<br>  {<br>    “type”: “Ready”,<br>    “status”: “True”<br>  }<br>]<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">如果就绪状态的状态保持<span class="code">``Unknown`</span><span class="code">`或`</span><span class="code">`False`</span><span class="code">`超过`</span><span class="code">`pod-eviction-timeout`</span>`，则会将参数传递给[<span class="string">kube-controller-manager</span>](<span class="link">https://kubernetes.io/docs/admin/kube-controller-manager/</span>)，并且节点控制器会调度节点上的所有Pod以进行删除。默认逐出超时持续时间为<span class="strong">**五分钟**</span>。在某些情况下，当节点无法访问时，apiserver无法与节点上的kubelet通信。在重新建立与apiserver的通信之前，不能将删除pod的决定传送到kubelet。同时，计划删除的pod可以继续在分区节点上运行。</span><br><span class="line"></span><br><span class="line">在1.5之前的Kubernetes版本中，节点控制器会从apiserver中[<span class="string">强制删除</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/pods/pod/#force-deletion-of-pods</span>)这些无法访问的pod。但是，在1.5及更高版本中，节点控制器不会强制删除容器，直到确认它们已停止在群集中运行。您可以看到可能在无法访问的节点上运行的Pod处于<span class="code">``Terminating`</span><span class="code">`或`</span><span class="code">`Unknown`</span>`状态。如果节点永久离开群集，如果Kubernetes无法从底层基础架构推断出，则群集管理员可能需要手动删除节点对象。从Kubernetes中删除节点对象会导致节点上运行的所有Pod对象从apiserver中删除，并释放它们的名称。</span><br><span class="line"></span><br><span class="line">在版本1.12中，<span class="code">``TaintNodesByCondition`</span>`功能被提升为beta版，因此节点生命周期控制器会自动创建表示条件的[<span class="string"> taints</span>](<span class="link">https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/</span>) 。类似地，调度程序在考虑节点时忽略条件;相反，它会查看Node的污点和Pod的容忍度。 现在，用户可以在旧的调度模型和更灵活的新调度模型之间进行选择。根据旧型号，可以安排没有任何容忍度的Pod。但是可以在该节点上安排容忍特定节点的污点的Pod。</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 警告：启用此功能会在观察到条件和创建污点之间产生一个小延迟。此延迟通常小于一秒，但它可以增加成功安排但被kubelet拒绝的Pod的数量。</span></span><br><span class="line"></span><br><span class="line"><span class="section">##### 容量</span></span><br><span class="line">描述节点上可用的资源：CPU，内存以及可以在节点上调度的最大pod数。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 信息</span></span><br><span class="line">有关节点的一般信息，例如内核版本，Kubernetes版本（kubelet和kube-proxy版本），Docker版本（如果使用），操作系统名称。信息由Kubelet从节点收集。</span><br><span class="line"></span><br><span class="line"><span class="section">#### 管理</span></span><br><span class="line">与[<span class="string">pod</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/pods/pod/</span>)和[<span class="string">服务</span>](<span class="link">https://kubernetes.io/docs/concepts/services-networking/service/</span>)不同，Kubernetes本身并不创建节点：它由Google Compute Engine等云提供商在外部创建，或者存在于物理或虚拟机池中。因此，当Kubernetes创建节点时，它会创建一个表示节点的对象。创建后，Kubernetes会检查节点是否有效。例如，如果您尝试从以下内容创建节点：</span><br></pre></td></tr></table></figure></p>
<p>{<br>  “kind”: “Node”,<br>  “apiVersion”: “v1”,<br>  “metadata”: {<br>    “name”: “10.240.79.157”,<br>    “labels”: {<br>      “name”: “my-first-k8s-node”<br>    }<br>  }<br>}<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Kubernetes在内部创建节点对象（表示），并通过基于``metadata.name``字段的运行状况检查来验证节点。如果节点有效 - 即，如果所有必需的服务都在运行 - 它有资格运行pod。否则，对于任何群集活动，它将被忽略，直到它变为有效。</span><br><span class="line"></span><br><span class="line">&gt; 注意： Kubernetes保留无效节点的对象，并不断检查它是否有效。您必须显式删除Node对象才能停止此过程。</span><br><span class="line"></span><br><span class="line">目前，有三个组件与Kubernetes节点接口交互：节点控制器，kubelet和kubectl。</span><br><span class="line"></span><br><span class="line">##### 节点控制器</span><br><span class="line">节点控制器是Kubernetes主组件，它管理节点的各个方面。</span><br><span class="line"></span><br><span class="line">节点控制器在节点的生命周期中具有多个角色。第一种是在注册时为节点分配CIDR块（如果打开了CIDR分配）。</span><br><span class="line"></span><br><span class="line">第二个是使节点控制器的内部节点列表与云提供商的可用计算机列表保持同步。在云环境中运行时，只要节点不健康，节点控制器就会询问云提供商该节点的VM是否仍然可用。如果不是，则节点控制器从其节点列表中删除该节点。</span><br><span class="line"></span><br><span class="line">第三是监测节点的健康状况。节点控制器负责在节点变得无法访问时将NodeStatus的NodeReady条件更新为ConditionUnknown（即节点控制器由于某种原因停止接收心跳，例如由于节点关闭），然后从节点中驱逐所有pod （如果节点仍然无法访问，则使用正常终止）。（默认超时为<span class="number">40</span> ``--node-monitor-period``秒，开始报告ConditionUnknown，之后<span class="number">5</span>米开始驱逐pod。）节点控制器每秒检查每个节点的状态。</span><br><span class="line"></span><br><span class="line">在<span class="number">1.13</span>之前的Kubernetes版本中，NodeStatus是节点的心跳。从Kubernetes <span class="number">1.13</span>开始，节点租用功能作为alpha功能引入（功能门``NodeLease``， [KEP<span class="number">-0009</span>](https:<span class="comment">//github.com/kubernetes/community/blob/master/keps/sig-node/0009-node-heartbeat.md)）。启用节点租用功能时，每个节点都有一个关联的``Lease``对象 ``kube-node-lease``由节点定期更新的命名空间，NodeStatus和节点租约都被视为来自节点的心跳。节点租约经常更新，而NodeStatus仅在有一些更改或经过足够时间时从节点报告为主节点（默认值为1分钟，这比不可达节点的默认超时40秒）。由于节点租约比NodeStatus轻得多，因此从可伸缩性和性能角度来看，此功能使节点心跳显着降低。</span></span><br><span class="line"></span><br><span class="line">在Kubernetes <span class="number">1.4</span>中，我们更新了节点控制器的逻辑，以便在大量节点到达主站时遇到问题时更好地处理案例（例如，因为主站有网络问题）。从<span class="number">1.4</span>开始，节点控制器在决定pod驱逐时查看集群中所有节点的状态。</span><br><span class="line"></span><br><span class="line">在大多数情况下，节点控制器将驱逐率限制为每秒 ``--node-eviction-rate``（默认值<span class="number">0.1</span>），这意味着它不会每<span class="number">10</span>秒从多个节点驱逐pod。</span><br><span class="line"></span><br><span class="line">当给定可用区中的节点变得不健康时，节点逐出行为会发生变化。节点控制器同时检查区域中节点的百分比是否不健康（NodeReady条件是ConditionUnknown或ConditionFalse）。如果不健康节点的比例至少为 ``--unhealthy-zone-threshold``（默认为<span class="number">0.55</span>），则驱逐率降低：如果群集较小（即小于或等于``--large-cluster-size-threshold``节点 - 默认为<span class="number">50</span>）则停止驱逐，否则驱逐率降低为 ``--secondary-node-eviction-rate``（默认<span class="number">0.01</span>）每秒。每个可用区域实施这些策略的原因是因为一个可用区域可能从主服务器分区而其他可用区域保持连接。如果您的群集未跨越多个云提供商可用区域，则只有一个可用区域（整个群集）。</span><br><span class="line"></span><br><span class="line">在可用区域之间传播节点的一个关键原因是，当整个区域出现故障时，工作负载可以转移到健康区域。因此，如果区域中的所有节点都不健康，则节点控制器以正常速率驱逐``--node-eviction-rate``。角落情况是所有区域完全不健康（即群集中没有健康的节点）。在这种情况下，节点控制器假定主连接存在一些问题，并在某些连接恢复之前停止所有驱逐。</span><br><span class="line"></span><br><span class="line">从Kubernetes <span class="number">1.6</span>开始，NodeController还负责驱逐在具有``NoExecute``污点的节点上运行的pod，当pod不能容忍taints时。此外，作为默认禁用的alpha功能，NodeController负责添加与节点无法访问或未就绪等节点问题相对应的污点。 有关污点和alpha功能的详细信息，请参阅[此文档](https:<span class="comment">//kubernetes.io/docs/concepts/configuration/taint-and-toleration/)``NoExecute``。</span></span><br><span class="line"></span><br><span class="line">从版本<span class="number">1.8</span>开始，节点控制器可以负责创建表示节点条件的污点。这是<span class="number">1.8</span>版的alpha功能。</span><br><span class="line"></span><br><span class="line">##### 节点自注册</span><br><span class="line">当kubelet标志``--register-node``为true（默认值）时，kubelet将尝试向API服务器注册自己。这是大多数发行版使用的首选模式。</span><br><span class="line"></span><br><span class="line">对于自行注册，可以使用以下选项启动kubelet：</span><br><span class="line"></span><br><span class="line">- ``--kubeconfig`` - 凭证路径，以向apiserver验证自身。</span><br><span class="line">- ``--cloud-provider`` - 如何与云提供商交谈以阅读有关自身的元数据。</span><br><span class="line">- ``--register-node`` - 自动注册API服务器。</span><br><span class="line">- ``--register-<span class="keyword">with</span>-taints``- 使用给定的taints列表注册节点（以逗号分隔``&lt;key&gt;=&lt;value&gt;:&lt;effect&gt;``）。No-op如果``register-node``是假的。</span><br><span class="line">- ``--node-ip`` - 节点的IP地址。</span><br><span class="line">- ``--node-labels``- 在群集中注册节点时添加的标签（请参阅[<span class="number">1.13</span>+中NodeRestriction准入插件](https:<span class="comment">//kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)强制执行的标签限制）。</span></span><br><span class="line">- ``--node-status-update-frequency`` - 指定kubelet将节点状态发布到master的频率。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">当[节点授权模式](https:<span class="comment">//kubernetes.io/docs/reference/access-authn-authz/node/)和 [NodeRestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction/)录取插件的启用，kubelets仅被授权创建/修改自己的节点资源。</span></span><br><span class="line"></span><br><span class="line">#### 手动节点管理</span><br><span class="line">集群管理员可以创建和修改节点对象。</span><br><span class="line"></span><br><span class="line">如果管理员希望手动创建节点对象，请设置kubelet标志 ``--register-node=false``。</span><br><span class="line"></span><br><span class="line">管理员可以修改节点资源（无论设置如何``--register-node``）。修改包括在节点上设置标签并将其标记为不可调度。</span><br><span class="line"></span><br><span class="line">节点上的标签可以与pod上的节点选择器结合使用以控制调度，例如，将pod限制为仅有资格在节点的子集上运行。</span><br><span class="line"></span><br><span class="line">将节点标记为不可调度可防止将新pod调度到该节点，但不会影响节点上的任何现有pod。这在节点重启等之前作为准备步骤很有用。例如，要标记节点不可调度，请运行以下命令：</span><br></pre></td></tr></table></figure></p>
<p>kubectl cordon $NODENAME<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：由DaemonSet控制器创建的Pod绕过Kubernetes调度程序，不遵守节点上的不可调度属性。这假设守护进程属于机器，即使它在准备重新启动时正在耗尽应用程序。</span></span><br><span class="line"></span><br><span class="line"><span class="section">##### 节点容量</span></span><br><span class="line"></span><br><span class="line">节点的容量（cpus的数量和内存量）是节点对象的一部分。通常，节点在创建节点对象时注册自己并报告其容量。如果您正在进行[<span class="string">手动节点管理</span>](<span class="link">https://kubernetes.io/docs/concepts/architecture/nodes/#manual-node-administration</span>)，则需要在添加节点时设置节点容量。</span><br><span class="line"></span><br><span class="line">Kubernetes调度程序确保节点上的所有pod都有足够的资源。它检查节点上容器请求的总和不大于节点容量。它包括由kubelet启动的所有容器，但不包括由[<span class="string">容器运行时</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/components/#node-components</span>)直接启动的[<span class="string">容器</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/components/#node-components</span>)，也不包括在容器外部运行的任何进程。</span><br><span class="line"></span><br><span class="line">如果要为非Pod进程显式保留资源，请按照[<span class="string">本教程</span>](<span class="link">https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/#system-reserved</span>) 为系统守护程序保留资源。</span><br><span class="line"></span><br><span class="line"><span class="section">#### API对象</span></span><br><span class="line">Node是Kubernetes REST API中的顶级资源。有关API对象的更多详细信息，请参见： [<span class="string">Node API对象</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#node-v1-core</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">### 主节点通信</span></span><br><span class="line">本文档对master（实际上是apiserver）和Kubernetes集群之间的通信路径进行了编目。目的是允许用户自定义其安装以强化网络配置，以便群集可以在不受信任的网络（或云提供商上的完全公共IP）上运行。</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>群集到Master</span><br><span class="line"><span class="bullet">- </span>掌握群集</span><br><span class="line"></span><br><span class="line"><span class="section">#### 群集到Master</span></span><br><span class="line">从集群到主服务器的所有通信路径都在apiserver处终止（其他主服务器组件均未设计为公开远程服务）。在典型部署中，apiserver被配置为在安全HTTPS端口（443）上侦听远程连接，其中启用了一种或多种形式的客户端[<span class="string">认证</span>](<span class="link">https://kubernetes.io/docs/reference/access-authn-authz/authentication/</span>)。 应启用一种或多种[<span class="string">授权</span>](<span class="link">https://kubernetes.io/docs/reference/access-authn-authz/authorization/</span>)形式，尤其是 在允许[<span class="string">匿名请求</span>](<span class="link">https://kubernetes.io/docs/reference/access-authn-authz/authentication/#anonymous-requests</span>) 或[<span class="string">服务帐户令牌</span>](<span class="link">https://kubernetes.io/docs/reference/access-authn-authz/authentication/#service-account-tokens</span>)的情况下。</span><br><span class="line"></span><br><span class="line">应为节点配置群集的公共根证书，以便它们可以安全地连接到apiserver以及有效的客户端凭据。例如，在默认GKE部署中，提供给kubelet的客户端凭证采用客户端证书的形式。请参阅 [<span class="string">kubelet TLS bootstrapping</span>](<span class="link">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/</span>) 以自动配置kubelet客户端证书。</span><br><span class="line"></span><br><span class="line">希望连接到apiserver的Pod可以通过利用服务帐户安全地执行此操作，以便Kubernetes在实例化时自动将公共根证书和有效的承载令牌注入到pod中。该<span class="code">``kubernetes`</span>`服务（在所有名称空间中）配置有虚拟IP地址，该地址被重定向（通过kube-proxy）到apiserver上的HTTPS端点。</span><br><span class="line"></span><br><span class="line">主组件还通过安全端口与群集服务器通信。</span><br><span class="line"></span><br><span class="line">因此，默认情况下，从群集（节点和节点上运行的节点）到主节点的连接的默认操作模式是安全的，可以在不受信任和/或公共网络上运行。</span><br><span class="line"></span><br><span class="line"><span class="section">#### 掌握群集</span></span><br><span class="line">从主服务器（apiserver）到集群有两条主要通信路径。第一个是从apiserver到kubelet进程，它在集群中的每个节点上运行。第二种是通过apiserver的代理功能从apiserver到任何节点，pod或服务。</span><br><span class="line"></span><br><span class="line"><span class="section">##### kubelet的保护者</span></span><br><span class="line">从apiserver到kubelet的连接用于：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>获取pod的日志。</span><br><span class="line"><span class="bullet">- </span>附加（通过kubectl）到运行的pod。</span><br><span class="line"><span class="bullet">- </span>提供kubelet的端口转发功能。</span><br><span class="line"></span><br><span class="line">这些连接终止于kubelet的HTTPS端点。默认情况下，apiserver不会验证kubelet的服务证书，这会使连接受到中间人攻击，并且 <span class="strong">**不安全**</span>地运行在不受信任的和/或公共网络上。</span><br><span class="line"></span><br><span class="line">要验证此连接，请使用该<span class="code">``--kubelet-certificate-authority`</span>`标志为apiserver提供根证书包，以用于验证kubelet的服务证书。</span><br><span class="line"></span><br><span class="line">如果无法做到这一点，请 在apiserver和kubelet之间使用[<span class="string">SSH隧道</span>](<span class="link">https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/</span>)，以避免连接不受信任或公共网络。</span><br><span class="line"></span><br><span class="line">最后， 应启用[<span class="string">Kubelet身份验证和/或授权</span>](<span class="link">https://kubernetes.io/docs/admin/kubelet-authentication-authorization/</span>)以保护kubelet API。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 节点，pod和服务的apiserver</span></span><br><span class="line">从apiserver到节点，pod或服务的连接默认为纯HTTP连接，因此既未经过身份验证也未加密。它们可以通过前缀https:到API URL中的节点，pod或服务名称在安全HTTPS连接上运行，但它们不会验证HTTPS端点提供的证书，也不会提供客户端凭据，因此在连接将被加密时，它不会提供任何诚信保证。这些连接<span class="strong">**目前**</span>在不受信任和/或公共网络上运行<span class="strong">**是不安全的**</span>。</span><br><span class="line"></span><br><span class="line"><span class="section">### 云控制器管理器的基础概念</span></span><br><span class="line">最初创建云控制器管理器（CCM）概念（不要与二进制混淆），以允许特定于云的供应商代码和Kubernetes核心彼此独立地发展。云控制器管理器与其他主组件（如Kubernetes控制器管理器，API服务器和调度程序）一起运行。它也可以作为Kubernetes插件启动，在这种情况下它运行在Kubernetes之上。</span><br><span class="line"></span><br><span class="line">云控制器管理器的设计基于一种插件机制，允许新的云提供商通过使用插件轻松地与Kubernetes集成。有计划在Kubernetes上加入新的云提供商，以及将云提供商从旧模型迁移到新的CCM模型。</span><br><span class="line"></span><br><span class="line">本文档讨论了云控制器管理器背后的概念，并提供了有关其相关功能的详细信息。</span><br><span class="line"></span><br><span class="line">这是没有云控制器管理器的Kubernetes集群的架构：</span><br><span class="line"></span><br><span class="line">![<span class="string">image</span>](<span class="link">https://d33wubrfki0l68.cloudfront.net/e298a92e2454520dddefc3b4df28ad68f9b91c6f/70d52/images/docs/pre-ccm-arch.png</span>)</span><br><span class="line"><span class="bullet">- </span>设计</span><br><span class="line"><span class="bullet">- </span>CCM的组成部分</span><br><span class="line"><span class="bullet">- </span>CCM的功能</span><br><span class="line"><span class="bullet">- </span>插件机制</span><br><span class="line"><span class="bullet">- </span>授权</span><br><span class="line"><span class="bullet">- </span>供应商实施</span><br><span class="line"><span class="bullet">- </span>群集管理</span><br><span class="line"></span><br><span class="line"><span class="section">#### 设计</span></span><br><span class="line">在上图中，Kubernetes和云提供商通过几个不同的组件集成：</span><br><span class="line"><span class="bullet">- </span>Kubelet</span><br><span class="line"><span class="bullet">- </span>Kubernetes控制器经理</span><br><span class="line"><span class="bullet">- </span>Kubernetes API服务器</span><br><span class="line"></span><br><span class="line">CCM整合了前三个组件中的所有依赖于云的逻辑，以创建与云的单一集成点。CCM的新架构如下所示：</span><br><span class="line">![<span class="string">image</span>](<span class="link">https://d33wubrfki0l68.cloudfront.net/518e18713c865fe67a5f23fc64260806d72b38f5/61d75/images/docs/post-ccm-arch.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">#### CCM的组成部分</span></span><br><span class="line">CCM打破了Kubernetes控制器管理器（KCM）的一些功能，并将其作为一个单独的进程运行。具体来说，它打破了KCM中依赖于云的控制器。KCM具有以下依赖于云的控制器循环：</span><br><span class="line"><span class="bullet">- </span>节点控制器</span><br><span class="line"><span class="bullet">- </span>音量控制器</span><br><span class="line"><span class="bullet">- </span>路线控制器</span><br><span class="line"><span class="bullet">- </span>服务控制器</span><br><span class="line"></span><br><span class="line">在1.9版中，CCM运行前面列表中的以下控制器：</span><br><span class="line"><span class="bullet">- </span>节点控制器</span><br><span class="line"><span class="bullet">- </span>路线控制器</span><br><span class="line"><span class="bullet">- </span>服务控制器</span><br><span class="line"></span><br><span class="line">此外，它还运行另一个名为PersistentVolumeLabels控制器的控制器。此控制器负责在GCP和AWS云中创建的PersistentVolumes上设置区域和区域标签。</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：故意选择音量控制器不属于CCM。由于涉及复杂性并且由于现有的努力抽象出供应商特定的卷逻辑，因此决定不将卷控制器移动到CCM。</span></span><br><span class="line"></span><br><span class="line">使用CCM支持卷的最初计划是使用Flex卷来支持可插拔卷。然而，正在计划一项名为CSI的竞争性工作来取代Flex。</span><br><span class="line"></span><br><span class="line">考虑到这些动态，我们决定在CSI准备好之前进行中间止差测量。</span><br><span class="line"></span><br><span class="line"><span class="section">#### CCM的功能</span></span><br><span class="line"></span><br><span class="line">CCM从依赖于云提供商的Kubernetes组件继承其功能。本节基于这些组件构建。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 1. Kubernetes控制器经理</span></span><br><span class="line"></span><br><span class="line">CCM的大部分功能来自KCM。如上一节所述，CCM运行以下控制循环：</span><br><span class="line"><span class="bullet">- </span>节点控制器</span><br><span class="line"><span class="bullet">- </span>路线控制器</span><br><span class="line"><span class="bullet">- </span>服务控制器</span><br><span class="line"><span class="bullet">- </span>PersistentVolumeLabels控制器</span><br><span class="line"></span><br><span class="line"><span class="section">###### 节点控制器</span></span><br><span class="line">节点控制器负责通过从云提供商获取有关在集群中运行的节点的信息来初始化节点。节点控制器执行以下功能：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1. </span>使用特定于云的区域/区域标签初始化节点。</span><br><span class="line"><span class="bullet">2. </span>使用特定于云的实例详细信息初始化节点，例如，类型和大小。</span><br><span class="line"><span class="bullet">3. </span>获取节点的网络地址和主机名。</span><br><span class="line"><span class="bullet">4. </span>如果节点无响应，请检查云以查看该节点是否已从云中删除。如果已从云中删除该节点，请删除Kubernetes Node对象。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 路线控制器</span></span><br><span class="line">Route控制器负责适当地配置云中的路由，以便Kubernetes集群中不同节点上的容器可以相互通信。路径控制器仅适用于Google Compute Engine群集。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 服务控制器</span></span><br><span class="line">服务控制器负责监听服务创建，更新和删除事件。根据Kubernetes中当前的服务状态，它配置云负载均衡器（如ELB或Google LB）以反映Kubernetes中的服务状态。此外，它还确保云负载平衡器的服务后端是最新的。</span><br><span class="line"></span><br><span class="line"><span class="section">###### PersistentVolumeLabels控制器</span></span><br><span class="line">PersistentVolumeLabels控制器在创建AWS EBS / GCE PD卷时应用标签。这消除了用户手动设置这些卷上的标签的需要。</span><br><span class="line"></span><br><span class="line">这些标签对于pod的计划至关重要，因为这些卷仅限于在它们所在的区域/区域内工作。使用这些卷的任何Pod都需要在同一区域/区域中进行调度。</span><br><span class="line"></span><br><span class="line">PersistentVolumeLabels控制器专门为CCM创建; 也就是说，在创建CCM之前它不存在。这样做是为了将Kubernetes API服务器（它是一个许可控制器）中的PV标记逻辑移动到CCM。它不在KCM上运行。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 2. Kubelet</span></span><br><span class="line"></span><br><span class="line">节点控制器包含kubelet的依赖于云的功能。在引入CCM之前，kubelet负责使用特定于云的详细信息（如IP地址，区域/区域标签和实例类型信息）初始化节点。CCM的引入已将此初始化操作从kubelet转移到CCM。</span><br><span class="line"></span><br><span class="line">在这个新模型中，kubelet初始化一个没有特定于云的信息的节点。但是，它会为新创建的节点添加污点，使节点不可调度，直到CCM使用特定于云的信息初始化节点。然后它消除了这种污点。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 3. Kubernetes API服务器</span></span><br><span class="line">PersistentVolumeLabels控制器将Kubernetes API服务器的依赖于云的功能移动到CCM，如前面部分所述。</span><br><span class="line"></span><br><span class="line"><span class="section">#### 插件机制</span></span><br><span class="line">云控制器管理器使用Go接口允许插入任何云的实现。具体来说，它使用[<span class="string">此处</span>](<span class="link">https://github.com/kubernetes/cloud-provider/blob/9b77dc1c384685cb732b3025ed5689dd597a5971/cloud.go#L42-L62</span>)定义的CloudProvider接口。</span><br><span class="line"></span><br><span class="line">上面突出显示的四个共享控制器的实现，以及一些脚手架以及共享的cloudprovider接口，将保留在Kubernetes核心中。特定于云提供商的实现将在核心之外构建，并实现核心中定义的接口。</span><br><span class="line"></span><br><span class="line">有关开发插件的更多信息，请参阅[<span class="string">开发Cloud Controller Manager</span>](<span class="link">https://kubernetes.io/docs/tasks/administer-cluster/developing-cloud-controller-manager/</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">#### 授权</span></span><br><span class="line">本节分解了CCM执行其操作时各种API对象所需的访问权限。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 节点控制器</span></span><br><span class="line">Node控制器仅适用于Node对象。它需要完全访问get，list，create，update，patch，watch和delete Node对象。</span><br><span class="line"></span><br><span class="line">V1 /节点：</span><br><span class="line"><span class="bullet">- </span>Get</span><br><span class="line"><span class="bullet">- </span>List</span><br><span class="line"><span class="bullet">- </span>Create</span><br><span class="line"><span class="bullet">- </span>Update</span><br><span class="line"><span class="bullet">- </span>Patch</span><br><span class="line"><span class="bullet">- </span>Watch</span><br><span class="line"><span class="bullet">- </span>Delete</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">##### 路线控制器</span></span><br><span class="line">路由控制器侦听Node对象创建并适当地配置路由。它需要访问Node对象。</span><br><span class="line"></span><br><span class="line">V1 /节点：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>Get</span><br><span class="line"></span><br><span class="line"><span class="section">##### 服务控制器</span></span><br><span class="line">服务控制器侦听Service对象创建，更新和删除事件，然后适当地为这些服务配置端点。</span><br><span class="line"></span><br><span class="line">要访问服务，它需要列表和监视访问权限。要更新服务，它需要修补和更新访问权限。</span><br><span class="line"></span><br><span class="line">要为服务设置端点，需要访问create，list，get，watch和update。</span><br><span class="line"></span><br><span class="line">V1 /服务：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>List</span><br><span class="line"><span class="bullet">- </span>Get</span><br><span class="line"><span class="bullet">- </span>Watch</span><br><span class="line"><span class="bullet">- </span>Patch</span><br><span class="line"><span class="bullet">- </span>Update</span><br><span class="line"></span><br><span class="line"><span class="section">##### PersistentVolumeLabels控制器</span></span><br><span class="line">PersistentVolumeLabels控制器侦听PersistentVolume（PV）创建事件，然后更新它们。该控制器需要访问以获取和更新PV。</span><br><span class="line"></span><br><span class="line">V1 / PersistentVolume：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>Get</span><br><span class="line"><span class="bullet">- </span>List</span><br><span class="line"><span class="bullet">- </span>Watch</span><br><span class="line"><span class="bullet">- </span>Update</span><br><span class="line"></span><br><span class="line"><span class="section">##### 其他</span></span><br><span class="line">CCM核心的实现需要访问以创建事件，并且为了确保安全操作，它需要访问以创建ServiceAccounts。</span><br><span class="line"></span><br><span class="line">V1 /事件：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>Create</span><br><span class="line"><span class="bullet">- </span>Patch</span><br><span class="line"><span class="bullet">- </span>Update</span><br><span class="line"></span><br><span class="line">V1 / ServiceAccount：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>Create</span><br><span class="line"></span><br><span class="line">CCM的RBAC ClusterRole如下所示：</span><br></pre></td></tr></table></figure></p>
<p>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRole<br>metadata:<br>  name: cloud-controller-manager<br>rules:</p>
<ul>
<li>apiGroups:<ul>
<li>“”<br>resources:</li>
<li>events<br>verbs:</li>
<li>create</li>
<li>patch</li>
<li>update</li>
</ul>
</li>
<li>apiGroups:<ul>
<li>“”<br>resources:</li>
<li>nodes<br>verbs:</li>
<li>‘*’</li>
</ul>
</li>
<li>apiGroups:<ul>
<li>“”<br>resources:</li>
<li>nodes/status<br>verbs:</li>
<li>patch</li>
</ul>
</li>
<li>apiGroups:<ul>
<li>“”<br>resources:</li>
<li>services<br>verbs:</li>
<li>list</li>
<li>patch</li>
<li>update</li>
<li>watch</li>
</ul>
</li>
<li>apiGroups:<ul>
<li>“”<br>resources:</li>
<li>serviceaccounts<br>verbs:</li>
<li>create</li>
</ul>
</li>
<li>apiGroups:<ul>
<li>“”<br>resources:</li>
<li>persistentvolumes<br>verbs:</li>
<li>get</li>
<li>list</li>
<li>update</li>
<li>watch</li>
</ul>
</li>
<li>apiGroups:<ul>
<li>“”<br>resources:</li>
<li>endpoints<br>verbs:</li>
<li>create</li>
<li>get</li>
<li>list</li>
<li>watch</li>
<li>update<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">#### 供应商实施</span></span><br><span class="line">以下云提供商已实施CCM：</span><br><span class="line"><span class="bullet">- </span>[<span class="string">Digital Ocean</span>](<span class="link">https://github.com/digitalocean/digitalocean-cloud-controller-manager</span>)</span><br><span class="line"><span class="bullet">- </span>[<span class="string">Oracle</span>](<span class="link">https://github.com/oracle/oci-cloud-controller-manager</span>)</span><br><span class="line"><span class="bullet">- </span>[<span class="string">Azure</span>](<span class="link">https://github.com/kubernetes/kubernetes/tree/master/pkg/cloudprovider/providers/azure</span>)</span><br><span class="line"><span class="bullet">- </span>[<span class="string">GCE</span>](<span class="link">https://github.com/kubernetes/kubernetes/tree/master/pkg/cloudprovider/providers/gce</span>)</span><br><span class="line"><span class="bullet">- </span>[<span class="string">AWS</span>](<span class="link">https://github.com/kubernetes/kubernetes/tree/master/pkg/cloudprovider/providers/aws</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">#### 群集管理</span></span><br><span class="line">[<span class="string">此处</span>](<span class="link">https://kubernetes.io/docs/tasks/administer-cluster/running-cloud-controller/#cloud-controller-manager</span>)提供了有关配置和运行CCM的完整说明 </span><br><span class="line"></span><br><span class="line"><span class="section">## 容器</span></span><br><span class="line"><span class="section">### 镜像</span></span><br><span class="line">您创建Docker镜像并将其推送到仓库，然后在Kubernetes的pod中引用它。</span><br><span class="line"></span><br><span class="line"><span class="code">``image`</span><span class="code">`容器的属性支持与`</span><span class="code">`docker`</span>`命令相同的语法，包括私有仓库和标记。</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>更新镜像</span><br><span class="line"><span class="bullet">- </span>用清单构建多架构镜像</span><br><span class="line"><span class="bullet">- </span>使用私人仓库</span><br><span class="line"></span><br><span class="line"><span class="section">#### 更新镜像</span></span><br><span class="line">默认拉取策略<span class="code">``IfNotPresent`</span>`会导致Kubelet跳过拉动镜像（如果已存在）。如果您想总是强制Docker拉动，可以执行以下操作之一：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>将<span class="code">``imagePullPolicy`</span>`容器设置为Always。</span><br><span class="line"><span class="bullet">- </span>省略<span class="code">``imagePullPolicy`</span><span class="code">`并使用它`</span><span class="code">`:latest`</span>`作为要使用的镜像的标记。</span><br><span class="line"><span class="bullet">- </span>省略<span class="code">``imagePullPolicy`</span>`要使用的镜像和标记。</span><br><span class="line"><span class="bullet">- </span>启用[<span class="string">AlwaysPullImages</span>](<span class="link">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#alwayspullimages</span>)准入控制器。</span><br><span class="line"></span><br><span class="line">请注意，您应该避免使用<span class="code">``:latest`</span>`标记，有关详细信息，请[<span class="string">参阅配置的最佳实践</span>](<span class="link">https://kubernetes.io/docs/concepts/configuration/overview/#container-images</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">#### 用清单构建多架构图像</span></span><br><span class="line">Docker CLI现在支持以下命令<span class="code">``docker manifest`</span><span class="code">`中包含的子命令`</span><span class="code">`create`</span><span class="code">`，`</span><span class="code">`annotate`</span><span class="code">`并`</span><span class="code">`push`</span><span class="code">`。这些命令可用于构建和推送清单。您可以使用`</span><span class="code">`docker manifest inspect`</span>`查看清单。</span><br><span class="line"></span><br><span class="line">请在此处查看[<span class="string">docker文档</span>](<span class="link">https://docs.docker.com/edge/engine/reference/commandline/manifest/</span>)，</span><br><span class="line">请参阅我们在构建工具中如何使用它的[<span class="string">示例</span>](<span class="link">https://cs.k8s.io/?q=docker%20manifest%20(create%7Cpush%7Cannotate</span>)&amp;i=nope&amp;files=&amp;repos=)。</span><br><span class="line"></span><br><span class="line">这些命令完全依赖于Docker CLI，并且完全在Docker CLI上实现。您需要编辑<span class="code">``$HOME/.docker/config.json`</span><span class="code">`和设置`</span><span class="code">`experimental`</span><span class="code">`密钥，`</span><span class="code">`enabled`</span><span class="code">`或者只需在调用CLI命令时将`</span><span class="code">`DOCKER_CLI_EXPERIMENTAL`</span><span class="code">`环境变量设置为`</span><span class="code">`enabled`</span>`。</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：请使用Docker 18.06或更高版本，以下版本有错误或不支持实验命令行选项。[示例](https://github.com/docker/cli/issues/1135)会在containerd下导致问题。</span></span><br><span class="line"></span><br><span class="line">如果您在上传陈旧的清单时遇到问题，只需清理旧的清单<span class="code">``$HOME/.docker/manifests`</span>`即可重新开始。</span><br><span class="line"></span><br><span class="line">对于Kubernetes，我们通常使用带后缀的镜像<span class="code">``-$(ARCH)`</span><span class="code">`。为了向后兼容，请生成带有后缀的旧镜像。我们的想法是生成`</span><span class="code">`pause`</span><span class="code">`具有所有拱形清单的说明镜像，并说出`</span><span class="code">`pause-amd64`</span>`哪些向后兼容旧配置或YAML文件，这些文件可能硬编码带有后缀的镜像。</span><br><span class="line"></span><br><span class="line"><span class="section">#### 使用私人仓库</span></span><br><span class="line">私人仓库管理可能需要密钥才能从中读取图像。凭证可以通过多种方式提供：</span><br><span class="line"><span class="bullet">- </span>使用Google Container Registry</span><br><span class="line">  - Per-cluster</span><br><span class="line">  - 在Google Compute Engine或Google Kubernetes Engine上自动配置</span><br><span class="line">  - 所有pod都可以读取项目的私有仓库</span><br><span class="line"><span class="bullet">- </span>使用AWS EC2容器仓库（ECR）</span><br><span class="line">  - 使用IAM角色和策略来控制对ECR存储库的访问</span><br><span class="line">  - 自动刷新ECR登录凭据</span><br><span class="line"><span class="bullet">- </span>使用Azure容器仓库（ACR）</span><br><span class="line"><span class="bullet">- </span>使用IBM Cloud Container Registry</span><br><span class="line"><span class="bullet">- </span>配置节点以验证私有仓库</span><br><span class="line">  - 所有pod都可以读取任何已配置的私有仓库</span><br><span class="line">  - 需要集群管理员进行节点配置</span><br><span class="line"><span class="bullet">- </span>预拉镜像</span><br><span class="line">  - 所有pod都可以使用节点上缓存的任何镜像</span><br><span class="line">  - 需要root权限才能设置所有节点</span><br><span class="line"><span class="bullet">- </span>在Pod上指定ImagePullSecrets</span><br><span class="line">  - 只有提供自己密钥的pod才能访问私有仓库</span><br><span class="line"></span><br><span class="line">下面更详细地描述每个选项。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 使用Google Container Registry</span></span><br><span class="line">在Google Compute Engine（GCE）上运行时，Kubernetes对[<span class="string">Google Container Registry（GCR）</span>](<span class="link">https://cloud.google.com/tools/container-registry/</span>)提供原生支持。如果您在GCE或Google Kubernetes Engine上运行群集，只需使用完整的镜像名称（例如gcr.io/my_project/image：tag）。</span><br><span class="line"></span><br><span class="line">群集中的所有pod都具有此仓库中镜像的读取权限。</span><br><span class="line"></span><br><span class="line">kubelet将使用实例的Google服务帐户向GCR进行身份验证。实例上的服务帐户将具有一个 <span class="code">``https://www.googleapis.com/auth/devstorage.read_only`</span>`，因此它可以从项目的GCR中提取，但不能推送。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 使用AWS EC2 Container Registry</span></span><br><span class="line">当节点是AWS EC2实例时，Kubernetes对[<span class="string">AWS EC2 Container Registry</span>](<span class="link">https://aws.amazon.com/ecr/</span>)具有本机支持。</span><br><span class="line"></span><br><span class="line">只需<span class="code">``ACCOUNT.dkr.ecr.REGION.amazonaws.com/imagename:tag`</span>`在Pod定义中使用完整的图像名称（例如）。</span><br><span class="line"></span><br><span class="line">可以创建pod的群集的所有用户都可以运行使用ECR仓库中任何镜像的pod。</span><br><span class="line"></span><br><span class="line">kubelet将获取并定期刷新ECR凭据。它需要以下权限才能执行此操作：</span><br><span class="line"><span class="bullet">- </span>ecr:GetAuthorizationToken</span><br><span class="line"><span class="bullet">- </span>ecr:BatchCheckLayerAvailability</span><br><span class="line"><span class="bullet">- </span>ecr:GetDownloadUrlForLayer</span><br><span class="line"><span class="bullet">- </span>ecr:GetRepositoryPolicy</span><br><span class="line"><span class="bullet">- </span>ecr:DescribeRepositories</span><br><span class="line"><span class="bullet">- </span>ecr:ListImages</span><br><span class="line"><span class="bullet">- </span>ecr:BatchGetImage</span><br><span class="line"></span><br><span class="line">要求：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>您必须使用kubelet版本<span class="code">``v1.2.0`</span><span class="code">`或更新版本。（例如run `</span><span class="code">`/usr/bin/kubelet --version=true`</span>`）。</span><br><span class="line"><span class="bullet">- </span>如果您的节点位于区域A中且您的注册表位于不同的区域B中，则需要<span class="code">``v1.3.0`</span>`更新版本或更新版本。</span><br><span class="line"><span class="bullet">- </span>ECR必须在您所在的地区提供</span><br><span class="line"></span><br><span class="line">故障排除：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>验证上述所有要求。</span><br><span class="line"><span class="bullet">- </span><span class="code">``us-west-2`</span>`在工作站上获取$ REGION（例如）凭据。SSH进入主机并使用这些信用卡手动运行Docker。它有用吗？</span><br><span class="line"><span class="bullet">- </span>验证kubelet是否正在运行<span class="code">``--cloud-provider=aws`</span>`。</span><br><span class="line"><span class="bullet">- </span>检查kubelet日志（例如<span class="code">``journalctl -u kubelet`</span>`）以获取日志行，例如：</span><br><span class="line">  - <span class="code">``plugins.go:56] Registering credential provider: aws-ecr-key`</span>`</span><br><span class="line">  - <span class="code">``provider.go:91] Refreshing cache for provider: *aws_credentials.ecrProvider`</span>`</span><br><span class="line"></span><br><span class="line"><span class="section">##### 使用Azure容器仓库（ACR）</span></span><br><span class="line">使用[<span class="string">Azure容器仓库</span>](<span class="link">https://azure.microsoft.com/en-us/services/container-registry/</span>)时， 您可以使用管理员用户或服务主体进行身份验证。在任何一种情况下，身份验证都通过标准Docker身份验证完成 这些说明假定使用 [<span class="string">azure-cli</span>](<span class="link">https://github.com/azure/azure-cli</span>)命令行工具。</span><br><span class="line"></span><br><span class="line">您首先需要创建一个仓库并生成凭据，完整的文档可以在[<span class="string">Azure容器仓库文档</span>](<span class="link">https://docs.microsoft.com/en-us/azure/container-registry/container-registry-get-started-azure-cli</span>)中找到。</span><br><span class="line"></span><br><span class="line">创建容器仓库后，您将使用以下凭据登录：</span><br><span class="line"><span class="bullet">- </span><span class="code">``DOCKER_USER`</span>` ：服务主体或管理员用户名</span><br><span class="line"><span class="bullet">- </span><span class="code">``DOCKER_PASSWORD`</span>`：服务主体密码或管理员用户密码</span><br><span class="line"><span class="bullet">- </span><span class="code">``DOCKER_REGISTRY_SERVER`</span><span class="code">`： `</span><span class="code">`$&#123;some-registry-name&#125;.azurecr.io`</span>`</span><br><span class="line"><span class="bullet">- </span><span class="code">``DOCKER_EMAIL`</span><span class="code">`：`</span><span class="code">` $&#123;some-email-address&#125;`</span>`</span><br><span class="line"></span><br><span class="line">填好这些变量后，您可以[<span class="string">配置Kubernetes Secret并使用它来部署Pod</span>](<span class="link">https://kubernetes.io/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 使用IBM Cloud Container Registry</span></span><br><span class="line">IBM Cloud Container Registry提供了一个多租户私有镜像仓库，您可以使用它来安全地存储和共享Docker镜像。默认情况下，集成的漏洞顾问会扫描私有仓库中的镜像，以检测安全问题和潜在漏洞。IBM Cloud帐户中的用户可以访问您的镜像，也可以创建令牌以授予对仓库命名空间的访问权限。</span><br><span class="line"></span><br><span class="line">要安装IBM Cloud Container Registry CLI插件并为镜像创建命名空间，请参阅[<span class="string">IBM Cloud Container Registry入门</span>](<span class="link">https://console.bluemix.net/docs/services/Registry/index.html#index</span>)。</span><br><span class="line"></span><br><span class="line">您可以使用IBM Cloud Container Registry将容器从[<span class="string">IBM Cloud公共镜像</span>](<span class="link">https://console.bluemix.net/docs/services/RegistryImages/index.html#ibm_images</span>)和私有镜像部署到<span class="code">``default`</span><span class="code">`IBM Cloud Kubernetes Service集群的命名空间中。要将容器部署到其他名称空间，或使用来自其他IBM Cloud Container Registry区域或IBM Cloud帐户的镜像，请创建Kubernetes `</span><span class="code">`imagePullSecret`</span>`。有关更多信息，请参阅[<span class="string">从镜像构建容器</span>](<span class="link">https://console.bluemix.net/docs/containers/cs_images.html#images</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 配置节点以验证私有仓库</span></span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：如果您在Google Kubernetes Engine上运行，则``.dockercfg``每个节点上都会有一个包含Google Container Registry凭据的节点。你不能使用这种方法。</span></span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：如果您在AWS EC2上运行并且正在使用EC2容器仓库（ECR），则每个节点上的kubelet将管理和更新ECR登录凭据。你不能使用这种方法</span></span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：如果您可以控制节点配置，则此方法是合适的。它不能可靠地在GCE和任何其他进行自动节点替换的云提供商上运行。</span></span><br><span class="line"></span><br><span class="line">Docker将私有仓库的密钥存储在<span class="code">``$HOME/.dockercfg`</span><span class="code">`或`</span><span class="code">`$HOME/.docker/config.json`</span>`文件中。如果您将相同的文件放在下面的搜索路径列表中，则kubelet会在拉取镜像时将其用作凭据提供程序。</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span><span class="code">``&#123;--root-dir:-/var/lib/kubelet&#125;/config.json`</span>`</span><br><span class="line"><span class="bullet">- </span><span class="code">``&#123;cwd of kubelet&#125;/config.json`</span>`</span><br><span class="line"><span class="bullet">- </span><span class="code">``$&#123;HOME&#125;/.docker/config.json`</span>`</span><br><span class="line"><span class="bullet">- </span><span class="code">``/.docker/config.json`</span>`</span><br><span class="line"><span class="bullet">- </span><span class="code">``&#123;--root-dir:-/var/lib/kubelet&#125;/.dockercfg`</span>`</span><br><span class="line"><span class="bullet">- </span><span class="code">``&#123;cwd of kubelet&#125;/.dockercfg`</span>`</span><br><span class="line"><span class="bullet">- </span><span class="code">``$&#123;HOME&#125;/.dockercfg`</span>`</span><br><span class="line"><span class="bullet">- </span><span class="code">``/.dockercfg`</span>`</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：您可能必须``HOME=/root``在环境文件中明确设置kubelet。</span></span><br><span class="line"></span><br><span class="line">以下是配置节点以使用私有仓库的建议步骤。在此示例中，在桌面/笔记本电脑上运行这些：</span><br><span class="line"><span class="bullet">1. </span><span class="code">``docker login [server]`</span><span class="code">`针对要使用的每组凭据运行。这更新`</span><span class="code">`$HOME/.docker/config.json`</span>`。</span><br><span class="line"><span class="bullet">2. </span><span class="code">``$HOME/.docker/config.json`</span>`在编辑器中查看以确保它仅包含您要使用的凭据。</span><br><span class="line"><span class="bullet">3. </span>获取节点列表，例如：</span><br><span class="line"><span class="bullet">- </span>如果你想要这些名字： <span class="code">``nodes=$(kubectl get nodes -o jsonpath='&#123;range.items[*].metadata&#125;&#123;.name&#125; &#123;end&#125;')`</span>`</span><br><span class="line"><span class="bullet">- </span>如果你想获得IP： <span class="code">``nodes=$(kubectl get nodes -o jsonpath='&#123;range .items[*].status.addresses[?(@.type=="ExternalIP")]&#125;&#123;.address&#125; &#123;end&#125;')`</span>`</span><br><span class="line"><span class="bullet">4. </span>将本地复制<span class="code">``.docker/config.json`</span>`到上面的搜索路径列表之一。</span><br><span class="line"><span class="bullet">- </span>例如： <span class="code">``for n in $nodes; do scp ~/.docker/config.json root@$n:/var/lib/kubelet/config.json; done`</span>`</span><br><span class="line"></span><br><span class="line">通过创建使用私有镜像的pod进行验证，例如：</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>kubectl create -f - &lt;&lt;EOF<br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: private-image-test-1<br>spec:<br>  containers:</p>
<pre><code>- name: uses-private-image
  image: $PRIVATE_IMAGE_NAME
  imagePullPolicy: Always
  command: [ &quot;echo&quot;, &quot;SUCCESS&quot; ]
</code></pre><p>EOF<br>pod/private-image-test-1 created<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果一切正常，那么过了一会儿，你应该看到：</span><br></pre></td></tr></table></figure></p>
<p>kubectl logs private-image-test-1<br>SUCCESS<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果失败了，那么你会看到：</span><br></pre></td></tr></table></figure></p>
<p>kubectl describe pods/private-image-test-1 | grep “Failed”<br>  Fri, 26 Jun 2015 15:36:13 -0700    Fri, 26 Jun 2015 15:39:13 -0700    19    {kubelet node-i2hq}    spec.containers{uses-private-image}    failed        Failed to pull image “user/privaterepo:v1”: Error: image user/privaterepo:v1 not found<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">您必须确保群集中的所有节点都具有相同的节点``.docker/config.json``。否则，pod将在某些节点上运行，而无法在其他节点上运行。例如，如果使用节点自动缩放，则每个实例模板都需要包含``.docker/config.json``或装载包含它的驱动器。</span><br><span class="line"></span><br><span class="line">将私有仓库项添加到任何私有仓库中后，所有pod都将具有对镜像的读访问权限``.docker/config.json``。</span><br><span class="line"></span><br><span class="line">##### 预拉图像</span><br><span class="line"></span><br><span class="line">&gt; 注意：如果您在Google Kubernetes Engine上运行，则.dockercfg每个节点上都会有一个包含Google Container Registry凭据的节点。你不能使用这种方法。</span><br><span class="line"></span><br><span class="line">&gt; 注意：如果您可以控制节点配置，则此方法是合适的。它不能可靠地在GCE和任何其他进行自动节点替换的云提供商上运行。</span><br><span class="line"></span><br><span class="line">默认情况下，kubelet将尝试从指定的仓库中提取每个镜像。但是，如果``imagePullPolicy``容器的属性设置为``IfNotPresent``或``Never``，则使用本地镜像（分别优先或排他）。</span><br><span class="line"></span><br><span class="line">如果您希望依赖预先提取的镜像作为仓库身份验证的替代，则必须确保群集中的所有节点都具有相同的预拉镜像。</span><br><span class="line"></span><br><span class="line">这可以用于预加载某些镜像以提高速度，或者作为对私有仓库进行身份验证的替代方法。</span><br><span class="line"></span><br><span class="line">所有pod都可以读取任何预拉镜像。</span><br><span class="line"></span><br><span class="line">##### 在Pod上指定ImagePullSecrets</span><br><span class="line"></span><br><span class="line">&gt; 注意：此方法目前是Google Kubernetes Engine，GCE以及自动创建节点的任何云提供商的推荐方法。</span><br><span class="line"></span><br><span class="line">Kubernetes支持在pod上指定仓库项。</span><br><span class="line"></span><br><span class="line">##### 使用Docker配置创建机密</span><br><span class="line">运行以下命令，替换相应的大写值：</span><br></pre></td></tr></table></figure></p>
<p>kubectl create secret docker-registry myregistrykey –docker-server=DOCKER_REGISTRY_SERVER –docker-username=DOCKER_USER –docker-password=DOCKER_PASSWORD –docker-email=DOCKER_EMAIL<br>secret/myregistrykey created.<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">如果需要访问多个仓库，则可以为每个仓库创建一个秘密。 在为Pods提取镜像时，Kubelet会将任何内容合并``imagePullSecrets``为一个虚拟内容``.docker/config.json``。</span><br><span class="line"></span><br><span class="line">Pod只能在自己的命名空间中引用镜像拉取秘密，因此每个命名空间需要执行一次此过程。</span><br><span class="line"></span><br><span class="line">###### 绕过kubectl会产生秘密</span><br><span class="line"></span><br><span class="line">如果由于某种原因，您需要单个项目中的多个项目``.docker/config.json``或需要上述命令未给出的控制，那么您可以[使用json或yaml创建一个秘密](https:<span class="comment">//kubernetes.io/docs/user-guide/secrets/#creating-a-secret-manually)。</span></span><br><span class="line"></span><br><span class="line">务必：</span><br><span class="line"></span><br><span class="line">- 设置数据项的名称 ``.dockerconfigjson``</span><br><span class="line">- base64编码docker文件并粘贴该字符串，不间断作为字段的值 ``data[<span class="string">".dockerconfigjson"</span>]``</span><br><span class="line">- 设置``type``为``kubernetes.io/dockerconfigjson``</span><br><span class="line"></span><br><span class="line">例：</span><br></pre></td></tr></table></figure></p>
<p>apiVersion: v1<br>kind: Secret<br>metadata:<br>  name: myregistrykey<br>  namespace: awesomeapps<br>data:<br>  .dockerconfigjson: UmVhbGx5IHJlYWxseSByZWVlZWVlZWVlZWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGx5eXl5eXl5eXl5eXl5eXl5eXl5eSBsbGxsbGxsbGxsbGxsbG9vb29vb29vb29vb29vb29vb29vb29vb29vb25ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubmdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2cgYXV0aCBrZXlzCg==<br>type: kubernetes.io/dockerconfigjson<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如果收到错误消息``error: no objects passed to create``，则可能表示base64编码的字符串无效。如果收到类似的错误消息``Secret <span class="string">"myregistrykey"</span> is invalid: data[.dockerconfigjson]: invalid value ...``，则表示数据已成功取消base64编码，但无法解析为``.docker/config.json``文件。</span><br><span class="line"></span><br><span class="line">##### 参考Pod上的imagePullSecrets</span><br><span class="line">现在，您可以通过向``imagePullSecrets`` pod定义添加一个部分来创建引用该秘密的pod。</span><br></pre></td></tr></table></figure></p>
<p>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: foo<br>  namespace: awesomeapps<br>spec:<br>  containers:</p>
<pre><code>- name: foo
  image: janedoe/awesomeapp:v1
</code></pre><p>  imagePullSecrets:</p>
<pre><code>- name: myregistrykey
</code></pre><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">需要对使用私有仓库的每个pod执行此操作。</span><br><span class="line"></span><br><span class="line">但是，可以通过在[<span class="string">serviceAccount</span>](<span class="link">https://kubernetes.io/docs/user-guide/service-accounts</span>)资源中设置imagePullSecrets来自动设置此字段。检查将[<span class="string">ImagePullSecrets添加到服务帐户</span>](<span class="link">https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#add-imagepullsecrets-to-a-service-account</span>)以获取详细说明。</span><br><span class="line"></span><br><span class="line">您可以将其与每个节点结合使用<span class="code">``.docker/config.json`</span>`。凭证将被合并。这种方法适用于Google Kubernetes Engine。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 用例</span></span><br><span class="line">有许多配置私有仓库的解决方案。以下是一些常见用例和建议的解决方案。</span><br><span class="line"><span class="bullet">1. </span>群集仅运行非专有（例如开源）镜像。无需隐藏镜像。</span><br><span class="line"><span class="bullet">- </span>在Docker hub上使用公共镜像。</span><br><span class="line">  - 无需配置。</span><br><span class="line">  - 在GCE / Google Kubernetes Engine上，自动使用本地镜像来提高速度和可用性。</span><br><span class="line"><span class="bullet">2. </span>群集运行一些专有镜像，这些镜像像应隐藏给公司外部的人员，但对所有群集用户可见。</span><br><span class="line"><span class="bullet">- </span>使用托管的私有[<span class="string">Docker仓库</span>](<span class="link">https://docs.docker.com/registry/</span>)。</span><br><span class="line">  - 它可能托管在[<span class="string">Docker Hub</span>](<span class="link">https://hub.docker.com/signup</span>)或其他地方。</span><br><span class="line">  - 如上所述，在每个节点上手动配置<span class="code">``.docker / config.json`</span>`。</span><br><span class="line"><span class="bullet">- </span>或者，使用开放读取访问权限在防火墙后面运行内部私有仓库。</span><br><span class="line">  - 不需要Kubernetes配置。</span><br><span class="line"><span class="bullet">- </span>或者，在使用GCE / Google Kubernetes Engine时，请使用该项目的Google Container Registry。</span><br><span class="line">  - 与集群自动调节相比，它可以比手动节点配置更好地工作。</span><br><span class="line"><span class="bullet">- </span>或者，在更改节点配置不方便的群集上，请使用<span class="code">``imagePullSecrets`</span>`。</span><br><span class="line"><span class="bullet">3. </span>具有专有镜像的集群，其中一些需要更严格的访问控制。</span><br><span class="line"><span class="bullet">- </span>确保[<span class="string">AlwaysPullImages准入控制器</span>](<span class="link">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#alwayspullimages</span>)处于活动状态。否则，所有Pod都可能访问所有镜像。</span><br><span class="line"><span class="bullet">- </span>将敏感数据移动到“秘密”资源中，而不是将其打包在镜像中。</span><br><span class="line"><span class="bullet">4. </span>一个多租户群集，每个租户都需要拥有私有仓库。</span><br><span class="line"><span class="bullet">- </span>确[<span class="string">保AlwaysPullImages准入控制器</span>](<span class="link">https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#alwayspullimages</span>)处于活动状态。否则，所有租户的所有Pod都可能访问所有图像。</span><br><span class="line"><span class="bullet">- </span>运行需要授权的私有仓库。</span><br><span class="line"><span class="bullet">- </span>为每个租户生成仓库凭据，保密，并为每个租户命名空间填充机密。</span><br><span class="line"><span class="bullet">- </span>租户将这个秘密添加到每个命名空间的imagePullSecrets。</span><br><span class="line"></span><br><span class="line"><span class="section">### 容器环境变量</span></span><br><span class="line">此页面描述Container环境中Container可用的资源。</span><br><span class="line"></span><br><span class="line"><span class="section">#### 容器环境</span></span><br><span class="line">Kubernetes Container环境为容器提供了几个重要资源：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>文件系统，是镜像和一个或多个卷的组合。</span><br><span class="line"><span class="bullet">- </span>有关Container本身的信息。</span><br><span class="line"><span class="bullet">- </span>有关群集中其他对象的信息。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 容器信息</span></span><br><span class="line">Container 的主机名是运行Container的Pod的名称。它可以通过 libc中的<span class="code">``hostname`</span><span class="code">`命令或 [`</span><span class="code">`gethostname`</span>`](http://man7.org/linux/man-pages/man2/gethostname.2.html)函数调用获得。</span><br><span class="line"></span><br><span class="line">Pod名称和命名空间可通过[<span class="string">向下API</span>](<span class="link">https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/</span>)作为环境变量使用 。</span><br><span class="line"></span><br><span class="line">Pod定义中的用户定义环境变量也可用于Container，Docker镜像中静态指定的任何环境变量也是如此。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 群集信息</span></span><br><span class="line">创建Container时运行的所有服务的列表可作为环境变量用于该Container。这些环境变量与Docker链接的语法相匹配。</span><br><span class="line"></span><br><span class="line">对于名为foo的映射到名为bar的Container 的服务，定义了以下变量：</span><br></pre></td></tr></table></figure>
<p>FOO_SERVICE_HOST=<the host="" the="" service="" is="" running="" on=""><br>FOO_SERVICE_PORT=<the port="" the="" service="" is="" running="" on=""><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">服务具有专用IP地址，如果启用了[DNS插件](http:<span class="comment">//releases.k8s.io/master/cluster/addons/dns/)，则可通过DNS使用Container 。 </span></span><br><span class="line"></span><br><span class="line">### 运行时类</span><br><span class="line">特征状态： Kubernetes v1<span class="number">.12</span></span><br><span class="line">该页面描述了RuntimeClass资源和运行时选择机制。</span><br><span class="line"></span><br><span class="line">&gt; 此功能目前处于alpha状态，意思是：</span><br><span class="line">版本名称包含alpha（例如v1alpha1）。</span><br><span class="line">可能是马车。启用该功能可能会暴露错误。默认情况下禁用。</span><br><span class="line">可随时删除对功能的支持，恕不另行通知。</span><br><span class="line">API可能会在以后的软件版本中以不兼容的方式更改，恕不另行通知。</span><br><span class="line">由于错误风险增加和缺乏长期支持，建议仅在短期测试集群中使用。</span><br><span class="line"></span><br><span class="line">#### 运行时类</span><br><span class="line">RuntimeClass是一个alpha功能，用于选择用于运行pod容器的容器运行时配置。</span><br><span class="line"></span><br><span class="line">##### 建立</span><br><span class="line">作为早期的alpha功能，必须采取一些额外的设置步骤才能使用RuntimeClass功能：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 启用RuntimeClass功能门（在apiservers＆kubelets上，需要<span class="number">1.12</span>+版本）</span><br><span class="line"><span class="number">2.</span> 安装RuntimeClass CRD</span><br><span class="line"><span class="number">3.</span> 在节点上配置CRI实现（取决于运行时）</span><br><span class="line"><span class="number">4.</span> 创建相应的RuntimeClass资源</span><br><span class="line"></span><br><span class="line">##### <span class="number">1.</span>启用RuntimeClass feature gate</span><br><span class="line">有关启用feature gates的说明，请参见[feature gates](https:<span class="comment">//kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/)。必须在apiservers和kubelet上启用``RuntimeClass``功能门。</span></span><br><span class="line"></span><br><span class="line">##### <span class="number">2.</span>安装RuntimeClass CRD</span><br><span class="line">RuntimeClass [CustomResourceDefinition](https:<span class="comment">//kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/)（CRD）可以在Kubernetes git repo的addons目录中找到：``kubernetes / cluster / addons / runtimeclass / runtimeclass_crd.yaml``</span></span><br><span class="line"></span><br><span class="line">安装CRD ``kubectl apply -f runtimeclass_crd.yaml``。</span><br><span class="line"></span><br><span class="line">##### <span class="number">3.</span>在节点上配置CRI实现</span><br><span class="line">使用RuntimeClass进行选择的配置取决于CRI实现。有关如何配置的信息，请参阅CRI实现的相应文档。由于这是一个alpha功能，并非所有CRI都支持多个RuntimeClasses。</span><br><span class="line"></span><br><span class="line">&gt; 注意： RuntimeClass当前假定整个集群中的同类节点配置（这意味着所有节点的配置方式与容器运行时相同）。任何异构性（变化的配置）必须通过调度功能独立于RuntimeClass进行管理（请参阅[将Pod分配给节点](https:<span class="comment">//kubernetes.io/docs/concepts/configuration/assign-pod-node/)）。</span></span><br><span class="line"></span><br><span class="line">配置具有相应的``RuntimeHandler``名称，由RuntimeClass引用。RuntimeHandler必须是有效的DNS <span class="number">1123</span>子域（字母数字``+`` ``-``和``.``字符）。</span><br><span class="line"></span><br><span class="line">##### <span class="number">4.</span>创建相应的RuntimeClass资源</span><br><span class="line">步骤<span class="number">3</span>中的配置设置应各自具有关联的``RuntimeHandler``名称，用于标识配置。对于每个RuntimeHandler（以及可选的空<span class="string">""</span>处理程序），创建相应的RuntimeClass对象。</span><br><span class="line"></span><br><span class="line">RuntimeClass资源当前只有<span class="number">2</span>个重要字段：RuntimeClass name（``metadata.name``）和RuntimeHandler（``spec.runtimeHandler``）。对象定义如下所示：</span><br></pre></td></tr></table></figure></the></the></p>
<p>apiVersion: node.k8s.io/v1alpha1  # RuntimeClass is defined in the node.k8s.io API group<br>kind: RuntimeClass<br>metadata:<br>  name: myclass  # The name the RuntimeClass will be referenced by</p>
<h1 id="RuntimeClass-is-a-non-namespaced-resource"><a href="#RuntimeClass-is-a-non-namespaced-resource" class="headerlink" title="RuntimeClass is a non-namespaced resource"></a>RuntimeClass is a non-namespaced resource</h1><p>spec:<br>  runtimeHandler: myconfiguration  # The name of the corresponding CRI configuration<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 注意：建议将RuntimeClass写入操作（create <span class="regexp">/ update /</span> patch <span class="regexp">/ delete）限制为群集管理员。这通常是默认值。有关详细信息，请参阅[授权概述](https:/</span><span class="regexp">/kubernetes.io/</span>docs<span class="regexp">/reference/</span>access-authn-authz<span class="regexp">/authorization/</span>)。</span><br><span class="line"></span><br><span class="line"><span class="comment">##### 用法</span></span><br><span class="line">为集群配置RuntimeClasses后，使用它们非常简单。runtimeClassName在Pod规范中指定a 。例如：</span><br></pre></td></tr></table></figure></p>
<p>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: mypod<br>spec:<br>  runtimeClassName: myclass</p>
<h1 id="…-16"><a href="#…-16" class="headerlink" title="…"></a>…</h1><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">这将指示Kubelet使用命名的RuntimeClass来运行此pod。如果命名的RuntimeClass不存在，或者CRI无法运行相应的处理程序，则pod将进入 ``Failed``终端[阶段](https:<span class="comment">//kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-phase)。查找错误消息的相应[事件](https://kubernetes.io/docs/tasks/debug-application-cluster/debug-application-introspection/)。</span></span><br><span class="line"></span><br><span class="line">如果未``runtimeClassName``指定，则将使用默认的RuntimeHandler，这相当于禁用RuntimeClass功能时的行为。</span><br><span class="line"></span><br><span class="line">### 容器生命周期钩子</span><br><span class="line">此页面描述了kubelet管理的容器如何使用Container生命周期钩子框架来运行在管理生命周期中由事件触发的代码。</span><br><span class="line"></span><br><span class="line">- 概观</span><br><span class="line">- 集装箱挂钩</span><br><span class="line"></span><br><span class="line">#### 概观</span><br><span class="line">类似于许多具有组件生命周期钩子的编程语言框架，例如Angular，Kubernetes为Containers提供了生命周期钩子。钩子使Container能够了解其管理生命周期中的事件，并在执行相应的生命周期钩子时运行在处理程序中实现的代码。</span><br><span class="line"></span><br><span class="line">#### 容器钩子</span><br><span class="line">有两个暴露给容器的钩子：</span><br><span class="line"></span><br><span class="line">``PostStart``</span><br><span class="line"></span><br><span class="line">在创建容器后立即执行此挂钩。但是，无法保证挂钩将在容器ENTRYPOINT之前执行。没有参数传递给处理程序。</span><br><span class="line"></span><br><span class="line">``PreStop``</span><br><span class="line"></span><br><span class="line">在容器终止之前立即调用此挂钩。它是阻塞的，意味着它是同步的，所以它必须在删除容器的调用之前完成。没有参数传递给处理程序。</span><br><span class="line"></span><br><span class="line">终止行为的更详细描述可以在[终端中](https:<span class="comment">//kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods)找到 。</span></span><br><span class="line"></span><br><span class="line">##### 钩子处理程序实现</span><br><span class="line">容器可以通过实现和注册该钩子的处理程序来访问钩子。可以为Container实现两种类型的钩子处理程序：</span><br><span class="line"></span><br><span class="line">- Exec - 执行特定命令，例如``pre-stop.sh``，在Container的cgroups和名称空间内。命令消耗的资源将根据Container计算。</span><br><span class="line">- HTTP - 对Container上的特定端点执行HTTP请求。</span><br><span class="line"></span><br><span class="line">##### 钩子处理程序执行</span><br><span class="line">调用Container生命周期管理挂钩时，Kubernetes管理系统会在为该挂钩注册的Container中执行处理程序。 </span><br><span class="line"></span><br><span class="line">钩子处理程序调用在包含Container的Pod的上下文中是同步的。这意味着对于一个``PostStart``钩子，Container ENTRYPOINT和钩子异步发射。但是，如果挂钩运行或挂起太长时间，则Container无法达到某种``running``状态。</span><br><span class="line"></span><br><span class="line">``PreStop``钩子的行为类似。如果钩子在执行期间挂起，则Pod阶段将保持``Terminating``状态并在``terminationGracePeriodSecondspod``结束后被杀死。如果一个 ``PostStart``或``PreStophook``失败，则会终止Container。</span><br><span class="line"></span><br><span class="line">用户应使其钩子处理程序尽可能轻量级。但是，有些情况下，长时间运行的命令是有意义的，例如在停止Container之前保存状态。</span><br><span class="line"></span><br><span class="line">##### 挂钩送货保证</span><br><span class="line">钩子传递至少是一次，这意味着可以为任何给定事件多次调用钩子，例如for ``PostStart``或``PreStop``。由钩子实现来正确处理这个问题。</span><br><span class="line"></span><br><span class="line">通常，只进行单次交付。例如，如果HTTP挂钩接收器关闭且无法获取流量，则不会尝试重新发送。然而，在一些罕见的情况下，可能会发生双重递送。例如，如果一个kubelet在发送一个钩子的过程中重新启动，那么在该kubelet重新启动后可能会重新发送一个钩子。</span><br><span class="line"></span><br><span class="line">##### 调试Hook处理程序</span><br><span class="line">在Pod事件中不公开Hook处理程序的日志。如果处理程序由于某种原因失败，它会广播一个事件。因为``PostStart``，这是``FailedPostStartHook``事件，因为``PreStop``这是``FailedPreStopHook``事件。您可以通过运行来查看这些事件``kubectl describe pod &lt;pod_name&gt;``。以下是运行此命令的一些事件输出示例：</span><br></pre></td></tr></table></figure>
<p>Events:<br>  FirstSeen    LastSeen    Count    From                            SubobjectPath        Type        Reason        Message</p>
<hr>
<p>  1m        1m        1    {default-scheduler }                                Normal        Scheduled    Successfully assigned test-1730497541-cq1d2 to gke-test-cluster-default-pool-a07e5d30-siqd<br>  1m        1m        1    {kubelet gke-test-cluster-default-pool-a07e5d30-siqd}    spec.containers{main}    Normal        Pulling        pulling image “test:1.0”<br>  1m        1m        1    {kubelet gke-test-cluster-default-pool-a07e5d30-siqd}    spec.containers{main}    Normal        Created        Created container with docker id 5c6a256a2567; Security:[seccomp=unconfined]<br>  1m        1m        1    {kubelet gke-test-cluster-default-pool-a07e5d30-siqd}    spec.containers{main}    Normal        Pulled        Successfully pulled image “test:1.0”<br>  1m        1m        1    {kubelet gke-test-cluster-default-pool-a07e5d30-siqd}    spec.containers{main}    Normal        Started        Started container with docker id 5c6a256a2567<br>  38s        38s        1    {kubelet gke-test-cluster-default-pool-a07e5d30-siqd}    spec.containers{main}    Normal        Killing        Killing container with docker id 5c6a256a2567: PostStart handler: Error executing in Docker Container: 1<br>  37s        37s        1    {kubelet gke-test-cluster-default-pool-a07e5d30-siqd}    spec.containers{main}    Normal        Killing        Killing container with docker id 8df9fdfd7054: PostStart handler: Error executing in Docker Container: 1<br>  38s        37s        2    {kubelet gke-test-cluster-default-pool-a07e5d30-siqd}                Warning        FailedSync    Error syncing pod, skipping: failed to “StartContainer” for “main” with RunContainerError: “PostStart handler: Error executing in Docker Container: 1”<br>  1m         22s         2     {kubelet gke-test-cluster-default-pool-a07e5d30-siqd}    spec.containers{main}    Warning        FailedPostStartHook<br>  <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line"><span class="section">##   Workloads</span></span><br><span class="line"><span class="section">### Pods</span></span><br><span class="line"><span class="section">#### Pod概述</span></span><br><span class="line">此页面概述Pod了Kubernetes对象模型中最小的可部署对象。</span><br><span class="line"><span class="bullet">- </span>了解Pods</span><br><span class="line"><span class="bullet">- </span>使用Pods</span><br><span class="line"><span class="bullet">- </span>Pod模板</span><br><span class="line"></span><br><span class="line"><span class="section">##### 了解Pods</span></span><br><span class="line">一个pod是在创建或部署Kubernetes对象模型Kubernetes-最小最简单的单元的基本构建块。Pod表示群集上正在运行的进程。</span><br><span class="line"></span><br><span class="line">Pod封装了一个应用程序容器（或者，在某些情况下，多个容器），存储资源，一个唯一的网络IP以及控制容器应该如何运行的选项。Pod表示部署单元：Kubernetes中的单个应用程序实例，可能包含单个容器或少量紧密耦合且共享资源的容器。</span><br><span class="line"></span><br><span class="line">[<span class="string">Docker</span>](<span class="link">https://www.docker.com/</span>)是Kubernetes Pod中最常用的容器运行时，但Pods也支持其他容器运行时。</span><br><span class="line"></span><br><span class="line">Kubernetes集群中的Pod可以以两种主要方式使用：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span><span class="strong">**运行单个容器的Pod**</span>。“one-container-per-Pod”模型是最常见的Kubernetes用例; 在这种情况下，您可以将Pod视为单个容器的包装，而Kubernetes直接管理Pod而不是容器。</span><br><span class="line"><span class="bullet">- </span><span class="strong">**运行多个需要协同工作的容器的Pod**</span>。Pod可以封装由多个共址容器组成的应用程序，这些容器紧密耦合并需要共享资源。这些共处一地的容器可能形成一个统一的服务单元 - 一个容器从共享卷向公众提供文件，而一个单独的“sidecar”容器刷新或更新这些文件。Pod将这些容器和存储资源作为单个可管理实体包装在一起。</span><br><span class="line"></span><br><span class="line">该[<span class="string">Kubernetes博客</span>](<span class="link">http://kubernetes.io/blog</span>)对pod用例一些额外的信息。有关更多信息，请参阅：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>[<span class="string">分布式系统工具包：复合容器的模式</span>](<span class="link">https://kubernetes.io/blog/2015/06/the-distributed-system-toolkit-patterns</span>)</span><br><span class="line"><span class="bullet">- </span>[<span class="string">容器设计模式</span>](<span class="link">https://kubernetes.io/blog/2016/06/container-design-patterns</span>)</span><br><span class="line"></span><br><span class="line">每个Pod都用于运行给定应用程序的单个实例。如果要水平扩展应用程序（例如，运行多个实例），则应使用多个Pod，每个实例一个。在Kubernetes中，这通常被称为复制。复制Pod通常由称为Controller的抽象创建和管理。有关更多信息，请参阅[<span class="string">Pod和控制器</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/#pods-and-controllers</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">###### Pod如何管理多个容器</span></span><br><span class="line">Pod旨在支持多个协作流程（作为容器），形成一个有凝聚力的服务单元。Pod中的容器自动位于群集中的同一物理或虚拟机上，并共同调度。容器可以共享资源和依赖关系，彼此通信，并协调它们何时以及如何终止。</span><br><span class="line"></span><br><span class="line">请注意，在单个Pod中对多个共存和共同管理的容器进行分组是一个相对高级的用例。您应该仅在容器紧密耦合的特定实例中使用此模式。例如，您可能有一个容器充当共享卷中文件的Web服务器，以及一个单独的“sidecar”容器，用于从远程源更新这些文件，如下图所示：</span><br><span class="line">![<span class="string">image</span>](<span class="link">https://d33wubrfki0l68.cloudfront.net/aecab1f649bc640ebef1f05581bfcc91a48038c4/728d6/images/docs/pod.svg</span>)</span><br><span class="line"></span><br><span class="line"><span class="strong">**pod diagram**</span></span><br><span class="line"></span><br><span class="line">Pod为其组成容器提供两种共享资源：网络和存储。</span><br><span class="line"></span><br><span class="line"><span class="strong">**联网**</span></span><br><span class="line"></span><br><span class="line">每个Pod都分配有唯一的IP地址。Pod中的每个容器都共享网络命名空间，包括IP地址和网络端口。Pod内的容器可以使用相互通信<span class="code">``localhost`</span>`。当Pod中的容器与Pod 外部的实体通信时，它们必须协调它们如何使用共享网络资源（例如端口）。</span><br><span class="line"></span><br><span class="line"><span class="strong">**存储**</span></span><br><span class="line"></span><br><span class="line">Pod可以指定一组共享存储卷。Pod中的所有容器都可以访问共享卷，允许这些容器共享数据。如果需要重新启动其中一个容器，则卷还允许Pod中的持久数据存活。见卷上Kubernetes如何实现一个pod里的共享存储更多的信息。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 使用Pods</span></span><br><span class="line">你很少直接在Kubernetes - 甚至是单身Pod中创建单独的Pod。这是因为Pods被设计为相对短暂的一次性实体。当创建Pod（由您直接创建或由Controller间接创建）时，它将被安排在群集中的节点上运行。Pod保留在该节点上，直到进程终止，pod对象被删除，pod 因资源不足而被驱逐，或者Node失败。</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：不应将重新启动Pod重新启动Pod中的容器。Pod本身不会运行，但是容器运行的环境会持续存在，直到删除为止。</span></span><br><span class="line"></span><br><span class="line">pod本身不能自我修复。如果将Pod调度到失败的节点，或者调度操作本身失败，则删除Pod; 同样，由于缺乏资源或节点维护，Pod将无法在驱逐中存活。Kubernetes使用更高级别的抽象，称为Controller，它处理管理相对可处理的Pod实例的工作。因此，虽然可以直接使用Pod，但在Kubernetes中使用Controller管理pod更为常见。见[<span class="string">pod和控制器</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/#pods-and-controllers</span>)上Kubernetes如何使用控制器来实现pod缩放和愈合的更多信息。</span><br><span class="line"></span><br><span class="line"><span class="section">###### pod和控制器</span></span><br><span class="line">Controller可以为您创建和管理多个Pod，处理复制和部署，并在集群范围内提供自我修复功能。例如，如果节点发生故障，Controller可能会通过在不同节点上安排相同的替换来自动替换Pod。</span><br><span class="line"></span><br><span class="line">包含一个或多个pod的控制器的一些示例包括：</span><br><span class="line"><span class="bullet">- </span>[<span class="string">部署</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</span>)</span><br><span class="line"><span class="bullet">- </span>[<span class="string">StatefulSet</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/</span>)</span><br><span class="line"><span class="bullet">- </span>[<span class="string">DaemonSet</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/</span>)</span><br><span class="line"></span><br><span class="line">通常，控制器使用您提供的Pod模板来创建它负责的Pod。</span><br><span class="line"></span><br><span class="line"><span class="section">##### Pod模板</span></span><br><span class="line">Pod模板是pod规范，包含在其他对象中，例如 [<span class="string">Replication Controllers</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/</span>)，[<span class="string">Jobs</span>](<span class="link">https://kubernetes.io/docs/concepts/jobs/run-to-completion-finite-workloads/</span>)和 [<span class="string">DaemonSets</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/</span>)。控制器使用Pod模板制作实际的pod。下面的示例是Pod的简单清单，其中包含一个打印消息的容器。</span><br></pre></td></tr></table></figure></p>
<p>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: myapp-pod<br>  labels:<br>    app: myapp<br>spec:<br>  containers:</p>
<ul>
<li>name: myapp-container<br>image: busybox<br>command: [‘sh’, ‘-c’, ‘echo Hello Kubernetes! &amp;&amp; sleep 3600’]<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">pod模板不是指定所有副本的当前所需状态，而是像cookie 切割机。切割 cookie后，cookie与切割机无关。没有“量子纠缠”。对模板的后续更改甚至切换到新模板对已创建的pod没有直接影响。类似地，随后可以直接更新由复制控制器创建的pod。这与pod有意对比，pod确实指定了属于pod的所有容器的当前所需状态。这种方法从根本上简化了系统语义并增加了原语的灵活性。</span><br><span class="line"></span><br><span class="line"><span class="section">#### Pods</span></span><br><span class="line">pods是可以创建和管理Kubernetes计算的最小可部署单元。</span><br><span class="line"><span class="bullet">- </span>什么是Pod？</span><br><span class="line"><span class="bullet">- </span>pod的动机</span><br><span class="line"><span class="bullet">- </span>pod的使用</span><br><span class="line"><span class="bullet">- </span>考虑的替代方案</span><br><span class="line"><span class="bullet">- </span>pod的耐久性（或缺乏）</span><br><span class="line"><span class="bullet">- </span>终止pod</span><br><span class="line"><span class="bullet">- </span>pod容器的特权模式</span><br><span class="line"><span class="bullet">- </span>API对象</span><br><span class="line"></span><br><span class="line"><span class="section">##### 什么是Pod？</span></span><br><span class="line">一个pod（如在whales或pea pod中）是一组一个或多个容器（如Docker容器），具有共享存储/网络，以及如何运行容器的规范。pod的内容始终位于同一位置并共同调度，并在共享上下文中运行。pod模拟特定于应用程序的“逻辑主机” - 它包含一个或多个相对紧密耦合的应用程序容器 - 在预容器世界中，在同一物理或虚拟机上执行意味着在同一逻辑主机上执行。</span><br><span class="line"></span><br><span class="line">虽然Kubernetes支持的容器运行时间多于Docker，但Docker是最常见的运行时，它有助于用Docker术语描述pod。</span><br><span class="line"></span><br><span class="line">pod的共享上下文是一组Linux命名空间，cgroup，以及可能的隔离方面 - 与隔离Docker容器相同的东西。在pod的上下文中，各个应用程序可能会应用进一步的子隔离。</span><br><span class="line"></span><br><span class="line">Pod中的容器共享IP地址和端口空间，并且可以通过它们找到彼此localhost。他们还可以使用标准的进程间通信（如SystemV信号量或POSIX共享内存）相互通信。不同pod中的容器具有不同的IP地址，并且在没有[<span class="string">特殊配置</span>](<span class="link">https://kubernetes.io/docs/concepts/policy/pod-security-policy/</span>)的情况下无法通过IPC进行通信 。这些容器通常通过Pod IP地址相互通信。</span><br><span class="line"></span><br><span class="line">pod中的应用程序还可以访问共享卷，共享卷被定义为pod的一部分，可以安装到每个应用程序的文件系统中。</span><br><span class="line"></span><br><span class="line">就[<span class="string">Docker</span>](<span class="link">https://www.docker.com/</span>)构造而言，pod被建模为一组具有共享命名空间和共享[<span class="string">卷</span>](<span class="link">https://kubernetes.io/docs/concepts/storage/volumes/</span>)的Docker容器 。</span><br><span class="line"></span><br><span class="line">与单个应用程序容器一样，pod被认为是相对短暂的（而不是持久的）实体。正如在pod的生命周期中所讨论的，创建pod，分配唯一ID（UID），并调度到它们保留的节点，直到终止（根据重启策略）或删除。如果节点终止，则在超时期限之后，将调度计划到该节点的Pod进行删除。给定的pod（由UID定义）不会“重新安排”到新节点; 相反，它可以被相同的pod替换，如果需要，甚至可以使用相同的名称，但是使用新的UID（有关更多详细信息，请参阅[<span class="string">复制控制器</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/</span>)）。</span><br><span class="line"></span><br><span class="line">当某些东西被认为具有与容量相同的生命周期时，例如卷，这意味着只要该容器（具有该UID）存在就存在。如果由于任何原因删除了该pod，即使创建了相同的替换，相关的东西（例如卷）也会被销毁并重新创建。</span><br><span class="line">![<span class="string">image</span>](<span class="link">https://d33wubrfki0l68.cloudfront.net/aecab1f649bc640ebef1f05581bfcc91a48038c4/728d6/images/docs/pod.svg</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">###### pod图</span></span><br><span class="line">一个多容器窗格，包含文件提取程序和Web服务器，该服务器使用持久卷在容器之间共享存储。</span><br><span class="line"></span><br><span class="line"><span class="section">##### pod的动机</span></span><br><span class="line"><span class="section">###### 管理</span></span><br><span class="line">Pod是多个合作过程模式的模型，形成了一个有凝聚力的服务单元。它们通过提供比其组成应用程序集更高级别的抽象来简化应用程序部署和管理。Pod用作部署，水平扩展和复制的单元。对容器中的容器自动处理共置（共同调度），共享命运（例如终止），协调复制，资源共享和依赖关系管理。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 资源共享和沟通</span></span><br><span class="line">Pod可以实现其成员之间的数据共享和通信。</span><br><span class="line"></span><br><span class="line">pod中的应用程序都使用相同的网络命名空间（相同的IP和端口空间），因此可以相互“找到”并使用它们进行通信<span class="code">``localhost`</span>`。因此，pod中的应用程序必须协调它们对端口的使用。每个pod在平面共享网络空间中具有IP地址，该网络空间与网络上的其他物理计算机和pod完全通信。</span><br><span class="line"></span><br><span class="line">主机名设置为pod中应用程序容器的pod名称。[<span class="string">关于网络的更多细节</span>](<span class="link">https://kubernetes.io/docs/concepts/cluster-administration/networking/</span>)。</span><br><span class="line"></span><br><span class="line">除了定义在pod中运行的应用程序容器之外，pod还指定了一组共享存储卷。卷使数据能够在容器重新启动后继续存在，并在容器内的应用程序之间共享。</span><br><span class="line"></span><br><span class="line"><span class="section">##### pod的使用</span></span><br><span class="line">Pod可用于托管垂直集成的应用程序堆栈（例如LAMP），但其主要动机是支持共址，共同管理的帮助程序，例如：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>内容管理系统，文件和数据加载器，本地缓存管理器等。</span><br><span class="line"><span class="bullet">- </span>日志和检查点备份，压缩，旋转，快照等</span><br><span class="line"><span class="bullet">- </span>数据变更观察者，日志零售商，日志和监控适配器，活动发布者等。</span><br><span class="line"><span class="bullet">- </span>代理，网桥和适配器</span><br><span class="line"><span class="bullet">- </span>控制器，管理器，配置器和更新器</span><br><span class="line"></span><br><span class="line">通常，单个pod不用于运行同一应用程序的多个实例。</span><br><span class="line"></span><br><span class="line">有关更长的说明，请参阅[<span class="string">分布式系统工具包：复合容器的模式</span>](<span class="link">https://kubernetes.io/blog/2015/06/the-distributed-system-toolkit-patterns</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 考虑的替代方案</span></span><br><span class="line">为什么不在一个（Docker）容器中运行多个程序？</span><br><span class="line"></span><br><span class="line"><span class="bullet">1. </span>透明度。使基础架构内的容器对基础架构可见，使基础架构能够为这些容器提供服务，例如进程管理和资源监视。这为用户提供了许多便利。</span><br><span class="line"><span class="bullet">2. </span>解耦软件依赖关系。各个容器可以独立地进行版本化，重建和重新部署。Kubernetes甚至有一天可能会支持单个容器的实时更新。</span><br><span class="line"><span class="bullet">3. </span>便于使用。用户无需运行自己的流程管理器，担心信号和退出代码传播等。</span><br><span class="line"><span class="bullet">4. </span>效率。由于基础设施承担更多责任，因此集装箱的重量可以更轻。</span><br><span class="line"></span><br><span class="line">为什么不支持基于亲和力的容器协同调度？</span><br><span class="line"></span><br><span class="line">这种方法可以提供协同定位，但不会提供pod的大部分好处，例如资源共享，IPC，保证命运共享和简化管理。</span><br><span class="line"></span><br><span class="line"><span class="section">##### pod的耐久性（或缺乏）</span></span><br><span class="line">pod不应被视为耐用实体。它们将无法在调度故障，节点故障或其他驱逐（例如由于缺乏资源）或节点维护的情况下存活。</span><br><span class="line"></span><br><span class="line">通常，用户不需要直接创建pod。他们应该几乎总是使用控制器，即使是singletons，例如， [<span class="string">部署</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</span>)。控制器提供集群范围的自我修复，以及复制和部署管理。像[<span class="string">StatefulSet</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/statefulset.md</span>)这样的控制器 也可以为有状态的pod提供支持。</span><br><span class="line"></span><br><span class="line">使用集合API作为主要的面向用户的原语在集群调度系统中相对常见，包括[<span class="string">Borg</span>](<span class="link">https://research.google.com/pubs/pub43438.html</span>)，[<span class="string">Marathon</span>](<span class="link">https://mesosphere.github.io/marathon/docs/rest-api.html</span>)，[<span class="string">Aurora</span>](<span class="link">http://aurora.apache.org/documentation/latest/reference/configuration/#job-schema</span>)和[<span class="string">Tupperware</span>](<span class="link">http://www.slideshare.net/Docker/aravindnarayanan-facebook140613153626phpapp02-37588997</span>)。</span><br><span class="line"></span><br><span class="line">Pod作为基元公开，以便于：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>调度程序和控制器可插拔性</span><br><span class="line"><span class="bullet">- </span>支持pod级操作，无需通过控制器API“代理”它们</span><br><span class="line"><span class="bullet">- </span>pod生命周期与控制器生命周期的解耦，例如引导</span><br><span class="line"><span class="bullet">- </span>控制器和服务的分离 - 端点控制器只是监视pod</span><br><span class="line"><span class="bullet">- </span>具有集群级功能的Kubelet级功能的清晰组合 - Kubelet实际上是“pod控制器”</span><br><span class="line"><span class="bullet">- </span>高可用性应用程序，它们将期望在终止之前更换pod，并且肯定在删除之前，例如在计划驱逐或图像预取的情况下。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 终止pod</span></span><br><span class="line">因为pod表示集群中节点上的正在运行的进程，所以允许这些进程在不再需要时优雅地终止（与使用KILL信号猛烈杀死并且没有机会清理）非常重要。用户应该能够请求删除并知道进程何时终止，但也能够确保删除最终完成。当用户请求删除pod时，系统会在允许pod强制终止之前记录预期的宽限期，并将TERM信号发送到每个容器中的主进程。宽限期到期后，KILL信号将发送到这些进程，然后从API服务器中删除该pod。如果在等待进程终止时重新启动Kubelet或容器管理器，</span><br><span class="line"></span><br><span class="line">一个示例流程：</span><br><span class="line"><span class="bullet">1. </span>用户发送删除Pod的命令，默认宽限期（30秒）</span><br><span class="line"><span class="bullet">2. </span>API服务器中的Pod随着时间的推移而更新，其中Pod被视为“死”以及宽限期。</span><br><span class="line"><span class="bullet">3. </span>在客户端命令中列出时，Pod显示为“终止”</span><br><span class="line"><span class="bullet">4. </span>（与3同时）当Kubelet看到Pod已被标记为终止，因为已经设置了2中的时间，它开始了pod关闭过程。</span><br><span class="line">   1. 如果其中一个Pod的容器定义了一个[<span class="string">preStop挂钩</span>](<span class="link">https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#hook-details</span>)，则会在容器内部调用它。如果在<span class="code">``preStop`</span>`宽限期到期后钩子仍在运行，则以小（2秒）延长的宽限期调用步骤2。</span><br><span class="line">   2. 容器被发送TERM信号。请注意，并非Pod中的所有容器都会同时收到TERM信号，并且<span class="code">``preStop`</span>`如果它们关闭的顺序很重要，则每个容器都需要一个钩子。</span><br><span class="line"><span class="bullet">5. </span>（与3同时）Pod从端点列表中删除以进行维护，并且不再被视为复制控制器的运行pod集的一部分。缓慢关闭的窗格无法继续提供流量，因为负载平衡器（如服务代理）会将其从旋转中移除。</span><br><span class="line"><span class="bullet">6. </span>当宽限期到期时，仍然在Pod中运行的任何进程都将被SIGKILL杀死。</span><br><span class="line"><span class="bullet">7. </span>Kubelet将通过设置宽限期0（立即删除）完成删除API服务器上的Pod。Pod从API中消失，不再从客户端可见。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">默认情况下，所有删除在30秒内都是正常的。该<span class="code">``kubectl delete`</span><span class="code">`命令支持`</span><span class="code">`--grace-period=&lt;seconds&gt;`</span><span class="code">`允许用户覆盖默认值并指定其自己的值的选项。值`</span><span class="code">`0 `</span><span class="code">`[force删除](https://kubernetes.io/docs/concepts/workloads/pods/pod/#force-deletion-of-pods) pod。在kubectl版本&gt; = 1.5时，必须指定一个额外的标志`</span><span class="code">`--force`</span><span class="code">`一起`</span><span class="code">`--grace-period=0`</span>`，以执行力的缺失。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 强制删除pod</span></span><br><span class="line">强制删除pod被定义为立即从群集状态和etcd删除pod。当执行强制删除时，许可证持有者不会等待来自kubelet的确认该pod已在其运行的节点上终止。它会立即删除API中的pod，以便可以使用相同的名称创建新的pod。在节点上，设置为立即终止的pod在被强制终止之前仍将被给予一个小的宽限期。</span><br><span class="line"></span><br><span class="line">强制删除可能对某些pod有潜在危险，应谨慎执行。如果是StatefulSet pod，请参阅任务文档以[<span class="string">从StatefulSet中删除</span>](<span class="link">https://kubernetes.io/docs/tasks/run-application/force-delete-stateful-set-pod/</span>) Pod 。</span><br><span class="line"></span><br><span class="line"><span class="section">##### pod容器的特权模式</span></span><br><span class="line">从Kubernetes v1.1开始，pod中的任何容器都可以使用容器规范中的<span class="code">``privileged`</span><span class="code">`标志启用特权模式`</span><span class="code">`SecurityContext`</span>`。这对于想要使用Linux功能（如操作网络堆栈和访问设备）的容器非常有用。容器内的进程获得与容器外部进程可用的几乎相同的权限。使用特权模式，将网络和卷插件编写为不需要编译到kubelet的独立窗格应该更容易。</span><br><span class="line"></span><br><span class="line">如果主服务器正在运行Kubernetes v1.1或更高版本，并且节点运行的版本低于v1.1，那么api-server将接受新的特权pod，但不会启动。他们将处于待决状态。如果用户呼叫<span class="code">``kubectl describe pod FooPodName`</span>`，用户可以查看pod处于暂挂状态的原因。describe命令输出中的events表将说：</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Error validating pod “FooPodName”.”FooPodNamespace” from api, ignoring: spec.containers[0].securityContext.privileged: forbidden ‘&lt;*&gt;(0xc2089d3248)true’<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">如果主服务器运行的版本低于<span class="built_in">v1</span>.<span class="number">1</span>，则无法创建特权pod。如果用户尝试创建具有特权容器的pod，则用户将收到以下错误：</span><br></pre></td></tr></table></figure></p>
<p>The Pod “FooPodName” is invalid. spec.containers[0].securityContext.privileged: forbidden ‘&lt;*&gt;(0xc20b222db0)true’<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">##### API对象</span></span><br><span class="line">Pod是Kubernetes REST API中的顶级资源。有关API对象的更多详细信息，请参阅： [<span class="string">Pod API对象</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#pod-v1-core</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">#### Pod生命周期</span></span><br><span class="line">该页面描述了Pod的生命周期。</span><br><span class="line"><span class="bullet">- </span>Pod阶段</span><br><span class="line"><span class="bullet">- </span>Pod条件</span><br><span class="line"><span class="bullet">- </span>容器探针</span><br><span class="line"><span class="bullet">- </span>Pod和Container状态</span><br><span class="line"><span class="bullet">- </span>Pod准备gate</span><br><span class="line"><span class="bullet">- </span>重启政策</span><br><span class="line"><span class="bullet">- </span>Pod寿命</span><br><span class="line"><span class="bullet">- </span>例子</span><br><span class="line"></span><br><span class="line"><span class="section">##### Pod阶段</span></span><br><span class="line">Pod的<span class="code">``status`</span><span class="code">`字段是 [PodStatus](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#podstatus-v1-core) 对象，它有一个`</span><span class="code">`phase`</span>`字段。</span><br><span class="line"></span><br><span class="line">Pod的阶段是Pod在其生命周期中的简单，高级摘要。该阶段不是对Container或Pod状态的全面观察汇总，也不是一个综合状态机。</span><br><span class="line"></span><br><span class="line">Pod阶段值的数量和含义受到严密保护。除了这里记录的内容之外，没有任何关于具有给定<span class="code">``phase`</span>`值的Pod的假设。</span><br><span class="line"></span><br><span class="line">以下是可能的值<span class="code">``phase`</span>`：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">值 | 描述</span><br><span class="line">---|---</span><br><span class="line"><span class="code">``Pending`</span>` | Pod已被Kubernetes系统接受，但尚未创建一个或多个Container图像。这包括计划之前的时间以及通过网络下载图像所花费的时间，这可能需要一段时间。</span><br><span class="line"><span class="code">``Running`</span>` | Pod已绑定到节点，并且已创建所有Container。至少有一个Container仍在运行，或者正在启动或重新启动。</span><br><span class="line"><span class="code">``Succeeded`</span>` | Pod中的所有容器都已成功终止，并且不会重新启动。</span><br><span class="line"><span class="code">``Failed`</span>` | Pod中的所有容器都已终止，并且至少有一个Container已终止失败。也就是说，Container要么退出非零状态，要么被系统终止。</span><br><span class="line"><span class="code">``Unknown`</span>` | 由于某种原因，无法获得Pod的状态，这通常是由于与Pod的主机通信时出错。</span><br><span class="line"></span><br><span class="line"><span class="section">##### Pod条件</span></span><br><span class="line">Pod有一个PodStatus，它有一个[<span class="string">PodConditions</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#podcondition-v1-core</span>)数组， Pod已经或没有通过它。PodCondition数组的每个元素都有六个可能的字段：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>该<span class="code">``lastProbeTime`</span>`字段提供上次探测Pod条件的时间戳。</span><br><span class="line"><span class="bullet">- </span>该<span class="code">``lastTransitionTime`</span>`字段提供Pod最后从一个状态转换到另一个状态的时间戳。</span><br><span class="line"><span class="bullet">- </span>该<span class="code">``message`</span>`字段是人类可读的消息，指示有关转换的详细信息。</span><br><span class="line"><span class="bullet">- </span>该<span class="code">``reason`</span>`字段是该条件最后一次转换的唯一，单字，CamelCase原因。</span><br><span class="line"><span class="bullet">- </span>该<span class="code">``status`</span><span class="code">`字段是一个字符串，可能的值为“ `</span><span class="code">`True`</span><span class="code">`”，“ `</span><span class="code">`False`</span><span class="code">`”和“ `</span><span class="code">`Unknown`</span>`”。</span><br><span class="line"><span class="bullet">- </span>该<span class="code">``type`</span>`字段是一个包含以下可能值的字符串：</span><br><span class="line">  - <span class="code">``PodScheduled`</span>`：Pod已被安排到一个节点;</span><br><span class="line">  - <span class="code">``Ready`</span>`：Pod可以提供请求，应该添加到所有匹配服务的负载平衡池中;</span><br><span class="line">  - <span class="code">``Initialized`</span>`：所有[<span class="string">init容器</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/pods/init-containers</span>) 都已成功启动;</span><br><span class="line">  - <span class="code">``Unschedulable`</span>`：调度程序现在无法调度Pod，例如由于缺少资源或其他限制;</span><br><span class="line">  - <span class="code">``ContainersReady`</span>`：Pod中的所有容器都已准备就绪。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 容器探针</span></span><br><span class="line">一个[<span class="string">探头</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#probe-v1-core</span>)是通过周期性地执行的诊断[<span class="string">kubelet </span>](<span class="link">https://kubernetes.io/docs/admin/kubelet/</span>)上的容器。为了执行诊断，kubelet调用Container实现的 [<span class="string">Handler</span>](<span class="link">https://godoc.org/k8s.io/kubernetes/pkg/api/v1#Handler</span>)。有三种类型的处理程序：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>[<span class="string">ExecAction</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#execaction-v1-core</span>)：在Container内执行指定的命令。如果命令以状态代码0退出，则认为诊断成功。</span><br><span class="line"><span class="bullet">- </span>[<span class="string">TCPSocketAction</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#tcpsocketaction-v1-core</span>)：对指定端口上的Container的IP地址执行TCP检查。如果端口打开，则诊断被认为是成功的。</span><br><span class="line"><span class="bullet">- </span>[<span class="string">HTTPGetAction</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#httpgetaction-v1-core</span>)：对指定端口和路径上的Container的IP地址执行HTTP Get请求。如果响应的状态代码大于或等于200且小于400，则认为诊断成功。</span><br><span class="line"></span><br><span class="line">每个探针都有三个结果之一：</span><br><span class="line"><span class="bullet">- </span>成功：Container通过了诊断。</span><br><span class="line"><span class="bullet">- </span>失败：容器未通过诊断。</span><br><span class="line"><span class="bullet">- </span>未知：诊断失败，因此不应采取任何措施。</span><br><span class="line"></span><br><span class="line">在运行容器时，kubelet可以选择性地执行和响应两种探测器：</span><br><span class="line"><span class="bullet">- </span><span class="code">``livenessProbe`</span><span class="code">`：指示Container是否正在运行。如果活动探测失败，则kubelet会杀死Container，并且Container将受其重启策略的约束。如果Container未提供活动探测，则默认状态为`</span><span class="code">`Success`</span>`。</span><br><span class="line"><span class="bullet">- </span><span class="code">``readinessProbe`</span><span class="code">`：指示Container是否已准备好为请求提供服务。如果准备就绪探测失败，则端点控制器会从与Pod匹配的所有服务的端点中删除Pod的IP地址。初始延迟之前的默认准备状态是`</span><span class="code">`Failure`</span><span class="code">`。如果Container未提供就绪探测，则默认状态为`</span><span class="code">`Success`</span>`。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 什么时候应该使用活力或准备探针？</span></span><br><span class="line">如果您的Container中的进程在遇到问题或变得不健康时能够自行崩溃，则您不一定需要活动探测器; kubelet将根据Pod的内容自动执行正确的操作<span class="code">``restartPolicy`</span>`。</span><br><span class="line"></span><br><span class="line">如果您希望在探测失败时杀死并重新启动Container，则指定活动探测，并指定<span class="code">``restartPolicy`</span>`Always或OnFailure。</span><br><span class="line"></span><br><span class="line">如果您只想在探测成功时开始向Pod发送流量，请指定准备探测。在这种情况下，准备情况探测可能与活动探测相同，但规范中存在准备探测意味着Pod将在不接收任何流量的情况下启动，并且仅在探测开始成功后才开始接收流量。</span><br><span class="line"></span><br><span class="line">如果Container需要在启动期间处理大型数据，配置文件或迁移，请指定就绪性探针。</span><br><span class="line"></span><br><span class="line">如果您希望Container能够自行维护，您可以指定一个就绪探针，用于检查特定于就绪状态的端点，该端点与活动探针不同。</span><br><span class="line"></span><br><span class="line">请注意，如果您只想在删除Pod时排除请求，则不一定需要准备探测; 在删除时，无论准备情况探测是否存在，Pod都会自动将其置于未准备状态。Pod在等待Pod中的容器停止时仍处于未准备状态。</span><br><span class="line"></span><br><span class="line">有关如何设置活动或准备情况探测的详细信息，请参阅 [<span class="string">配置活动和准备探测</span>](<span class="link">https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">##### Pod和Container状态</span></span><br><span class="line">有关Pod容器状态的详细信息，请参阅 [<span class="string">PodStatus </span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#podstatus-v1-core</span>)和 [<span class="string">ContainerStatus</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#containerstatus-v1-core</span>)。请注意，报告为Pod状态的信息取决于当前的 [<span class="string">ContainerState</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#containerstatus-v1-core</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">##### Pod准备gate</span></span><br><span class="line">特征状态： <span class="code">``Kubernetes v1.12`</span>`</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 此功能目前处于测试状态</span></span><br><span class="line"></span><br><span class="line">为了通过注入额外的反馈或信号来增加Pod准备的可扩展性<span class="code">``PodStatus`</span><span class="code">`，Kubernetes 1.11引入了一个名为[Pod ready ++](https://github.com/kubernetes/enhancements/blob/master/keps/sig-network/0007-pod-ready%2B%2B.md)的功能。您可以使用新的字段`</span><span class="code">`ReadinessGate`</span><span class="code">`中`</span><span class="code">`PodSpec`</span><span class="code">`指定波德准备进行评估附加条件。如果Kubernetes在`</span><span class="code">`status.conditionsPod`</span><span class="code">` 的字段中找不到这样的条件，则条件的状态默认为“ `</span><span class="code">`False`</span>`”。以下是一个例子：</span><br></pre></td></tr></table></figure></p>
<p>Kind: Pod<br>…<br>spec:<br>  readinessGates:</p>
<pre><code>- conditionType: &quot;www.example.com/feature-1&quot;
</code></pre><p>status:<br>  conditions:</p>
<pre><code>- type: Ready  # this is a builtin PodCondition
  status: &quot;True&quot;
  lastProbeTime: null
  lastTransitionTime: 2018-01-01T00:00:00Z
- type: &quot;www.example.com/feature-1&quot;   # an extra PodCondition
  status: &quot;False&quot;
  lastProbeTime: null
  lastTransitionTime: 2018-01-01T00:00:00Z
</code></pre><p>  containerStatuses:</p>
<pre><code>- containerID: docker://abcd...
  ready: true
</code></pre><p>…<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">新Pod条件必须符合Kubernetes [<span class="string">标签密钥格式</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#syntax-and-character-set</span>)。由于该<span class="code">``kubectl patch`</span><span class="code">`命令仍然不支持修补对象状态，因此必须`</span><span class="code">`PATCH`</span>`使用其中一个[<span class="string">KubeClient库</span>](<span class="link">https://kubernetes.io/docs/reference/using-api/client-libraries/</span>)通过操作注入新的Pod条件。</span><br><span class="line"></span><br><span class="line">随着新Pod条件的引入，<span class="strong">**只有**</span> 当以下两个语句都成立时，<span class="strong">**才会**</span>评估Pod是否就绪：</span><br><span class="line"><span class="bullet">- </span>Pod中的所有容器都已准备就绪。</span><br><span class="line"><span class="bullet">- </span>指定的所有条件<span class="code">``ReadinessGates`</span><span class="code">`均为“ `</span><span class="code">`True`</span>`”。</span><br><span class="line"></span><br><span class="line">为了便于对Pod准备评估进行此更改，<span class="code">``ContainersReady`</span><span class="code">`引入了一个新的Pod条件 来捕获旧的Pod `</span><span class="code">`Ready`</span>`条件。</span><br><span class="line"></span><br><span class="line">在K8s 1.11中，作为alpha功能，必须通过将<span class="code">``PodReadinessGates`</span>` 功能门设置 为true 来明确启用“Pod Ready ++”功能。</span><br><span class="line"></span><br><span class="line">在K8s 1.12中，默认情况下启用该功能。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 重启政策</span></span><br><span class="line">PodSpec的<span class="code">``restartPolicy`</span><span class="code">`字段可能包含Always，OnFailure和Never。默认值为Always。 `</span><span class="code">`restartPolicy`</span><span class="code">`适用于Pod中的所有容器。`</span><span class="code">`restartPolicy`</span>`仅指由同一节点上的kubelet重新启动Container。由kubelet重新启动的已退出容器将以指数退避延迟（10秒，20秒，40秒......）重新启动，上限为五分钟，并在成功执行十分钟后重置。正如[<span class="string">Pods文档</span>](<span class="link">https://kubernetes.io/docs/user-guide/pods/#durability-of-pods-or-lack-thereof</span>)中所讨论的 ，一旦绑定到节点，Pod将永远不会被反弹到另一个节点。</span><br><span class="line"></span><br><span class="line"><span class="section">##### Pod寿命</span></span><br><span class="line">一般来说，pod不会消失，直到有人摧毁它们。这可能是人或控制者。此规则的唯一例外是具有<span class="code">``phase`</span><span class="code">`成功或失败超过一定持续时间（由`</span><span class="code">`terminated-pod-gc-threshold`</span>`master确定）的Pod将过期并自动销毁。</span><br><span class="line"></span><br><span class="line">有三种控制器可供选择：</span><br><span class="line"><span class="bullet">- </span>使用[<span class="string">Job</span>](<span class="link">https://kubernetes.io/docs/concepts/jobs/run-to-completion-finite-workloads/</span>) for Pods预期终止，例如批量计算。作业仅适用于 <span class="code">``restartPolicy`</span>`等于OnFailure或Never的Pod。</span><br><span class="line"><span class="bullet">- </span>对不希望终止的[<span class="string">Pod</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/</span>)（例如，Web服务器）使用[<span class="string">ReplicationController</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/</span>)， [<span class="string">ReplicaSet</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/</span>)或 [<span class="string">Deployment</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</span>)。ReplicationControllers仅适用于具有<span class="code">``restartPolicy`</span>`Always的Pod。</span><br><span class="line"><span class="bullet">- </span>使用需要为每台计算机运行一个的[<span class="string">Pod的DaemonSet</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/</span>)，因为它们提供特定于计算机的系统服务。</span><br><span class="line"></span><br><span class="line">所有三种类型的控制器都包含PodTemplate。建议创建适当的控制器并让它创建Pod，而不是自己直接创建Pod。这是因为Pods单独对机器故障没有弹性，但是控制器是。</span><br><span class="line"></span><br><span class="line">如果节点死亡或与群集的其余部分断开连接，Kubernetes会应用策略<span class="code">``phase`</span>`将丢失节点上的所有Pod设置为Failed。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 例子</span></span><br><span class="line"><span class="section">###### 高级活动探测示例</span></span><br><span class="line">活动探测由kubelet执行，因此所有请求都在kubelet网络名称空间中进行。</span><br></pre></td></tr></table></figure></p>
<p>apiVersion: v1<br>kind: Pod<br>metadata:<br>  labels:<br>    test: liveness<br>  name: liveness-http<br>spec:<br>  containers:</p>
<ul>
<li>args:<ul>
<li>/server<br>image: k8s.gcr.io/liveness<br>livenessProbe:<br>httpGet:<h1 id="when-“host”-is-not-defined-“PodIP”-will-be-used"><a href="#when-“host”-is-not-defined-“PodIP”-will-be-used" class="headerlink" title="when “host” is not defined, “PodIP” will be used"></a>when “host” is not defined, “PodIP” will be used</h1><h1 id="host-my-host"><a href="#host-my-host" class="headerlink" title="host: my-host"></a>host: my-host</h1><h1 id="when-“scheme”-is-not-defined-“HTTP”-scheme-will-be-used-Only-“HTTP”-and-“HTTPS”-are-allowed"><a href="#when-“scheme”-is-not-defined-“HTTP”-scheme-will-be-used-Only-“HTTP”-and-“HTTPS”-are-allowed" class="headerlink" title="when “scheme” is not defined, “HTTP” scheme will be used. Only “HTTP” and “HTTPS” are allowed"></a>when “scheme” is not defined, “HTTP” scheme will be used. Only “HTTP” and “HTTPS” are allowed</h1><h1 id="scheme-HTTPS"><a href="#scheme-HTTPS" class="headerlink" title="scheme: HTTPS"></a>scheme: HTTPS</h1>  path: /healthz<br>  port: 8080<br>  httpHeaders:<ul>
<li>name: X-Custom-Header<br>value: Awesome<br>initialDelaySeconds: 15<br>timeoutSeconds: 1<br>name: liveness<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">###### 示例状态</span><br><span class="line">-<span class="ruby"> Pod正在运行并有一个Container。集装箱出口成功。</span></span><br><span class="line"><span class="ruby">  - 记录完成事件。</span></span><br><span class="line"><span class="ruby">  - 如果<span class="string">``</span>restartPolicy<span class="string">``</span>是：</span></span><br><span class="line"><span class="ruby">    - 始终：重启容器; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">    - OnFailure：Pod <span class="string">``</span>phase<span class="string">``</span>成功。</span></span><br><span class="line"><span class="ruby">    - 从不：Pod <span class="string">``</span>phase<span class="string">``</span>成功。</span></span><br><span class="line"><span class="ruby">- Pod正在运行并有一个Container。容器退出失败。</span></span><br><span class="line"><span class="ruby">  - 记录失败事件。</span></span><br><span class="line"><span class="ruby">  - 如果<span class="string">``</span>restartPolicy<span class="string">``</span>是：</span></span><br><span class="line"><span class="ruby">    - 始终：重启容器; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">    - OnFailure：重启容器; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">    - 从不：Pod <span class="string">``</span>phase<span class="string">``</span>变得失败。</span></span><br><span class="line"><span class="ruby">- Pod正在运行并有两个容器。容器<span class="number">1</span>出现故障。</span></span><br><span class="line"><span class="ruby">  - 记录失败事件。</span></span><br><span class="line"><span class="ruby">  - 如果<span class="string">``</span>restartPolicy<span class="string">``</span>是：</span></span><br><span class="line"><span class="ruby">    - 始终：重启容器; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">    - OnFailure：重启容器; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">    - 从不：不要重启容器; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">  - 如果Container <span class="number">1</span>未运行，并且Container <span class="number">2</span>退出：</span></span><br><span class="line"><span class="ruby">    - 记录失败事件。</span></span><br><span class="line"><span class="ruby">    - 如果<span class="string">``</span>restartPolicy<span class="string">``</span>是：</span></span><br><span class="line"><span class="ruby">      - 始终：重启容器; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">      - OnFailure：重启容器; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">      - 从不：Pod <span class="string">``</span>phase<span class="string">``</span>变得失败。</span></span><br><span class="line"><span class="ruby">- Pod正在运行并有一个Container。容器耗尽内存。</span></span><br><span class="line"><span class="ruby">  - 记录失败事件。</span></span><br><span class="line"><span class="ruby">  - 记录OOM事件。</span></span><br><span class="line"><span class="ruby">  - 如果<span class="string">``</span>restartPolicy<span class="string">``</span>是：</span></span><br><span class="line"><span class="ruby">    - 始终：重启容器; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">    - OnFailure：重启容器; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">    - 从不：记录失败事件; Pod <span class="string">``</span>phase<span class="string">``</span>保持运行状态。</span></span><br><span class="line"><span class="ruby">- Pod正在运行，磁盘已经死亡。</span></span><br><span class="line"><span class="ruby">  - 杀死所有容器。</span></span><br><span class="line"><span class="ruby">  - 记录适当的事件。</span></span><br><span class="line"><span class="ruby">  - Pod <span class="string">``</span>phase<span class="string">``</span>变得失败。</span></span><br><span class="line"><span class="ruby">  - 如果在控制器下运行，Pod将在其他位置重新创建。</span></span><br><span class="line"><span class="ruby">- Pod正在运行，其节点已分段。</span></span><br><span class="line"><span class="ruby">  - 杀死所有容器。</span></span><br><span class="line"><span class="ruby">  - 记录适当的事件。</span></span><br><span class="line"><span class="ruby">  - Pod <span class="string">``</span>phase<span class="string">``</span>变得失败。</span></span><br><span class="line"><span class="ruby">  - 如果在控制器下运行，Pod将在其他位置重新创建。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment">#### 初始容器</span></span></span><br><span class="line"><span class="ruby">此页面提供了Init Containers的概述，它是在应用程序容器之前运行的专用容器，可以包含应用程序映像中不存在的实用程序或设置脚本。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">- 了解Init容器</span></span><br><span class="line"><span class="ruby">- Init容器可以用于什么？</span></span><br><span class="line"><span class="ruby">- 详细的行为</span></span><br><span class="line"><span class="ruby">- 支持和兼容性</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment">##### 了解Init容器</span></span></span><br><span class="line"><span class="ruby">一个[pod](<span class="symbol">https:</span>/<span class="regexp">/kubernetes.io/docs</span><span class="regexp">/concepts/workloads</span><span class="regexp">/pods/pod</span>-overview/)能够在其内运行的应用程序的多个容器，但它也可以有一个或多个初始化容器，该容器的应用容器启动之前运行。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Init容器与常规容器完全相同，除了：</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">- 他们总是跑完成。</span></span><br><span class="line"><span class="ruby">- 每个人必须在下一个启动之前成功完成。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">如果Init容器的Init容器失败，Kubernetes会重复重启Pod，直到Init容器成功。但是，如果Pod具有<span class="string">``</span>restartPolicy<span class="string">``</span>Never，则不会重新启动。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">要将Container指定为Init容器，请将<span class="string">``</span>initContainers<span class="string">``</span>PodSpec上的字段添加 为应用程序数组旁边的[Container](<span class="symbol">https:</span>/<span class="regexp">/kubernetes.io/docs</span><span class="regexp">/reference/generated</span><span class="regexp">/kubernetes-api/v</span>1.<span class="number">13</span>/<span class="comment">#container-v1-core)类型的JSON containers数组。init容器的状态在``.status.initContainerStatuses ``字段中作为容器状态的数组返回（类似于``.status.containerStatuses ``字段）。</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment">###### 与常规容器的差异</span></span></span><br><span class="line"><span class="ruby">Init Containers支持应用容器的所有字段和功能，包括资源限制，卷和安全设置。但是，Init容器的资源请求和限制的处理方式略有不同，这些内容在下面的[参考资料](<span class="symbol">https:</span>/<span class="regexp">/kubernetes.io/docs</span><span class="regexp">/concepts/workloads</span><span class="regexp">/pods/init</span>-containers/<span class="comment">#resources)中有说明。此外，Init Containers不支持就绪探针，因为它们必须在Pod准备好之前运行完成。</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">如果为Pod指定了多个Init容器，则按顺序一次运行一个Container。每一个都必须在下一次运行之前成功。当所有Init容器都运行完成后，Kubernetes会初始化Pod并像往常一样运行应用程序容器。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment">##### Init容器可以用于什么？</span></span></span><br><span class="line"><span class="ruby">由于Init Containers具有来自应用容器的单独镜像，因此它们对于启动相关代码具有一些优势：</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">- 出于安全原因，它们可以包含并运行不希望包含在应用容器镜像中的实用程序。</span></span><br><span class="line"><span class="ruby">- 它们可以包含应用程序镜像中不存在的用于设置的实用程序或自定义代码。例如，没有必要使镜像<span class="string">``</span>FROM<span class="string">``</span>的另一个镜像只使用像工具 <span class="string">``</span>sed<span class="string">``</span>，<span class="string">``</span>awk<span class="string">``</span>，<span class="string">``</span>python<span class="string">``</span>，或<span class="string">``</span>dig<span class="string">``</span>在安装过程中。</span></span><br><span class="line"><span class="ruby">- 应用程序映像构建器和部署者角色可以独立工作，而无需共同构建单个应用程序镜像。</span></span><br><span class="line"><span class="ruby">- 他们使用Linux命名空间，以便他们从应用程序容器中获得不同的文件系统视图。因此，他们可以访问应用容器无法访问的秘密。</span></span><br><span class="line"><span class="ruby">- 它们在任何应用程序容器启动之前运行完成，而应用程序容器并行运行，因此Init容器提供了一种简单的方法来阻止或延迟应用容器的启动，直到满足一组前置条件。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment">###### 例子</span></span></span><br><span class="line"><span class="ruby">以下是有关如何使用Init Containers的一些想法：</span></span><br><span class="line"><span class="ruby">- 等待使用shell命令创建服务，例如：</span></span><br><span class="line"><span class="ruby">- 我在&#123;<span class="number">1</span>..<span class="number">100</span>&#125;; 做睡觉<span class="number">1</span>; 如果挖我的服务; 然后退出<span class="number">0</span>; 网络连接; 完成; 退出<span class="number">1</span></span></span><br><span class="line"><span class="ruby">- 使用以下命令从向下API向远程服务器注册此Pod：</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">    curl -X POST http：/<span class="regexp">/ $ MANAGEMENT_SERVICE_HOST：$ MANAGEMENT_SERVICE_PORT /</span> register -d<span class="string">'instal = $（）IP = $（）”</span></span></span><br><span class="line"><span class="ruby">- 等待一段时间，然后使用类似命令启动app Container <span class="string">``</span>sleep <span class="number">60</span><span class="string">``</span>。</span></span><br><span class="line"><span class="ruby">- 将git存储库克隆到卷中。</span></span><br><span class="line"><span class="ruby">- 将值放入配置文件并运行模板工具以动态生成主应用程序Container的配置文件。例如，将POD_IP值放在配置中，并使用Jinja生成主应用程序配置文件。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">可以在[StatefulSets](<span class="symbol">https:</span>/<span class="regexp">/kubernetes.io/docs</span><span class="regexp">/concepts/workloads</span><span class="regexp">/controllers/statefulset</span><span class="regexp">/)文档 和[Production Pods指南](https:/</span><span class="regexp">/kubernetes.io/docs</span><span class="regexp">/tasks/configure</span>-pod-container/configure-pod-initialization/)中找到更详细的用法示例。</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="comment">###### 初始容器正在使用中</span></span></span><br><span class="line"><span class="ruby">以下针对Kubernetes <span class="number">1.5</span>的yaml文件概述了一个具有两个Init容器的简单Pod。第一个等待，<span class="string">``</span>myservice<span class="string">``</span>第二个等待<span class="string">``</span>mydb<span class="string">``</span>。一旦两个容器完成，Pod就会开始。</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: myapp-pod<br>  labels:<br>    app: myapp<br>  annotations:<br>    pod.beta.kubernetes.io/init-containers: ‘[<br>        {<br>            “name”: “init-myservice”,<br>            “image”: “busybox”,<br>            “command”: [“sh”, “-c”, “until nslookup myservice; do echo waiting for myservice; sleep 2; done;”]<br>        },<br>        {<br>            “name”: “init-mydb”,<br>            “image”: “busybox”,<br>            “command”: [“sh”, “-c”, “until nslookup mydb; do echo waiting for mydb; sleep 2; done;”]<br>        }<br>    ]’<br>spec:<br>  containers:</p>
<ul>
<li>name: myapp-container<br>image: busybox<br>command: [‘sh’, ‘-c’, ‘echo The app is running! &amp;&amp; sleep 3600’]<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Kubernetes <span class="number">1.6</span>中有一种新语法，尽管旧的注释语法仍适用于<span class="number">1.6</span>和<span class="number">1.7</span>。新语法必须用于<span class="number">1.8</span>或更高版本。我们已将Init Containers的声明移至``spec``：</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: myapp-pod<br>  labels:<br>    app: myapp<br>spec:<br>  containers:</p>
<ul>
<li>name: myapp-container<br>image: busybox<br>command: [‘sh’, ‘-c’, ‘echo The app is running! &amp;&amp; sleep 3600’]<br>initContainers:</li>
<li>name: init-myservice<br>image: busybox<br>command: [‘sh’, ‘-c’, ‘until nslookup myservice; do echo waiting for myservice; sleep 2; done;’]</li>
<li>name: init-mydb<br>image: busybox<br>command: [‘sh’, ‘-c’, ‘until nslookup mydb; do echo waiting for mydb; sleep 2; done;’]<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.5</span>语法仍适用于<span class="number">1.6</span>，但我们建议使用<span class="number">1.6</span>语法。在Kubernetes <span class="number">1.6</span>中，Init Containers在API中成为了一个领域。beta注释在<span class="number">1.6</span>和<span class="number">1.7</span>中仍然受到尊重，但在<span class="number">1.8</span>或更高版本中不受支持。</span><br><span class="line"></span><br><span class="line">下面YAML文件概述了``mydb``与``myservice``服务：</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>kind: Service<br>apiVersion: v1<br>metadata:<br>  name: myservice<br>spec:<br>  ports:</p>
<ul>
<li>protocol: TCP<br>port: 80<br>targetPort: 9376</li>
</ul>
<hr>
<p>kind: Service<br>apiVersion: v1<br>metadata:<br>  name: mydb<br>spec:<br>  ports:</p>
<ul>
<li>protocol: TCP<br>port: 80<br>targetPort: 9377<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以使用以下命令启动和调试此Pod：</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>$ kubectl create -f myapp.yaml<br>pod/myapp-pod created<br>$ kubectl get -f myapp.yaml<br>NAME        READY     STATUS     RESTARTS   AGE<br>myapp-pod   0/1       Init:0/2   0          6m<br>$ kubectl describe -f myapp.yaml<br>Name:          myapp-pod<br>Namespace:     default<br>[…]<br>Labels:        app=myapp<br>Status:        Pending<br>[…]<br>Init Containers:<br>  init-myservice:<br>[…]<br>    State:         Running<br>[…]<br>  init-mydb:<br>[…]<br>    State:         Waiting<br>      Reason:      PodInitializing<br>    Ready:         False<br>[…]<br>Containers:<br>  myapp-container:<br>[…]<br>    State:         Waiting<br>      Reason:      PodInitializing<br>    Ready:         False<br>[…]<br>Events:<br>  FirstSeen    LastSeen    Count    From                      SubObjectPath                           Type          Reason        Message</p>
<hr>
<p>  16s          16s         1        {default-scheduler }                                              Normal        Scheduled     Successfully assigned myapp-pod to 172.17.4.201<br>  16s          16s         1        {kubelet 172.17.4.201}    spec.initContainers{init-myservice}     Normal        Pulling       pulling image “busybox”<br>  13s          13s         1        {kubelet 172.17.4.201}    spec.initContainers{init-myservice}     Normal        Pulled        Successfully pulled image “busybox”<br>  13s          13s         1        {kubelet 172.17.4.201}    spec.initContainers{init-myservice}     Normal        Created       Created container with docker id 5ced34a04634; Security:[seccomp=unconfined]<br>  13s          13s         1        {kubelet 172.17.4.201}    spec.initContainers{init-myservice}     Normal        Started       Started container with docker id 5ced34a04634<br>$ kubectl logs myapp-pod -c init-myservice # Inspect the first init container<br>$ kubectl logs myapp-pod -c init-mydb      # Inspect the second init container<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一旦我们启动mydb和myservice服务，我们就可以看到Init Containers完成并myapp-pod创建了：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl create -f services.yaml<br>service/myservice created<br>service/mydb created<br>$ kubectl get -f myapp.yaml<br>NAME        READY     STATUS    RESTARTS   AGE<br>myapp-pod   1/1       Running   0          9m<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line">这个例子非常简单，但应该为您创建自己的Init容器提供一些灵感。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 详细的行为</span></span><br><span class="line">在Pod启动期间，初始化网络和卷后，初始容器将按顺序启动。每个Container必须在下一个Container启动之前成功退出。如果Container由于运行时未能启动或因故障退出，则根据Pod重试<span class="code">``restartPolicy`</span><span class="code">`。但是，如果将Pod `</span><span class="code">`restartPolicy`</span><span class="code">`设置为Always，则Init Containers将使用 `</span><span class="code">`RestartPolicy`</span>`OnFailure。</span><br><span class="line"></span><br><span class="line">在<span class="code">``Ready`</span><span class="code">`所有Init容器都成功之前，Pod不能。Init容器上的端口不在服务下聚合。正在初始化的Pod处于`</span><span class="code">`Pending`</span><span class="code">`状态，但应将条件`</span><span class="code">`Initializing`</span>`设置为true。</span><br><span class="line"></span><br><span class="line">如果[<span class="string">重新启动</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/pods/init-containers/#pod-restart-reasons</span>) Pod，则必须再次执行所有Init Containers。</span><br><span class="line"></span><br><span class="line">Init容器规范的更改仅限于容器镜像字段。更改Init Container镜像字段相当于重新启动Pod。</span><br><span class="line"></span><br><span class="line">由于Init Containers可以重新启动，重试或重新执行，因此Init Container代码应该是幂等的。特别是，<span class="code">``EmptyDirs`</span>` 应该为输出文件已经存在的可能性准备写入文件的代码。</span><br><span class="line"></span><br><span class="line">Init Containers具有应用Container的所有字段。但是，Kubernetes禁止<span class="code">``readinessProbe`</span>`使用，因为Init Containers无法定义与完成不同的准备情况。这在验证期间强制执行。</span><br><span class="line"></span><br><span class="line">使用<span class="code">``activeDeadlineSeconds`</span><span class="code">`上pod`</span><span class="code">`livenessProbe`</span>`的容器，以防止初始化容器从永远失败。活动截止日期包括Init Containers。</span><br><span class="line"></span><br><span class="line">Pod中每个应用程序和Init容器的名称必须是唯一的; 任何与另一个名称共享名称的Container都会引发验证错误。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 资源</span></span><br><span class="line">给定Init Containers的排序和执行，适用以下资源使用规则：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>在所有Init Containers上定义的任何特定资源请求或限制的最高值是有效的init请求/限制</span><br><span class="line"><span class="bullet">- </span>Pod 对资源的有效请求/限制是以下值中的较高者：</span><br><span class="line"><span class="bullet">- </span>资源的所有应用容器请求/限制的总和</span><br><span class="line"><span class="bullet">- </span>资源的有效init请求/限制</span><br><span class="line"><span class="bullet">- </span>调度是基于有效的请求/限制完成的，这意味着Init Containers可以预留在Pod生命周期内未使用的初始化资源。</span><br><span class="line"><span class="bullet">- </span>Pod的有效QoS层的QoS层是Init Containers和app容器的QoS层。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">根据有效的Pod请求和限制应用配额和限制。</span><br><span class="line"></span><br><span class="line">Pod级别cgroup基于有效的Pod请求和限制，与调度程序相同。</span><br><span class="line"></span><br><span class="line"><span class="section">###### Pod重启原因</span></span><br><span class="line">Pod可以重新启动，导致重新执行Init Containers，原因如下：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>用户更新PodSpec，导致Init容器映像发生更改。App Container图像更改仅重新启动应用程序Container。</span><br><span class="line"><span class="bullet">- </span>Pod基础架构容器重新启动。这种情况并不常见，必须由对节点具有root访问权限的人员来完成。</span><br><span class="line"><span class="bullet">- </span>Pod中的所有容器都被终止，同时<span class="code">``restartPolicy`</span>`设置为Always，强制重新启动，并且Init Container完成记录由于垃圾回收而丢失。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 支持和兼容性</span></span><br><span class="line">具有Apiserver 1.6.0或更高版本的群集支持使用该<span class="code">``.spec.initContainers`</span><span class="code">`字段的Init Containers 。以前的版本使用alpha或beta注释支持Init Containers。该`</span><span class="code">`.spec.initContainers`</span>`字段还镜像为alpha和beta注释，以便Kubelet 1.3.0或更高版本可以执行Init Containers，因此版本1.6 apiserver可以安全地回滚到1.5.x版，而不会丢失现有创建的pod的Init Container功能。</span><br><span class="line"></span><br><span class="line">在Apiserver和Kubelet 1.8.0或更高版本中，删除了对alpha和beta注释的支持，需要从不推荐的注释转换到 <span class="code">``.spec.initContainers`</span>`字段。</span><br><span class="line"></span><br><span class="line">此功能已在1.6中退出测试版。可以在应用程序<span class="code">``containers`</span>`阵列旁边的PodSpec中指定Init容器。beta注释值仍将受到尊重并覆盖PodSpec字段值，但是，它们在1.6和1.7中已弃用。在1.8中，不再支持注释，必须将其转换为PodSpec字段。</span><br><span class="line"></span><br><span class="line"><span class="section">#### Pod Preset</span></span><br><span class="line">此页面提供PodPresets的概述，PodPresets是在创建时将特定信息注入pod的对象。信息可以包括秘密，卷，卷安装和环境变量。</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>了解Pod预设</span><br><span class="line"><span class="bullet">- </span>这个怎么运作</span><br><span class="line"><span class="bullet">- </span>启用Pod预设</span><br><span class="line"></span><br><span class="line"><span class="section">##### 了解Pod预设</span></span><br><span class="line"><span class="code">``Pod Preset`</span>`是一种API资源，用于在创建时将其他运行时需求注入Pod。您可以使用[<span class="string">标签选择器</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors</span>) 指定应用给定Pod预设的Pod。</span><br><span class="line"></span><br><span class="line">使用Pod预设允许pod模板作者不必显式提供每个pod的所有信息。这样，使用特定服务的pod模板的作者不需要知道有关该服务的所有详细信息。</span><br><span class="line"></span><br><span class="line">有关背景的更多信息，请参阅[<span class="string">PodPreset</span>](<span class="link">https://git.k8s.io/community/contributors/design-proposals/service-catalog/pod-preset.md</span>)的[<span class="string">设计方案</span>](<span class="link">https://git.k8s.io/community/contributors/design-proposals/service-catalog/pod-preset.md</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 这个怎么运作</span></span><br><span class="line">Kubernetes提供了一个准入控制器（<span class="code">``PodPreset`</span>`），当启用时，它将Pod Presets应用于传入的pod创建请求。发生pod创建请求时，系统会执行以下操作：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1. </span>检索所有<span class="code">``PodPresets`</span>`可用的。</span><br><span class="line"><span class="bullet">2. </span>检查任何标签选择器是否<span class="code">``PodPreset`</span>`与正在创建的pod上的标签匹配。</span><br><span class="line"><span class="bullet">3. </span>尝试将所定义的各种资源合并<span class="code">``PodPreset`</span>`到正在创建的Pod中。</span><br><span class="line"><span class="bullet">4. </span>出错时，抛出一个记录pod上合并错误的事件，并创建pod 而不从中注入任何资源<span class="code">``PodPreset`</span>`。</span><br><span class="line"><span class="bullet">5. </span>注释生成的修改后的Pod规范，以指示它已被修改<span class="code">``PodPreset`</span><span class="code">`。注释是形式的 `</span><span class="code">`podpreset.admission.kubernetes.io/podpreset-&lt;pod-preset name&gt;: "&lt;resource version&gt;"`</span>`。</span><br><span class="line"></span><br><span class="line">每个Pod可以匹配零个或多个Pod Presets; 并且每个<span class="code">``PodPreset`</span><span class="code">`都可以应用于零个或多个pod。当 `</span><span class="code">`PodPreset`</span><span class="code">`应用于一个或多个Pod时，Kubernetes会修改Pod规范。对于更改`</span><span class="code">`Env`</span><span class="code">`，`</span><span class="code">`EnvFrom`</span><span class="code">`和 `</span><span class="code">`VolumeMounts`</span><span class="code">`，Kubernetes修改在波德所有容器容器规范; 对于更改`</span><span class="code">`Volume`</span>`，Kubernetes修改Pod规范。</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意： Pod Preset能够``.spec.containers``在适当的时候修改Pod规范中的字段。没有从POD预置资源定义将被应用到initContainers外地。</span></span><br><span class="line"></span><br><span class="line"><span class="section">###### 禁用特定Pod的Pod预设</span></span><br><span class="line">在某些情况下，您希望Pod不会被任何Pod Preset突变改变。在这些情况下，您可以在表单的Pod Spec中添加注释：<span class="code">``podpreset.admission.kubernetes.io/exclude: "true"`</span>`。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 启用Pod预设</span></span><br><span class="line">要在群集中使用Pod Presets，您必须确保以下内容：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1. </span>您已启用API类型<span class="code">``settings.k8s.io/v1alpha1/podpreset`</span><span class="code">`。例如，这可以通过包含`</span><span class="code">`settings.k8s.io/v1alpha1=true`</span><span class="code">`在`</span><span class="code">`--runtime-config`</span><span class="code">`API服务器的选项中来完成。在minikube中，`</span><span class="code">`--extra-config=apiserver.runtime-config=settings.k8s.io/v1alpha1=true`</span>`在启动集群时添加此标志 。</span><br><span class="line"><span class="bullet">2. </span>您已启用准入控制器<span class="code">``PodPreset`</span><span class="code">`。执行此操作的一种方法是包含`</span><span class="code">`PodPreset`</span><span class="code">`在`</span><span class="code">`--enable-admission-plugins`</span><span class="code">`为API服务器指定的选项值中。在minikube中，`</span><span class="code">`--extra-config=apiserver.enable-admission-plugins=Initializers,NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,PodPreset`</span>` 在启动集群时添加此标志 。</span><br><span class="line"><span class="bullet">3. </span>您已通过<span class="code">``PodPreset`</span>`在将使用的命名空间中创建对象来定义Pod预设。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 中断</span></span><br><span class="line">本指南适用于想要构建高可用性应用程序的应用程序所有者，因此需要了解Pod可能发生的中断类型。</span><br><span class="line"></span><br><span class="line">它也适用于希望执行自动群集操作的群集管理员，例如升级和自动缩放群集。</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>自愿和非自愿中断</span><br><span class="line"><span class="bullet">- </span>处理中断</span><br><span class="line"><span class="bullet">- </span>中断预算如何运作</span><br><span class="line"><span class="bullet">- </span>PDB示例</span><br><span class="line"><span class="bullet">- </span>分离群集所有者和应用程序所有者角色</span><br><span class="line"><span class="bullet">- </span>如何在群集上执行破坏性操作</span><br><span class="line"></span><br><span class="line"><span class="section">##### 自愿和非自愿中断</span></span><br><span class="line">在有人（一个人或一个控制器）摧毁它们，或者存在不可避免的硬件或系统软件错误之前，Pod不会消失。</span><br><span class="line"></span><br><span class="line">我们将这些不可避免的案例称为对应用程序的非自愿中断。例如：</span><br><span class="line"><span class="bullet">- </span>支持节点的物理机的硬件故障</span><br><span class="line"><span class="bullet">- </span>集群管理员错误地删除了VM（实例）</span><br><span class="line"><span class="bullet">- </span>云提供商或虚拟机管理程序故障使虚拟机消失</span><br><span class="line"><span class="bullet">- </span>内核恐慌</span><br><span class="line"><span class="bullet">- </span>由于群集网络分区，节点从群集中消失</span><br><span class="line"><span class="bullet">- </span>由于节点[<span class="string">资源不足</span>](<span class="link">https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/</span>)而导致pod被驱逐。</span><br><span class="line"></span><br><span class="line">除资源不足外，大多数用户都应熟悉所有这些条件; 它们不是Kubernetes特有的。</span><br><span class="line"></span><br><span class="line">我们将其他案件称为自愿中断。其中包括应用程序所有者启动的操作和群集管理员启动的操作。典型应用程序所有者操作包</span><br><span class="line"><span class="bullet">- </span>删除管理pod的部署或其他控制器</span><br><span class="line"><span class="bullet">- </span>更新部署的pod模板导致重新启动</span><br><span class="line"><span class="bullet">- </span>直接删除pod（例如意外）</span><br><span class="line"></span><br><span class="line">群集管理员操作包括：</span><br><span class="line">-[<span class="string"> 耗尽节点</span>](<span class="link">https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/</span>)进行修复或升级。</span><br><span class="line"><span class="bullet">- </span>从群集中排出节点以缩小群集（了解[<span class="string">群集自动缩放</span>](<span class="link">https://kubernetes.io/docs/tasks/administer-cluster/cluster-management/#cluster-autoscaler</span>) ）。</span><br><span class="line"><span class="bullet">- </span>从节点中删除pod以允许其他内容适合该节点。</span><br><span class="line"></span><br><span class="line">这些操作可以由集群管理员直接执行，也可以由集群管理员或集群主机提供商自动运行。</span><br><span class="line"></span><br><span class="line">请咨询您的集群管理员或咨询您的云提供商或分发文档，以确定是否为您的集群启用了任何自愿中断源。如果未启用，则可以跳过创建Pod中断预算。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 处理中断</span></span><br><span class="line">以下是一些缓解非自愿中断的方法：</span><br><span class="line"><span class="bullet">- </span>确保您的pod [<span class="string">请求所需的资源</span>](<span class="link">https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-ram-container</span>)。</span><br><span class="line"><span class="bullet">- </span>如果需要更高的可用性，请复制应用程序。（了解运行复制的 [<span class="string">无状态</span>](<span class="link">https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/</span>) 和[<span class="string">有状态</span>](<span class="link">https://kubernetes.io/docs/tasks/run-application/run-replicated-stateful-application/</span>)应用程序。）</span><br><span class="line"><span class="bullet">- </span>为了在运行复制的应用程序时获得更高的可用性，可以跨机架（使用[<span class="string">反关联</span>](<span class="link">https://kubernetes.io/docs/user-guide/node-selection/#inter-pod-affinity-and-anti-affinity-beta-feature</span>)）或跨区域（如果使用 [<span class="string">多区域群集</span>](<span class="link">https://kubernetes.io/docs/setup/multiple-zones</span>)）分布应用程序 。</span><br><span class="line"></span><br><span class="line">自愿中断的频率各不相同。在基本的Kubernetes集群上，根本没有自愿中断。但是，您的群集管理员或托管服务提供商可能会运行一些导致自愿中断的其他服务。例如，推出节点软件更新可能会导致自愿中断。此外，群集（节点）自动缩放的某些实现可能会导致自动中断以进行碎片整理和压缩节点。您的集群管理员或托管服务提供商应记录预期的自愿中断级别（如果有）。</span><br><span class="line"></span><br><span class="line">Kubernetes提供的功能可以帮助您在频繁的自愿中断的同时运行高可用性应用程序。我们将这组功能称为 中断预算。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 中断预算如何运作</span></span><br><span class="line">应用程序所有者可以<span class="code">``PodDisruptionBudget`</span>`为每个应用程序创建一个对象（PDB）。PDB限制复制应用程序的pod的数量，这些pod与自愿中断同时发生故障。例如，基于仲裁的应用程序希望确保运行的副本数量永远不会低于仲裁所需的数量。Web前端可能希望确保服务负载的副本数量永远不会低于总数的某个百分比。</span><br><span class="line"></span><br><span class="line">集群管理器和托管提供商应使用通过调用[<span class="string">Eviction API</span>](<span class="link">https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/#the-eviction-api</span>) 而不是直接删除pod来遵守Pod Disruption Budgets的工具。示例是<span class="code">``kubectl drain`</span><span class="code">`命令和Kubernetes-on-GCE集群升级脚本（`</span><span class="code">`cluster/gce/upgrade.sh`</span>`）。</span><br><span class="line"></span><br><span class="line">当集群管理员想要耗尽节点时，他们使用<span class="code">``该kubectl drain`</span>`命令。该工具试图驱逐机器上的所有pod。可以暂时拒绝逐出请求，并且该工具定期重试所有失败的请求，直到所有pod终止，或者直到达到可配置的超时。</span><br><span class="line"></span><br><span class="line">PDB指定应用程序可以容忍的副本数量，相对于预期的副本数量。例如，具有部署<span class="code">``.spec.replicas: 5`</span>`应该在任何给定时间具有5个pod。如果其PDB允许一次有4个，则Eviction API将允许一次自动中断一个而不是两个pod。</span><br><span class="line"></span><br><span class="line">组成应用程序的pod组使用标签选择器指定，与应用程序控制器使用的标签选择器相同（部署，有状态集等）。</span><br><span class="line"></span><br><span class="line">“预期”数量的pod是根据<span class="code">``.spec.replicaspods`</span><span class="code">`控制器计算出来的。使用`</span><span class="code">`.metadata.ownerReferences`</span>`对象的pod从pod中发现控制器。</span><br><span class="line"></span><br><span class="line">PDB不能防止[<span class="string">非自愿中断</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#voluntary-and-involuntary-disruptions</span>)发生，但它们确实违背了预算。</span><br><span class="line"></span><br><span class="line">由于滚动升级到应用程序而被删除或不可用的Pod确实会计入中断预算，但是在执行滚动升级时，控制器（如部署和有状态集）不受PDB限制 - 在应用程序更新期间处理故障在控制器规范中。（了解有关[<span class="string">更新部署的信息</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment</span>)。）</span><br><span class="line"></span><br><span class="line">当吊舱使用驱逐API逐出，它是正常终止（见 <span class="code">``terminationGracePeriodSeconds`</span>`在[<span class="string">PodSpec</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#podspec-v1-core</span>)。）</span><br><span class="line"></span><br><span class="line">PDB示例</span><br><span class="line">考虑具有3个节点的群集中，<span class="code">``node-1`</span><span class="code">`通过`</span><span class="code">`node-3`</span><span class="code">`。群集正在运行多个应用程序。其中一人有3个副本最初称 `</span><span class="code">`pod-a`</span><span class="code">`，`</span><span class="code">`pod-b`</span><span class="code">`和`</span><span class="code">`pod-c`</span><span class="code">`。`</span><span class="code">`pod-x`</span>`还示出了另一个没有PDB的不相关的pod。最初，pod的布局如下：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">节点-1 | 节点-2- | 节点-3-</span><br><span class="line">---|---|---</span><br><span class="line">pod-a 可用 | pod-b 可用 | pod-c 可用</span><br><span class="line">pod-x 可用 | | </span><br><span class="line"></span><br><span class="line">所有3个pod都是部署的一部分，它们共同拥有一个PDB，要求所有3个pod中至少有2个可用。</span><br><span class="line"></span><br><span class="line">例如，假设集群管理员想要重新启动到新的内核版本来修复内核中的错误。群集管理员首先尝试<span class="code">``node-1`</span><span class="code">`使用该`</span><span class="code">`kubectl drain`</span><span class="code">`命令消耗。该工具试图驱逐`</span><span class="code">`pod-a`</span><span class="code">`和`</span><span class="code">`pod-x`</span><span class="code">`。这立即成功。两个pod同时进入该`</span><span class="code">`terminating`</span>`。这使集群处于以下状态</span><br><span class="line"></span><br><span class="line">节点-1 耗尽 | 节点-2- | 节点-3-</span><br><span class="line">---|---|---</span><br><span class="line">pod-a  终止 | pod-b 可用 | pod-c 可用</span><br><span class="line">pod-x  终止 | | </span><br><span class="line"></span><br><span class="line">部署注意到其中一个pod正在终止，因此它会创建一个名为的替换<span class="code">``pod-d`</span><span class="code">`。由于`</span><span class="code">`node-1`</span><span class="code">`是封锁的，它落在另一个节点上。还创造`</span><span class="code">`pod-y`</span><span class="code">`了一些替代品`</span><span class="code">`pod-x`</span>`。</span><br><span class="line"></span><br><span class="line">（注意：对于一个StatefulSet，<span class="code">``pod-a`</span><span class="code">`它将被称为类似的东西`</span><span class="code">`pod-1`</span><span class="code">`，需要在它被替换之前完全终止，也可以被调用，`</span><span class="code">`pod-1`</span>`但是可以创建不同的UID。否则，该示例也适用于StatefulSet。）</span><br><span class="line"></span><br><span class="line">现在集群处于以下状态：</span><br><span class="line"></span><br><span class="line">节点-1 耗尽 | 节点-2- | 节点-3-</span><br><span class="line">---|---|---</span><br><span class="line">pod-a  终止 | pod-b 可用 | pod-c 可用</span><br><span class="line">pod-x  终止 | pod-b 开始 | POD-Y</span><br><span class="line"></span><br><span class="line">在某些时候，pod终止，集群看起来像这样：</span><br><span class="line"></span><br><span class="line">节点-1 耗尽 | 节点-2- | 节点-3-</span><br><span class="line">---|---|---</span><br><span class="line"> | pod-b 可用 | pod-c 可用</span><br><span class="line"> | pod-b 开始 | POD-Y</span><br><span class="line"> </span><br><span class="line"> 此时，如果一个不耐烦的集群管理员试图耗尽，<span class="code">``node-2`</span><span class="code">`或者 `</span><span class="code">`node-3`</span><span class="code">`排除命令将阻塞，因为部署只有2个可用的pod，并且其PDB至少需要2.经过一段时间后，`</span><span class="code">`pod-d`</span>`变为可用。</span><br><span class="line"></span><br><span class="line">群集状态现在看起来像这样：</span><br><span class="line"></span><br><span class="line">节点-1 耗尽 | 节点-2- | 节点-3-</span><br><span class="line">---|---|---</span><br><span class="line"> | pod-b 可用 | pod-c 可用</span><br><span class="line"> | pod-b 可用 | POD-Y</span><br><span class="line"> </span><br><span class="line"> 现在，集群管理员试图耗尽<span class="code">``node-2`</span><span class="code">`。drain命令将尝试以某种顺序驱逐两个pod，`</span><span class="code">`pod-b`</span><span class="code">`先说然后再说 `</span><span class="code">`pod-d`</span><span class="code">`。它将成功驱逐`</span><span class="code">`pod-b`</span><span class="code">`。但是，当它试图逐出时`</span><span class="code">`pod-d`</span>`，它将被拒绝，因为这将只留下一个可用于部署的pod。</span><br><span class="line"></span><br><span class="line">部署创建了<span class="code">``pod-b`</span><span class="code">`被叫的替代品`</span><span class="code">`pod-e`</span><span class="code">`。因为集群中没有足够的资源来安排 `</span><span class="code">`pod-e`</span>`排水将再次阻塞。群集可能最终处于此状态：</span><br><span class="line"></span><br><span class="line">节点-1 耗尽 | 节点-2- | 节点-3- | 没有节点</span><br><span class="line">---|---|---|---</span><br><span class="line"> | pod-b 可用 | pod-c 可用 | pod-e 待定</span><br><span class="line"> | pod-b 可用 | POD-Y | </span><br><span class="line"> </span><br><span class="line"> 此时，集群管理员需要将节点添加回集群以继续升级。</span><br><span class="line"></span><br><span class="line">你可以看到Kubernetes如何改变发生中断的速度，根据：</span><br><span class="line"><span class="bullet">- </span>应用程序需要多少个副本</span><br><span class="line"><span class="bullet">- </span>优雅地关闭实例需要多长时间</span><br><span class="line"><span class="bullet">- </span>启动新实例需要多长时间</span><br><span class="line"><span class="bullet">- </span>控制器的类型</span><br><span class="line"><span class="bullet">- </span>集群的资源容量</span><br><span class="line"></span><br><span class="line"><span class="section">##### 分离群集所有者和应用程序所有者角色</span></span><br><span class="line">通常，将群集管理器和应用程序所有者视为彼此知之甚少的单独角色很有用。在这些情况下，这种职责分离可能有意义：</span><br><span class="line"><span class="bullet">- </span>当有许多应用程序团队共享Kubernetes集群时，角色有自然的专业化</span><br><span class="line"><span class="bullet">- </span>当第三方工具或服务用于自动化集群管理时</span><br><span class="line"></span><br><span class="line">Pod Disruption Budgets通过在角色之间提供接口来支持这种角色分离。</span><br><span class="line"></span><br><span class="line">如果您的组织中没有这样的责任分离，则可能不需要使用Pod Disruption Budgets。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 如何在群集上执行破坏性操作</span></span><br><span class="line">如果您是群集管理员，并且需要对群集中的所有节点执行中断操作，例如节点或系统软件升级，则可以使用以下选项：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>在升级期间接受停机时间。</span><br><span class="line"><span class="bullet">- </span>故障转移到另一个完整的副本群集。</span><br><span class="line">  - 没有停机时间，但对于重复的节点以及人类协调切换的努力可能都是昂贵的。</span><br><span class="line"><span class="bullet">- </span>编写容错中断应用程序并使用PDB。</span><br><span class="line">  - 没有停机时间。</span><br><span class="line">  - 最小的资源重复。</span><br><span class="line">  - 允许更多自动化群集管理。</span><br><span class="line">  - 编写容忍破坏性的应用程序很棘手，但容忍自愿中断的工作很大程度上与支持自动缩放和容忍非自愿中断的工作重叠。</span><br><span class="line"></span><br><span class="line"><span class="section">### 控制器</span></span><br><span class="line"><span class="section">#### ReplicaSet</span></span><br><span class="line">ReplicaSet是下一代复制控制器。现在ReplicaSet和 [<span class="string">Replication Controller</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/</span>)之间的唯一区别是选择器支持。ReplicaSet支持新的基于集合的选择器要求，如[<span class="string">标签用户指南</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors</span>)中所述， 而Replication Controller仅支持基于等同的选择器要求。</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>如何使用ReplicaSet</span><br><span class="line"><span class="bullet">- </span>何时使用ReplicaSet</span><br><span class="line"><span class="bullet">- </span>例</span><br><span class="line"><span class="bullet">- </span>编写副本集规范</span><br><span class="line"><span class="bullet">- </span>使用ReplicaSet</span><br><span class="line"><span class="bullet">- </span>ReplicaSet的替代品</span><br><span class="line"></span><br><span class="line"><span class="section">##### 如何使用ReplicaSet</span></span><br><span class="line">大多数[<span class="string">kubectl</span>](<span class="link">https://kubernetes.io/docs/user-guide/kubectl/</span>)支持复制控制器的命令也支持ReplicaSet。[<span class="string">rolling-update</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#rolling-update</span>)命令是一个例外 。如果您想要滚动更新功能，请考虑使用部署。此外， [<span class="string">rolling-update</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#rolling-update</span>)命令是必需的，而Deployments是声明性的，因此我们建议通过[<span class="string">rollout</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#rollout</span>)命令使用Deployments 。</span><br><span class="line"></span><br><span class="line">虽然ReplicaSet可以独立使用，但今天它主要被 [<span class="string">Deployments</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</span>)用作协调pod创建，删除和更新的机制。使用“部署”时，您不必担心管理它们创建的副本集。部署拥有并管理其ReplicaSet。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 何时使用ReplicaSet</span></span><br><span class="line">ReplicaSet确保在任何给定时间运行指定数量的pod副本。但是，Deployment是一个更高级别的概念，它管理ReplicaSet并为pod提供声明性更新以及许多其他有用的功能。因此，除非您需要自定义更新编排或根本不需要更新，否则我们建议使用部署而不是直接使用ReplicaSet。</span><br><span class="line"></span><br><span class="line">这实际上意味着您可能永远不需要操作ReplicaSet对象：改为使用Deployment，并在spec部分中定义您的应用程序。</span><br><span class="line"></span><br><span class="line">例</span><br></pre></td></tr></table></figure></p>
<p>#controllers/frontend.yaml<br>apiVersion: apps/v1<br>kind: ReplicaSet<br>metadata:<br>  name: frontend<br>  labels:<br>    app: guestbook<br>    tier: frontend<br>spec:</p>
<h1 id="modify-replicas-according-to-your-case"><a href="#modify-replicas-according-to-your-case" class="headerlink" title="modify replicas according to your case"></a>modify replicas according to your case</h1><p>  replicas: 3<br>  selector:<br>    matchLabels:<br>      tier: frontend<br>    matchExpressions:</p>
<pre><code>- {key: tier, operator: In, values: [frontend]}
</code></pre><p>  template:<br>    metadata:<br>      labels:<br>        app: guestbook<br>        tier: frontend<br>    spec:<br>      containers:</p>
<pre><code>- name: php-redis
  image: gcr.io/google_samples/gb-frontend:v3
  resources:
    requests:
      cpu: 100m
      memory: 100Mi
  env:
  - name: GET_HOSTS_FROM
    value: dns
    # If your cluster config does not include a dns service, then to
    # instead access environment variables to find service host
    # info, comment out the &apos;value: dns&apos; line above, and uncomment the
    # line below.
    # value: env
  ports:
  - containerPort: 80
</code></pre><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将此清单保存``frontend.yaml``到Kubernetes集群并将其提交到Kubernetes集群应该创建已定义的ReplicaSet及其管理的pod。</span><br></pre></td></tr></table></figure>
<p>$ kubectl create -f <a href="http://k8s.io/examples/controllers/frontend.yaml" target="_blank" rel="noopener">http://k8s.io/examples/controllers/frontend.yaml</a><br>replicaset.apps/frontend created<br>$ kubectl describe rs/frontend<br>Name:        frontend<br>Namespace:    default<br>Selector:    tier=frontend,tier in (frontend)<br>Labels:        app=guestbook<br>        tier=frontend<br>Annotations:    <none><br>Replicas:    3 current / 3 desired<br>Pods Status:    3 Running / 0 Waiting / 0 Succeeded / 0 Failed<br>Pod Template:<br>  Labels:       app=guestbook<br>                tier=frontend<br>  Containers:<br>   php-redis:<br>    Image:      gcr.io/google_samples/gb-frontend:v3<br>    Port:       80/TCP<br>    Requests:<br>      cpu:      100m<br>      memory:   100Mi<br>    Environment:<br>      GET_HOSTS_FROM:   dns<br>    Mounts:             <none><br>  Volumes:              <none><br>Events:<br>  FirstSeen    LastSeen    Count    From                SubobjectPath    Type        Reason            Message</none></none></none></p>
<hr>
<p>  1m           1m          1        {replicaset-controller }             Normal      SuccessfulCreate  Created pod: frontend-qhloh<br>  1m           1m          1        {replicaset-controller }             Normal      SuccessfulCreate  Created pod: frontend-dnjpy<br>  1m           1m          1        {replicaset-controller }             Normal      SuccessfulCreate  Created pod: frontend-9si5l<br>$ kubectl get pods<br>NAME             READY     STATUS    RESTARTS   AGE<br>frontend-9si5l   1/1       Running   0          1m<br>frontend-dnjpy   1/1       Running   0          1m<br>frontend-qhloh   1/1       Running   0          1m<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### 编写副本集规范</span><br><span class="line">与所有其他Kubernetes API对象，一个ReplicaSet需要``apiVersion``，``kind``和``metadata``领域。有关使用清单的一般信息，请参阅[使用kubectl进行对象管理](https:<span class="comment">//kubernetes.io/docs/concepts/overview/object-management-kubectl/overview/)。</span></span><br><span class="line"></span><br><span class="line">ReplicaSet还需要一个[``.spec``部分](https:<span class="comment">//git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status)。</span></span><br><span class="line"></span><br><span class="line">###### Pod模板</span><br><span class="line">这``.spec.template``是唯一必需的领域``.spec``。这``.spec.template``是一个 [pod模板](https:<span class="comment">//kubernetes.io/docs/concepts/workloads/pods/pod-overview/#pod-templates)。它与pod具有完全相同的架构 ，除了它是嵌套的并且没有``apiVersion``或``kind``。</span></span><br><span class="line"></span><br><span class="line">除了pod的必填字段外，ReplicaSet中的pod模板还必须指定适当的标签和适当的重新启动策略。</span><br><span class="line"></span><br><span class="line">对于标签，请确保不与其他控制器重叠。有关更多信息，请参阅[pod选择器](https:<span class="comment">//kubernetes.io/docs/concepts/workloads/controllers/replicaset/#pod-selector)。</span></span><br><span class="line"></span><br><span class="line">对于[重新启动策略](https:<span class="comment">//kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy)，唯一允许的值``.spec.template.spec.restartPolicy``是``Always``，这是默认值。</span></span><br><span class="line"></span><br><span class="line">对于本地容器重新启动，ReplicaSet委托给节点上的代理程序，例如[Kubelet](https:<span class="comment">//kubernetes.io/docs/admin/kubelet/)或Docker。</span></span><br><span class="line"></span><br><span class="line">###### Pod选择器</span><br><span class="line">该``.spec.selector``字段是[标签选择器](https:<span class="comment">//kubernetes.io/docs/concepts/overview/working-with-objects/labels/)。ReplicaSet使用与选择器匹配的标签管理所有pod。它不区分它创建或删除的pod以及另一个人或进程创建或删除的pod。这允许替换ReplicaSet而不影响正在运行的pod。</span></span><br><span class="line"></span><br><span class="line">在``.spec.template.metadata.labels``必须匹配``.spec.selector``，否则会被API被拒绝。</span><br><span class="line"></span><br><span class="line">在Kubernetes <span class="number">1.9</span>中，``apps/v1``ReplicaSet类型的API版本是当前版本，默认情况下已启用。``apps/v1beta2``不推荐使用API版本。</span><br><span class="line"></span><br><span class="line">此外，您通常不应创建任何标签与此选择器匹配的pod，可以直接与另一个ReplicaSet一起创建，也可以与其他控制器（如Deployment）一起创建。如果这样做，ReplicaSet会认为它创建了其他pod。Kubernetes并没有阻止你这样做。</span><br><span class="line"></span><br><span class="line">如果最终有多个具有重叠选择器的控制器，则必须自己管理删除。</span><br><span class="line"></span><br><span class="line">###### 副本集上的标签</span><br><span class="line">ReplicaSet本身可以有标签（``.metadata.labels``）。通常，您可以将它们设置为相同``.spec.template.metadata.labels``。但是，允许它们不同，并且``.metadata.labels``不会影响ReplicaSet的行为。</span><br><span class="line"></span><br><span class="line">###### 副本</span><br><span class="line">您可以通过设置指定应同时运行的pod数量``.spec.replicas``。在任何时间运行的数字可能更高或更低，例如，如果副本只是增加或减少，或者如果正常关闭吊舱，并且提前开始更换。</span><br><span class="line"></span><br><span class="line">如果未指定``.spec.replicas``，则默认为<span class="number">1</span>。</span><br><span class="line"></span><br><span class="line">##### 使用ReplicaSet</span><br><span class="line">###### 删除ReplicaSet及其Pod</span><br><span class="line">要删除ReplicaSet及其所有Pod，请使用[``kubectl delete``](https:<span class="comment">//kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#delete)。该[垃圾收集器](https://kubernetes.io/docs/concepts/workloads/controllers/garbage-collection/)在默认情况下会自动删除所有相关的荚。</span></span><br><span class="line"></span><br><span class="line">使用REST API或``client-go``库时，必须设置``propagationPolicy``为``Background``或``Foreground``删除选项。例如：</span><br></pre></td></tr></table></figure></p>
<p>kubectl proxy –port=8080<br>curl -X DELETE  ‘localhost:8080/apis/extensions/v1beta1/namespaces/default/replicasets/frontend’ \</p>
<blockquote>
<p>-d ‘{“kind”:”DeleteOptions”,”apiVersion”:”v1”,”propagationPolicy”:”Foreground”}’ \<br>-H “Content-Type: application/json”<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">###### 仅删除副本集</span><br><span class="line">您可以删除副本集，而不会影响使用[``kubectl <span class="keyword">delete</span><span class="symbol">``</span>](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#<span class="keyword">delete</span>)该<span class="symbol">``</span>--cascade=<span class="literal">false</span><span class="symbol">``</span>选项的任何pod 。使用REST API或<span class="symbol">``</span>client-go<span class="symbol">``</span>库时，必须设置<span class="symbol">``</span>propagationPolicy<span class="symbol">``</span>为<span class="symbol">``</span>Orphan<span class="symbol">``</span>，例如：</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>kubectl proxy –port=8080<br>curl -X DELETE  ‘localhost:8080/apis/extensions/v1beta1/namespaces/default/replicasets/frontend’ \</p>
<blockquote>
<p>-d ‘{“kind”:”DeleteOptions”,”apiVersion”:”v1”,”propagationPolicy”:”Orphan”}’ \<br>-H “Content-Type: application/json”<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">删除原始文件后，您可以创建一个新的ReplicaSet来替换它。只要旧的和新``.spec.selector``的相同，那么新的将采用旧的豆荚。但是，它不会做任何努力使现有的pod匹配一个新的，不同的pod模板。要以受控方式将pod更新为新规范，请使用[滚动更新](https:<span class="comment">//kubernetes.io/docs/concepts/workloads/controllers/replicaset/#rolling-updates)。</span></span><br><span class="line"></span><br><span class="line">###### 从副本集隔离pod</span><br><span class="line">可以通过更改标签来从ReplicaSet的目标集中删除Pod。此技术可用于从服务中删除pod以进行调试，数据恢复等。以这种方式删除的Pod将自动替换（假设副本的数量也未更改）。</span><br><span class="line"></span><br><span class="line">###### 缩放副本集</span><br><span class="line">只需更新``.spec.replicas``字段即可轻松扩展或缩小ReplicaSet 。ReplicaSet控制器确保具有匹配标签选择器的所需数量的pod可用且可操作。</span><br><span class="line"></span><br><span class="line">###### ReplicaSet作为水平Pod自动缩放器目标</span><br><span class="line">ReplicaSet也可以是 [Horizontal Pod Autoscalers (HPA)](https:<span class="comment">//kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/)的目标 。也就是说，HPA可以自动缩放ReplicaSet。以下是针对我们在上一个示例中创建的ReplicaSet的示例HPA。</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>#controllers/hpa-rs.yaml<br>apiVersion: autoscaling/v1<br>kind: HorizontalPodAutoscaler<br>metadata:<br>  name: frontend-scaler<br>spec:<br>  scaleTargetRef:<br>    kind: ReplicaSet<br>    name: frontend<br>  minReplicas: 3<br>  maxReplicas: 10<br>  targetCPUUtilizationPercentage: 50<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将此清单保存``hpa-rs.yaml``到Kubernetes集群并将其提交到Kubernetes集群应该创建定义的HPA，该HPA根据复制的pod的CPU使用情况自动调整目标ReplicaSet。</span><br></pre></td></tr></table></figure></p>
<p>kubectl create -f <a href="https://k8s.io/examples/controllers/hpa-rs.yaml" target="_blank" rel="noopener">https://k8s.io/examples/controllers/hpa-rs.yaml</a><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">或者，您可以使用该``kubectl autoscale``命令来完成相同的操作（并且它更容易！）</span><br></pre></td></tr></table></figure></p>
<p>kubectl autoscale rs frontend –max=10<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">##### ReplicaSet的替代品</span></span><br><span class="line"><span class="section">###### 部署（推荐）</span></span><br><span class="line">[<span class="string">``Deployment``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</span>)是一个更高级别的API对象，它以类似的方式更新其底层ReplicaSet及其Pod <span class="code">``kubectl rolling-update`</span><span class="code">`。如果您需要此滚动更新功能，则建议进行部署，因为`</span><span class="code">`kubectl rolling-update`</span>`它们不同于声明式，服务器端，并具有其他功能。有关使用部署运行无状态应用程序的更多信息，请阅读使用部署[<span class="string">运行无状态应用程序</span>](<span class="link">https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">###### Bare Pods</span></span><br><span class="line">与用户直接创建pod的情况不同，ReplicaSet会替换因任何原因而被删除或终止的pod，例如在节点故障或破坏性节点维护（例如内核升级）的情况下。因此，即使您的应用程序只需要一个pod，我们也建议您使用ReplicaSet。可以想象它与流程主管类似，只是它监控多个节点上的多个pod而不是单个节点上的单个进程。ReplicaSet将本地容器重新启动委派给节点上的某个代理程序（例如，Kubelet或Docker）。</span><br><span class="line"></span><br><span class="line"><span class="section">###### Job</span></span><br><span class="line">对于预期会自行终止的pod（即批处理作业），请使用[<span class="string">``Job``</span>](<span class="link">https://kubernetes.io/docs/concepts/jobs/run-to-completion-finite-workloads/</span>)而不是ReplicaSet。</span><br><span class="line"></span><br><span class="line"><span class="section">###### DaemonSet</span></span><br><span class="line">[<span class="string">``DaemonSet``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/</span>)对于提供机器级功能的pod，例如机器监视或机器日志记录，请使用ReplicaSet而不是ReplicaSet。这些pod的生命周期与机器生命周期相关：pod需要在其他pod启动之前在机器上运行，并且当机器准备好重新启动/关闭时可以安全终止。</span><br><span class="line"></span><br><span class="line"><span class="section">#### ReplicationController</span></span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：现在建议使用配置ReplicaSet的Deployment来设置复制。</span></span><br><span class="line"></span><br><span class="line">ReplicationController确保pod副本的指定数量的在任何一个时间运行。换句话说，ReplicationController确保一个pod或一组同类pod总是可用。</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>ReplicationController的工作原理</span><br><span class="line"><span class="bullet">- </span>运行示例ReplicationController</span><br><span class="line"><span class="bullet">- </span>编写ReplicationController规范</span><br><span class="line"><span class="bullet">- </span>使用ReplicationControllers</span><br><span class="line"><span class="bullet">- </span>常见的使用模式</span><br><span class="line"><span class="bullet">- </span>编写复制程序</span><br><span class="line"><span class="bullet">- </span>ReplicationController的职责</span><br><span class="line"><span class="bullet">- </span>API对象</span><br><span class="line"><span class="bullet">- </span>ReplicationController的替代品</span><br><span class="line"><span class="bullet">- </span>欲获得更多信息</span><br><span class="line"></span><br><span class="line"><span class="section">##### ReplicationController的工作原理</span></span><br><span class="line">如果存在太多pod，则ReplicationController将终止额外的pod。如果太少，ReplicationController将启动更多pod。与手动创建的pod不同，ReplicationController维护的pod在失败，删除或终止时会自动替换。例如，在内核升级等破坏性维护之后，会在节点上重新创建pod。因此，即使应用程序只需要一个pod，也应该使用ReplicationController。ReplicationController类似于进程管理程序，但是ReplicationController不是监视单个节点上的各个进程，而是监视多个节点上的多个pod。</span><br><span class="line"></span><br><span class="line">在讨论中，ReplicationController通常缩写为“rc”或“rcs”，并且作为kubectl命令中的快捷方式。</span><br><span class="line"></span><br><span class="line">一个简单的例子是创建一个ReplicationController对象，以无限期地可靠地运行Pod的一个实例。更复杂的用例是运行复制服务的几个相同副本，例如Web服务器。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 运行示例ReplicationController</span></span><br><span class="line">此示例ReplicationController配置运行nginx Web服务器的三个副本。</span><br></pre></td></tr></table></figure></p>
<p>#controllers/replication.yaml<br>apiVersion: v1<br>kind: ReplicationController<br>metadata:<br>  name: nginx<br>spec:<br>  replicas: 3<br>  selector:<br>    app: nginx<br>  template:<br>    metadata:<br>      name: nginx<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx
  ports:
  - containerPort: 80
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过下载示例文件然后运行此命令来运行示例作业：</span><br></pre></td></tr></table></figure>
<p>$ kubectl create -f <a href="https://k8s.io/examples/controllers/replication.yaml" target="_blank" rel="noopener">https://k8s.io/examples/controllers/replication.yaml</a><br>replicationcontroller/nginx created<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用以下命令检查ReplicationController的状态：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl describe replicationcontrollers/nginx<br>Name:        nginx<br>Namespace:   default<br>Selector:    app=nginx<br>Labels:      app=nginx<br>Annotations:    <none><br>Replicas:    3 current / 3 desired<br>Pods Status: 0 Running / 3 Waiting / 0 Succeeded / 0 Failed<br>Pod Template:<br>  Labels:       app=nginx<br>  Containers:<br>   nginx:<br>    Image:              nginx<br>    Port:               80/TCP<br>    Environment:        <none><br>    Mounts:             <none><br>  Volumes:              <none><br>Events:<br>  FirstSeen       LastSeen     Count    From                        SubobjectPath    Type      Reason              Message</none></none></none></none></p>
<hr>
<p>  20s             20s          1        {replication-controller }                    Normal    SuccessfulCreate    Created pod: nginx-qrm3m<br>  20s             20s          1        {replication-controller }                    Normal    SuccessfulCreate    Created pod: nginx-3ntk0<br>  20s             20s          1        {replication-controller }                    Normal    SuccessfulCreate    Created pod: nginx-4ok8v<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里创建了三个pod，但没有一个正在运行，可能是因为正在拉动图像。稍后，相同的命令可能会显示：</span><br></pre></td></tr></table></figure></p>
<p>  Pods Status:    3 Running / 0 Waiting / 0 Succeeded / 0 Failed<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">要以机器可读的形式列出属于ReplicationController的所有pod，可以使用如下命令：</span><br></pre></td></tr></table></figure></p>
<p>  $ pods=$(kubectl get pods –selector=app=nginx –output=jsonpath={.items..metadata.name})<br>echo $pods<br>nginx-3ntk0 nginx-4ok8v nginx-qrm3m<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">这里，选择器与ReplicationController的选择器相同（在<span class="code">``kubectl describe`</span><span class="code">`输出中看到 ，并以不同的形式显示`</span><span class="code">`replication.yaml`</span><span class="code">`。该`</span><span class="code">`--output=jsonpath`</span>`选项指定一个表达式，它只从返回列表中的每个pod获取名称。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 编写ReplicationController规范</span></span><br><span class="line">与所有其他Kubernetes配置，一个ReplicationController需要<span class="code">``apiVersion`</span><span class="code">`，`</span><span class="code">`kind`</span><span class="code">`和`</span><span class="code">`metadata`</span>`领域。有关使用配置文件的一般信息，请参阅[<span class="string">对象管理</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/object-management-kubectl/overview/</span>)。</span><br><span class="line"></span><br><span class="line">ReplicationController还需要一个[<span class="string">``.spec``部分</span>](<span class="link">https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">###### Pod模板</span></span><br><span class="line">这<span class="code">``.spec.template`</span><span class="code">`是唯一必需的领域`</span><span class="code">`.spec`</span>`。</span><br><span class="line"></span><br><span class="line">这<span class="code">``.spec.template`</span><span class="code">`是一个[pod模板](https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/#pod-templates)。它与pod具有完全相同的架构，除了它是嵌套的并且没有`</span><span class="code">`apiVersion`</span><span class="code">`或`</span><span class="code">`kind`</span>`。</span><br><span class="line"></span><br><span class="line">除了Pod的必需字段之外，ReplicationController中的pod模板还必须指定适当的标签和适当的重新启动策略。对于标签，请确保不要与其他控制器重叠。请参阅[<span class="string">pod选择器</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/#pod-selector</span>)。</span><br><span class="line"></span><br><span class="line">只允许[<span class="string">``.spec.template.spec.restartPolicy``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy</span>)等于<span class="code">``Always`</span>`，如果未指定，则为默认值。</span><br><span class="line"></span><br><span class="line">对于本地容器重新启动，ReplicationControllers委托给节点上的代理程序，例如[<span class="string">``Kubelet``</span>](<span class="link">https://kubernetes.io/docs/admin/kubelet/</span>)或Docker。</span><br><span class="line"></span><br><span class="line"><span class="section">###### ReplicationController上的标签</span></span><br><span class="line">ReplicationController本身可以有labels（<span class="code">``.metadata.labels`</span><span class="code">`）。通常，您可以将它们设置为相同`</span><span class="code">`.spec.template.metadata.labels`</span><span class="code">`; 如果`</span><span class="code">`.metadata.labels`</span><span class="code">`未指定，则默认为`</span><span class="code">`.spec.template.metadata.labels`</span><span class="code">`。但是，允许它们不同，并且`</span><span class="code">`.metadata.labels`</span>`不会影响ReplicationController的行为。</span><br><span class="line"></span><br><span class="line"><span class="section">###### Pod选择器</span></span><br><span class="line">该<span class="code">``.spec.selector`</span>`字段是[<span class="string">标签选择器</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors</span>)。ReplicationController管理具有与选择器匹配的标签的所有pod。它不区分它创建或删除的pod以及另一个人或进程创建或删除的pod。这允许在不影响正在运行的pod的情况下替换ReplicationController。</span><br><span class="line"></span><br><span class="line">如果指定，则<span class="code">``.spec.template.metadata.labels`</span><span class="code">`必须等于`</span><span class="code">`.spec.selector`</span><span class="code">`，否则将被API拒绝。如果`</span><span class="code">`.spec.selector`</span><span class="code">`未指定，则默认为`</span><span class="code">` .spec.template.metadata.labels`</span>`。</span><br><span class="line"></span><br><span class="line">此外，您通常不应创建任何标签与此选择器匹配的pod，可以直接创建，与另一个ReplicationController或其他控制器（如Job）匹配。如果这样做，ReplicationController会认为它创建了其他pod。Kubernetes并没有阻止你这样做。</span><br><span class="line"></span><br><span class="line">如果最终有多个具有重叠选择器的控制器，则必须自己管理删除（见[<span class="string">下文</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/#working-with-replicationcontrollers</span>)）。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 多个副本</span></span><br><span class="line">您可以通过设置<span class="code">``.spec.replicas`</span>`要同时运行的窗格数来指定应同时运行的窗格数。在任何时间运行的数字可能更高或更低，例如，如果副本只是增加或减少，或者如果正常关闭吊舱，并且提前开始更换。</span><br><span class="line"></span><br><span class="line">如果未指定<span class="code">``.spec.replicas`</span>`，则默认为1。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 使用ReplicationControllers</span></span><br><span class="line"><span class="section">###### 删除ReplicationController及其Pod</span></span><br><span class="line">要删除ReplicationController及其所有pod，请使用<span class="code">``kubectl delete`</span>`。在删除ReplicationController本身之前，Kubectl会将ReplicationController缩放为零并等待它删除每个pod。如果此kubectl命令被中断，则可以重新启动它。</span><br><span class="line"></span><br><span class="line">使用REST API或转到客户端库时，需要显式执行这些步骤（将副本扩展为0，等待窗格删除，然后删除ReplicationController）。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 仅删除ReplicationController</span></span><br><span class="line">您可以删除ReplicationController而不影响其任何pod。</span><br><span class="line"></span><br><span class="line">使用kubectl，指定<span class="code">``--cascade=false`</span><span class="code">`选项[`</span><span class="code">`kubectl delete`</span>`](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#delete)。</span><br><span class="line"></span><br><span class="line">使用REST API或转到客户端库时，只需删除ReplicationController对象即可。</span><br><span class="line"></span><br><span class="line">删除原始文件后，您可以创建一个新的ReplicationController来替换它。只要旧的和新<span class="code">``.spec.selector`</span>`的相同，那么新的将采用旧的pod。但是，它不会做任何努力使现有的pod匹配一个新的，不同的pod模板。要以受控方式将pod更新为新规范，请使用[<span class="string">滚动更新</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/#rolling-updates</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 从ReplicationController中隔离pod</span></span><br><span class="line">可以通过更改标签来从ReplicationController的目标集中删除Pod。此技术可用于从服务中删除pod以进行调试，数据恢复等。以这种方式删除的Pod将自动替换（假设副本的数量也未更改）。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 常见的使用模式</span></span><br><span class="line"><span class="section">###### 重新安排</span></span><br><span class="line"></span><br><span class="line">如上所述，无论您是要保持运行1个pod还是1000个，ReplicationController都将确保存在指定数量的pod，即使在节点发生故障或pod终止时（例如，由于另一个控制剂）。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 缩放</span></span><br><span class="line">通过简单地更新<span class="code">``replicas`</span>`字段，ReplicationController可以手动或通过自动缩放控制代理轻松扩展或缩小副本数量。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 滚动更新</span></span><br><span class="line">ReplicationController旨在通过逐个替换pod来促进对服务的滚动更新。</span><br><span class="line"></span><br><span class="line">如[<span class="string">＃1353</span>](<span class="link">http://issue.k8s.io/1353</span>)中所述，建议的方法是创建一个具有1个副本的新ReplicationController，逐个扩展新的（+1）和旧（-1）控制器，然后在它达到0个副本后删除旧控制器。无论意外故障如何，这都可以预测更新pod的集合。</span><br><span class="line"></span><br><span class="line">理想情况下，滚动更新控制器会考虑应用程序准备情况，并确保在任何给定时间内有足够数量的pod可以高效地运行。</span><br><span class="line"></span><br><span class="line">这两个ReplicationControllers需要创建具有至少一个区分标签的pod，例如pod的主容器的image标签，因为它通常是图像更新，可以激发滚动更新。</span><br><span class="line"></span><br><span class="line">滚动更新在客户端工具中实现 [<span class="string">``kubectl rolling-update``</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#rolling-update</span>)。访问[<span class="string">``kubectl rolling-update``</span>](<span class="link">https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/</span>)任务以获得更具体的示例。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 多个发行tracks</span></span><br><span class="line">除了在滚动更新正在进行时运行多个版本的应用程序之外，通常使用多个版本跟踪长时间运行多个版本，甚至连续运行多个版本。轨道将按标签区分。</span><br><span class="line"></span><br><span class="line">例如，服务可能会定位所有pod <span class="code">``tier in (frontend), environment in (prod)`</span><span class="code">`。现在说你有10个复制的pod组成这个层。但是你希望能够'canary'这个组件的新版本。您可以`</span><span class="code">`replicas`</span><span class="code">`为大部分副本设置一个设置为9 的ReplicationController ，带有标签`</span><span class="code">`tier=frontend, environment=prod, track=stable`</span><span class="code">`，另一个`</span><span class="code">`replicas`</span><span class="code">`设置为1的带有标签的ReplicationController 用于canary`</span><span class="code">`tier=frontend, environment=prod, track=canary`</span>`。现在该服务涵盖了canary和non-canary pods。但是你可以分别搞乱ReplicationControllers来测试，监视结果等。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 将ReplicationControllers与Services一起使用</span></span><br><span class="line">多个ReplicationControllers可以位于单个服务之后，例如，某些流量转到旧版本，有些流量转到新版本。</span><br><span class="line"></span><br><span class="line">ReplicationController永远不会自行终止，但预计它不会像服务一样长寿。服务可以由多个ReplicationControllers控制的pod组成，并且预计可以在服务的生命周期内创建和销毁许多ReplicationController（例如，执行运行服务的pod的更新）。服务本身及其客户端都应该忽略维护服务pod的ReplicationControllers。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 编写复制程序</span></span><br><span class="line">由ReplicationController创建的Pod旨在是可互换的和语义相同的，尽管它们的配置可能随着时间的推移变得异构。这显然适用于复制的无状态服务器，但ReplicationControllers也可用于维护主选，分片和工作池应用程序的可用性。此类应用程序应使用动态工作分配机制，例如[<span class="string">RabbitMQ工作队列</span>](<span class="link">https://www.rabbitmq.com/tutorials/tutorial-two-python.html</span>)，而不是静态/一次性定制每个pod的配置，这被视为反模式。执行的任何pod自定义，例如资源的垂直自动调整（例如，cpu或内存），应由另一个在线控制器进程执行，与ReplicationController本身不同。</span><br><span class="line"></span><br><span class="line"><span class="section">##### ReplicationController的职责</span></span><br><span class="line">ReplicationController只是确保所需数量的pod与其标签选择器匹配并且可以运行。目前，只有已终止的广告连播从其计数中排除。将来，可以考虑系统提供的[<span class="string">准备情况</span>](<span class="link">http://issue.k8s.io/620</span>)和其他信息，我们可以对替换策略添加更多控制，并且我们计划发出可以由外部客户使用的事件，以实现任意复杂的替换和/或扩展下行政策。</span><br><span class="line"></span><br><span class="line">ReplicationController永远受限于这种狭隘的责任。它本身不会执行准备就绪或活力探测。它不是执行自动缩放，而是由外部自动缩放器控制（如[<span class="string">＃492中所述</span>](<span class="link">http://issue.k8s.io/492</span>)），这将改变其<span class="code">``replicas`</span>`字段。我们不会将调度策略（例如，[<span class="string">传播</span>](<span class="link">http://issue.k8s.io/367#issuecomment-48428019</span>)）添加到ReplicationController。它也不应该验证控制的pod与当前指定的模板匹配，因为这会妨碍自动调整大小和其他自动化过程。同样，完成期限，排序依赖性，配置扩展和其他功能属于其他地方。我们甚至计划分析批量pod创建的机制（[<span class="string">＃170</span>](<span class="link">http://issue.k8s.io/170</span>)）。</span><br><span class="line"></span><br><span class="line">ReplicationController旨在成为可组合的构建块原语。我们希望在它和其他补充原语之上构建更高级别的API和/或工具，以便将来用户使用。kubectl目前支持的“宏”操作（运行，缩放，滚动更新）是概念验证的例子。例如，我们可以想象像[<span class="string">Asgard</span>](<span class="link">http://techblog.netflix.com/2012/06/asgard-web-based-cloud-management-and.html</span>)管理ReplicationControllers，自动缩放器，服务，调度策略，canary等。</span><br><span class="line"></span><br><span class="line"><span class="section">##### API对象</span></span><br><span class="line">复制控制器是Kubernetes REST API中的顶级资源。有关API对象的更多详细信息，请访问： [<span class="string">ReplicationController API</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#replicationcontroller-v1-core</span>)对象。</span><br><span class="line"></span><br><span class="line"><span class="section">##### ReplicationController的替代品</span></span><br><span class="line"><span class="section">###### ReplicaSet</span></span><br><span class="line">[<span class="string">``ReplicaSet``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/</span>)是支持新的[<span class="string">基于集合的标签选择器</span>](<span class="link">https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#set-based-requirement</span>)的下一代ReplicationController 。它主要用作[<span class="string">``Deployment``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</span>)协调pod创建，删除和更新的机制。请注意，除非您需要自定义更新编排或根本不需要更新，否则我们建议您使用“部署”而不是直接使用“副本集”。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 部署（推荐）</span></span><br><span class="line">[<span class="string">``Deployment``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</span>)是一个更高级别的API对象，它以类似的方式更新其基础副本集及其Pod <span class="code">``kubectl rolling-update`</span><span class="code">`。如果您需要此滚动更新功能，则建议进行部署，因为`</span><span class="code">`kubectl rolling-update`</span>`它们不同于声明式，服务器端，并具有其他功能。</span><br><span class="line"></span><br><span class="line"><span class="section">###### pod</span></span><br><span class="line">与用户直接创建pod的情况不同，ReplicationController替换因任何原因而被删除或终止的pod，例如在节点故障或破坏性节点维护（例如内核升级）的情况下。因此，即使您的应用程序只需要一个pod，我们也建议您使用ReplicationController。可以想象它与流程主管类似，只是它监控多个节点上的多个pod而不是单个节点上的单个进程。ReplicationController将本地容器重新启动委派给节点上的某个代理（例如，Kubelet或Docker）。</span><br><span class="line"></span><br><span class="line"><span class="section">###### job</span></span><br><span class="line">[<span class="string">``Job``</span>](<span class="link">https://kubernetes.io/docs/concepts/jobs/run-to-completion-finite-workloads/</span>)对于预期会自行终止的pod（即批处理作业），请使用而不是ReplicationController。</span><br><span class="line"></span><br><span class="line"><span class="section">###### DaemonSet</span></span><br><span class="line">[<span class="string">``DaemonSet``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/</span>)对于提供机器级功能的pod，例如机器监视或机器日志记录，请使用而不是ReplicationController。这些pod的生命周期与机器生命周期相关：pod需要在其他pod启动之前在机器上运行，并且当机器准备好重新启动/关闭时可以安全终止。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 欲获得更多信息</span></span><br><span class="line">读取[<span class="string">运行无状态AP复制控制器</span>](<span class="link">https://kubernetes.io/docs/tutorials/stateless-application/run-stateless-ap-replication-controller/</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">#### 部署</span></span><br><span class="line">一个部署控制器提供声明更新[<span class="string">pod</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/pods/pod/</span>)和 [<span class="string">ReplicaSets</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/</span>)。</span><br><span class="line"></span><br><span class="line">您在Deployment对象中描述了所需的状态，Deployment控制器以受控速率将实际状态更改为所需状态。您可以定义部署以创建新的ReplicaSet，或者删除现有的部署并使用新的部署采用所有资源。</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：您不应管理部署所拥有的ReplicaSet。应通过操作Deployment对象来涵盖所有用例。如果您的用例未在下面介绍，请考虑在主Kubernetes存储库中打开一个问题。</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>用例</span><br><span class="line"><span class="bullet">- </span>创建部署</span><br><span class="line"><span class="bullet">- </span>更新部署</span><br><span class="line"><span class="bullet">- </span>回滚部署</span><br><span class="line"><span class="bullet">- </span>扩展部署</span><br><span class="line"><span class="bullet">- </span>暂停和恢复部署</span><br><span class="line"><span class="bullet">- </span>部署状态</span><br><span class="line"><span class="bullet">- </span>清理政策</span><br><span class="line"><span class="bullet">- </span>用例</span><br><span class="line"><span class="bullet">- </span>编写部署规范</span><br><span class="line"><span class="bullet">- </span>部署的替代方案</span><br><span class="line"></span><br><span class="line"><span class="section">##### 用例</span></span><br><span class="line">以下是部署的典型用例：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>[<span class="string">创建部署以部署副本集</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment</span>)。ReplicaSet在后台创建Pod。检查卷展栏的状态以查看它是否成功。</span><br><span class="line"><span class="bullet">- </span>通过更新Deployment的PodTemplateSpec来[<span class="string">声明</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment</span>) Pod 的[<span class="string">新状态</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment</span>)。创建一个新的ReplicaSet，Deployment部署管理以受控速率将Pod从旧ReplicaSet移动到新ReplicaSet。每个新的ReplicaSet都会更新Deployment的修订版。</span><br><span class="line"><span class="bullet">- </span>如果[<span class="string">部署</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-back-a-deployment</span>)的当前状态不稳定，则[<span class="string">回滚到早期的部署修订版</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-back-a-deployment</span>)。每次回滚都会更新Deployment的修订版。</span><br><span class="line"><span class="bullet">- </span>[<span class="string">扩展部署以促进更多负载</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment</span>)。</span><br><span class="line"><span class="bullet">- </span>[<span class="string">暂停部署</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#pausing-and-resuming-a-deployment</span>)以将多个修复程序应用于其PodTemplateSpec，然后恢复它以启动新的部署。</span><br><span class="line"><span class="bullet">- </span>[<span class="string">使用部署的状态</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#deployment-status</span>)作为卷展栏卡住的指示符。</span><br><span class="line"><span class="bullet">- </span>[<span class="string">清理</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#clean-up-policy</span>)不再需要的[<span class="string">旧ReplicaSet</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#clean-up-policy</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">##### 创建部署</span></span><br><span class="line"></span><br><span class="line">以下是部署的示例。它创建一个ReplicaSet来调出三个Pod <span class="code">``nginx`</span>`：</span><br></pre></td></tr></table></figure></p>
<p>#controllers/nginx-deployment.yaml<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nginx-deployment<br>  labels:<br>    app: nginx<br>spec:<br>  replicas: 3<br>  selector:<br>    matchLabels:<br>      app: nginx<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:</p>
<pre><code>- name: nginx
  image: nginx:1.7.9
  ports:
  - containerPort: 80
</code></pre><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">在这个例子中：</span><br><span class="line">- ``nginx-deployment``创建名为的部署，由``.metadata.name``字段指示。</span><br><span class="line">- 部署创建三个复制的Pod，由``replicas``字段指示。</span><br><span class="line">- 该``selector``字段定义了Deployment如何找到要管理的Pod。在这种情况下，您只需选择Pod模板（``app: nginx``）中定义的标签。但是，只要Pod模板本身满足规则，就可以使用更复杂的选择规则。</span><br><span class="line"></span><br><span class="line">&gt; 注意： ``matchLabels``是&#123;key，value&#125;对的映射。``matchLabels``映射中的单个&#123;key，value&#125; 等效``matchExpressions``于其元素，其键字段为“key”，运算符为“In”，值数组仅包含“value”。要求是AND。</span><br><span class="line"></span><br><span class="line">- 该``template``字段包含以下子字段：</span><br><span class="line">  - ``app: nginx``使用该``labels``字段标记Pod 。</span><br><span class="line">  - Pod模板的规范或.template.spec字段表示Pod 运行一个容器nginx，该容器在版本<span class="number">1.7</span><span class="number">.9</span>下运行nginx Docker Hub映像。</span><br><span class="line">  - 创建一个容器并nginx使用该name字段命名。</span><br><span class="line">  - nginx在版本运行图像<span class="number">1.7</span><span class="number">.9</span>。</span><br><span class="line">  - 打开端口，<span class="number">80</span>以便容器可以发送和接受流量。</span><br><span class="line"> </span><br><span class="line">要创建此部署，请运行以下命令：</span><br></pre></td></tr></table></figure>
<p>kubectl create -f <a href="https://k8s.io/examples/controllers/nginx-deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/controllers/nginx-deployment.yaml</a><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; 注意：您可以指定``--record``标志以写入在资源批注中执行的命令kubernetes.io/change-cause。它对于将来的内省非常有用，例如，可以查看每个Deployment修订版中执行的命令。</span><br><span class="line"></span><br><span class="line">接下来，运行``kubectl get deployments``。输出类似于以下内容：</span><br></pre></td></tr></table></figure></p>
<p>NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br>nginx-deployment   3         0         0            0           1s<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">检查群集中的“部署”时，将显示以下字段：</span><br><span class="line"></span><br><span class="line">- ``NAME`` 列出群集中的部署名称。</span><br><span class="line">- ``DESIRED``显示应用程序的所需副本数，您在创建部署时定义这些副本。这是理想的状态。</span><br><span class="line">- ``CURRENT`` 显示当前正在运行的副本数量。</span><br><span class="line">- ``UP-TO-DATE`` 显示已更新以实现所需状态的副本数。</span><br><span class="line">- ``AVAILABLE`` 显示用户可以使用的应用程序副本数。</span><br><span class="line">- ``AGE`` 显示应用程序运行的时间。</span><br><span class="line"></span><br><span class="line">请注意每个字段中的值如何与Deployment规范中的值相对应：</span><br><span class="line"></span><br><span class="line">- 根据``.spec.replicas``字段，所需副本的数量为<span class="number">3</span> 。</span><br><span class="line">- 根据``.status.replicas``字段，当前副本的数量为<span class="number">0</span> 。</span><br><span class="line">- 根据``.status.updatedReplicas``字段，最新副本的数量为<span class="number">0</span> 。</span><br><span class="line">- 根据``.status.availableReplicas``字段，可用副本的数量为<span class="number">0</span> 。</span><br><span class="line"></span><br><span class="line">要查看“部署”卷展栏状态，请运行``kubectl rollout status deployment.v1.apps/nginx-deployment``。此命令返回以下输出：</span><br></pre></td></tr></table></figure></p>
<p>Waiting for rollout to finish: 2 out of 3 new replicas have been updated…<br>deployment.apps/nginx-deployment successfully rolled out<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">``kubectl get deployments``几秒钟后再次运行：</span><br></pre></td></tr></table></figure></p>
<p>NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br>nginx-deployment   3         3         3            3           18s<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">请注意，Deployment已创建所有三个副本，并且所有副本都是最新的（它们包含最新的Pod模板）并且可用（Pod状态至少为Deployment的``.spec.minReadySeconds``字段值准备就绪）。</span><br><span class="line"></span><br><span class="line">要查看``rs``部署创建的ReplicaSet（），请运行``kubectl get rs``：</span><br></pre></td></tr></table></figure></p>
<p>NAME                          DESIRED   CURRENT   READY   AGE<br>nginx-deployment-2035384211   3         3         3       18s<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">请注意，ReplicaSet的名称始终格式为``[DEPLOYMENT-NAME]-[POD-TEMPLATE-HASH-VALUE]``。创建部署时会自动生成哈希值。</span><br><span class="line"></span><br><span class="line">要查看为每个pod自动生成的标签，请运行``kubectl get pods --show-labels``。返回以下输出：</span><br></pre></td></tr></table></figure></p>
<p>NAME                                READY     STATUS    RESTARTS   AGE       LABELS<br>nginx-deployment-2035384211-7ci7o   1/1       Running   0          18s       app=nginx,pod-template-hash=2035384211<br>nginx-deployment-2035384211-kzszj   1/1       Running   0          18s       app=nginx,pod-template-hash=2035384211<br>nginx-deployment-2035384211-qqcnn   1/1       Running   0          18s       app=nginx,pod-template-hash=2035384211<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">创建的ReplicaSet确保始终有三个Pod ``nginx``在运行。</span><br><span class="line"></span><br><span class="line">&gt; 注意：您必须在部署中指定适当的选择器和Pod模板标签（在本例中 ``app: nginx``）。不要将标签或选择器与其他控制器（包括其他部署和StatefulSet）重叠。Kubernetes不会阻止您重叠，如果多个控制器具有重叠的选择器，那么这些控制器可能会发生冲突并出现意外行为。</span><br><span class="line"></span><br><span class="line">###### Pod-template-hash标签</span><br><span class="line"></span><br><span class="line">&gt; 注意：请勿更改此标签。</span><br><span class="line"></span><br><span class="line">``pod-template-hash``部署控制器将标签添加到部署创建或采用的每个ReplicaSet。</span><br><span class="line"></span><br><span class="line">此标签可确保部署的子ReplicaSet不重叠。它是通过散列``PodTemplate``ReplicaSet并使用生成的散列作为添加到ReplicaSet选择器，Pod模板标签以及ReplicaSet可能具有的任何现有Pod中的标签值生成的。</span><br><span class="line"></span><br><span class="line">##### 更新部署</span><br><span class="line"></span><br><span class="line">&gt; 注意：当且仅当部署的pod模板（即``.spec.template``）更改时，才会触发Deployment的部署，例如，如果更新模板的标签或容器图像。其他更新（例如扩展部署）不会触发部署。</span><br><span class="line"></span><br><span class="line">假设您现在想要更新nginx Pod以使用``nginx:<span class="number">1.9</span><span class="number">.1</span>``镜像而不是``nginx:<span class="number">1.7</span><span class="number">.9</span>``图像。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl –record deployment.apps/nginx-deployment set image deployment.v1.apps/nginx-deployment<br>nginx=nginx:1.9.1 image updated<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">或者，您可以``edit``部署和改变``.spec.template.spec.containers[<span class="number">0</span>].image``从``nginx:<span class="number">1.7</span><span class="number">.9</span>``到``nginx:<span class="number">1.9</span><span class="number">.1</span>``：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl edit deployment.v1.apps/nginx-deployment<br>deployment.apps/nginx-deployment edited<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">要查看卷展栏状态，请运行：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl rollout status deployment.v1.apps/nginx-deployment<br>Waiting for rollout to finish: 2 out of 3 new replicas have been updated…<br>deployment.apps/nginx-deployment successfully rolled out<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">部署成功后，您可能需要``get``部署：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl get deployments<br>NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br>nginx-deployment   3         3         3            3           36s<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">最新副本的数量表示Deployment已将副本更新为最新配置。当前副本表示此部署管理的副本总数，可用副本表示可用的当前副本数。</span><br><span class="line"></span><br><span class="line">您可以运行``kubectl get rs``以查看部署通过创建新的ReplicaSet并将其扩展到<span class="number">3</span>个副本来更新Pod，以及将旧的ReplicaSet缩减为<span class="number">0</span>个副本。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl get rs<br>NAME                          DESIRED   CURRENT   READY   AGE<br>nginx-deployment-1564180365   3         3         3       6s<br>nginx-deployment-2035384211   0         0         0       36s<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">``get pods``现在运行应该只显示新的Pod：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl get pods<br>NAME                                READY     STATUS    RESTARTS   AGE<br>nginx-deployment-1564180365-khku8   1/1       Running   0          14s<br>nginx-deployment-1564180365-nacti   1/1       Running   0          14s<br>nginx-deployment-1564180365-z9gth   1/1       Running   0          14s<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">下次要更新这些Pod时，只需再次更新Deployment的pod模板。</span><br><span class="line"></span><br><span class="line">部署可以确保在更新时只有一定数量的Pod可能会关闭。默认情况下，它确保至少比所需的Pod数量少<span class="number">25</span>％（最大不可用<span class="number">25</span>％）。</span><br><span class="line"></span><br><span class="line">部署还可以确保在所需数量的Pod之上只能创建一定数量的Pod。默认情况下，它确保最多比所需数量的Pod多<span class="number">25</span>％（最大浪涌<span class="number">25</span>％）。</span><br><span class="line"></span><br><span class="line">例如，如果仔细查看上面的部署，您将看到它首先创建了一个新的Pod，然后删除了一些旧的Pod并创建了新的Pod。在有足够数量的新Pod出现之前，它不会杀死旧的Pod，并且在足够数量的旧Pod被杀之前不会创建新的Pod。它确保可用Pod的数量至少为<span class="number">2</span>，并且Pod的总数最多为<span class="number">4</span>。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl describe deployments<br>Name:                   nginx-deployment<br>Namespace:              default<br>CreationTimestamp:      Thu, 30 Nov 2017 10:56:25 +0000<br>Labels:                 app=nginx<br>Annotations:            deployment.kubernetes.io/revision=2<br>Selector:               app=nginx<br>Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable<br>StrategyType:           RollingUpdate<br>MinReadySeconds:        0<br>RollingUpdateStrategy:  25% max unavailable, 25% max surge<br>Pod Template:<br>  Labels:  app=nginx<br>  Containers:<br>   nginx:<br>    Image:        nginx:1.9.1<br>    Port:         80/TCP<br>    Environment:  <none><br>    Mounts:       <none><br>  Volumes:        <none><br>Conditions:<br>  Type           Status  Reason</none></none></none></p>
<hr>
<p>  Available      True    MinimumReplicasAvailable<br>  Progressing    True    NewReplicaSetAvailable<br>OldReplicaSets:  <none><br>NewReplicaSet:   nginx-deployment-1564180365 (3/3 replicas created)<br>Events:<br>  Type    Reason             Age   From                   Message</none></p>
<hr>
<p>  Normal  ScalingReplicaSet  2m    deployment-controller  Scaled up replica set nginx-deployment-2035384211 to 3<br>  Normal  ScalingReplicaSet  24s   deployment-controller  Scaled up replica set nginx-deployment-1564180365 to 1<br>  Normal  ScalingReplicaSet  22s   deployment-controller  Scaled down replica set nginx-deployment-2035384211 to 2<br>  Normal  ScalingReplicaSet  22s   deployment-controller  Scaled up replica set nginx-deployment-1564180365 to 2<br>  Normal  ScalingReplicaSet  19s   deployment-controller  Scaled down replica set nginx-deployment-2035384211 to 1<br>  Normal  ScalingReplicaSet  19s   deployment-controller  Scaled up replica set nginx-deployment-1564180365 to 3<br>  Normal  ScalingReplicaSet  14s   deployment-controller  Scaled down replica set nginx-deployment-2035384211 to 0<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">在这里，您可以看到，当您第一次创建部署时，它创建了一个ReplicaSet（nginx-deployment<span class="number">-2035384211</span>）并直接将其扩展到<span class="number">3</span>个副本。更新部署时，它创建了一个新的ReplicaSet（nginx-deployment<span class="number">-1564180365</span>）并将其扩展为<span class="number">1</span>，然后将旧的ReplicaSet缩小为<span class="number">2</span>，这样至少有<span class="number">2</span>个Pod可用，最多创建了<span class="number">4</span>个Pod一直。然后，它继续使用相同的滚动更新策略向上和向下扩展新旧ReplicaSet。最后，您将在新的ReplicaSet中拥有<span class="number">3</span>个可用副本，并将旧的ReplicaSet缩小为<span class="number">0</span>。</span><br><span class="line"></span><br><span class="line">###### Rollover (aka multiple updates <span class="keyword">in</span>-flight)</span><br><span class="line">每次部署控制器观察到新的部署对象时，如果没有现有的ReplicaSet，则会创建ReplicaSet以显示所需的Pod。现有的ReplicaSet控制其标签匹配``.spec.selector``但模板不匹配的Pod ``.spec.template``按比例缩小。最终，新的ReplicaSet将缩放到，``.spec.replicas``并且所有旧的ReplicaSet将缩放为<span class="number">0</span>。</span><br><span class="line"></span><br><span class="line">如果在现有部署过程中更新部署，则部署将根据更新创建新的ReplicaSet并开始向上扩展，并将翻转之前正在扩展的ReplicaSet - 它会将其添加到其列表中旧的ReplicaSet和将开始缩小它。</span><br><span class="line"></span><br><span class="line">例如，假设您创建了一个部署以创建<span class="number">5</span>个副本``nginx:<span class="number">1.7</span><span class="number">.9</span>``，但是``nginx:<span class="number">1.9</span><span class="number">.1</span>``当仅创建了<span class="number">3</span>个副本时，则更新部署以创建<span class="number">5</span>个副本``nginx:<span class="number">1.7</span><span class="number">.9</span>``。在这种情况下，部署将立即开始杀死``nginx:<span class="number">1.7</span><span class="number">.9</span>``它创建的<span class="number">3</span>个Pod，并将开始创建 ``nginx:<span class="number">1.9</span><span class="number">.1</span>Pod``。``nginx:<span class="number">1.7</span><span class="number">.9</span>``在更改课程之前，它不会等待创建<span class="number">5</span>个副本。</span><br><span class="line"></span><br><span class="line">###### 标签选择器更新</span><br><span class="line">通常不鼓励进行标签选择器更新，建议您事先规划选择器。在任何情况下，如果您需要执行标签选择器更新，请务必小心谨慎，并确保您已掌握所有含义。</span><br><span class="line"></span><br><span class="line">&gt; 注意：在API版本中``apps/v1``，部署的标签选择器在创建后是不可变的。</span><br><span class="line"></span><br><span class="line">- 选择器添加要求使用新标签更新部署规范中的pod模板标签，否则将返回验证错误。此更改是非重叠的，这意味着新选择器不会选择使用旧选择器创建的ReplicaSet和Pod，从而导致孤立所有旧ReplicaSet并创建新的ReplicaSet。</span><br><span class="line">- 选择器更新 - 即更改选择器键中的现有值 - 导致与添加相同的行为。</span><br><span class="line">- 选择器删除 - 即从部署选择器中删除现有密钥 - 不需要对pod模板标签进行任何更改。没有现有的ReplicaSet是孤立的，并且未创建新的ReplicaSet，但请注意，已删除的标签仍存在于任何现有的Pod和ReplicaSet中。</span><br><span class="line"></span><br><span class="line">##### 回滚部署</span><br><span class="line">有时您可能想要回滚部署; 例如，当部署不稳定时，例如崩溃循环。默认情况下，所有Deployment的卷展栏历史记录都保留在系统中，以便您可以随时回滚（可以通过修改修订历史记录限制来更改）。</span><br><span class="line"></span><br><span class="line">&gt; 注意：触发Deployment的部署时会创建Deployment的修订版。这意味着当且仅当部署的pod模板（``.spec.template``）发生更改时才会创建新修订，例如，如果更新模板的标签或容器图像。其他更新（例如扩展部署）不会创建部署版本，因此您可以方便地同时进行手动或自动扩展。这意味着当您回滚到早期版本时，仅回滚Deployment的pod模板部分。</span><br><span class="line"></span><br><span class="line">假设您在更新部署时输入了拼写错误，方法是将图像名称``nginx:<span class="number">1.91</span>``替换为``nginx:<span class="number">1.9</span><span class="number">.1</span>``：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.91 –record=true<br>deployment.apps/nginx-deployment image updated<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">推出将被卡住。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl rollout status deployment.v1.apps/nginx-deployment<br>Waiting for rollout to finish: 1 out of 3 new replicas have been updated…<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">按Ctrl-C可停止上面的卷展状态监视。有关卡片推出的更多信息， [<span class="string">请在此处阅读更多信息</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#deployment-status</span>)。</span><br><span class="line"></span><br><span class="line">您将看到旧副本的数量（nginx-deployment-1564180365和nginx-deployment-2035384211）为2，新副本（nginx-deployment-3066724191）为1。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl get rs<br>NAME                          DESIRED   CURRENT   READY   AGE<br>nginx-deployment-1564180365   3         3         3       25s<br>nginx-deployment-2035384211   0         0         0       36s<br>nginx-deployment-3066724191   1         1         0       6s<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看创建的Pod，您将看到由新ReplicaSet创建的<span class="number">1</span> Pod陷入图像拉环。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl get pods<br>NAME                                READY     STATUS             RESTARTS   AGE<br>nginx-deployment-1564180365-70iae   1/1       Running            0          25s<br>nginx-deployment-1564180365-jbqqo   1/1       Running            0          25s<br>nginx-deployment-1564180365-hysrc   1/1       Running            0          25s<br>nginx-deployment-3066724191-08mng   0/1       ImagePullBackOff   0          6s<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 注意： Deployment控制器将自动停止错误的卷展栏，并将停止扩展新的ReplicaSet。这取决于maxUnavailable您指定的rollingUpdate参数（特别是）。默认情况下，Kubernetes将值设置为25％。</span></span><br></pre></td></tr></table></figure></p>
<p>$ kubectl describe deployment<br>Name:           nginx-deployment<br>Namespace:      default<br>CreationTimestamp:  Tue, 15 Mar 2016 14:48:04 -0700<br>Labels:         app=nginx<br>Selector:       app=nginx<br>Replicas:       3 desired | 1 updated | 4 total | 3 available | 1 unavailable<br>StrategyType:       RollingUpdate<br>MinReadySeconds:    0<br>RollingUpdateStrategy:  25% max unavailable, 25% max surge<br>Pod Template:<br>  Labels:  app=nginx<br>  Containers:<br>   nginx:<br>    Image:        nginx:1.91<br>    Port:         80/TCP<br>    Host Port:    0/TCP<br>    Environment:  <none><br>    Mounts:       <none><br>  Volumes:        <none><br>Conditions:<br>  Type           Status  Reason</none></none></none></p>
<hr>
<p>  Available      True    MinimumReplicasAvailable<br>  Progressing    True    ReplicaSetUpdated<br>OldReplicaSets:     nginx-deployment-1564180365 (3/3 replicas created)<br>NewReplicaSet:      nginx-deployment-3066724191 (1/1 replicas created)<br>Events:<br>  FirstSeen LastSeen    Count   From                    SubobjectPath   Type        Reason              Message</p>
<hr>
<p>  1m        1m          1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-2035384211 to 3<br>  22s       22s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 1<br>  22s       22s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 2<br>  22s       22s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 2<br>  21s       21s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 1<br>  21s       21s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 3<br>  13s       13s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 0<br>  13s       13s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-3066724191 to 1<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">要解决此问题，您需要回滚到稳定的以前版本的Deployment。</span><br><span class="line"></span><br><span class="line">###### 检查部署的部署历史记录</span><br><span class="line">首先，检查此部署的修订版：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl rollout history deployment.v1.apps/nginx-deployment<br>deployments “nginx-deployment”<br>REVISION    CHANGE-CAUSE<br>1           kubectl create –filename=<a href="https://k8s.io/examples/controllers/nginx-deployment.yaml" target="_blank" rel="noopener">https://k8s.io/examples/controllers/nginx-deployment.yaml</a> –record=true<br>2           kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1 –record=true<br>3           kube    ctl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.91 –record=true<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">``CHANGE-CAUSEkubernetes.io/change-cause``在创建时从部署批注复制到其修订版。您可以``CHANGE-CAUSE``通过以下方式指定消息： </span><br><span class="line">- 注释部署 ``kubectl annotate deployment.v1.apps/nginx-deployment kubernetes.io/change-cause=<span class="string">"image updated to 1.9.1"</span>``</span><br><span class="line">- 附加``--record``标志以保存``kubectl``对资源进行更改的命令。</span><br><span class="line">- 手动编辑资源的清单。</span><br><span class="line"></span><br><span class="line">要进一步查看每个修订的详细信息，请运行：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl rollout history deployment.v1.apps/nginx-deployment –revision=2<br>deployments “nginx-deployment” revision 2<br>  Labels:       app=nginx<br>          pod-template-hash=1159050644<br>  Annotations:  kubernetes.io/change-cause=kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1 –record=true<br>  Containers:<br>   nginx:<br>    Image:      nginx:1.9.1<br>    Port:       80/TCP<br>     QoS Tier:<br>        cpu:      BestEffort<br>        memory:   BestEffort<br>    Environment Variables:      <none><br>  No volumes.<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">###### 回滚到以前的版本</span><br><span class="line">现在，您已决定撤消当前的卷展栏并回滚到上一版本：</span><br></pre></td></tr></table></figure></none></p>
<p>$ kubectl rollout undo deployment.v1.apps/nginx-deployment<br>deployment.apps/nginx-deployment<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">或者，您可以通过在``--to-revision``以下位置指定回滚到特定修订：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl rollout undo deployment.v1.apps/nginx-deployment –to-revision=2<br>deployment.apps/nginx-deployment<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">有关与推出相关的命令的更多详细信息，请阅读[<span class="string">kubectl rollout</span>](<span class="link">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#rollout</span>)。</span><br><span class="line"></span><br><span class="line">部署现在回滚到以前的稳定版本。如您所见，<span class="code">``DeploymentRollback`</span>`从Deployment控制器生成用于回滚到版本2 的事件。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl get deployment nginx-deployment<br>NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br>nginx-deployment   3         3         3            3           30m</p>
<p>$ kubectl describe deployment nginx-deployment<br>Name:                   nginx-deployment<br>Namespace:              default<br>CreationTimestamp:      Sun, 02 Sep 2018 18:17:55 -0500<br>Labels:                 app=nginx<br>Annotations:            deployment.kubernetes.io/revision=4<br>                        kubernetes.io/change-cause=kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1 –record=true<br>Selector:               app=nginx<br>Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable<br>StrategyType:           RollingUpdate<br>MinReadySeconds:        0<br>RollingUpdateStrategy:  25% max unavailable, 25% max surge<br>Pod Template:<br>  Labels:  app=nginx<br>  Containers:<br>   nginx:<br>    Image:        nginx:1.9.1<br>    Port:         80/TCP<br>    Host Port:    0/TCP<br>    Environment:  <none><br>    Mounts:       <none><br>  Volumes:        <none><br>Conditions:<br>  Type           Status  Reason</none></none></none></p>
<hr>
<p>  Available      True    MinimumReplicasAvailable<br>  Progressing    True    NewReplicaSetAvailable<br>OldReplicaSets:  <none><br>NewReplicaSet:   nginx-deployment-c4747d96c (3/3 replicas created)<br>Events:<br>  Type    Reason              Age   From                   Message</none></p>
<hr>
<p>  Normal  ScalingReplicaSet   12m   deployment-controller  Scaled up replica set nginx-deployment-75675f5897 to 3<br>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-c4747d96c to 1<br>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled down replica set nginx-deployment-75675f5897 to 2<br>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-c4747d96c to 2<br>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled down replica set nginx-deployment-75675f5897 to 1<br>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-c4747d96c to 3<br>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled down replica set nginx-deployment-75675f5897 to 0<br>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-595696685f to 1<br>  Normal  DeploymentRollback  15s   deployment-controller  Rolled back deployment “nginx-deployment” to revision 2<br>  Normal  ScalingReplicaSet   15s   deployment-controller  Scaled down replica set nginx-deployment-595696685f to 0<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### 扩展部署</span><br><span class="line">您可以使用以下命令扩展部署：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl scale deployment.v1.apps/nginx-deployment –replicas=10<br>deployment.apps/nginx-deployment scaled<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">假设在群集中启用了[<span class="string">水平pod自动缩放</span>](<span class="link">https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</span>)，则可以为Deployment设置自动缩放器，并根据现有Pod的CPU利用率选择要运行的最小和最大[<span class="string">Pod</span>](<span class="link">https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</span>)数。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl autoscale deployment.v1.apps/nginx-deployment –min=10 –max=15 –cpu-percent=80<br>deployment.apps/nginx-deployment scaled<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">###### 比例缩放</span></span><br><span class="line">RollingUpdate Deployments支持同时运行多个版本的应用程序。当您或自动扩展器扩展正在部署（正在进行或暂停）的RollingUpdate部署时，部署控制器将平衡现有活动副本集（具有Pod的副本集）中的其他副本，以降低风险。这称为比例缩放。</span><br><span class="line"></span><br><span class="line">例如，您正在运行具有10个副本的部署，[<span class="string">``maxSurge``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#max-surge</span>) = 3和[<span class="string">``maxUnavailable``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#max-unavailable</span>) = 2。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl get deploy<br>NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br>nginx-deployment     10        10        10           10          50s<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">您更新到一个新的映像，该映像恰好在集群内部无法解析。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:sometag<br>deployment.apps/nginx-deployment image updated<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">图像更新使用ReplicaSet nginx-deployment<span class="number">-1989198191</span>开始新的部署，但由于``maxUnavailable``您在上面提到的要求而被阻止 。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl get rs<br>NAME                          DESIRED   CURRENT   READY     AGE<br>nginx-deployment-1989198191   5         5         0         9s<br>nginx-deployment-618515232    8         8         8         1m<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">然后出现一个新的部署扩展请求。自动缩放器将部署副本增加到<span class="number">15.</span>部署控制器需要决定在哪里添加这些新的<span class="number">5</span>个副本。如果您没有使用比例缩放，则所有<span class="number">5</span>个都将添加到新的ReplicaSet中。通过比例缩放，您可以在所有ReplicaSet上传播其他副本。具有最多副本的ReplicaSets和较低比例的较大比例将转到具有较少副本的ReplicaSet。任何剩余物都会添加到具有最多副本的ReplicaSet中。零副本的ReplicaSet不会按比例放大。</span><br><span class="line"></span><br><span class="line">在上面的示例中，<span class="number">3</span>个副本将添加到旧的ReplicaSet中，<span class="number">2</span>个副本将添加到新的ReplicaSet中。假设新副本变得健康，推出过程最终应将所有副本移动到新的ReplicaSet。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl get deploy<br>NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br>nginx-deployment     15        18        7            8           7m<br>$ kubectl get rs<br>NAME                          DESIRED   CURRENT   READY     AGE<br>nginx-deployment-1989198191   7         7         0         7m<br>nginx-deployment-618515232    11        11        11        7m<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### 暂停和恢复部署</span><br><span class="line">您可以在触发一个或多个更新之前暂停部署，然后恢复它。这将允许您在暂停和恢复之间应用多个修复，而不会触发不必要的部署。</span><br><span class="line"></span><br><span class="line">例如，使用刚刚创建的部署：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl get deploy<br>NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br>nginx     3         3         3            3           1m<br>$ kubectl get rs<br>NAME               DESIRED   CURRENT   READY     AGE<br>nginx-2142116321   3         3         3         1m<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过运行以下命令暂停：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl rollout pause deployment.v1.apps/nginx-deployment<br>deployment.apps/nginx-deployment paused<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后更新部署的映像：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1<br>deployment.apps/nginx-deployment image updated<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请注意，没有新的卷展栏开始：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl rollout history deployment.v1.apps/nginx-deployment<br>deployments “nginx”<br>REVISION  CHANGE-CAUSE<br>1   <none></none></p>
<p>$ kubectl get rs<br>NAME               DESIRED   CURRENT   READY     AGE<br>nginx-2142116321   3         3         3         2m<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">您可以根据需要进行更多更新，例如，更新将使用的资源：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl set resources deployment.v1.apps/nginx-deployment -c=nginx –limits=cpu=200m,memory=512Mi<br>deployment.apps/nginx-deployment resource requirements updated<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">暂停之前部署的初始状态将继续其功能，但只要部署暂停，部署的新更新将不会产生任何影响。</span><br><span class="line"></span><br><span class="line">最后，恢复部署并观察一个新的ReplicaSet，提供所有新的更新：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl rollout resume deployment.v1.apps/nginx-deployment<br>deployment.apps/nginx-deployment resumed<br>$ kubectl get rs -w<br>NAME               DESIRED   CURRENT   READY     AGE<br>nginx-2142116321   2         2         2         2m<br>nginx-3926361531   2         2         0         6s<br>nginx-3926361531   2         2         1         18s<br>nginx-2142116321   1         2         2         2m<br>nginx-2142116321   1         2         2         2m<br>nginx-3926361531   3         2         1         18s<br>nginx-3926361531   3         2         1         18s<br>nginx-2142116321   1         1         1         2m<br>nginx-3926361531   3         3         1         18s<br>nginx-3926361531   3         3         2         19s<br>nginx-2142116321   0         1         1         2m<br>nginx-2142116321   0         1         1         2m<br>nginx-2142116321   0         0         0         2m<br>nginx-3926361531   3         3         3         20s<br>^C<br>$ kubectl get rs<br>NAME               DESIRED   CURRENT   READY     AGE<br>nginx-2142116321   0         0         0         2m<br>nginx-3926361531   3         3         3         28s<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：在恢复暂停部署之前，无法回滚暂停部署。</span></span><br><span class="line"></span><br><span class="line"><span class="section">##### 部署状态</span></span><br><span class="line">部署在其生命周期中进入各种状态。它可以[<span class="string">``前进``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#progressing-deployment</span>)，同时推出新ReplicaSet，也可以是[<span class="string">完整的</span>](<span class="link">hhttps://kubernetes.io/docs/concepts/workloads/controllers/deployment/#complete-deployment</span>)，也可以[<span class="string">不取得进展</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#failed-deployment</span>)。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 进步部署</span></span><br><span class="line">当执行以下任务之一时，Kubernetes将部署标记为进度：</span><br><span class="line"><span class="bullet">- </span>部署创建一个新的ReplicaSet。</span><br><span class="line"><span class="bullet">- </span>部署正在扩展其最新的ReplicaSet。</span><br><span class="line"><span class="bullet">- </span>部署正在缩减其旧的ReplicaSet。</span><br><span class="line"><span class="bullet">- </span>新Pod已准备就绪或可用（至少准备[<span class="string">MinReadySeconds</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#min-ready-seconds</span>)）。</span><br><span class="line"></span><br><span class="line">您可以使用监视部署的进度<span class="code">``kubectl rollout status`</span>`。</span><br><span class="line"></span><br><span class="line"><span class="section">###### 完成部署</span></span><br><span class="line">Kubernetes 在具有以下特征时将部署标记为完成：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>与部署关联的所有副本都已更新为您指定的最新版本，这意味着您已请求的任何更新已完成。</span><br><span class="line"><span class="bullet">- </span>可以使用与部署关联的所有副本。</span><br><span class="line"><span class="bullet">- </span>没有旧的部署副本正在运行。</span><br><span class="line"></span><br><span class="line">您可以使用检查部署是否已完成<span class="code">``kubectl rollout status`</span><span class="code">`。如果卷展栏成功完成，则`</span><span class="code">`kubectl rollout status`</span>`返回零退出代码。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl rollout status deployment.v1.apps/nginx-deployment<br>Waiting for rollout to finish: 2 of 3 updated replicas are available…<br>deployment.apps/nginx-deployment successfully rolled out<br>$ echo $?<br>0<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">###### 部署失败</span></span><br><span class="line">您的部署可能会在尝试部署其最新的ReplicaSet时遇到困难，而无需完成。这可能是由于以下一些因素造成的：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>配额不足</span><br><span class="line"><span class="bullet">- </span>准备探针失败</span><br><span class="line"><span class="bullet">- </span>图像拉错误</span><br><span class="line"><span class="bullet">- </span>权限不足</span><br><span class="line"><span class="bullet">- </span>限制范围</span><br><span class="line"><span class="bullet">- </span>应用程序运行时配置错误</span><br><span class="line"></span><br><span class="line">检测此情况的一种方法是在部署规范中指定截止时间参数:([<span class="string">`` .spec.progressDeadlineSeconds``</span>](<span class="link">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#progress-deadline-seconds</span>)）。<span class="code">``.spec.progressDeadlineSeconds`</span>`表示部署控制器在指示（在“部署”状态中）部署进度已停止之前等待的秒数。</span><br><span class="line"></span><br><span class="line">以下<span class="code">``kubectl`</span><span class="code">`命令设置规范`</span><span class="code">`progressDeadlineSeconds`</span>`以使控制器报告在10分钟后缺少部署进度：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl patch deployment.v1.apps/nginx-deployment -p ‘{“spec”:{“progressDeadlineSeconds”:600}}’<br>deployment.apps/nginx-deployment patched<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">超过截止日期后，Deployment控制器会向Deployment部署一个具有以下属性的DeploymentCondition <span class="code">``.status.conditions`</span>`：</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>类型=进展</span><br><span class="line"><span class="bullet">- </span>状态=假</span><br><span class="line"><span class="bullet">- </span>原因= ProgressDeadlineExceeded</span><br><span class="line"></span><br><span class="line">有关状态条件的更多信息，请参阅[<span class="string">Kubernetes API约定</span>](<span class="link">https://git.k8s.io/community/contributors/devel/api-conventions.md#typical-status-properties</span>)。</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：除了报告状态条件之外，Kubernetes不对停顿的部署采取任何操作 ``Reason=ProgressDeadlineExceeded``。更高级别的协调器可以利用它并相应地采取相应措施，例如，将部署回滚到其先前版本。</span></span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 注意：如果您暂停部署，Kubernetes不会根据您指定的截止日期检查进度。您可以安全地在部署和暂停期间暂停部署，而不会触发超出截止日期的条件。</span></span><br><span class="line"></span><br><span class="line">由于您设置的超时时间较短或者由于任何其他可被视为瞬态的错误，您可能会遇到部署的暂时性错误。例如，假设您的配额不足。如果您描述部署，您将注意到以下部分：</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl describe deployment nginx-deployment<br>&lt;…&gt;<br>Conditions:<br>  Type            Status  Reason</p>
<hr>
<p>  Available       True    MinimumReplicasAvailable<br>  Progressing     True    ReplicaSetUpdated<br>  ReplicaFailure  True    FailedCreate<br>&lt;…&gt;<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果您运行``kubectl get deployment nginx-deployment -o yaml``，部署状态可能如下所示：</span><br></pre></td></tr></table></figure></p>
<p>status:<br>  availableReplicas: 2<br>  conditions:</p>
<ul>
<li>lastTransitionTime: 2016-10-04T12:25:39Z<br>lastUpdateTime: 2016-10-04T12:25:39Z<br>message: Replica set “nginx-deployment-4262182780” is progressing.<br>reason: ReplicaSetUpdated<br>status: “True”<br>type: Progressing</li>
<li>lastTransitionTime: 2016-10-04T12:25:42Z<br>lastUpdateTime: 2016-10-04T12:25:42Z<br>message: Deployment has minimum availability.<br>reason: MinimumReplicasAvailable<br>status: “True”<br>type: Available</li>
<li>lastTransitionTime: 2016-10-04T12:25:39Z<br>lastUpdateTime: 2016-10-04T12:25:39Z<br>message: ‘Error creating: pods “nginx-deployment-4262182780-“ is forbidden: exceeded quota:<br>  object-counts, requested: pods=1, used: pods=3, limited: pods=2’<br>reason: FailedCreate<br>status: “True”<br>type: ReplicaFailure<br>observedGeneration: 3<br>replicas: 2<br>unavailableReplicas: 2<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">最终，一旦超出部署进度截止日期，Kubernetes将更新状态和进度条件的原因：</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Conditions:<br>  Type            Status  Reason</p>
<hr>
<p>  Available       True    MinimumReplicasAvailable<br>  Progressing     False   ProgressDeadlineExceeded<br>  ReplicaFailure  True    FailedCreate<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">您可以通过缩小部署，缩小可能正在运行的其他控制器或增加命名空间中的配额来解决配额不足的问题。如果您满足配额条件，然后部署控制器完成“部署”卷展栏，您将看到部署状态更新成功条件（``Status=<span class="literal">True</span>``和``Reason=NewReplicaSetAvailable``）。</span><br></pre></td></tr></table></figure></p>
<p>Conditions:<br>  Type          Status  Reason</p>
<hr>
<p>  Available     True    MinimumReplicasAvailable<br>  Progressing   True    NewReplicaSetAvailable<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">``Type=Available``与``Status=<span class="literal">True</span>``您的部署具有最小可用性手段。最低可用性由部署策略中指定的参数决定。``Type=Progressing``和 ``Status=<span class="literal">True</span>``表示您的部署正处于推出过程中并且正在进行中或已成功完成其进度并且所需的最小新副本可用（请参阅详细信息的条件原因 - 在我们的情况下 ``Reason=NewReplicaSetAvailable``意味着部署完成）。</span><br><span class="line"></span><br><span class="line">您可以使用检查部署是否未能进展``kubectl rollout status``。``kubectl rollout status`` 如果部署已超过进度截止日期，则返回非零退出代码。</span><br></pre></td></tr></table></figure></p>
<p>$ kubectl rollout status deployment.v1.apps/nginx-deployment<br>Waiting for rollout to finish: 2 out of 3 new replicas have been updated…<br>error: deployment “nginx” exceeded its progress deadline<br>$ echo $?<br>1<br><code>`</code></p>
<h6 id="在失败的部署上运行"><a href="#在失败的部署上运行" class="headerlink" title="在失败的部署上运行"></a>在失败的部署上运行</h6><p>适用于完整部署的所有操作也适用于失败的部署。如果需要在“部署”窗格模板中应用多个调整，可以向上/向下缩放，回滚到以前的版本，甚至可以暂停它。</p>
<h5 id="清理政策"><a href="#清理政策" class="headerlink" title="清理政策"></a>清理政策</h5><p>您可以<code>.spec.revisionHistoryLimit</code>在部署中设置字段，以指定要保留此部署的旧ReplicaSet数。其余的将在后台进行垃圾收集。默认情况下，它是10。</p>
<blockquote>
<p>注意：将此字段显式设置为0将导致清理部署的所有历史记录，从而部署将无法回滚。</p>
</blockquote>
<h5 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h5><h6 id="Canary部署"><a href="#Canary部署" class="headerlink" title="Canary部署"></a>Canary部署</h6><p>如果要使用部署将发布部署到用户或服务器的子集，则可以按照<a href="https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments" target="_blank" rel="noopener">管理资源</a>中描述的canary模式创建多个部署，每个版本一个 。</p>
<h5 id="编写部署规范"><a href="#编写部署规范" class="headerlink" title="编写部署规范"></a>编写部署规范</h5><p>与所有其他Kubernetes CONFIGS，部署需求<code>apiVersion</code>，<code>kind</code>以及<code>metadata</code>各个领域。有关使用配置文件的一般信息，请参阅<a href="https://kubernetes.io/docs/tutorials/stateless-application/run-stateless-application-deployment/" target="_blank" rel="noopener">部署应用程序</a>，配置容器以及<a href="https://kubernetes.io/docs/concepts/overview/object-management-kubectl/overview/" target="_blank" rel="noopener">使用kubectl管理资源文档</a>。</p>
<p>部署还需要一个<a href="https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status" target="_blank" rel="noopener"><code>.spec</code>部分</a>。</p>
<h6 id="Pod模板"><a href="#Pod模板" class="headerlink" title="Pod模板"></a>Pod模板</h6><p>这<code>.spec.template</code>是唯一必需的领域<code>.spec</code>。</p>
<p>这<code>.spec.template</code>是一个<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/#pod-templates" target="_blank" rel="noopener">pod模板</a>。它与Pod具有完全相同的架构，除了它是嵌套的并且没有 <code>apiVersion</code>或<code>kind</code>。</p>
<p>除了Pod的必填字段外，部署中的pod模板还必须指定适当的标签和适当的重新启动策略。对于标签，请确保不要与其他控制器重叠。见<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#selector" target="_blank" rel="noopener">选择器</a>）。</p>
<p>只允许<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy" target="_blank" rel="noopener"><code>.spec.template.spec.restartPolicy</code></a>等于<code>Always</code>，如果未指定，则为默认值。</p>
<h6 id="副本"><a href="#副本" class="headerlink" title="副本"></a>副本</h6><p><code>.spec.replicas</code>是一个可选字段，指定所需Pod的数量。默认为1。</p>
<h6 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h6><p><code>.spec.selector</code>是一个可选字段，用于指定 此部署所针对的Pod 的标签选择器。</p>
<p><code>.spec.selector</code>必须匹配<code>.spec.template.metadata.labels</code>，否则它将被API拒绝。</p>
<p>在API版本<code>apps/v1</code>，<code>.spec.selector</code>并且<code>.metadata.labels</code>不默认<code>.spec.template.metadata.labels</code>，如果没有设置。所以必须明确设置它们。另请注意，<code>.spec.selector</code>在创建部署后，它是不可变的<code>apps/v1</code>。</p>
<p>部署可以终止其标签与选择器匹配的Pod，如果它们的模板不同<code>.spec.template</code>或者此类Pod的总数超过<code>.spec.replicas</code>。<code>.spec.template</code>如果Pod 的数量小于所需的数量，它会调出新的Pod 。</p>
<blockquote>
<p>注意：您不应通过创建另一个部署或通过创建另一个控制器（如ReplicaSet或ReplicationController）来创建其标签与此选择器匹配的其他pod。如果您这样做，第一个部署认为它创建了这些其他pod。Kubernetes并没有阻止你这样做。</p>
</blockquote>
<p>如果您有多个具有重叠选择器的控制器，控制器将相互争斗并且行为不正确。</p>
<h6 id="战略"><a href="#战略" class="headerlink" title="战略"></a>战略</h6><p><code>.spec.strategy</code>指定用于替换旧Pod的策略。 <code>.spec.strategy.type</code>可以是“重新创建”或“RollingUpdate”。“RollingUpdate”是默认值。</p>
<h5 id="重新创建部署"><a href="#重新创建部署" class="headerlink" title="重新创建部署"></a>重新创建部署</h5><p>所有现有的Pod都会在创建新的Pod之前被杀死.spec.strategy.type==Recreate。</p>
<h5 id="滚动更新部署"><a href="#滚动更新部署" class="headerlink" title="滚动更新部署"></a>滚动更新部署</h5><p>部署时会以滚动更新 方式更新Pod <code>.spec.strategy.type==RollingUpdate</code>。您可以指定<code>maxUnavailable</code>并<code>maxSurge</code>控制滚动更新过程。</p>
<p><strong>maxUnavailable</strong></p>
<p><code>.spec.strategy.rollingUpdate.maxUnavailable</code>是一个可选字段，指定更新过程中可用的最大Pod数。该值可以是绝对数（例如，5）或所需Pod的百分比（例如，10％）。通过四舍五入计算绝对数字的百分比。如果<code>.spec.strategy.rollingUpdate.maxSurge</code>为0，则该值不能为0.默认值为25％。</p>
<p>例如，当此值设置为30％时，旧的ReplicaSet可以在滚动更新开始时立即按比例缩小到所需Pod的70％。准备好新的Pod后，可以进一步缩小旧的ReplicaSet，然后扩展新的ReplicaSet，确保在更新期间始终可用的Pod总数至少是所需Pod的70％。</p>
<p><strong>Max Surge</strong></p>
<p><code>.spec.strategy.rollingUpdate.maxSurge</code>是一个可选字段，指定可以在所需数量的Pod上创建的最大Pod数。该值可以是绝对数（例如，5）或所需Pod的百分比（例如，10％）。如果<code>MaxUnavailable</code>为0，则该值不能为0.绝对数量是通过向上舍入的百分比计算的。默认值为25％。</p>
<p>例如，当此值设置为30％时，可以在滚动更新开始时立即按比例放大新的ReplicaSet，这样旧的和新的Pod的总数不会超过所需Pod的130％。一旦旧的Pod被杀死，新的ReplicaSet可以进一步扩展，确保在更新期间随时运行的Pod总数最多为所需Pod的130％。</p>
<h6 id="进度截止日期"><a href="#进度截止日期" class="headerlink" title="进度截止日期"></a>进度截止日期</h6><p><code>.spec.progressDeadlineSeconds</code>是一个可选字段，指定在系统报告部署失败进度之前等待部署进度的秒数 - 表示为带有<code>Type=Progressing</code>，<code>Status=False</code>。的条件。以及<code>Reason=ProgressDeadlineExceeded</code>资源的状态。部署控制器将继续重试部署。将来，一旦实现自动回滚，部署控制器将在观察到这种情况后立即回滚部署。</p>
<p>如果指定，则此字段必须大于<code>.spec.minReadySeconds</code>。</p>
<h6 id="Min-Ready-Seconds"><a href="#Min-Ready-Seconds" class="headerlink" title="Min Ready Seconds"></a>Min Ready Seconds</h6><p><code>.spec.minReadySeconds</code>是一个可选字段，指定新创建的Pod应该在没有任何容器崩溃的情况下准备好的最小秒数，以使其可用。默认为0（Pod一旦准备好就会被视为可用）。要了解有关何时认为Pod已准备就绪的详细信息，请参阅<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes" target="_blank" rel="noopener">容器探测器</a>。</p>
<h6 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h6><p>现场<code>.spec.rollbackTo</code>已被弃用的API版本<code>extensions/v1beta1</code>和<code>apps/v1beta1</code>，并在API版本不再支持开始<code>apps/v1beta2</code>。相反，应该使用<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-back-to-a-previous-revision" target="_blank" rel="noopener">回滚到先前版本</a>中的<code>kubectl rollout undo</code>介绍。</p>
<h6 id="修订历史限制"><a href="#修订历史限制" class="headerlink" title="修订历史限制"></a>修订历史限制</h6><p>部署的修订历史记录存储在它控制的副本集中。</p>
<p><code>.spec.revisionHistoryLimit</code>是一个可选字段，指定要保留以允许回滚的旧ReplicaSet的数量。其理想值取决于新部署的频率和稳定性。如果未设置此字段，则默认情况下将保留所有旧的ReplicaSet，消耗资源<code>etcd</code>并拥挤输出<code>kubectl get rs</code>。每个Deployment修订版的配置都存储在其ReplicaSet中; 因此，一旦删除旧的ReplicaSet，您将无法回滚到该部署版本。</p>
<p>更具体地说，将此字段设置为零意味着将清除所有具有0副本的旧ReplicaSet。在这种情况下，无法撤消新的“部署”卷展栏，因为它的修订历史记录已清除。</p>
<h6 id="已暂停"><a href="#已暂停" class="headerlink" title="已暂停"></a>已暂停</h6><p><code>.spec.paused</code>是一个可选的布尔字段，用于暂停和恢复部署。暂停部署与未暂停部署之间的唯一区别是，暂停部署的PodTemplateSpec的任何更改都不会触发新的部署，只要它暂停即可。默认情况下，部署在创建时不会暂停。</p>
<h5 id="部署的替代方案"><a href="#部署的替代方案" class="headerlink" title="部署的替代方案"></a>部署的替代方案</h5><h6 id="kubectl滚动更新"><a href="#kubectl滚动更新" class="headerlink" title="kubectl滚动更新"></a>kubectl滚动更新</h6><p><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#rolling-update" target="_blank" rel="noopener"><code>kubectl rolling update</code></a>以类似的方式更新Pod和ReplicationControllers。但建议使用部署，因为它们是声明性的，服务器端，并且具有其他功能，例如即使在滚动更新完成后回滚到任何先前的修订版。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2019/01/11/CentOS上安装Shadowsocks客户端/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/11/CentOS上安装Shadowsocks客户端/" itemprop="url">CentOS上安装Shadowsocks客户端</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-11T15:47:00+08:00">
                2019-01-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/11/CentOS上安装Shadowsocks客户端/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/01/11/CentOS上安装Shadowsocks客户端/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="CentOS上安装Shadowsocks客户端"><a href="#CentOS上安装Shadowsocks客户端" class="headerlink" title="CentOS上安装Shadowsocks客户端"></a>CentOS上安装Shadowsocks客户端</h1><h2 id="Shadowsocks简介"><a href="#Shadowsocks简介" class="headerlink" title="Shadowsocks简介"></a>Shadowsocks简介</h2><p>Shadowsocks，是一种加密的传输方式（一种基于 Socks5 代理方式的网络数据加密传输包）；SS 是目前主流的科学上网方式，是目前最稳定最好用的科学上网工具之一。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="安装pip"><a href="#安装pip" class="headerlink" title="安装pip"></a>安装pip</h3><p>pip是Python的包管理工具，我们接下来是使用pip安装的Shadowsocks。</p>
<ol>
<li><p>通过yum管理工具安装：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y pip</span><br></pre></td></tr></table></figure>
</li>
<li><p>镜像库没有这个包，那么可以手动安装:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">"https://bootstrap.pypa.io/get-pip.py"</span> -<span class="keyword">o</span> <span class="string">"get-pip.py"</span></span><br><span class="line"><span class="keyword">python</span> <span class="built_in">get</span>-pip.<span class="keyword">py</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="安装Shadowsocks客户端"><a href="#安装Shadowsocks客户端" class="headerlink" title="安装Shadowsocks客户端"></a>安装Shadowsocks客户端</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> <span class="comment">--upgrade pip</span></span><br><span class="line">pip <span class="keyword">install</span> shadowsocks</span><br></pre></td></tr></table></figure>
<p>新建配置文件<code>vi /etc/shadowsocks.json</code>：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"server"</span>:<span class="string">"x.x.x.x"</span>,</span><br><span class="line"><span class="attr">"server_port"</span>:<span class="number">25247</span>,</span><br><span class="line"><span class="attr">"local_address"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line"><span class="attr">"local_port"</span>:<span class="number">25252</span>,</span><br><span class="line"><span class="attr">"password"</span>:<span class="string">"123456"</span>,</span><br><span class="line"><span class="attr">"timeout"</span>:<span class="number">1000</span>,</span><br><span class="line"><span class="attr">"method"</span>:<span class="string">"aes-256-cfb"</span>,</span><br><span class="line"><span class="attr">"workers"</span>: <span class="number">10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编写启动服务<code>vi /etc/systemd/system/shadowsocks.service</code>:<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=shadowsocks</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">30</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/sslocal -c /etc/shadowsocks.json</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure></p>
<p>启动服务<code>systemctl start shadowsocks</code>，运行 <code>curl --socks5 127.0.0.1:25252 http://httpbin.org/ip</code> ， 返回你ss服务器ip，则说明Shadowsocks客户端启动成功。</p>
<h2 id="使用Privoxy把shadowsocks转换为Http代理"><a href="#使用Privoxy把shadowsocks转换为Http代理" class="headerlink" title="使用Privoxy把shadowsocks转换为Http代理"></a>使用Privoxy把shadowsocks转换为Http代理</h2><h3 id="Privoxy简介"><a href="#Privoxy简介" class="headerlink" title="Privoxy简介"></a>Privoxy简介</h3><p>Privoxy是一个代理辅助工具，这里用Privoxy把Shadowsocks socks5代理转换为http代理。可以作为kubernetes的docker容器需要访问google的服务，也同时可以作为命令行的代理，本实例用作命令行代理。</p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>使用yum安装：<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> privoxy -y</span><br></pre></td></tr></table></figure></p>
<p>修改配置文件<code>vi /etc/privoxy/config</code>，加入一行代码<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">forward-socks5 / <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">25252</span> .</span><br><span class="line">listen-address <span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>:<span class="number">8118</span>  #这里的<span class="built_in">ip</span>也可以是k8s的<span class="built_in">ip</span></span><br></pre></td></tr></table></figure></p>
<p>启动服务<code>systemctl start privoxy</code>，执行命令<code>curl -x localhost:8118 google.com</code>，返回数据则表示服务启动成功</p>
<h3 id="全局设置"><a href="#全局设置" class="headerlink" title="全局设置"></a>全局设置</h3><p>编辑文件<code>vi /etc/profile</code>：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">http_proxy</span>=http://127.0.0.1:8118</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">https_proxy</span>=http://127.0.0.1:8118</span><br></pre></td></tr></table></figure></p>
<p>使配置生效<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">source</span> <span class="regexp">/etc/</span>profile</span><br></pre></td></tr></table></figure></p>
<p>测试代码<code>curl www.google.com</code>，返回数据则成功设置全局命令行代理</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2019/01/07/基于Frp内网穿透反向代理的端口转发实现本地服务器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/07/基于Frp内网穿透反向代理的端口转发实现本地服务器/" itemprop="url">基于Frp内网穿透反向代理的端口转发实现本地服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-07T15:47:00+08:00">
                2019-01-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/07/基于Frp内网穿透反向代理的端口转发实现本地服务器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/01/07/基于Frp内网穿透反向代理的端口转发实现本地服务器/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基于frp内网穿透反向代理的端口转发实现本地服务器"><a href="#基于frp内网穿透反向代理的端口转发实现本地服务器" class="headerlink" title="基于frp内网穿透反向代理的端口转发实现本地服务器"></a>基于frp内网穿透反向代理的端口转发实现本地服务器</h1><h2 id="frp简介"><a href="#frp简介" class="headerlink" title="frp简介"></a>frp简介</h2><p><a href="https://github.com/fatedier/frp" target="_blank" rel="noopener">frp</a> 是一个可用于内网穿透的高性能的反向代理应用，支持 tcp, udp, http, https 协议。</p>
<ul>
<li>利用处于内网或防火墙后的机器，对外网环境提供 http 或 https 服务。</li>
<li>对于 http, https 服务支持基于域名的虚拟主机，支持自定义域名绑定，使多个域名可以共用一个80端口。</li>
<li>利用处于内网或防火墙后的机器，对外网环境提供 tcp 和 udp 服务，例如在家里通过 ssh 访问处于公司内网环境内的主机。</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="准备条件"><a href="#准备条件" class="headerlink" title="准备条件"></a>准备条件</h3><p>公网服务器一台，内网服务器一台，公网服务器绑定域名1个。</p>
<h3 id="开始搭建"><a href="#开始搭建" class="headerlink" title="开始搭建"></a>开始搭建</h3><h4 id="公网服务器"><a href="#公网服务器" class="headerlink" title="公网服务器"></a>公网服务器</h4><p>ssh连接到公网服务器上，新建目录</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/<span class="built_in">local</span>/frp</span><br></pre></td></tr></table></figure>
<p>根据对应的操作系统及架构，从 <a href="https://github.com/fatedier/frp/releases" target="_blank" rel="noopener">Release</a> 页面下载最新版本的程序。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//gi</span>thub.com<span class="regexp">/fatedier/</span>frp<span class="regexp">/releases/</span>download<span class="regexp">/v0.22.0/</span>frp_0.<span class="number">22.0</span>_linux_arm64.tar.gz</span><br></pre></td></tr></table></figure>
<p>解压</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tar</span> <span class="selector-tag">-zxvf</span>  <span class="selector-tag">frp_0</span><span class="selector-class">.22</span><span class="selector-class">.0_linux_arm64</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>
<p>首先删掉<code>frpc</code>、<code>frpc.ini</code>两个文件，然后再进行配置<br>修改<code>frps.ini</code>文件，这里使用了最简化的配置：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frps.ini</span></span><br><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br><span class="line">vhost_http_port = 6081</span><br><span class="line">max_pool_count = 20</span><br><span class="line">allow_ports = 2000-3000,6081,4000-50000 <span class="comment">#端口白名单</span></span><br><span class="line">dashboard_port = 7500</span><br><span class="line">dashboard_user = admin</span><br><span class="line">dashboard_pwd = admin</span><br><span class="line">token = 123456 <span class="comment">#客户端也要配置一样的token</span></span><br><span class="line">authentication_timeout = 90000 <span class="comment">#超时时间，如果客户端遇到服务启动认证失败，大概率是时区问题，服务器设置一下就好了</span></span><br></pre></td></tr></table></figure>
<p>保存然后启动服务<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./frps</span> -c <span class="string">./frps.ini</span></span><br></pre></td></tr></table></figure></p>
<p>这是前台启动，后台启动命令为</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup <span class="string">./frps</span> -c <span class="string">./frps.ini</span> &amp;</span><br></pre></td></tr></table></figure>
<p>可以通过访问<code>http://xx.xx.xx.xx:7500/static/#/proxies/tcp</code>访问<code>frp</code>服务的监控界面，账号密码与上面配置的一致。</p>
<h4 id="内网服务器"><a href="#内网服务器" class="headerlink" title="内网服务器"></a>内网服务器</h4><p>根据对应的操作系统及架构，从 <a href="https://github.com/fatedier/frp/releases" target="_blank" rel="noopener">Release</a> 页面下载最新版本的程序。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//gi</span>thub.com<span class="regexp">/fatedier/</span>frp<span class="regexp">/releases/</span>download<span class="regexp">/v0.22.0/</span>frp_0.<span class="number">22.0</span>_linux_arm64.tar.gz</span><br></pre></td></tr></table></figure>
<p>解压</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tar</span> <span class="selector-tag">-zxvf</span>  <span class="selector-tag">frp_0</span><span class="selector-class">.22</span><span class="selector-class">.0_linux_arm64</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>
<p>首先删掉<code>frpc</code>、<code>frpc.ini</code>两个文件，然后再进行配置<br>修改 <code>frpc.ini</code> 文件。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frpc.ini</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = xx.xx.xx.xx <span class="comment">#公网ip地址</span></span><br><span class="line">server_port = 7000</span><br><span class="line">token = 123456</span><br><span class="line"> </span><br><span class="line"><span class="comment">#公网通过ssh访问内部服务器</span></span><br><span class="line">[ssh]</span><br><span class="line">type = tcp              <span class="comment">#连接协议</span></span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22         <span class="comment">#ssh默认端口号</span></span><br><span class="line">remote_port = 6000      <span class="comment">#自定义的访问内部ssh端口号</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#公网访问内部web服务器以http方式</span></span><br><span class="line">[web]</span><br><span class="line">type = http         <span class="comment">#访问协议</span></span><br><span class="line">local_port = 8081   <span class="comment">#内网web服务的端口号</span></span><br><span class="line">custom_domains = strongcat.top <span class="comment">#所绑定的公网服务器域名，一级、二级域名都可以</span></span><br></pre></td></tr></table></figure>
<p>保存然后执行启动</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./frpc</span> -c <span class="string">./frpc.ini</span></span><br></pre></td></tr></table></figure>
<p>这是前台启动，后台启动命令为</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup <span class="string">./frpc</span> -c <span class="string">./frpc.ini</span> &amp;</span><br></pre></td></tr></table></figure>
<h4 id="认证超时解决办法"><a href="#认证超时解决办法" class="headerlink" title="认证超时解决办法"></a>认证超时解决办法</h4><p>一般认证超时的原因是由于2个服务器之间时间不同，可以通过命令tzselect修改时区，按照步骤设置时区<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tzselect</span></span><br></pre></td></tr></table></figure></p>
<p>同步服务器时间<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">sudo </span><span class="string">yum </span><span class="string">install </span><span class="string">ntp</span></span><br><span class="line"><span class="string">timedatectl </span><span class="built_in">set-timezone</span> <span class="string">Asia/</span><span class="string">Shanghai</span></span><br><span class="line"><span class="string">timedatectl </span><span class="built_in">set-ntp</span> <span class="string">yes</span></span><br></pre></td></tr></table></figure></p>
<p>查看时间确保同步<code>timedatectl</code></p>
<h2 id="开机自启动"><a href="#开机自启动" class="headerlink" title="开机自启动"></a>开机自启动</h2><p>我用的是centOS7的操作系统，为了防止因为网络或者重启问题Frp失效，所以写了一个开机启动服务，公网服务器配置：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=frp</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">30</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">ExecStart</span>=/root/frp/frp_0.<span class="number">22.0</span>_linux_386/frps -c /root/frp/frp_0.<span class="number">22.0</span>_linux_386/frps.ini</span><br><span class="line"><span class="attr">ExecStop</span>=/bin/kill <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">60</span>s</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p>内网服务器配置：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=frp</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"><span class="attr">Wants</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">30</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">ExecStart</span>=/root/frp/frp_0.<span class="number">22.0</span>_linux_386/frpc -c /root/frp/frp_0.<span class="number">22.0</span>_linux_386/frpc.ini</span><br><span class="line"><span class="attr">ExecStop</span>=/bin/kill <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">60</span>s</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure></p>
<p>文件保存到<code>/etc/systemd/system/frp.service</code>中，并执行<code>systemctl daemon-reload</code>，<code>systemctl start frp</code>,开机启动<code>systemctl enable frp</code></p>
<p>外网ssh访问内网服务器（直接使用配置里面数据演示）</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -oPort=<span class="number">6000</span> root@x<span class="selector-class">.x</span><span class="selector-class">.x</span><span class="selector-class">.x</span></span><br></pre></td></tr></table></figure>
<p> 将 <code>www.strongcat.top</code> 的域名 A 记录解析到 IP <code>x.x.x.x</code>，如果服务器已经有对应的域名，也可以将 CNAME 记录解析到服务器原先的域名。</p>
<p> 通过浏览器访问 <code>http://www.yourdomain.com:8080</code> 即可访问到处于内网机器上的 <code>web</code> 服务。</p>
<p> 有些系统默认自带防火墙，需要开通端口</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd <span class="attribute">--zone</span>=public <span class="attribute">--add-port</span>=6000/tcp --permanent  </span><br><span class="line">systemctl stop firewalld.service  </span><br><span class="line">systemctl start firewalld.service</span><br></pre></td></tr></table></figure>
<p>如果遇到<code>authorization timeout</code>错误的话，需要进行2个服务器之间的时间同步。2边服务器都执行下面的命令：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#下载ntpdate</span></span><br><span class="line">yum install -y ntpdate</span><br><span class="line"><span class="meta">#调整时区为上海，也就是北京时间+8区</span></span><br><span class="line">cp <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/zoneinfo/</span>Asia/Shanghai <span class="meta-keyword">/etc/</span>localtime</span><br><span class="line">yes | cp -f <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/zoneinfo/</span>Asia/Shanghai <span class="meta-keyword">/etc/</span>localtime</span><br><span class="line"><span class="meta">#使用NTP来同步时间</span></span><br><span class="line">ntpdate us.pool.ntp.org</span><br><span class="line"><span class="meta">#定时同步时间（每隔10分钟同步时钟）</span></span><br><span class="line">crontab -l &gt;<span class="meta-keyword">/tmp/</span>crontab.bak</span><br><span class="line">echo <span class="string">"*/10 * * * * /usr/sbin/ntpdate us.pool.ntp.org | logger -t NTP"</span> &gt;&gt; <span class="meta-keyword">/tmp/</span>crontab.bak</span><br><span class="line">crontab <span class="meta-keyword">/tmp/</span>crontab.bak</span><br></pre></td></tr></table></figure></p>
<p>如果是像我这种笔记本的话，可以设置系统关闭盖子的动作<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/systemd/logind.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">HandlePowerKey         按下电源键后的行为，默认power off</span><br><span class="line">HandleSleepKey          按下挂起键后的行为，默认<span class="keyword">suspend</span></span><br><span class="line">HandleHibernateKey   按下休眠键后的行为，默认hibernate</span><br><span class="line">HandleLidSwitch          合上笔记本盖后的行为，默认<span class="keyword">suspend</span></span><br><span class="line"></span><br><span class="line">ignore 忽略，跳过</span><br><span class="line">power off 关机</span><br><span class="line">eboot 重启</span><br><span class="line">halt 挂起</span><br><span class="line"><span class="keyword">suspend</span> <span class="keyword">shell</span>内建指令，可暂停目前正在执行的<span class="keyword">shell</span>。若要恢复，则必须使用SIGCONT信息。所有的进程都会暂停，但不是消失（halt是进程关闭）</span><br><span class="line">hibernate 让笔记本进入休眠状态</span><br><span class="line">hybrid-<span class="keyword">sleep</span> 混合睡眠，主要是为台式机设计的，是睡眠和休眠的结合体，当你选择Hybird时，系统会像休眠一样把内存里的数据从头到尾复制到硬盘里 ，然后进入睡眠状态，即内存和CPU还是活动的，其他设置不活动，这样你想用电脑时就可以快速恢复到之前的状态了，笔记本一般不用这个功能。</span><br><span class="line">lock 仅锁屏，计算机继续工作。</span><br></pre></td></tr></table></figure>
<p>更多指令可以参考<a href="http://www.jinbuguo.com/systemd/logind.conf.html" target="_blank" rel="noopener">这篇博客</a></p>
<p>最后重新加载服务使配置生效<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">systemctl restart systemd-logind</span></span><br></pre></td></tr></table></figure></p>
<h2 id="进阶（配合nginx实现域名转发）"><a href="#进阶（配合nginx实现域名转发）" class="headerlink" title="进阶（配合nginx实现域名转发）"></a>进阶（配合nginx实现域名转发）</h2><h3 id="购买域名"><a href="#购买域名" class="headerlink" title="购买域名"></a>购买域名</h3><p>购买域名，国内需要备案，然后再阿里云中添加域名，创建域名解析，如图所示<br><img src="https://ws1.sinaimg.cn/large/9bc4cb9fgy1g0and9vxv5j225607ut9t.jpg" alt="image"></p>
<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker pull nginx</span></span><br></pre></td></tr></table></figure>
<p>新建文件<code>nginx.conf</code><br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attribute">error_log</span>  /var/log/nginx/error.log <span class="literal">warn</span>;</span><br><span class="line"><span class="attribute">pid</span>        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># frp的接收http请求的反向代理</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> <span class="regexp">*.strongsickcat.com</span> strongsickcat.com;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="comment"># 7071端口即为frp监听的http端口</span></span><br><span class="line">            <span class="attribute">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>:<span class="number">80</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">"upgrade"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="attribute">proxy_connect_timeout</span> <span class="number">7d</span>;</span><br><span class="line">            <span class="attribute">proxy_send_timeout</span> <span class="number">7d</span>;</span><br><span class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">7d</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment"># 防止爬虫抓取</span></span><br><span class="line">        <span class="attribute">if</span> (<span class="variable">$http_user_agent</span> <span class="regexp">~* "360Spider|JikeSpider|Spider|spider|bot|Bot|2345Explorer|curl|wget|webZIP|qihoobot|Baiduspider|Googlebot|Googlebot-Mobile|Googlebot-Image|Mediapartners-Google|Adsbot-Google|Feedfetcher-Google|Yahoo!</span> Slurp|Yahoo! Slurp China|YoudaoBot|Sosospider|Sogou spider|Sogou web spider|MSNBot|ia_archiver|Tomato Bot|NSPlayer|bingbot<span class="string">")</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                return 403;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>docker启动nginx<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -<span class="selector-tag">p</span> <span class="number">80</span>:<span class="number">80</span> --name mynginx -v <span class="variable">$PWD</span>/www:/www -v <span class="variable">$PWD</span>/nginx<span class="selector-class">.conf</span>:/etc/nginx/nginx<span class="selector-class">.conf</span> -v <span class="variable">$PWD</span>/logs:/wwwlogs  -d nginx</span><br></pre></td></tr></table></figure></p>
<p>附上frp客户端与服务端配置<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#frps.ini</span></span><br><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">max_pool_count</span> = <span class="number">20</span></span><br><span class="line"><span class="attr">allow_ports</span> = <span class="number">4000</span>-<span class="number">50000</span></span><br><span class="line"><span class="attr">dashboard_port</span> = <span class="number">7500</span></span><br><span class="line"><span class="attr">dashboard_user</span> = admin</span><br><span class="line"><span class="attr">dashboard_pwd</span> = <span class="number">742041978</span></span><br><span class="line"><span class="attr">token</span> = <span class="number">2524668868</span></span><br><span class="line"><span class="attr">authentication_timeout</span> = <span class="number">900</span></span><br><span class="line"><span class="attr">vhost_http_port</span> = <span class="number">8080</span></span><br><span class="line"><span class="attr">subdomain_host</span> = strongsickcat.com</span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#客户端 frpc.ini</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 106.15.226.184</span><br><span class="line">server_port = 7000</span><br><span class="line">token = 2524668868</span><br><span class="line">admin_addr = 127.0.0.1</span><br><span class="line">admin_port = 7400</span><br><span class="line"></span><br><span class="line">[ssh]</span><br><span class="line">type = tcp</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22</span><br><span class="line">remote_port = 6000</span><br><span class="line"></span><br><span class="line">[test_static_file]</span><br><span class="line">type = tcp</span><br><span class="line">remote_port = 16001</span><br><span class="line">plugin = static_file</span><br><span class="line">plugin_local_path = /root/file</span><br><span class="line">plugin_strip_prefix = static</span><br><span class="line">plugin_http_user = admin</span><br><span class="line">plugin_http_passwd = 742041978</span><br><span class="line"></span><br><span class="line">[kibana]</span><br><span class="line">type = http</span><br><span class="line"><span class="comment"># local_port代表你想要暴露给外网的本地web服务端口</span></span><br><span class="line">local_port = 5601</span><br><span class="line"><span class="comment"># subdomain 在全局范围内要确保唯一，每个代理服务的subdomain不能重名，否则会影响正常使用。</span></span><br><span class="line"><span class="comment"># 客户端的subdomain需和服务端的subdomain_host配合使用</span></span><br><span class="line">subdomain = kibana</span><br><span class="line"></span><br><span class="line">[elasticsearch]</span><br><span class="line">type = http</span><br><span class="line">local_port = 9200</span><br><span class="line">subdomain = elasticsearch</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">type = tcp</span><br><span class="line">local_port = 3306</span><br><span class="line">remote_port = 13306</span><br><span class="line"></span><br><span class="line">[prometheus]</span><br><span class="line">type = http</span><br><span class="line">local_port = 9090</span><br><span class="line">subdomain = prometheus</span><br><span class="line"></span><br><span class="line">[prometheus-linux]</span><br><span class="line">type = tcp</span><br><span class="line">local_port = 9100</span><br><span class="line">remote_port = 9100</span><br><span class="line"></span><br><span class="line">[prometheus-mysql]</span><br><span class="line">type = tcp</span><br><span class="line">local_port = 9104</span><br><span class="line">remote_port = 9104</span><br><span class="line"></span><br><span class="line">[grafana]</span><br><span class="line">type = http</span><br><span class="line">local_port = 3000</span><br><span class="line">subdomain = grafana</span><br><span class="line"></span><br><span class="line">[prometheusa]</span><br><span class="line">type = tcp</span><br><span class="line">local_port = 9090</span><br><span class="line">remote_port = 9090</span><br></pre></td></tr></table></figure>
<p>按照我的配置文件，可以直接通过子域名访问kibana服务<br><a href="http://kibana.strongsickcat.com:8080" target="_blank" rel="noopener">http://kibana.strongsickcat.com:8080</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2019/01/04/Selenium测试框架/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/04/Selenium测试框架/" itemprop="url">Selenium测试框架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-04T09:47:00+08:00">
                2019-01-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/04/Selenium测试框架/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/01/04/Selenium测试框架/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.seleniumhq.org/" target="_blank" rel="noopener">Selenium官网</a></p>
<h1 id="Selenium简介"><a href="#Selenium简介" class="headerlink" title="Selenium简介"></a>Selenium简介</h1><p>Selenium可以对浏览器进行自动化测试。它主要用于自动化Web应用程序以进行测试，但当然不仅限于此。无聊的基于Web的管理任务也可以自动化。 Selenium得到了一些最大的浏览器供应商的支持，这些供应商已采取（或正在采取）将Selenium作为其浏览器本机部分的步骤。它也是无数其他浏览器自动化工具，API和框架的核心技术。支持多种语言，在java中可以作为自动化测试框架，在python中可以模拟页面用户点击对自动化爬虫进行补充。</p>
<p>支持的浏览器：<br><img src="https://ws1.sinaimg.cn/large/007yGiDRgy1fyy2e6qz72j310m0wu45r.jpg" alt="image"></p>
<h1 id="Selenium使用"><a href="#Selenium使用" class="headerlink" title="Selenium使用"></a>Selenium使用</h1><p>Selenium提供了一种非常简单的开发方式，例如用Chrome开发的话，去开发者工具下载Katalon Selenium IDE，如图所示。<br><img src="https://ws1.sinaimg.cn/large/007yGiDRgy1fyy2ex4m1gj315o15gjwi.jpg" alt="image"></p>
<h2 id="开始录制"><a href="#开始录制" class="headerlink" title="开始录制"></a>开始录制</h2><p>录制过程中，IDE会自动帮我们把命令行插入到测试用例中，包括：</p>
<ul>
<li>单击链接</li>
<li>输入值</li>
<li>从下拉框选择数据</li>
<li>单击按钮或者选择框<br>点击开始录制，在最上方输入网站域名，后期可以通过更换域名来实现不同域名下的应用的测试。</li>
</ul>
<h2 id="使用上下文菜单添加验证和断言"><a href="#使用上下文菜单添加验证和断言" class="headerlink" title="使用上下文菜单添加验证和断言"></a>使用上下文菜单添加验证和断言</h2><p>使用Selenium IDE录制，转到显示测试应用程序的浏览器，然后右键单击页面上的任意位置。您将看到一个显示验证和/或断言命令的上下文菜单。<br>Selenium命令有三种“风格”：动作，访问器和断言。</p>
<ul>
<li>动作是通常操纵应用程序状态的命令。他们执行“点击此链接”和“选择该选项”之类的操作。如果操作失败或出错，则停止执行当前测试。</li>
<li>访问者检查应用程序的状态并将结果存储在变量中，例如“storeTitle”。它们还用于自动生成断言。</li>
<li>断言与访问器类似，但它们验证应用程序的状态是否符合预期。示例包括“确保页面标题为X”和“验证是否选中此复选框”。</li>
</ul>
<h2 id="脚本语法"><a href="#脚本语法" class="headerlink" title="脚本语法"></a>脚本语法</h2><p>命令很简单，由2个参数构成：</p>
<table>
<thead>
<tr>
<th>verifyText</th>
<th>//div//a[2]</th>
<th>Login</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这些参数并不总是必需的;这取决于命令。在某些情况下，两者都是必需的，在其他情况下需要一个参数，而在另一些情况下，命令可能根本不需要参数。这里有几个例子：</p>
<table>
<thead>
<tr>
<th>chooseCancelOnNextPrompt</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>pause</td>
<td>500</td>
<td></td>
</tr>
<tr>
<td>type</td>
<td>id=phone</td>
<td>(555) 666-7066</td>
</tr>
<tr>
<td>type</td>
<td>id=address1</td>
<td>${myVariableAddress}</td>
</tr>
</tbody>
</table>
<p>命令参考描述了每个命令的参数要求。 参数有所不同，但它们通常是：</p>
<ul>
<li>Locators用于标识页面内UI元素的定位器。</li>
<li>text patterns用于验证或声明预期页面内容的文本模式。</li>
<li>text patterns or selenium variables文本模式或selenium变量，用于在输入字段中输入文本或从选项列表中选择选项。<h3 id="常用的Selenium命令"><a href="#常用的Selenium命令" class="headerlink" title="常用的Selenium命令"></a>常用的Selenium命令</h3></li>
<li><strong>open</strong> 打开url页面</li>
<li><strong>click</strong> 执行单击操作，并可选择等待加载新页面。</li>
<li><strong>verifyTitle/assertTitle</strong> 验证预期的页面标题。</li>
<li><strong>verifyTextPresent</strong> 验证预期文本是否在页面上的某个位置。</li>
<li><strong>verifyText</strong> 验证预期文本及其相应的HTML标记出现在页面上。</li>
<li><strong>verifyTable</strong> 验证表的预期内容。</li>
</ul>
<h3 id="验证页面元素"><a href="#验证页面元素" class="headerlink" title="验证页面元素"></a>验证页面元素</h3><h4 id="断言与验证的选择"><a href="#断言与验证的选择" class="headerlink" title="断言与验证的选择"></a>断言与验证的选择</h4><ul>
<li><strong>assert</strong> 错误后会不继续执行并中断当前的测试用例</li>
<li><strong>verify</strong> 错误后会继续执行<br>的最佳用途是对测试命令进行逻辑分组，并使用“assert”后跟一个或多个“verify”测试命令启动每个组。一个例子如下：</li>
</ul>
<h5 id="verifyElementPresent"><a href="#verifyElementPresent" class="headerlink" title="verifyElementPresent"></a>verifyElementPresent</h5><table>
<thead>
<tr>
<th>Command</th>
<th>Target</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>verifyElementPresent</td>
<td>//div/p/img</td>
<td></td>
</tr>
</tbody>
</table>
<p>此命令验证页面上是否存在由<code>&lt;img&gt;</code> HTML标记的存在指定的图像，并且它遵循<code>&lt;div&gt;</code>标记和<code>&lt;p&gt;</code>标记。第一个（也是唯一的）参数是一个定位器，用于告诉Selenese命令如何查找元素。<br><code>verifyElementPresent</code>可用于检查页面中是否存在任何HTML标记。您可以检查链接，段落，分区<code>&lt;div&gt;</code>等是否存在。以下是一些示例。</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Target</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>verifyElementPresent</td>
<td>//div/p</td>
<td></td>
</tr>
<tr>
<td>verifyElementPresent</td>
<td>//div/a</td>
<td></td>
</tr>
<tr>
<td>verifyElementPresent</td>
<td>id=Login</td>
<td></td>
</tr>
<tr>
<td>verifyElementPresent</td>
<td>link=Go to Marketing Research</td>
<td></td>
</tr>
<tr>
<td>verifyElementPresent</td>
<td>//a[2]</td>
<td></td>
</tr>
<tr>
<td>verifyElementPresent</td>
<td>//head/title</td>
<td></td>
</tr>
</tbody>
</table>
<h5 id="verifyText"><a href="#verifyText" class="headerlink" title="verifyText"></a>verifyText</h5><p>必须在测试文本及其UI元素时使用verifyText。 verifyText必须使用定位器。如果选择XPath或DOM定位器，则可以验证特定文本是否显示在页面上相对于页面上其他UI组件的特定位置。<br>Command | Target | Value<br>—|— |—<br>verifyText |//table/tr/td/div/p | This is my text and it occurs right after the div inside the table.</p>
<h4 id="定位元素"><a href="#定位元素" class="headerlink" title="定位元素"></a>定位元素</h4><p>对于许多Selenium命令，需要一个目标。此目标标识Web应用程序内容中的元素，并包含位置策略，后跟位置格式为locatorType = location。在许多情况下可以省略定位器类型。下面解释各种定位器类型，每个定位器类型都有示例。</p>
<h5 id="按标识符定位"><a href="#按标识符定位" class="headerlink" title="按标识符定位"></a>按标识符定位</h5><p>例如，页面源可以具有id和name属性，如下所示：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&lt;html&gt;</span></span><br><span class="line"> <span class="symbol">&lt;body&gt;</span></span><br><span class="line">  &lt;form id=<span class="string">"loginForm"</span>&gt;</span><br><span class="line">   &lt;<span class="built_in">input</span> name=<span class="string">"username"</span> <span class="built_in">type</span>=<span class="string">"text"</span> /&gt;</span><br><span class="line">   &lt;<span class="built_in">input</span> name=<span class="string">"password"</span> <span class="built_in">type</span>=<span class="string">"password"</span> /&gt;</span><br><span class="line">   &lt;<span class="built_in">input</span> name=<span class="string">"continue"</span> <span class="built_in">type</span>=<span class="string">"submit"</span> value=<span class="string">"Login"</span> /&gt;</span><br><span class="line">   &lt;<span class="built_in">input</span> name=<span class="string">"continue"</span> <span class="built_in">type</span>=<span class="string">"button"</span> value=<span class="string">"Clear"</span> /&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line"> &lt;/body&gt;</span><br><span class="line"><span class="symbol">&lt;html&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>以下定位器策略将返回上面由行号指示的HTML片段中的元素：</p>
<ul>
<li>identifier=loginForm (3)</li>
<li>identifier=password (5)</li>
<li>identifier=continue (6)</li>
<li>continue (6)<br>由于定位器的标识符类型是默认值，因此上面的前三个示例中的标识符=不是必需的。</li>
</ul>
<p><strong>通过id定位</strong></p>
<p> id=loginForm (3)</p>
<p> <strong>通过名称定位</strong></p>
<ul>
<li>name=username (4)</li>
<li>name=continue value=Clear (7)</li>
<li>name=continue Clear (7)</li>
<li>name=continue type=button (7)</li>
</ul>
<p>与某些类型的XPath和DOM定位器不同，上面三种类型的定位器允许Selenium测试UI元素，而与其在页面上的位置无关。因此，如果页面结构和组织被更改，测试仍将通过。您可能想也可能不想测试页面结构是否发生变化。在Web设计者经常更改页面但其功能必须经过回归测试的情况下，通过id和name属性进行测试，或者通过任何HTML属性进行测试变得非常重要。</p>
<p>由于只有xpath定位符以“//”开头，因此在指定XPath定位符时不必包含xpath =标签。</p>
<ul>
<li>xpath=/html/body/form[1] (3) - 绝对路径（如果HTML仅稍微更改，则会中断）</li>
<li>//form[1] (3) - HTML中的第一个表单元素</li>
<li>xpath=//form[@id=’loginForm’] (3) - 表单元素，其属性名为“id”，值为“loginForm”</li>
<li>xpath=//form[input/@name=’username’] (3) - 带有输入子元素的第一个表单元素，其属性名为“name”，值为“username”</li>
<li>//input[@name=’username’] (4) - 第一个输入元素，其属性名为“name”，值为“username”</li>
<li>//form[@id=’loginForm’]/input[1] (4) - 表单元素的第一个输入子元素，其属性名为“id”，值为“loginForm”</li>
<li>//input[@name=’continue’][@type=’button’] (7) -输入名为’name’的属性和值’continue’以及名为’type’的属性和值’button’</li>
<li>//form[@id=’loginForm’]/input[4] (7) - 表单元素的第四个输入子元素，其属性名为“id”，值为“loginForm”</li>
</ul>
<p>主要的语法参考<a href="https://www.w3.org/TR/2017/REC-xpath-31-20170321/" target="_blank" rel="noopener">Xpath</a><br>可以使用浏览器的devtools复制XPath：<br><img src="https://www.seleniumhq.org/docs/_images/chapt2_img18_Copy_xpath.png" alt="image"></p>
<p><strong>通过链接文本查找超链接</strong></p>
<p>这是一种使用链接文本在网页中查找超链接的简单方法。如果存在具有相同文本的两个链接，则将使用第一个匹配。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>Are you sure you want to do this?<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"continue.html"</span>&gt;</span>Continue<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"cancel.html"</span>&gt;</span>Cancel<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>link=Continue (4)</li>
<li>link=Cancel (5)</li>
</ul>
<p><strong>通过CSS定位</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"> &lt;body&gt;</span><br><span class="line">  &lt;form id=<span class="string">"loginForm"</span>&gt;</span><br><span class="line">   &lt;input <span class="class"><span class="keyword">class</span></span>=<span class="string">"required"</span> name=<span class="string">"username"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"text"</span> /&gt;</span><br><span class="line">   &lt;input <span class="class"><span class="keyword">class</span></span>=<span class="string">"required passfield"</span> name=<span class="string">"password"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"password"</span> /&gt;</span><br><span class="line">   &lt;input name=<span class="string">"continue"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"submit"</span> value=<span class="string">"Login"</span> /&gt;</span><br><span class="line">   &lt;input name=<span class="string">"continue"</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">"button"</span> value=<span class="string">"Clear"</span> /&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;html&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>css=form#loginForm (3)</li>
<li>css=input[name=”username”] (4)</li>
<li>css=input.required[type=”text”] (4)</li>
<li>css=input.passfield (5)</li>
<li>css=#loginForm input[type=”button”] (7)</li>
<li>css=#loginForm input:nth-child(2) (5)</li>
</ul>
<p>可以参考<a href="http://www.w3.org/TR/css3-selectors/" target="_blank" rel="noopener"> the W3C publication</a></p>
<p>没有明确的设定选择器的话，将会默认使用id选择器</p>
<h3 id="存储命令和Selenium变量"><a href="#存储命令和Selenium变量" class="headerlink" title="存储命令和Selenium变量"></a>存储命令和Selenium变量</h3><p>可以使用Selenium变量在脚本开头存储常量。此外，当与数据驱动的测试设计（在后面的部分中讨论）结合使用时，Selenium变量可用于存储从命令行，从另一个程序或从文件传递到测试程序的值。</p>
<p>plain store命令是许多存储命令中最基本的命令，可用于在selenium变量中简单地存储常量值。它需要两个参数，即要存储的文本值和一个selenium变量。在为变量选择名称时，请使用仅包含字母数字字符的标准变量命名约定。</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Target</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>store</td>
<td><a href="mailto:paul@mysite.org" target="_blank" rel="noopener">paul@mysite.org</a></td>
<td>userName</td>
</tr>
</tbody>
</table>
<p>稍后在脚本中，将需要使用变量的存储值。要访问变量的值，请将变量括在大括号（{}）中，并在其前面加上美元符号。</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Target</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>verifyText</td>
<td>//div/p</td>
<td>${userName}</td>
</tr>
</tbody>
</table>
<p>变量的常见用途是存储输入字段的输入</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Target</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>type</td>
<td>id=login</td>
<td>${userName}</td>
</tr>
</tbody>
</table>
<p><strong>storeText</strong></p>
<p>StoreText对应于verifyText。它使用定位器来标识特定的页面文本。如果找到该文本，则存储在变量中。 StoreText可用于从正在测试的页面中提取文本。</p>
<p>echo命令可以用来打印变量</p>
<h3 id="Alerts-Popups-and-Multiple-Windows"><a href="#Alerts-Popups-and-Multiple-Windows" class="headerlink" title="Alerts, Popups, and Multiple Windows"></a>Alerts, Popups, and Multiple Windows</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">(resultText)</span></span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.getElementById(<span class="string">'output'</span>).childNodes[<span class="number">0</span>].nodeValue=resultText;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">show_confirm</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> confirmation=confirm(<span class="string">"Chose an option."</span>);</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">if</span> (confirmation==<span class="literal">true</span>)&#123;</span></span><br><span class="line"><span class="actionscript">        output(<span class="string">"Confirmed."</span>);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="actionscript">        output(<span class="string">"Rejected!"</span>);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">show_alert</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">      alert(<span class="string">"I'm blocking!"</span>);</span></span><br><span class="line"><span class="actionscript">      output(<span class="string">"Alert is gone."</span>);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">show_prompt</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> response = prompt(<span class="string">"What's the best web QA tool?"</span>,<span class="string">"Selenium"</span>);</span></span><br><span class="line"><span class="undefined">      output(response);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">open_window</span><span class="params">(windowName)</span></span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.open(<span class="string">"newWindow.html"</span>,windowName);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btnConfirm"</span> <span class="attr">onclick</span>=<span class="string">"show_confirm()"</span> <span class="attr">value</span>=<span class="string">"Show confirm box"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btnAlert"</span> <span class="attr">onclick</span>=<span class="string">"show_alert()"</span> <span class="attr">value</span>=<span class="string">"Show alert"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btnPrompt"</span> <span class="attr">onclick</span>=<span class="string">"show_prompt()"</span> <span class="attr">value</span>=<span class="string">"Show prompt"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"newWindow.html"</span> <span class="attr">id</span>=<span class="string">"lnkNewWindow"</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span>New Window Link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btnNewNamelessWindow"</span> <span class="attr">onclick</span>=<span class="string">"open_window()"</span> <span class="attr">value</span>=<span class="string">"Open Nameless Window"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btnNewNamedWindow"</span> <span class="attr">onclick</span>=<span class="string">"open_window('Mike')"</span> <span class="attr">value</span>=<span class="string">"Open Named Window"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"output"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>assertFoo(pattern)</td>
<td>如果模式与弹出窗口的文本不匹配，则抛出错误</td>
</tr>
<tr>
<td>assertFooPresent</td>
<td>如果弹出窗口不可用则抛出错误</td>
</tr>
<tr>
<td>assertFooNotPresent</td>
<td>如果存在任何弹出窗口则抛出错误</td>
</tr>
<tr>
<td>storeFoo(variable)</td>
<td>将弹出文本存储在变量中</td>
</tr>
<tr>
<td>storeFooPresent(variable)</td>
<td>将弹出窗口的文本存储在变量中并返回true或false</td>
</tr>
</tbody>
</table>
<p>在Selenium下运行时，不会显示JavaScript弹出窗口。这是因为函数调用实际上是由Selenium自己的JavaScript在运行时覆盖的。但是，仅仅因为你看不到弹出窗口并不意味着你不必处理它。要处理弹出窗口，必须调用其assertFoo（模式）函数。如果您未能断言是否存在弹出窗口，则您的下一个命令将被阻止，您将收到类似于以下错误的错误[错误]错误<br><code>error] Error: There was an unexpected Confirmation! [Chose an option.]</code></p>
<h4 id="Alerts"><a href="#Alerts" class="headerlink" title="Alerts"></a>Alerts</h4><p>让我们从Alerts开始，因为它们是最简单的弹出窗口。首先，在浏览器中打开上面的HTML示例，然后单击“Show alert”按钮。您会注意到，在您关闭警报后，页面上会显示“警报已消失。”文本。现在使用Selenium IDE录制完成相同的步骤，并在关闭警报后验证是否添加了文本。您的测试看起来像这样：</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Target</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>open</td>
<td>/</td>
<td></td>
</tr>
<tr>
<td>click</td>
<td>btnAlert</td>
<td></td>
</tr>
<tr>
<td>assertAlert</td>
<td>I’m blocking!</td>
<td></td>
</tr>
<tr>
<td>verifyTextPresent</td>
<td>Alert is gone.</td>
<td></td>
</tr>
</tbody>
</table>
<p>您可能会想“这很奇怪，我从未试图断言该警报。”但这是Selenium-IDE处理并为您关闭警报。如果您删除该步骤并重播测试，您将获得以下内容 <code>[error] Error: There was an unexpected Alert! [I&#39;m blocking!].</code></p>
<p>如果您只想声明警报存在但是不知道或不关心它包含哪个文本，则可以使用assertAlertPresent。这将返回true或false，错误地停止测试。</p>
<h4 id="Confirmations"><a href="#Confirmations" class="headerlink" title="Confirmations"></a>Confirmations</h4><p>确认的行为与警报的行为大致相同，其中assertConfirmation和assertConfirmationPresent提供与其警报对应物相同的特征。但是，默认情况下，Selenium会在弹出确认时选择“确定”。尝试单击示例页面中的“显示确认框”按钮，但单击弹出窗口中的“取消”按钮，然后断言输出文本。您的测试可能如下所示：</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Target</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>open</td>
<td>/</td>
<td></td>
</tr>
<tr>
<td>click</td>
<td>btnAlert</td>
<td></td>
</tr>
<tr>
<td>chooseCancelOnNextConfirmation</td>
<td></td>
<td></td>
</tr>
<tr>
<td>assertConfirmation</td>
<td>Choose an option.</td>
<td></td>
</tr>
<tr>
<td>verifyTextPresent</td>
<td>Rejected</td>
<td></td>
</tr>
</tbody>
</table>
<p>chooseCancelOnNextConfirmation函数告诉Selenium所有后续确认都应该返回false。可以通过调用chooseOkOnNextConfirmation来重置它。</p>
<p>可能会注意到您无法重播此测试，因为Selenium抱怨存在未经处理的确认。这是因为Selenium-IDE记录的事件顺序导致click和chooseCancelOnNextConfirmation被置于错误的顺序（如果考虑它就有意义，Selenium在打开确认之前无法知道正在取消）切换这两个命令，你的测试运行正常。</p>
<h4 id="Prompts"><a href="#Prompts" class="headerlink" title="Prompts"></a>Prompts</h4><p>提示的行为与警报的行为大致相同，其中assertPrompt和assertPromptPresent提供与其警报对应项相同的特征。默认情况下，Selenium会在弹出提示时等待您输入数据。尝试单击示例页面中的“显示提示”按钮，然后在提示中输入“Selenium”。测试可能如下所示：</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Target</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>open</td>
<td>/</td>
<td></td>
</tr>
<tr>
<td>answerOnNextPrompt</td>
<td>Selenium!</td>
<td></td>
</tr>
<tr>
<td>click</td>
<td>id=btnPrompt</td>
<td></td>
</tr>
<tr>
<td>assertPrompt</td>
<td>What’s the best web QA tool?</td>
<td></td>
</tr>
<tr>
<td>verifyTextPresent</td>
<td>Selenium!</td>
<td></td>
</tr>
</tbody>
</table>
<p>如果在提示中选择取消，您可能会注意到answerOnNextPrompt只显示空白目标。 Selenium对取消和提示上的空白条目基本上是一样的。</p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><h4 id="断点"><a href="#断点" class="headerlink" title="断点"></a>断点</h4><p>要设置断点，请选择一个命令，单击鼠标右键，然后从上下文菜单中选择“切换断点”。然后单击“运行”按钮以从开始到断点运行测试用例。<br>从测试用例的中间位置到结束位置运行测试用例或者到达起始点之后的断点有时也很有用。例如，假设您的测试用例首先登录到网站，然后执行一系列测试，并且您正在尝试调试其中一个测试。但是，您只需要登录一次，但是在开发测试时需要不断重新运行测试。您可以登录一次，然后从测试用例的登录部分之后的起点运行测试用例。这将阻止您每次重新运行测试用例时都必须手动注销。</p>
<h4 id="按步骤执行测试"><a href="#按步骤执行测试" class="headerlink" title="按步骤执行测试"></a>按步骤执行测试</h4><p>要一次执行一个测试用例（“step through”），只需重复按此按钮。</p>
<p><img src="https://www.seleniumhq.org/docs/_images/chapt2_img09_Step.png" alt="image"></p>
<h4 id="Find-Button"><a href="#Find-Button" class="headerlink" title="Find Button"></a>Find Button</h4><p>“查找”按钮用于查看当前显示的网页（在浏览器中）中当前选定的Selenium命令中使用的UI元素。在为命令的第一个参数构建定位器时，这非常有用（请参阅定位元素一节）。它可以与标识网页上UI元素的任何命令一起使用，例如，单击，单击和等待，键入，以及某些断言和验证命令等。 从表视图中，选择具有locator参数的任何命令。单击“查找”按钮。现在查看网页：应该有一个明亮的绿色矩形，包围locator参数指定的元素。</p>
<h2 id="Java中应用Selenium"><a href="#Java中应用Selenium" class="headerlink" title="Java中应用Selenium"></a>Java中应用Selenium</h2><p><a href="https://github.com/dinghuang/seleniumJavaTest" target="_blank" rel="noopener">项目地址</a></p>
<p>我在本地录制了一个简单的脚本，选择导出到java+junit，类似下面：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchGoogle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> WebDriver driver;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> acceptNextAlert = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> StringBuffer verificationErrors = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    <span class="keyword">private</span> SeleniumConfigure seleniumConfigure = SeleniumConfigureParse.getSeleniumConfigure();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        driver = DriverUtil.getDriver();</span><br><span class="line">        driver .manage().window().maximize();<span class="comment">//全屏</span></span><br><span class="line">        driver.manage().timeouts().implicitlyWait(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchGoogle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        driver.get(seleniumConfigure.getBaseUrl());</span><br><span class="line">        driver.findElement(By.name(<span class="string">"q"</span>)).click();</span><br><span class="line">        driver.findElement(By.name(<span class="string">"q"</span>)).clear();</span><br><span class="line">        driver.findElement(By.name(<span class="string">"q"</span>)).sendKeys(<span class="string">"google"</span>);</span><br><span class="line">        driver.findElement(By.name(<span class="string">"q"</span>)).sendKeys(Keys.ENTER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        driver.quit();</span><br><span class="line">        String verificationErrorString = verificationErrors.toString();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">""</span>.equals(verificationErrorString)) &#123;</span><br><span class="line">            fail(verificationErrorString);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isElementPresent</span><span class="params">(By by)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            driver.findElement(by);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isAlertPresent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            driver.switchTo().alert();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoAlertPresentException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">closeAlertAndGetItsText</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Alert alert = driver.switchTo().alert();</span><br><span class="line">            String alertText = alert.getText();</span><br><span class="line">            <span class="keyword">if</span> (acceptNextAlert) &#123;</span><br><span class="line">                alert.accept();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                alert.dismiss();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> alertText;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            acceptNextAlert = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新建项目，pom.xml如下<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"> <span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span></span><br><span class="line"><span class="xml">         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line"><span class="xml">         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>choerodon<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>selenium<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.seleniumhq.selenium<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>selenium-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.14.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.yaml/snakeyaml --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.yaml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>snakeyaml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!--&lt;dependency&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!--&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!--&lt;artifactId&gt;lombok&lt;/artifactId&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!--&lt;version&gt;1.18.4&lt;/version&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!--&lt;scope&gt;provided&lt;/scope&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!--&lt;/dependency&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0-M3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.surefire<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>surefire-junit47<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0-M3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$</span><span class="template-variable">&#123;basedir&#125;</span><span class="xml">/output<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">outputName</span>&gt;</span>测试报告<span class="tag">&lt;/<span class="name">outputName</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!--&lt;plugin&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="comment">&lt;!--&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="comment">&lt;!--&lt;artifactId&gt;maven-site-plugin&lt;/artifactId&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="comment">&lt;!--&lt;version&gt;2.1&lt;/version&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="comment">&lt;!--&lt;configuration&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="comment">&lt;!--&lt;outputDirectory&gt;$</span></span><span class="template-variable">&#123;basedir&#125;</span><span class="xml"><span class="comment">/output&lt;/outputDirectory&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="comment">&lt;!--&lt;outputName&gt;测试报告&lt;/outputName&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="comment">&lt;!--&lt;/configuration&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="comment">&lt;!--&lt;/plugin&gt;--&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="与Docker结合"><a href="#与Docker结合" class="headerlink" title="与Docker结合"></a>与Docker结合</h2><p> 使用远程的驱动服务来测试，目前只支持Chrome和FireFox，本地如果要起服务，请在docker中执行下面的命令启动服务<br> <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull elgalu/selenium</span><br><span class="line">docker <span class="builtin-name">run</span> -d <span class="attribute">--name</span>=grid -p 4444:24444 -p 5900:25900  -e <span class="attribute">TZ</span>=<span class="string">"Asia/Shanghai"</span> -e <span class="attribute">MAX_INSTANCES</span>=20 -e <span class="attribute">MAX_SESSIONS</span>=20  -v /Users/dinghuang/Documents/Tool/selenium/shm:/dev/shm --privileged elgalu/selenium</span><br><span class="line">docker exec grid wait_all_done 30s</span><br></pre></td></tr></table></figure></p>
<p> 可以在<code>http://localhost:4444/grid/console</code>中查看详情</p>
<p> 关闭服务命令：<br> <figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> grid <span class="keyword">stop</span></span><br><span class="line">docker <span class="keyword">stop</span> grid</span><br></pre></td></tr></table></figure></p>
<p> 在JAVA代码中，可以通过远程的docker容器启动浏览器进行测试<br> <figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webDriver = <span class="keyword">new</span> <span class="type">RemoteWebDriver</span>(<span class="keyword">new</span> <span class="type">URL</span>(<span class="string">"http://localhost:4444/wd/hub"</span>), browser);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2018/09/21/如何在GitHub Page使用HEXO搭建博客/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/21/如何在GitHub Page使用HEXO搭建博客/" itemprop="url">如何在GitHub Page使用HEXO搭建博客</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-21T13:51:00+08:00">
                2018-09-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/21/如何在GitHub Page使用HEXO搭建博客/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/21/如何在GitHub Page使用HEXO搭建博客/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="如何在使用GitHub-Page搭建HEXO博客"><a href="#如何在使用GitHub-Page搭建HEXO博客" class="headerlink" title="如何在使用GitHub Page搭建HEXO博客"></a>如何在使用GitHub Page搭建HEXO博客</h1><p><a href="https://github.com/dinghuang/Blog" target="_blank" rel="noopener">项目地址</a></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li>安装Git</li>
<li>安装Node.js</li>
<li>注册Github账号</li>
<li>创建新的仓库 名称必须为 用户名.github.io<br><img src="https://ws1.sinaimg.cn/large/007yGiDRgy1fyy2iwon08j31f2110dln.jpg" alt="此处输入图片的描述"></li>
<li>添加本地电脑的SSH认证，如图所示<br><img src="https://ws1.sinaimg.cn/large/007yGiDRgy1fyy2k0uun6j31lg0rsqaf.jpg" alt="此处输入图片的描述"><br>在本地命令工具中输入<br><code>ssh-keygen -t rsa -C &quot;Github的注册邮箱地址&quot;</code><br>一路回车之后会得到两个文件：id_rsa和id_rsa.pub，然后<br>用带格式的编辑器（比方说notepad++或者sublime）打开id_rsa.pub，复制里面的所有内容，然粘贴到KEY里面。</li>
</ol>
<h2 id="安装HEXO"><a href="#安装HEXO" class="headerlink" title="安装HEXO"></a>安装HEXO</h2><ol>
<li>打开命令行工具<br><code>npm install -g hexo-cli</code></li>
<li>安装 Hexo 完成后，分步执行（即输入代码之后敲回车）下列命令，Hexo 将会在指定文件夹中新建所需要的文件。<br><code>hexo init &lt;folder&gt;</code><br>在文件夹内执行<br><code>npm install</code></li>
<li>成功后，博客项目成功初始化</li>
</ol>
<h2 id="配置NEXT主题"><a href="#配置NEXT主题" class="headerlink" title="配置NEXT主题"></a>配置NEXT主题</h2><ol>
<li>安装NEXT主题</li>
</ol>
<p><code>mkdir themes/next</code><br><code>curl -s https://api.github.com/repos/iissnan/hexo-theme-next/releases/latest | grep tarball_url | cut -d &#39;&quot;&#39; -f 4 | wget -i - -O- | tar -zx -C themes/next --strip-components=1</code><br>修改站点配置文件<code>_config.yml</code><br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">title:</span> 一只病猫</span><br><span class="line"><span class="symbol">subtitle:</span> 静坐常思己过，闲谈莫论人非</span><br><span class="line"><span class="symbol">description:</span> 学习、生活、闲谈、足球</span><br><span class="line"><span class="symbol">author:</span> 强壮的病猫</span><br><span class="line"><span class="symbol">language:</span> zh-Hans</span><br><span class="line"><span class="symbol">timezone:</span> Asia/Shanghai</span><br><span class="line"><span class="symbol">theme:</span> next</span><br><span class="line"><span class="symbol">url:</span> https:<span class="comment">//dinghuang.github.io/</span></span><br><span class="line"><span class="symbol">deploy:</span></span><br><span class="line"><span class="symbol">  type:</span> git</span><br><span class="line"><span class="symbol">  repo:</span> https:<span class="comment">//github.com/dinghuang/dinghuang.github.io.git</span></span><br><span class="line"><span class="symbol">  branch:</span> master</span><br><span class="line"><span class="meta">#开启swiftype搜索，后面的id在swiftype官网申请，[具体操作][3]</span></span><br><span class="line"><span class="symbol">swiftype_key:</span> HcRPHRrBuwozvgUoLNyX</span><br><span class="line"><span class="meta">#要放到仓库的静态资源都放在source文件夹中，.md会被转换成HTML，所以这里要忽略</span></span><br><span class="line"><span class="symbol">skip_render:</span> README.md</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>配置NEXT主题<br>设置主题配置文件<code>./themes/next/_config.yml</code>，可以参考本项目的配置。<br>NEXT强大之处在于继承了很多第三方服务插件，不过类似评论搜索功能的插件被墙了，外网是可以用的。<a href="https://theme-next.iissnan.com/third-party-services.html" target="_blank" rel="noopener">具体参考</a></li>
<li>设置标签分类<br>参考<a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">链接</a>，在文章开头，引入：<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">title: 设计模式</span><br><span class="line">date: 2018<span class="string">-07</span><span class="string">-18</span> 09:43:00</span><br><span class="line"><span class="keyword">tags:</span></span><br><span class="line">    - JAVA</span><br><span class="line">categories: JAVA</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>更多配置请参考官方文档</p>
<h2 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h2><ol>
<li>输入命令<br><code>npm install hexo-deployer-git --save</code></li>
<li>创建文章<br><code>hexo new &quot;你想要的文章标题填在这个双引号里&quot;</code></li>
<li>文章会生成在<br><code>./source/_posts/设计模式.md</code><br>进行修改后<br><code>hexo clean ; hexo genarate</code></li>
<li>然后输入<br><code>hexo deploy</code><br>此时文章已经成功部署。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2018/09/08/VPS搭建SS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/08/VPS搭建SS/" itemprop="url">VPS搭建SS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-08T22:49:00+08:00">
                2018-09-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/08/VPS搭建SS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/08/VPS搭建SS/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="购买VPS服务器"><a href="#购买VPS服务器" class="headerlink" title="购买VPS服务器"></a>购买VPS服务器</h1><p>声明：本教程仅供学习用</p>
<p><a href="https://my.vultr.com/" target="_blank" rel="noopener">购买地址</a></p>
<p>推荐vultr的原因是，vultr支持支付宝、服务器较多，价格虽然不算便宜，但是网速稳定。<br>各个机房速度测试，直接ping 域名<br>地理位置 官方测试服务器ip 下载测试文件<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Frankfurt, DE fra-de-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Amsterdam, NL ams-nl-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Paris, France par-fr-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">London, UK lon-gb-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Singapore sgp-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">New York (NJ) nj-us-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Tokyo, Japan hnd-jp-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Chicago, Illinois il-us-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Atlanta, Georgia ga-us-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Miami, Florida fl-us-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Seattle, Washington wa-us-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Dallas, Texas tx-us-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Silicon Valley, California sjo-ca-us-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Los Angeles, California lax-ca-us-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br><span class="line">Sydney, Australia syd-au-ping<span class="selector-class">.vultr</span><span class="selector-class">.com</span> <span class="number">100</span>M <span class="number">1000</span>M</span><br></pre></td></tr></table></figure></p>
<p>经过测试，大陆地区，Tokyo的速度是最快的，延迟在50ms左右。</p>
<h1 id="搭建ShadowSocksR服务"><a href="#搭建ShadowSocksR服务" class="headerlink" title="搭建ShadowSocksR服务"></a>搭建ShadowSocksR服务</h1><p>ssh连接购买的服务器<br><code>ssh -p22 root@xx.xx.xx.xx</code><br>搭建ssr服务<br><code>wget --no-check-certificate https://raw.githubusercontent.com/teddysun/shadowsocks_install/master/shadowsocksR.sh</code><br><code>chmod +x shadowsocksR.sh</code><br><code>./shadowsocksR.sh 2&gt;&amp;1 | tee shadowsocksR.log</code><br>根据提示输入相关配置<br>相关指令：<br>卸载: <code>./shadowsocksR.sh uninstall</code><br>启动：<code>/etc/init.d/shadowsocks start</code><br>停止：<code>/etc/init.d/shadowsocks stop</code><br>重启：<code>/etc/init.d/shadowsocks restart</code><br>状态：<code>/etc/init.d/shadowsocks status</code><br>配置文件路径：<code>/etc/shadowsocks.json</code><br>日志文件路径：<code>/var/log/shadowsocks.log</code><br>代码安装目录：<code>/usr/local/shadowsocks</code><br>如果要配置多个用户，多个端口，打开配置文件路径，修改如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"server"</span>:<span class="string">"0.0.0.0"</span>,</span><br><span class="line">    <span class="attr">"server_ipv6"</span>:<span class="string">"[::]"</span>,</span><br><span class="line">    <span class="attr">"server_port"</span>:<span class="number">9001</span>,</span><br><span class="line">    <span class="attr">"local_address"</span>:<span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="attr">"local_port"</span>:<span class="number">1080</span>,</span><br><span class="line">    <span class="attr">"port_password"</span>:&#123;</span><br><span class="line">        <span class="attr">"9001"</span>:<span class="string">"123456"</span>,</span><br><span class="line">        <span class="attr">"9002"</span>:<span class="string">"123456"</span>,</span><br><span class="line">        <span class="attr">"9003"</span>:<span class="string">"123456"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"timeout"</span>:<span class="number">300</span>,</span><br><span class="line">    <span class="attr">"method"</span>:<span class="string">"aes-256-cfb"</span>,</span><br><span class="line">    <span class="attr">"protocol"</span>:<span class="string">"origin"</span>,</span><br><span class="line">    <span class="attr">"obfs"</span>:<span class="string">"plain"</span>,</span><br><span class="line">    <span class="attr">"fast_open"</span>:<span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>设置相关端口后要在防火墙打开相关端口的通讯，Centos默认使用firewall命令，如下所示：<br><code>sudo firewall-cmd --zone=public --add-port=3000/tcp --permanent</code><br><code>sudo firewall-cmd --reload</code><br><code>firewall-cmd --list-all</code></p>
<h1 id="优化网络"><a href="#优化网络" class="headerlink" title="优化网络"></a>优化网络</h1><h2 id="1-系统层面"><a href="#1-系统层面" class="headerlink" title="1.系统层面"></a>1.系统层面</h2><p><code>vi /etc/sysctl.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> max open files</span></span><br><span class="line">fs.file-max = 1024000</span><br><span class="line"><span class="meta">#</span><span class="bash"> max <span class="built_in">read</span> buffer</span></span><br><span class="line">net.core.rmem_max = 67108864</span><br><span class="line"><span class="meta">#</span><span class="bash"> max write buffer</span></span><br><span class="line">net.core.wmem_max = 67108864</span><br><span class="line"><span class="meta">#</span><span class="bash"> default <span class="built_in">read</span> buffer</span></span><br><span class="line">net.core.rmem_default = 65536</span><br><span class="line"><span class="meta">#</span><span class="bash"> default write buffer</span></span><br><span class="line">net.core.wmem_default = 65536</span><br><span class="line"><span class="meta">#</span><span class="bash"> max processor input queue</span></span><br><span class="line">net.core.netdev_max_backlog = 4096</span><br><span class="line"><span class="meta">#</span><span class="bash"> max backlog</span></span><br><span class="line">net.core.somaxconn = 4096</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> resist SYN flood attacks</span></span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> reuse timewait sockets when safe</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> turn off fast timewait sockets recycling</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> short FIN timeout</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="meta">#</span><span class="bash"> short keepalive time</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 1200</span><br><span class="line"><span class="meta">#</span><span class="bash"> outbound port range</span></span><br><span class="line">net.ipv4.ip_local_port_range = 10000 65000</span><br><span class="line"><span class="meta">#</span><span class="bash"> max SYN backlog</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 4096</span><br><span class="line"><span class="meta">#</span><span class="bash"> max timewait sockets held by system simultaneously</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP receive buffer</span></span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP write buffer</span></span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</span><br><span class="line"><span class="meta">#</span><span class="bash"> turn on path MTU discovery</span></span><br><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> high-latency network</span></span><br><span class="line">net.ipv4.tcp_congestion_control = htcp</span><br><span class="line"><span class="meta">#</span><span class="bash"> forward ipv4</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure>
<p>保存生效<br><code>sysctl -p</code><br>其中最后的hybla是为高延迟网络（如美国，欧洲）准备的算法，需要内核支持，测试内核是否支持，在终端输入：<br><code>sysctl net.ipv4.tcp_available_congestion_control</code><br>如果结果中有hybla，则证明你的内核已开启hybla，如果没有hybla，可以用命令modprobe tcp_hybla开启。</p>
<p>对于低延迟的网络（如日本，香港等），可以使用htcp，可以非常显著的提高速度，首先使用modprobe tcp_htcp开启，再将net.ipv4.tcp_congestion_control = hybla改为net.ipv4.tcp_congestion_control = htcp，建议EC2日本用户使用这个算法。</p>
<h2 id="2-TCP优化"><a href="#2-TCP优化" class="headerlink" title="2.TCP优化"></a>2.TCP优化</h2><p>1.修改文件句柄数限制<br>如果是<code>ubuntu/centos</code>均可修改<code>/etc/sysctl.conf</code><br>找到<code>fs.file-max</code>这一行，修改其值为<code>1024000</code>，并保存退出。然后执行<code>sysctl -p</code>使其生效<br>修改<code>vi /etc/security/limits.conf</code>文件，加入</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">*               </span>soft    nofile           512000</span><br><span class="line"><span class="bullet">*               </span>hard    nofile          1024000</span><br></pre></td></tr></table></figure>
<p>针对centos,还需要修改<code>vi /etc/pam.d/common-session</code>文件，加入<br><code>session required pam_limits.so</code></p>
<p>2.修改<code>vi /etc/profile</code>文件，加入<br><code>ulimit -SHn 1024000</code><br>然后重启服务器执行<code>ulimit -n</code>，查询返回<code>1024000</code>即可。</p>
<p><code>sysctl.conf</code>报错解决方法<br>修复<code>modprobe</code>的：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f <span class="regexp">/sbin/m</span>odprobe </span><br><span class="line">ln -s <span class="regexp">/bin/</span><span class="keyword">true</span> <span class="regexp">/sbin/m</span>odprobe</span><br></pre></td></tr></table></figure></p>
<p>修复<code>sysctl</code>的：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f <span class="regexp">/sbin/</span>sysctl </span><br><span class="line">ln -s <span class="regexp">/bin/</span><span class="keyword">true</span> <span class="regexp">/sbin/</span>sysctl</span><br></pre></td></tr></table></figure></p>
<h2 id="3-软件辅助优化"><a href="#3-软件辅助优化" class="headerlink" title="3.软件辅助优化"></a>3.软件辅助优化</h2><p>软件辅助优化都得参考系统内核，查看是否适用，如果不适用，可以修改系统内核。</p>
<p>2.1 锐速</p>
<p>锐速是TCP底层加速软件,官方已停止推出永久免费版本,但网上有破解版可以继续使用。需要购买的话先到锐速官网注册帐号,并确认<a href="http://dl.serverspeeder.com/ls.do?m=availables" target="_blank" rel="noopener">内核版本</a>是否支持锐速的版本。</p>
<p>一键安装速锐破解版</p>
<p><code>wget -N --no-check-certificate https://github.com/91yun/serverspeeder/raw/master/serverspeeder.sh &amp;&amp; bash serverspeeder.sh</code><br>一键卸载</p>
<p><code>chattr -i /serverspeeder/etc/apx* &amp;&amp; /serverspeeder/bin/serverSpeeder.sh uninstall -f</code><br>设置</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Enter</span> <span class="selector-tag">your</span> <span class="selector-tag">accelerated</span> <span class="selector-tag">interface</span>(s) <span class="selector-attr">[eth0]</span>: <span class="selector-tag">eth0</span></span><br><span class="line"><span class="selector-tag">Enter</span> <span class="selector-tag">your</span> <span class="selector-tag">outbound</span> <span class="selector-tag">bandwidth</span> <span class="selector-attr">[1000000 kbps]</span>: <span class="selector-tag">1000000</span></span><br><span class="line"><span class="selector-tag">Enter</span> <span class="selector-tag">your</span> <span class="selector-tag">inbound</span> <span class="selector-tag">bandwidth</span> <span class="selector-attr">[1000000 kbps]</span>: <span class="selector-tag">1000000</span></span><br><span class="line"><span class="selector-tag">Configure</span> <span class="selector-tag">shortRtt-bypass</span> <span class="selector-attr">[0 ms]</span>: <span class="selector-tag">0</span></span><br><span class="line"><span class="selector-tag">Auto</span> <span class="selector-tag">load</span> <span class="selector-tag">ServerSpeeder</span> <span class="selector-tag">on</span> <span class="selector-tag">linux</span> <span class="selector-tag">start-up</span>? <span class="selector-attr">[n]</span><span class="selector-pseudo">:y</span></span><br></pre></td></tr></table></figure>
<p><strong>是否开机自启</strong><br><code>Run ServerSpeeder now? [y]:y #是否现在启动</code><br>执行lsmod，看到有appex0模块即说明锐速已正常安装并启动。</p>
<p>至此，安装就结束了，但还有后续配置。<br>修改<code>vi /serverspeeder/etc/config</code>文件的几个参数以使锐速更好的工作</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">accppp</span>=<span class="string">"1"</span> #加速PPTP、L2TP V-P-N；设为1表示开启，设为0表示关闭</span><br><span class="line"><span class="attribute">advinacc</span>=<span class="string">"1"</span> #高级入向加速开关；设为 1 表示开启，设为 0 表示关闭；开启此功能可以得到更好的流入方向流量加速效果；</span><br><span class="line"><span class="attribute">maxmode</span>=<span class="string">"1"</span> #最大传输模式；设为 1 表示开启；设为 0 表示关闭；开启后会进一步提高加速效果，但是可能会降低有效数据率。</span><br><span class="line"><span class="attribute">rsc</span>=<span class="string">"1"</span> #网卡接收端合并开关；设为 1 表示开启，设为 0 表示关闭；在有些较新的网卡驱动中，带有 RSC 算法的，需要打开该功能。</span><br><span class="line"><span class="attribute">l2wQLimit</span>=<span class="string">"512 4096"</span> #从<span class="built_in"> LAN </span>到<span class="built_in"> WAN </span>加速引擎在缓冲池充满和空闲时分别能够缓存的数据包队列的长度的上限；该值设置的高会获得更好的加速效果，但是会消耗更多的内存</span><br><span class="line"><span class="attribute">w2lQLimit</span>=<span class="string">"512 4096"</span> #从<span class="built_in"> WAN </span>到<span class="built_in"> LAN </span>加速引擎在缓冲池充满和空闲时分别能够缓存的数据包队列的长度的上限；该值设置的高会获得更好的加速效果，但是会消耗更多的内存</span><br></pre></td></tr></table></figure>
<p>重读配置以使配置生效<code>/serverspeeder/bin/serverSpeeder.sh reload</code></p>
<p>查看锐速当前状态<code>/serverspeeder/bin/serverSpeeder.sh stats</code></p>
<p>查看所有命令<code>/serverspeeder/bin/serverSpeeder.sh help</code></p>
<p>停止<code>/serverspeeder/bin/serverSpeeder.sh stop</code></p>
<p>启动<code>/serverspeeder/bin/serverSpeeder.sh start</code></p>
<p>重启锐速<code>/serverspeeder/bin/serverSpeeder.sh restart</code></p>
<p>2.1 安装Google BBR</p>
<p>要求内核版本<code>4.13.5-1.el7.elrepo.x86_64</code> 以上<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh http:<span class="comment">//www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install kernel-<span class="keyword">ml</span> -<span class="built_in">y</span></span><br></pre></td></tr></table></figure></p>
<p>检查内核是否更新<br><code>rpm -qa | grep kernel</code><br>启动<br><code>grub2-set-default 1</code><br>重启<br><code>shutdown -r now</code><br>查看是否生效<br><code>uname -r</code><br>安装Google BBR<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'net.core.default_qdisc=fq'</span> | sudo tee -<span class="keyword">a</span> /etc/sysctl.<span class="keyword">conf</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'net.ipv4.tcp_congestion_control=bbr'</span> | sudo tee -<span class="keyword">a</span> /etc/sysctl.<span class="keyword">conf</span></span><br><span class="line">sysctl -<span class="keyword">p</span></span><br></pre></td></tr></table></figure></p>
<p>检查是否安装成功<br><code>sysctl net.ipv4.tcp_available_congestion_control</code><br>执行命令后，看是否是提示<br><code>“net.ipv4.tcp_available_congestion_control = bbr cubic reno”</code><br>执行命令，是否提示bbr<br><code>lsmod | grep bbr</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2018/07/18/设计模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/18/设计模式/" itemprop="url">设计模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-18T09:43:00+08:00">
                2018-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/18/设计模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/18/设计模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.runoob.com/design-pattern/design-pattern-tutorial.html" target="_blank" rel="noopener">菜鸟教程文档</a></p>
<h1 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h1><p>设计模式（Design pattern）代表了最佳的实践，通常被有经验的面向对象的软件开发人员所采用。设计模式是软件开发人员在软件开发过程中面临的一般问题的解决方案。这些解决方案是众多软件开发人员经过相当长的一段时间的试验和错误总结出来的。</p>
<p>设计模式是一套被反复使用的、多数人知晓的、经过分类编目的、代码设计经验的总结。使用设计模式是为了重用代码、让代码更容易被他人理解、保证代码可靠性。 毫无疑问，设计模式于己于他人于系统都是多赢的，设计模式使代码编制真正工程化，设计模式是软件工程的基石，如同大厦的一块块砖石一样。项目中合理地运用设计模式可以完美地解决很多问题，每种模式在现实中都有相应的原理来与之对应，每种模式都描述了一个在我们周围不断重复发生的问题，以及该问题的核心解决方案，这也是设计模式能被广泛应用的原因。</p>
<p><a href="https://github.com/dinghuang/concurrent" target="_blank" rel="noopener">代码案例</a></p>
<h2 id="1-创建型模式"><a href="#1-创建型模式" class="headerlink" title="1.创建型模式"></a>1.创建型模式</h2><p>这些设计模式提供了一种在创建对象的同时隐藏创建逻辑的方式，而不是使用 new 运算符直接实例化对象。这使得程序在判断针对某个给定实例需要创建哪些对象时更加灵活。</p>
<h3 id="1-1-工厂模式"><a href="#1-1-工厂模式" class="headerlink" title="1.1. 工厂模式"></a>1.1. 工厂模式</h3><p><strong>主要解决</strong>：主要解决接口选择的问题。</p>
<p><strong>何时使用</strong>：我们明确地计划不同条件下创建不同实例时。</p>
<p><strong>优点</strong>：</p>
<ol>
<li>一个调用者想创建一个对象，只要知道其名称就可以了</li>
<li>扩展性高，如果想增加一个产品，只要扩展一个工厂类就可以</li>
<li>屏蔽产品的具体实现，调用者只关心产品的接口</li>
</ol>
<p><strong>缺点</strong>：每次增加一个产品时，都需要增加一个具体类和对象实现工厂，使得系统中类的个数成倍增加，在一定程度上增加了系统的复杂度，同时也增加了系统具体类的依赖。这并不是什么好事。</p>
<p><strong>如何解决</strong>：让其子类实现工厂接口，返回的也是一个抽象的产品。</p>
<p><strong>使用场景</strong>： 1、日志记录器：记录可能记录到本地硬盘、系统事件、远程服务器等，用户可以选择记录日志到什么地方。 2、数据库访问，当用户不知道最后系统采用哪一类数据库，以及数据库可能有变化时。 3、设计一个连接服务器的框架，需要三个协议，”POP3”、”IMAP”、”HTTP”，可以把这三个作为产品类，共同实现一个接口。</p>
<p><strong>注意事项</strong>：作为一种创建类模式，在任何需要生成复杂对象的地方，都可以使用工厂方法模式。有一点需要注意的地方就是复杂对象适合使用工厂模式，而简单对象，特别是只需要通过 new 就可以完成创建的对象，无需使用工厂模式。如果使用工厂模式，就需要引入一个工厂类，会增加系统的复杂度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExpensiveCar</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"expensiveCar.run"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LitterCar</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"littleCard.run"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CarFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">getCar</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="string">"litterCar"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LitterCar();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"ExpensiveCar"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ExpensiveCar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-抽象工厂模式"><a href="#1-2-抽象工厂模式" class="headerlink" title="1.2. 抽象工厂模式"></a>1.2. 抽象工厂模式</h3><p><strong>主要解决</strong>：主要解决接口选择的问题。</p>
<p><strong>何时使用</strong>：系统的产品有多于一个的产品族，而系统只消费其中某一族的产品。</p>
<p><strong>优点</strong>：当一个产品族中的多个对象被设计成一起工作时，它能保证客户端始终只使用同一个产品族中的对象。</p>
<p><strong>缺点</strong>：产品族扩展非常困难，要增加一个系列的某一产品，既要在抽象的 Creator 里加代码，又要在具体的里面加代码。</p>
<p><strong>使用场景</strong>： 1、QQ 换皮肤，一整套一起换。 2、生成不同操作系统的程序。</p>
<p><strong>注意事项</strong>：产品族难扩展，产品等级易扩展。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExpensiveCar</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"expensiveCar.run"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LitterCar</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"littleCard.run"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Passengers</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getCar</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">implements</span> <span class="title">Passengers</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"man.getCar"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Woman</span> <span class="keyword">implements</span> <span class="title">Passengers</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"man.getCar"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Passengers <span class="title">getPassengers</span><span class="params">(String user)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Car <span class="title">getCar</span><span class="params">(String car)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CarFactory</span> <span class="keyword">extends</span> <span class="title">AbstractFactory</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Passengers <span class="title">getPassengers</span><span class="params">(String user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">getCar</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type.equals(<span class="string">"litterCar"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LitterCar();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"ExpensiveCar"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ExpensiveCar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PassengerFactory</span> <span class="keyword">extends</span> <span class="title">AbstractFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Passengers <span class="title">getPassengers</span><span class="params">(String user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (user.equals(<span class="string">"man"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Man();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user.equals(<span class="string">"woman"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Woman();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">getCar</span><span class="params">(String car)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProducer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractFactory <span class="title">getFactory</span><span class="params">(String choice)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (choice.equalsIgnoreCase(<span class="string">"Car"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CarFactory();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (choice.equalsIgnoreCase(<span class="string">"Passenger"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PassengerFactory();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-单例模式"><a href="#1-3-单例模式" class="headerlink" title="1.3. 单例模式"></a>1.3. 单例模式</h3><p><strong>主要解决</strong>：一个全局使用的类频繁地创建与销毁。</p>
<p><strong>何时使用</strong>：当您想控制实例数目，节省系统资源的时候。</p>
<p><strong>优点</strong>：</p>
<ol>
<li>在内存里只有一个实例，减少了内存的开销，尤其是频繁的创建和销毁实例（比如管理学院首页页面缓存）</li>
<li>避免对资源的多重占用（比如写文件操作）</li>
</ol>
<p>缺点：没有接口，不能继承，与单一职责原则冲突，一个类应该只关心内部逻辑，而不关心外面怎么样来实例化。</p>
<p><strong>使用场景</strong>：</p>
<ol>
<li>要求生产唯一序列号。</li>
<li>WEB 中的计数器，不用每次刷新都在数据库里加一次，用单例先缓存起来。</li>
<li>创建的一个对象需要消耗的资源过多，比如 I/O 与数据库的连接等。</li>
</ol>
<p><strong>注意事项</strong>：getInstance() 方法中需要使用同步锁 synchronized (Singleton.class) 防止多线程同时进入造成 instance 被多次实例化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 饿汉式</span></span><br><span class="line"><span class="comment"> * 是否 Lazy 初始化：否</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 是否多线程安全：是</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 实现难度：易</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 描述：这种方式比较常用，但容易产生垃圾对象。</span></span><br><span class="line"><span class="comment"> * 优点：没有加锁，执行效率会提高。</span></span><br><span class="line"><span class="comment"> * 缺点：类加载时就初始化，浪费内存。</span></span><br><span class="line"><span class="comment"> * 它基于 classloader 机制避免了多线程的同步问题，不过，instance 在类装载时就实例化，虽然导致类装载的原因有很多</span></span><br><span class="line"><span class="comment"> * 种，在单例模式中大多数都是调用 getInstance 方法， 但是也不能确定有其他的方式（或者其他的静态方法）导致类装载，</span></span><br><span class="line"><span class="comment"> * 这时候初始化 instance 显然没有达到 lazy loading 的效果。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> User user = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//让构造函数私有化，这样该类不会被实例化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"What???"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 懒汉式，线程不安全</span></span><br><span class="line"><span class="comment"> * 是否 Lazy 初始化：是</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 是否多线程安全：否</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 实现难度：易</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 描述：这种方式是最基本的实现方式，这种实现最大的问题就是不支持多线程。因为没有加锁 synchronized，所以严格意义上它并不算单例模式。</span></span><br><span class="line"><span class="comment"> * 这种方式 lazy loading 很明显，不要求线程安全，在多线程不能正常工作。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> User user;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//让构造函数私有化，这样该类不会被实例化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"no user"</span>);</span><br><span class="line">            user = <span class="keyword">new</span> User();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"What???"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 懒汉式，线程安全</span></span><br><span class="line"><span class="comment"> * 是否 Lazy 初始化：是</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 是否多线程安全：是</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 实现难度：易</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 描述：这种方式具备很好的 lazy loading，能够在多线程中很好的工作，但是，效率很低，99% 情况下不需要同步。</span></span><br><span class="line"><span class="comment"> * 优点：第一次调用才初始化，避免内存浪费。</span></span><br><span class="line"><span class="comment"> * 缺点：必须加锁 synchronized 才能保证单例，但加锁会影响效率。</span></span><br><span class="line"><span class="comment"> * getInstance() 的性能对应用程序不是很关键（该方法使用不太频繁）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//让构造函数私有化，这样该类不会被实例化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"no User"</span>);</span><br><span class="line">            user = <span class="keyword">new</span> User();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"What???"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 双检锁/双重校验锁（DCL，即 double-checked locking）</span></span><br><span class="line"><span class="comment"> * JDK 版本：JDK1.5 起</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 是否 Lazy 初始化：是</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 是否多线程安全：是</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 实现难度：较复杂</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 描述：这种方式采用双锁机制，安全且在多线程情况下能保持高性能。</span></span><br><span class="line"><span class="comment"> * getInstance() 的性能对应用程序很关键。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//让构造函数私有化，这样该类不会被实例化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (User.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"no User"</span>);</span><br><span class="line">                    user = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"What???"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登记式/静态内部类</span></span><br><span class="line"><span class="comment"> * 是否 Lazy 初始化：是</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 是否多线程安全：是</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 实现难度：一般</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 描述：这种方式能达到双检锁方式一样的功效，但实现更简单。对静态域使用延迟初始化，应使用这种方式而不是双检锁方式</span></span><br><span class="line"><span class="comment"> * 。这种方式只适用于静态域的情况，双检锁方式可在实例域需要延迟初始化时使用。</span></span><br><span class="line"><span class="comment"> * 这种方式同样利用了 classloader 机制来保证初始化 instance 时只有一个线程，它跟第 3 种方式不同的是：</span></span><br><span class="line"><span class="comment"> * 第 3 种方式只要 Singleton 类被装载了，那么 instance 就会被实例化（没有达到 lazy loading 效果）</span></span><br><span class="line"><span class="comment"> * ，而这种方式是 Singleton 类被装载了，instance 不一定被初始化。因为 SingletonHolder 类没有被主动使用，</span></span><br><span class="line"><span class="comment"> * 只有通过显式调用 getInstance 方法时，才会显式装载 SingletonHolder 类，从而实例化 instance。想象一下，</span></span><br><span class="line"><span class="comment"> * 如果实例化 instance 很消耗资源，所以想让它延迟加载，另外一方面，又不希望在 Singleton 类加载</span></span><br><span class="line"><span class="comment"> * 时就实例化，因为不能确保 Singleton 类还可能在其他的地方被主动使用从而被加载，那么这个时候实</span></span><br><span class="line"><span class="comment"> * 例化 instance 显然是不合适的。这个时候，这种方式相比第 3 种方式就显得很合理。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> User user = <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UserHolder.user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//不合法的构造函数</span></span><br><span class="line">        <span class="comment">//编译时错误：构造函数 User() 是私有的</span></span><br><span class="line"><span class="comment">//        User user = new User();</span></span><br><span class="line">        Runnable runnable = () -&gt; &#123;</span><br><span class="line">            <span class="comment">//枚举单例</span></span><br><span class="line"><span class="comment">//          User.USER.sendMessage();</span></span><br><span class="line">            User user = User.getUser();</span><br><span class="line">            user.showMessage();</span><br><span class="line">        &#125;;</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line">                .forEach(i -&gt; &#123;</span><br><span class="line">                    Thread thread = <span class="keyword">new</span> Thread(runnable);</span><br><span class="line">                    thread.start();</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般情况下，不建议使用懒汉方式，建议使用饿汉方式。只有在要明确实现 lazy loading 效果时，才会使用登记方式。如果涉及到反序列化创建对象时，可以尝试使用枚举方式。如果有其他特殊的需求，可以考虑使用双检锁方式。</p>
<h3 id="1-4-建造者模式"><a href="#1-4-建造者模式" class="headerlink" title="1.4. 建造者模式"></a>1.4. 建造者模式</h3><p>建造者模式（Builder Pattern）使用多个简单的对象一步一步构建成一个复杂的对象。这种类型的设计模式属于创建型模式，它提供了一种创建对象的最佳方式。</p>
<p>一个 Builder 类会一步一步构造最终的对象。该 Builder 类是独立于其他对象的。</p>
<p><strong>主要解决</strong>：主要解决在软件系统中，有时候面临着”一个复杂对象”的创建工作，其通常由各个部分的子对象用一定的算法构成；由于需求的变化，这个复杂对象的各个部分经常面临着剧烈的变化，但是将它们组合在一起的算法却相对稳定。</p>
<p><strong>何时使用</strong>：一些基本部件不会变，而其组合经常变化的时候。</p>
<p><strong>如何解决</strong>：将变与不变分离开。</p>
<p><strong>应用实例</strong>：</p>
<ol>
<li>去肯德基，汉堡、可乐、薯条、炸鸡翅等是不变的，而其组合是经常变化的，生成出所谓的”套餐”</li>
<li>JAVA 中的 StringBuilder</li>
</ol>
<p><strong>优点</strong>： </p>
<ol>
<li>建造者独立，易扩展</li>
<li>便于控制细节风险</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>产品必须有共同点，范围有限制</li>
<li>如内部变化复杂，会有很多的建造类</li>
</ol>
<p><strong>使用场景</strong>： </p>
<ol>
<li>需要生成的对象具有复杂的内部结构</li>
<li>需要生成的对象内部属性本身相互依赖</li>
</ol>
<p><strong>注意事项</strong>：与工厂模式的区别是：建造者模式更加关注与零件装配的顺序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">price</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Production <span class="title">production</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Production</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">production</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hand</span> <span class="keyword">implements</span> <span class="title">Production</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">production</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hand"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Machine</span> <span class="keyword">implements</span> <span class="title">Production</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">production</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Machine"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">implements</span> <span class="title">Product</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Production <span class="title">production</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Hand();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">float</span> <span class="title">price</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Mac</span> <span class="keyword">implements</span> <span class="title">Product</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Production <span class="title">production</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Machine();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">float</span> <span class="title">price</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowsSystem</span> <span class="keyword">extends</span> <span class="title">Windows</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"windowsSystem"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">price</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">25.0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MacSystem</span> <span class="keyword">extends</span> <span class="title">Mac</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"macSystem"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">price</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">30.0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemProduct</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Product&gt; products = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProduct</span><span class="params">(Product product)</span> </span>&#123;</span><br><span class="line">        products.add(product);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getCost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">float</span> cost = <span class="number">0.0f</span>;</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            cost += product.price();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cost;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showProducts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">            System.out.print(<span class="string">"Product : "</span> + product.name());</span><br><span class="line">            System.out.print(<span class="string">",Production : "</span> + product.production().production());</span><br><span class="line">            System.out.println(<span class="string">", Price : "</span> + product.price());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemProductBuilder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SystemProduct <span class="title">prepareMacSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SystemProduct systemProduct = <span class="keyword">new</span> SystemProduct();</span><br><span class="line">        systemProduct.addProduct(<span class="keyword">new</span> MacSystem());</span><br><span class="line">        <span class="keyword">return</span> systemProduct;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SystemProduct <span class="title">prepareWindowsSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SystemProduct systemProduct = <span class="keyword">new</span> SystemProduct();</span><br><span class="line">        systemProduct.addProduct(<span class="keyword">new</span> WindowsSystem());</span><br><span class="line">        <span class="keyword">return</span> systemProduct;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuilderTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SystemProductBuilder systemProductBuilder = <span class="keyword">new</span> SystemProductBuilder();</span><br><span class="line">        SystemProduct windows = systemProductBuilder.prepareMacSystem();</span><br><span class="line">        System.out.println(<span class="string">"windows product"</span>);</span><br><span class="line">        windows.showProducts();</span><br><span class="line">        System.out.println(<span class="string">"Total Cost: "</span> + windows.getCost());</span><br><span class="line"></span><br><span class="line">        SystemProduct allSystem = systemProductBuilder.prepareAllSystem();</span><br><span class="line">        System.out.println(<span class="string">"allSystem"</span>);</span><br><span class="line">        allSystem.showProducts();</span><br><span class="line">        System.out.println(<span class="string">"Total Cost: "</span> + allSystem.getCost());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-5-原型模式"><a href="#1-5-原型模式" class="headerlink" title="1.5. 原型模式"></a>1.5. 原型模式</h3><p>原型模式（Prototype Pattern）是用于创建重复的对象，同时又能保证性能。这种类型的设计模式属于创建型模式，它提供了一种创建对象的最佳方式。</p>
<p>这种模式是实现了一个原型接口，该接口用于创建当前对象的克隆。当直接创建对象的代价比较大时，则采用这种模式。例如，一个对象需要在一个高代价的数据库操作之后被创建。我们可以缓存该对象，在下一个请求时返回它的克隆，在需要的时候更新数据库，以此来减少数据库调用。</p>
<p><strong>主要解决</strong>：在运行期建立和删除原型。</p>
<p><strong>何时使用</strong>： </p>
<ol>
<li>当一个系统应该独立于它的产品创建，构成和表示时</li>
<li>当要实例化的类是在运行时刻指定时，例如，通过动态装载</li>
<li>为了避免创建一个与产品类层次平行的工厂类层次时</li>
<li>当一个类的实例只能有几个不同状态组合中的一种时。建立相应数目的原型并克隆它们可能比每次用合适的状态手工实例化该类更方便一些</li>
</ol>
<p><strong>如何解决</strong>：利用已有的一个原型对象，快速地生成和原型对象一样的实例。</p>
<p><strong>应用实例</strong>：</p>
<ol>
<li>细胞分裂</li>
<li>JAVA 中的 Object clone() 方法</li>
</ol>
<p><strong>优点</strong>： </p>
<ol>
<li>性能提高</li>
<li>逃避构造函数的约束</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>配备克隆方法需要对类的功能进行通盘考虑，这对于全新的类不是很难，但对于已有的类不一定很容易，特别当一个类引用不支持串行化的间接对象，或者引用含有循环结构的时候</li>
<li>必须实现 Cloneable 接口</li>
</ol>
<p><strong>使用场景</strong>： </p>
<ol>
<li>资源优化场景</li>
<li>类初始化需要消化非常多的资源，这个资源包括数据、硬件资源等 性能和安全要求的场景</li>
<li>通过 new 产生一个对象需要非常繁琐的数据准备或访问权限，则可以使用原型模式 一个对象多个修改者的场景</li>
<li>一个对象需要提供给其他对象访问，而且各个调用者可能都需要修改其值时，可以考虑使用原型模式拷贝多个对象供调用者使用</li>
<li>在实际项目中，原型模式很少单独出现，一般是和工厂方法模式一起出现，通过 clone<br>的方法创建一个对象，然后由工厂方法提供给调用者。原型模式已经与 Java 融为浑然一体，大家可以随手拿来使用</li>
</ol>
<p><strong>注意事项</strong>：与通过对一个类进行实例化来构造新对象不同的是，原型模式是通过拷贝一个现有对象生成新对象的。浅拷贝实现 Cloneable，重写，深拷贝是通过实现 Serializable 读取二进制流。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个抽象类 Prototype 和扩展了 Prototype 类的实体类。下一步是定义类 PrototypeCache，该类把 Prototype</span></span><br><span class="line"><span class="comment"> * 对象存储在一个 Hashtable 中，并在请求的时候返回它们的克隆。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Prototype</span> <span class="keyword">implements</span> <span class="title">Cloneable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Object clone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            clone = <span class="keyword">super</span>.clone();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (CloneNotSupportedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrototypeOne</span> <span class="keyword">extends</span> <span class="title">Prototype</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PrototypeOne</span><span class="params">()</span></span>&#123;</span><br><span class="line">        type = <span class="string">"prototypeOne"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Inside PrototypeOne::draw() method."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrototypeTwo</span> <span class="keyword">extends</span> <span class="title">Prototype</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PrototypeTwo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        type = <span class="string">"prototypeTwo"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Inside PrototypeTwo::draw() method."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrototypeCache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Hashtable&lt;String,Prototype&gt; propertyMap =</span><br><span class="line">            <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Prototype <span class="title">getProperType</span><span class="params">(String id)</span></span>&#123;</span><br><span class="line">        Prototype cachePrototype = propertyMap.get(id);</span><br><span class="line">        <span class="keyword">return</span> (Prototype) cachePrototype.clone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PrototypeOne prototypeOne = <span class="keyword">new</span> PrototypeOne();</span><br><span class="line">        prototypeOne.setId(<span class="string">"1"</span>);</span><br><span class="line">        propertyMap.put(prototypeOne.getId(),prototypeOne);</span><br><span class="line">        PrototypeTwo prototypeTwo = <span class="keyword">new</span> PrototypeTwo();</span><br><span class="line">        prototypeTwo.setId(<span class="string">"2"</span>);</span><br><span class="line">        propertyMap.put(prototypeTwo.getId(),prototypeTwo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrototypeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        PrototypeCache.loadCache();</span><br><span class="line">        PrototypeOne prototypeOne = (PrototypeOne) PrototypeCache.getProperType(<span class="string">"1"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Prototype : "</span> + prototypeOne.getType());</span><br><span class="line">        PrototypeTwo prototypeTwo = (PrototypeTwo) PrototypeCache.getProperType(<span class="string">"2"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Prototype : "</span> + prototypeTwo.getType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-结构型模式"><a href="#2-结构型模式" class="headerlink" title="2.结构型模式"></a>2.结构型模式</h2><p>这些设计模式关注类和对象的组合。继承的概念被用来组合接口和定义组合对象获得新功能的方式。</p>
<h3 id="2-1-适配器模式"><a href="#2-1-适配器模式" class="headerlink" title="2.1. 适配器模式"></a>2.1. 适配器模式</h3><p>适配器模式（Adapter Pattern）是作为两个不兼容的接口之间的桥梁。这种类型的设计模式属于结构型模式，它结合了两个独立接口的功能。</p>
<p>这种模式涉及到一个单一的类，该类负责加入独立的或不兼容的接口功能。举个真实的例子，读卡器是作为内存卡和笔记本之间的适配器。您将内存卡插入读卡器，再将读卡器插入笔记本，这样就可以通过笔记本来读取内存卡。</p>
<p>我们通过下面的实例来演示适配器模式的使用。其中，音频播放器设备只能播放 mp3 文件，通过使用一个更高级的音频播放器来播放 vlc 和 mp4 文件。</p>
<p><strong>主要解决</strong>：主要解决在软件系统中，常常要将一些”现存的对象”放到新的环境中，而新环境要求的接口是现对象不能满足的。</p>
<p><strong>何时使用</strong>： </p>
<ol>
<li>系统需要使用现有的类，而此类的接口不符合系统的需要</li>
<li>想要建立一个可以重复使用的类，用于与一些彼此之间没有太大关联的一些类，包括一些可能在将来引进的类一起工作，这些源类不一定有一致的接口</li>
<li>通过接口转换，将一个类插入另一个类系中（比如老虎和飞禽，现在多了一个飞虎，在不增加实体的需求下，增加一个适配器，在里面包容一个虎对象，实现飞的接口）</li>
</ol>
<p><strong>如何解决</strong>：继承或依赖（推荐）。</p>
<p><strong>应用实例</strong>：</p>
<ol>
<li>美国电器 110V，中国 220V，就要有一个适配器将 110V 转化为 220V</li>
<li>JAVA JDK 1.1 提供了 Enumeration 接口，而在 1.2 中提供了 Iterator 接口，想要使用 1.2 的JDK，则要将以前系统的 Enumeration 接口转化为 Iterator 接口，这时就需要适配器模式</li>
<li>在 LINUX 上运行 WINDOWS 程序</li>
<li>JAVA 中的 jdbc</li>
</ol>
<p><strong>优点</strong>：</p>
<ol>
<li>可以让任何两个没有关联的类一起运行</li>
<li>提高了类的复用</li>
<li>增加了类的透明度</li>
<li>灵活性好</li>
</ol>
<p><strong>缺点</strong>： </p>
<ol>
<li><p>过多地使用适配器，会让系统非常零乱，不易整体进行把握。比如，明明看到调用的是A接口，其实内部被适配成了B接口的实现，一个系统如果太多出现这种情况，无异于一场灾难。因此如果不是很有必要，可以不使用适配器，而是直接对系统进行重构</p>
</li>
<li><p>由于 JAVA 至多继承一个类，所以至多只能适配一个适配者类，而且目标类必须是抽象类</p>
</li>
</ol>
<p><strong>使用场景</strong>：有动机地修改一个正常运行的系统的接口，这时应该考虑使用适配器模式。</p>
<p><strong>注意事项</strong>：适配器不是在详细设计时添加的，而是解决正在服役的项目的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MediaPlayer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(String audioType, String fileName)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AdvancedMediaPlayer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playVlc</span><span class="params">(String fileName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playMp4</span><span class="params">(String fileName)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VlcPlayer</span> <span class="keyword">implements</span> <span class="title">AdvancedMediaPlayer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playVlc</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Playing vlc file. Name: "</span> + fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playMp4</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mp4Player</span> <span class="keyword">implements</span> <span class="title">AdvancedMediaPlayer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playVlc</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//do Nothing</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playMp4</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Playing mp4 file. Name: "</span> + fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaAdapter</span> <span class="keyword">implements</span> <span class="title">MediaPlayer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    AdvancedMediaPlayer advancedMusicPlayer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MediaAdapter</span><span class="params">(String audioType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (audioType.equalsIgnoreCase(<span class="string">"vlc"</span>)) &#123;</span><br><span class="line">            advancedMusicPlayer = <span class="keyword">new</span> VlcPlayer();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (audioType.equalsIgnoreCase(<span class="string">"mp4"</span>)) &#123;</span><br><span class="line">            advancedMusicPlayer = <span class="keyword">new</span> Mp4Player();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(String audioType, String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (audioType.equalsIgnoreCase(<span class="string">"vlc"</span>)) &#123;</span><br><span class="line">            advancedMusicPlayer.playVlc(fileName);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (audioType.equalsIgnoreCase(<span class="string">"mp4"</span>)) &#123;</span><br><span class="line">            advancedMusicPlayer.playMp4(fileName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AudioPlayer</span> <span class="keyword">implements</span> <span class="title">MediaPlayer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    MediaAdapter mediaAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(String audioType, String fileName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//播放 mp3 音乐文件的内置支持</span></span><br><span class="line">        <span class="keyword">if</span>(audioType.equalsIgnoreCase(<span class="string">"mp3"</span>))&#123;</span><br><span class="line">            System.out.println(<span class="string">"Playing mp3 file. Name: "</span>+ fileName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//mediaAdapter 提供了播放其他文件格式的支持</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(audioType.equalsIgnoreCase(<span class="string">"vlc"</span>)</span><br><span class="line">                || audioType.equalsIgnoreCase(<span class="string">"mp4"</span>))&#123;</span><br><span class="line">            mediaAdapter = <span class="keyword">new</span> MediaAdapter(audioType);</span><br><span class="line">            mediaAdapter.play(audioType, fileName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Invalid media. "</span>+</span><br><span class="line">                    audioType + <span class="string">" format not supported"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdapterTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AudioPlayer audioPlayer = <span class="keyword">new</span> AudioPlayer();</span><br><span class="line">        audioPlayer.play(<span class="string">"mp3"</span>, <span class="string">"beyond the horizon.mp3"</span>);</span><br><span class="line">        audioPlayer.play(<span class="string">"mp4"</span>, <span class="string">"alone.mp4"</span>);</span><br><span class="line">        audioPlayer.play(<span class="string">"vlc"</span>, <span class="string">"far far away.vlc"</span>);</span><br><span class="line">        audioPlayer.play(<span class="string">"avi"</span>, <span class="string">"mind me.avi"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-桥接模式"><a href="#2-2-桥接模式" class="headerlink" title="2.2. 桥接模式"></a>2.2. 桥接模式</h3><p>桥接（Bridge）是用于把抽象化与实现化解耦，使得二者可以独立变化。这种类型的设计模式属于结构型模式，它通过提供抽象化和实现化之间的桥接结构，来实现二者的解耦。</p>
<p>这种模式涉及到一个作为桥接的接口，使得实体类的功能独立于接口实现类。这两种类型的类可被结构化改变而互不影响。</p>
<p><strong>主要解决</strong>：在有多种可能会变化的情况下，用继承会造成类爆炸问题，扩展起来不灵活。</p>
<p><strong>何时使用</strong>：实现系统可能有多个角度分类，每一种角度都可能变化。</p>
<p><strong>如何解决</strong>：把这种多角度分类分离出来，让它们独立变化，减少它们之间耦合。</p>
<p><strong>应用实例</strong>： </p>
<ol>
<li>猪八戒从天蓬元帅转世投胎到猪，转世投胎的机制将尘世划分为两个等级，即：灵魂和肉体，前者相当于抽象化，后者相当于实现化。生灵通过功能的委派，调用肉体对象的功能，使得生灵可以动态地选择</li>
<li>墙上的开关，可以看到的开关是抽象的，不用管里面具体怎么实现的</li>
</ol>
<p><strong>优点</strong>： </p>
<ol>
<li>抽象和实现的分离</li>
<li>优秀的扩展能力</li>
<li>实现细节对客户透明</li>
</ol>
<p><strong>缺点</strong>：桥接模式的引入会增加系统的理解与设计难度，由于聚合关联关系建立在抽象层，要求开发者针对抽象进行设计与编程。</p>
<p><strong>使用场景</strong>： </p>
<ol>
<li>如果一个系统需要在构件的抽象化角色和具体化角色之间增加更多的灵活性，避免在两个层次之间建立静态的继承联系，通过桥接模式可以使它们在抽象层建立一个关联关系</li>
<li>对于那些不希望使用继承或因为多层次继承导致系统类的个数急剧增加的系统，桥接模式尤为适用</li>
<li>一个类存在两个独立变化的维度，且这两个维度都需要进行扩展</li>
</ol>
<p><strong>注意事项</strong>：对于两个独立变化的维度，使用桥接模式再适合不过了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DrawAPI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawCircle</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedCircle</span> <span class="keyword">implements</span> <span class="title">DrawAPI</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawCircle</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Drawing Circle[ color: red, radius: "</span></span><br><span class="line">                + radius +<span class="string">", x: "</span> +x+<span class="string">", "</span>+ y +<span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreenCircle</span> <span class="keyword">implements</span> <span class="title">DrawAPI</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawCircle</span><span class="params">(<span class="keyword">int</span> radius, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Drawing Circle[ color: green, radius: "</span></span><br><span class="line">                + radius + <span class="string">", x: "</span> + x + <span class="string">", "</span> + y + <span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> DrawAPI drawAPI;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Shape</span><span class="params">(DrawAPI drawAPI)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.drawAPI = drawAPI;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x, y, radius;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Circle</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> radius, DrawAPI drawAPI)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(drawAPI);</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">        <span class="keyword">this</span>.radius = radius;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        drawAPI.drawCircle(radius, x, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BridgeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Shape redCircle = <span class="keyword">new</span> Circle(<span class="number">100</span>, <span class="number">100</span>, <span class="number">10</span>, <span class="keyword">new</span> RedCircle());</span><br><span class="line">        Shape greenCircle = <span class="keyword">new</span> Circle(<span class="number">100</span>, <span class="number">100</span>, <span class="number">10</span>, <span class="keyword">new</span> GreenCircle());</span><br><span class="line"></span><br><span class="line">        redCircle.draw();</span><br><span class="line">        greenCircle.draw();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-桥接模式"><a href="#2-3-桥接模式" class="headerlink" title="2.3. 桥接模式"></a>2.3. 桥接模式</h3><p>过滤器模式（Filter Pattern）或标准模式（Criteria Pattern）是一种设计模式，这种模式允许开发人员使用不同的标准来过滤一组对象，通过逻辑运算以解耦的方式把它们连接起来。这种类型的设计模式属于结构型模式，它结合多个标准来获得单一标准。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">String</span> name;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">String</span> gender;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">String</span> maritalStatus;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">public</span> Person(<span class="keyword">String</span> name,<span class="keyword">String</span> gender,<span class="keyword">String</span> maritalStatus)&#123;</span><br><span class="line">      <span class="built_in">this</span>.name = name;</span><br><span class="line">      <span class="built_in">this</span>.gender = gender;</span><br><span class="line">      <span class="built_in">this</span>.maritalStatus = maritalStatus;    </span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">String</span> getName() &#123;</span><br><span class="line">      <span class="keyword">return</span> name;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">String</span> getGender() &#123;</span><br><span class="line">      <span class="keyword">return</span> gender;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">String</span> getMaritalStatus() &#123;</span><br><span class="line">      <span class="keyword">return</span> maritalStatus;</span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Criteria</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Person&gt; meetCriteria(List&lt;Person&gt; persons);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CriteriaMale</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">Criteria</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> List&lt;Person&gt; meetCriteria(List&lt;Person&gt; persons) &#123;</span><br><span class="line">        <span class="keyword">return</span> persons.stream().filter(person -&gt; person.getGender()</span><br><span class="line">                .equalsIgnoreCase(<span class="string">"MALE"</span>)).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CriteriaFemale</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">Criteria</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> List&lt;Person&gt; meetCriteria(List&lt;Person&gt; persons) &#123;</span><br><span class="line">        <span class="keyword">return</span> persons.stream().filter(person -&gt; person.getGender()</span><br><span class="line">                .equalsIgnoreCase(<span class="string">"FEMALE"</span>)).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CriteriaSingle</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">Criteria</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> List&lt;Person&gt; meetCriteria(List&lt;Person&gt; persons) &#123;</span><br><span class="line">        <span class="keyword">return</span> persons.stream().filter(person -&gt; person.getMaritalStatus()</span><br><span class="line">                .equalsIgnoreCase(<span class="string">"SINGLE"</span>)).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AndCriteria</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">Criteria</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Criteria criteria;</span><br><span class="line">    <span class="keyword">private</span> Criteria otherCriteria;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AndCriteria(Criteria criteria, Criteria otherCriteria) &#123;</span><br><span class="line">        <span class="built_in">this</span>.criteria = criteria;</span><br><span class="line">        <span class="built_in">this</span>.otherCriteria = otherCriteria;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> List&lt;Person&gt; meetCriteria(List&lt;Person&gt; persons) &#123;</span><br><span class="line">        List&lt;Person&gt; firstCriteriaPersons = criteria.meetCriteria(persons);</span><br><span class="line">        <span class="keyword">return</span> otherCriteria.meetCriteria(firstCriteriaPersons);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrCriteria</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">Criteria</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Criteria criteria;</span><br><span class="line">    <span class="keyword">private</span> Criteria otherCriteria;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> OrCriteria(Criteria criteria, Criteria otherCriteria) &#123;</span><br><span class="line">        <span class="built_in">this</span>.criteria = criteria;</span><br><span class="line">        <span class="built_in">this</span>.otherCriteria = otherCriteria;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> List&lt;Person&gt; meetCriteria(List&lt;Person&gt; persons) &#123;</span><br><span class="line">        List&lt;Person&gt; firstCriteriaItems = criteria.meetCriteria(persons);</span><br><span class="line">        List&lt;Person&gt; otherCriteriaItems = otherCriteria.meetCriteria(persons);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Person person : <span class="type">otherCriteriaItems</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!firstCriteriaItems.contains(person))&#123;</span><br><span class="line">                firstCriteriaItems.add(person);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> firstCriteriaItems;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CriteriaTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(<span class="keyword">String</span>[] args) &#123;</span><br><span class="line">        List&lt;Person&gt; persons = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;Person&gt;();</span><br><span class="line"></span><br><span class="line">        persons.add(<span class="keyword">new</span> <span class="type">Person</span>(<span class="string">"Robert"</span>,<span class="string">"Male"</span>, <span class="string">"Single"</span>));</span><br><span class="line">        persons.add(<span class="keyword">new</span> <span class="type">Person</span>(<span class="string">"John"</span>,<span class="string">"Male"</span>, <span class="string">"Married"</span>));</span><br><span class="line">        persons.add(<span class="keyword">new</span> <span class="type">Person</span>(<span class="string">"Laura"</span>,<span class="string">"Female"</span>, <span class="string">"Married"</span>));</span><br><span class="line">        persons.add(<span class="keyword">new</span> <span class="type">Person</span>(<span class="string">"Diana"</span>,<span class="string">"Female"</span>, <span class="string">"Single"</span>));</span><br><span class="line">        persons.add(<span class="keyword">new</span> <span class="type">Person</span>(<span class="string">"Mike"</span>,<span class="string">"Male"</span>, <span class="string">"Single"</span>));</span><br><span class="line">        persons.add(<span class="keyword">new</span> <span class="type">Person</span>(<span class="string">"Bobby"</span>,<span class="string">"Male"</span>, <span class="string">"Single"</span>));</span><br><span class="line"></span><br><span class="line">        Criteria male = <span class="keyword">new</span> <span class="type">CriteriaMale</span>();</span><br><span class="line">        Criteria female = <span class="keyword">new</span> <span class="type">CriteriaFemale</span>();</span><br><span class="line">        Criteria single = <span class="keyword">new</span> <span class="type">CriteriaSingle</span>();</span><br><span class="line">        Criteria singleMale = <span class="keyword">new</span> <span class="type">AndCriteria</span>(single, male);</span><br><span class="line">        Criteria singleOrFemale = <span class="keyword">new</span> <span class="type">OrCriteria</span>(single, female);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Males: "</span>);</span><br><span class="line">        printPersons(male.meetCriteria(persons));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"\nFemales: "</span>);</span><br><span class="line">        printPersons(female.meetCriteria(persons));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"\nSingle Males: "</span>);</span><br><span class="line">        printPersons(singleMale.meetCriteria(persons));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"\nSingle Or Females: "</span>);</span><br><span class="line">        printPersons(singleOrFemale.meetCriteria(persons));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void printPersons(List&lt;Person&gt; persons)&#123;</span><br><span class="line">        <span class="keyword">for</span> (Person person : <span class="type">persons</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Person : [ Name : "</span> + person.getName()</span><br><span class="line">                    +<span class="string">", Gender : "</span> + person.getGender()</span><br><span class="line">                    +<span class="string">", Marital Status : "</span> + person.getMaritalStatus()</span><br><span class="line">                    +<span class="string">" ]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-组合模式"><a href="#2-4-组合模式" class="headerlink" title="2.4. 组合模式"></a>2.4. 组合模式</h3><p>组合模式（Composite Pattern），又叫部分整体模式，是用于把一组相似的对象当作一个单一的对象。组合模式依据树形结构来组合对象，用来表示部分以及整体层次。这种类型的设计模式属于结构型模式，它创建了对象组的树形结构。</p>
<p>这种模式创建了一个包含自己对象组的类。该类提供了修改相同对象组的方式。</p>
<p>我们通过下面的实例来演示组合模式的用法。实例演示了一个组织中员工的层次结构。</p>
<p><strong>意图</strong>：将对象组合成树形结构以表示”部分-整体”的层次结构。组合模式使得用户对单个对象和组合对象的使用具有一致性。</p>
<p><strong>主要解决</strong>：它在我们树型结构的问题中，模糊了简单元素和复杂元素的概念，客户程序可以向处理简单元素一样来处理复杂元素，从而使得客户程序与复杂元素的内部结构解耦。</p>
<p><strong>何时使用</strong>：</p>
<ol>
<li>您想表示对象的部分-整体层次结构（树形结构）</li>
<li>您希望用户忽略组合对象与单个对象的不同，用户将统一地使用组合结构中的所有对象</li>
</ol>
<p><strong>如何解决</strong>：树枝和叶子实现统一接口，树枝内部组合该接口。</p>
<p><strong>关键代码</strong>：树枝内部组合该接口，并且含有内部属性 List，里面放 Component。</p>
<p><strong>应用实例</strong>： </p>
<ol>
<li>算术表达式包括操作数、操作符和另一个操作数，其中，另一个操作符也可以是操作数、操作符和另一个操作数</li>
<li>在 JAVA AWT 和 SWING 中，对于 Button 和 Checkbox 是树叶，Container 是树枝</li>
</ol>
<p><strong>优点</strong>： </p>
<ol>
<li>高层模块调用简单</li>
<li>节点自由增加</li>
</ol>
<p><strong>缺点</strong>：在使用组合模式时，其叶子和树枝的声明都是实现类，而不是接口，违反了依赖倒置原则。</p>
<p><strong>使用场景</strong>：部分、整体场景，如树形菜单，文件、文件夹的管理。</p>
<p><strong>注意事项</strong>：定义时为具体类。</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class Employee &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> dept;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> salary;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Employee&gt; subordinates;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造函数</span></span><br><span class="line">    <span class="keyword">public</span> Employee(<span class="keyword">String</span> name,<span class="keyword">String</span> dept, <span class="built_in">int</span> sal) &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.dept = dept;</span><br><span class="line">        <span class="keyword">this</span>.salary = sal;</span><br><span class="line">        subordinates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">add</span>(Employee e) &#123;</span><br><span class="line">        subordinates.<span class="built_in">add</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> remove(Employee e) &#123;</span><br><span class="line">        subordinates.remove(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Employee&gt; getSubordinates()&#123;</span><br><span class="line">        <span class="keyword">return</span> subordinates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> toString() &#123;</span><br><span class="line">        <span class="keyword">return</span> MoreObjects.toStringHelper(<span class="keyword">this</span>)</span><br><span class="line">                .<span class="built_in">add</span>(<span class="string">"name"</span>, name)</span><br><span class="line">                .<span class="built_in">add</span>(<span class="string">"dept"</span>, dept)</span><br><span class="line">                .<span class="built_in">add</span>(<span class="string">"salary"</span>, salary)</span><br><span class="line">                .<span class="built_in">add</span>(<span class="string">"subordinates"</span>, subordinates)</span><br><span class="line">                .toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class CompositeTest &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) &#123;</span><br><span class="line">        Employee CEO = <span class="keyword">new</span> Employee(<span class="string">"John"</span>, <span class="string">"CEO"</span>, <span class="number">30000</span>);</span><br><span class="line"></span><br><span class="line">        Employee headSales = <span class="keyword">new</span> Employee(<span class="string">"Robert"</span>, <span class="string">"Head Sales"</span>, <span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line">        Employee headMarketing = <span class="keyword">new</span> Employee(<span class="string">"Michel"</span>, <span class="string">"Head Marketing"</span>, <span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line">        Employee clerk1 = <span class="keyword">new</span> Employee(<span class="string">"Laura"</span>, <span class="string">"Marketing"</span>, <span class="number">10000</span>);</span><br><span class="line">        Employee clerk2 = <span class="keyword">new</span> Employee(<span class="string">"Bob"</span>, <span class="string">"Marketing"</span>, <span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">        Employee salesExecutive1 = <span class="keyword">new</span> Employee(<span class="string">"Richard"</span>, <span class="string">"Sales"</span>, <span class="number">10000</span>);</span><br><span class="line">        Employee salesExecutive2 = <span class="keyword">new</span> Employee(<span class="string">"Rob"</span>, <span class="string">"Sales"</span>, <span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">        CEO.<span class="built_in">add</span>(headSales);</span><br><span class="line">        CEO.<span class="built_in">add</span>(headMarketing);</span><br><span class="line"></span><br><span class="line">        headSales.<span class="built_in">add</span>(salesExecutive1);</span><br><span class="line">        headSales.<span class="built_in">add</span>(salesExecutive2);</span><br><span class="line"></span><br><span class="line">        headMarketing.<span class="built_in">add</span>(clerk1);</span><br><span class="line">        headMarketing.<span class="built_in">add</span>(clerk2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//打印该组织的所有员工</span></span><br><span class="line">        System.out.<span class="built_in">println</span>(CEO);</span><br><span class="line">        CEO.getSubordinates().forEach(employee -&gt; &#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(employee);</span><br><span class="line">            employee.getSubordinates().forEach(System.out::<span class="built_in">println</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-5-装饰器模式"><a href="#2-5-装饰器模式" class="headerlink" title="2.5. 装饰器模式"></a>2.5. 装饰器模式</h3><p>装饰器模式（Decorator Pattern）允许向一个现有的对象添加新的功能，同时又不改变其结构。这种类型的设计模式属于结构型模式，它是作为现有的类的一个包装。</p>
<p>这种模式创建了一个装饰类，用来包装原有的类，并在保持类方法签名完整性的前提下，提供了额外的功能。</p>
<p><strong>意图</strong>：动态地给一个对象添加一些额外的职责。就增加功能来说，装饰器模式相比生成子类更为灵活。</p>
<p><strong>主要解决</strong>：一般的，我们为了扩展一个类经常使用继承方式实现，由于继承为类引入静态特征，并且随着扩展功能的增多，子类会很膨胀。</p>
<p><strong>何时使用</strong>：在不想增加很多子类的情况下扩展类。</p>
<p><strong>如何解决</strong>：将具体功能职责划分，同时继承装饰者模式。</p>
<p><strong>关键代码</strong>： </p>
<ol>
<li>Component 类充当抽象角色，不应该具体实现</li>
<li>修饰类引用和继承 Component 类，具体扩展类重写父类方法。</li>
</ol>
<p><strong>应用实例</strong>：</p>
<ol>
<li>孙悟空有 72 变，当他变成”庙宇”后，他的根本还是一只猴子，但是他又有了庙宇的功能</li>
<li>不论一幅画有没有画框都可以挂在墙上，但是通常都是有画框的，并且实际上是画框被挂在墙上。在挂在墙上之前，画可以被蒙上玻璃，装到框子里；这时画、玻璃和画框形成了一个物体。</li>
</ol>
<p><strong>优点</strong>：装饰类和被装饰类可以独立发展，不会相互耦合，装饰模式是继承的一个替代模式，装饰模式可以动态扩展一个实现类的功能。</p>
<p><strong>缺点</strong>：多层装饰比较复杂。</p>
<p><strong>使用场景</strong>：</p>
<ol>
<li>扩展一个类的功能</li>
<li>动态增加功能，动态撤销。</li>
</ol>
<p><strong>注意事项</strong>：可代替继承</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Decorator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CircleDecorator</span> <span class="keyword">implements</span> <span class="title">Decorator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Decorator: CircleDecorator"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedShapeDecorator</span> <span class="keyword">extends</span> <span class="title">ShapeDecorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedShapeDecorator</span><span class="params">(Decorator decorator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(decorator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        decorator.draw();</span><br><span class="line">        setRedBorder(decorator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setRedBorder</span><span class="params">(Decorator decorator)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Border Color: Red"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ShapeDecorator</span> <span class="keyword">implements</span> <span class="title">Decorator</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Decorator decorator ;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShapeDecorator</span><span class="params">(Decorator decorator)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.decorator = decorator;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        decorator.draw();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> <span class="keyword">implements</span> <span class="title">Decorator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Decorator: Rectangle"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecoratorTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Decorator circle = <span class="keyword">new</span> CircleDecorator();</span><br><span class="line"></span><br><span class="line">        Decorator redCircle = <span class="keyword">new</span> RedShapeDecorator(<span class="keyword">new</span> CircleDecorator());</span><br><span class="line"></span><br><span class="line">        Decorator redRectangle = <span class="keyword">new</span> RedShapeDecorator(<span class="keyword">new</span> Rectangle());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Circle with normal border"</span>);</span><br><span class="line">        circle.draw();</span><br><span class="line"></span><br><span class="line">        out.println(<span class="string">"\nCircle of red border"</span>);</span><br><span class="line">        redCircle.draw();</span><br><span class="line"></span><br><span class="line">        out.println(<span class="string">"\nRectangle of red border"</span>);</span><br><span class="line">        redRectangle.draw();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-6-外观模式"><a href="#2-6-外观模式" class="headerlink" title="2.6. 外观模式"></a>2.6. 外观模式</h3><p>外观模式（Facade Pattern）隐藏系统的复杂性，并向客户端提供了一个客户端可以访问系统的接口。这种类型的设计模式属于结构型模式，它向现有的系统添加一个接口，来隐藏系统的复杂性。</p>
<p>这种模式涉及到一个单一的类，该类提供了客户端请求的简化方法和对现有系统类方法的委托调用。</p>
<p><strong>意图</strong>：为子系统中的一组接口提供一个一致的界面，外观模式定义了一个高层接口，这个接口使得这一子系统更加容易使用。</p>
<p><strong>主要解决</strong>：降低访问复杂系统的内部子系统时的复杂度，简化客户端与之的接口。</p>
<p><strong>何时使用</strong>：</p>
<ol>
<li>客户端不需要知道系统内部的复杂联系，整个系统只需提供一个”接待员”即可</li>
<li>定义系统的入口。</li>
</ol>
<p><strong>如何解决</strong>：客户端不与系统耦合，外观类与系统耦合。</p>
<p><strong>关键代码</strong>：在客户端和复杂系统之间再加一层，这一层将调用顺序、依赖关系等处理好。</p>
<p><strong>应用实例</strong>：</p>
<ol>
<li>去医院看病，可能要去挂号、门诊、划价、取药，让患者或患者家属觉得很复杂，如果有提供接待人员，只让接待人员来处理，就很方便</li>
<li>JAVA 的三层开发模式</li>
</ol>
<p><strong>优点</strong>： </p>
<ol>
<li>减少系统相互依赖</li>
<li>提高灵活性</li>
<li>提高了安全性</li>
</ol>
<p>缺点：不符合开闭原则，如果要改东西很麻烦，继承重写都不合适。</p>
<p><strong>使用场景</strong>：</p>
<ol>
<li>为复杂的模块或子系统提供外界访问的模块</li>
<li>子系统相对独立</li>
<li>预防低水平人员带来的风险</li>
</ol>
<p><strong>注意事项</strong>：在层次化结构中，可以使用外观模式定义系统中每一层的入口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Facade</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RectangleFacade</span> <span class="keyword">implements</span> <span class="title">Facade</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Rectangle::draw()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SquareFacade</span> <span class="keyword">implements</span> <span class="title">Facade</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Square::draw()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FacadeMaker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Facade rectangleFacade;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Facade squareFacade;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FacadeMaker</span><span class="params">()</span></span>&#123;</span><br><span class="line">        rectangleFacade = <span class="keyword">new</span> RectangleFacade();</span><br><span class="line">        squareFacade = <span class="keyword">new</span> SquareFacade();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawSquare</span><span class="params">()</span></span>&#123;</span><br><span class="line">        squareFacade.draw();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawRectangle</span><span class="params">()</span></span>&#123;</span><br><span class="line">        rectangleFacade.draw();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FacadeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FacadeMaker facadeMaker = <span class="keyword">new</span> FacadeMaker();</span><br><span class="line"></span><br><span class="line">        facadeMaker.drawRectangle();</span><br><span class="line">        facadeMaker.drawSquare();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-7-享元模式"><a href="#2-7-享元模式" class="headerlink" title="2.7. 享元模式"></a>2.7. 享元模式</h3><p>享元模式（Flyweight Pattern）主要用于减少创建对象的数量，以减少内存占用和提高性能。这种类型的设计模式属于结构型模式，它提供了减少对象数量从而改善应用所需的对象结构的方式。</p>
<p>享元模式尝试重用现有的同类对象，如果未找到匹配的对象，则创建新对象。</p>
<p><strong>意图</strong>：运用共享技术有效地支持大量细粒度的对象。</p>
<p><strong>主要解决</strong>：在有大量对象时，有可能会造成内存溢出，我们把其中共同的部分抽象出来，如果有相同的业务请求，直接返回在内存中已有的对象，避免重新创建。</p>
<p><strong>何时使用</strong>： </p>
<ol>
<li>系统中有大量对象</li>
<li>这些对象消耗大量内存</li>
<li>这些对象的状态大部分可以外部化</li>
<li>这些对象可以按照内蕴状态分为很多组，当把外蕴对象从对象中剔除出来时，每一组对象都可以用一个对象来代替</li>
<li>系统不依赖于这些对象身份，这些对象是不可分辨的</li>
</ol>
<p><strong>如何解决</strong>：用唯一标识码判断，如果在内存中有，则返回这个唯一标识码所标识的对象。</p>
<p><strong>关键代码</strong>：用 HashMap 存储这些对象。</p>
<p><strong>应用实例</strong>：</p>
<ol>
<li>JAVA 中的 String，如果有则返回，如果没有则创建一个字符串保存在字符串缓存池里面</li>
<li>数据库的数据池</li>
</ol>
<p><strong>优点</strong>：大大减少对象的创建，降低系统的内存，使效率提高。</p>
<p><strong>缺点</strong>：提高了系统的复杂度，需要分离出外部状态和内部状态，而且外部状态具有固有化的性质，不应该随着内部状态的变化而变化，否则会造成系统的混乱。</p>
<p><strong>使用场景</strong>： </p>
<ol>
<li>系统有大量相似对象</li>
<li>需要缓冲池的场景</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>注意划分外部状态和内部状态，否则可能会引起线程安全问题</li>
<li>这些类必须有一个工厂对象加以控制</li>
</ol>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> interface Flyweight &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title">draw</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class CircleFlyweight implements Flyweight &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> <span class="built_in">color</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> x;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> y;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> radius;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CircleFlyweight(<span class="keyword">String</span> <span class="built_in">color</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">color</span> = <span class="built_in">color</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setX(<span class="built_in">int</span> x) &#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setY(<span class="built_in">int</span> y) &#123;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setRadius(<span class="built_in">int</span> radius) &#123;</span><br><span class="line">        <span class="keyword">this</span>.radius = radius;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span>() &#123;</span><br><span class="line">        System.out.<span class="built_in">println</span>(<span class="string">"Circle: Draw() [Color : "</span> + <span class="built_in">color</span></span><br><span class="line">                +<span class="string">", x : "</span> + x +<span class="string">", y :"</span> + y +<span class="string">", radius :"</span> + radius);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class FlyweightFactory &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">HashMap</span>&lt;<span class="keyword">String</span>, Flyweight&gt; circleMap = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Flyweight getCircle(<span class="keyword">String</span> <span class="built_in">color</span>) &#123;</span><br><span class="line">        CircleFlyweight circle = (CircleFlyweight) circleMap.<span class="built_in">get</span>(<span class="built_in">color</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (circle == <span class="keyword">null</span>) &#123;</span><br><span class="line">            circle = <span class="keyword">new</span> CircleFlyweight(<span class="built_in">color</span>);</span><br><span class="line">            circleMap.put(<span class="built_in">color</span>, circle);</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">"Creating circle of color : "</span> + <span class="built_in">color</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> circle;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class FlyweightTest &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> colors[] =</span><br><span class="line">            &#123; <span class="string">"Red"</span>, <span class="string">"Green"</span>, <span class="string">"Blue"</span>, <span class="string">"White"</span>, <span class="string">"Black"</span> &#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i=<span class="number">0</span>; i &lt; <span class="number">20</span>; ++i) &#123;</span><br><span class="line">            CircleFlyweight circle =</span><br><span class="line">                    (CircleFlyweight)FlyweightFactory.getCircle(getRandomColor());</span><br><span class="line">            circle.setX(getRandomX());</span><br><span class="line">            circle.setY(getRandomY());</span><br><span class="line">            circle.setRadius(<span class="number">100</span>);</span><br><span class="line">            circle.<span class="title">draw</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">String</span> getRandomColor() &#123;</span><br><span class="line">        <span class="keyword">return</span> colors[(<span class="built_in">int</span>)(Math.<span class="built_in">random</span>()*colors.length)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> getRandomX() &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">int</span>)(Math.<span class="built_in">random</span>()*<span class="number">100</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> getRandomY() &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">int</span>)(Math.<span class="built_in">random</span>()*<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-8-代理模式"><a href="#2-8-代理模式" class="headerlink" title="2.8. 代理模式"></a>2.8. 代理模式</h3><p>在代理模式（Proxy Pattern）中，一个类代表另一个类的功能。这种类型的设计模式属于结构型模式。</p>
<p>在代理模式中，我们创建具有现有对象的对象，以便向外界提供功能接口。</p>
<p><strong>意图</strong>：为其他对象提供一种代理以控制对这个对象的访问。</p>
<p><strong>主要解决</strong>：在直接访问对象时带来的问题，比如说：要访问的对象在远程的机器上。在面向对象系统中，有些对象由于某些原因（比如对象创建开销很大，或者某些操作需要安全控制，或者需要进程外的访问），直接访问会给使用者或者系统结构带来很多麻烦，我们可以在访问此对象时加上一个对此对象的访问层。</p>
<p><strong>何时使用</strong>：想在访问一个类时做一些控制。</p>
<p><strong>如何解决</strong>：增加中间层。</p>
<p><strong>关键代码</strong>：实现与被代理类组合。</p>
<p><strong>应用实例</strong>：</p>
<ol>
<li>Windows 里面的快捷方式</li>
<li>猪八戒去找高翠兰结果是孙悟空变的，可以这样理解：把高翠兰的外貌抽象出来，高翠兰本人和孙悟空都实现了这个接口，猪八戒访问高翠兰的时候看不出来这个是孙悟空，所以说孙悟空是高翠兰代理类</li>
<li>买火车票不一定在火车站买，也可以去代售点</li>
<li>一张支票或银行存单是账户中资金的代理。支票在市场交易中用来代替现金，并提供对签发人账号上资金的控制</li>
<li>spring aop</li>
</ol>
<p><strong>优点</strong>：</p>
<ol>
<li>职责清晰</li>
<li>高扩展性</li>
<li>智能化</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>由于在客户端和真实主题之间增加了代理对象，因此有些类型的代理模式可能会造成请求的处理速度变慢</li>
<li>实现代理模式需要额外的工作，有些代理模式的实现非常复杂</li>
</ol>
<p><strong>使用场景</strong>：按职责来划分，通常有以下使用场景： </p>
<ol>
<li>远程代理</li>
<li>虚拟代理</li>
<li>Copy-on-Write 代理</li>
<li>保护（Protect or Access）代理</li>
<li>Cache代理</li>
<li>防火墙（Firewall）代理</li>
<li>同步化（Synchronization）代理</li>
<li>智能引用（Smart Reference）代理</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>和适配器模式的区别：适配器模式主要改变所考虑对象的接口，而代理模式不能改变所代理类的接口</li>
<li>和装饰器模式的区别：装饰器模式为了增强功能，而代理模式是为了加以控制</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Image</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RealImage</span> <span class="keyword">implements</span> <span class="title">Image</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RealImage</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fileName = fileName;</span><br><span class="line">        loadFromDisk(fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Displaying "</span> + fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadFromDisk</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Loading "</span> + fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyImage</span> <span class="keyword">implements</span> <span class="title">Image</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RealImage realImage;</span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyImage</span><span class="params">(String fileName)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fileName = fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(realImage == <span class="keyword">null</span>)&#123;</span><br><span class="line">            realImage = <span class="keyword">new</span> RealImage(fileName);</span><br><span class="line">        &#125;</span><br><span class="line">        realImage.display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Image image = <span class="keyword">new</span> ProxyImage(<span class="string">"test_10mb.jpg"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//图像将从磁盘加载</span></span><br><span class="line">        image.display();</span><br><span class="line">        System.out.println(<span class="string">""</span>);</span><br><span class="line">        <span class="comment">//图像将无法从磁盘加载</span></span><br><span class="line">        image.display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-行为型模式"><a href="#3-行为型模式" class="headerlink" title="3.行为型模式"></a>3.行为型模式</h2><h3 id="3-1-责任链模式"><a href="#3-1-责任链模式" class="headerlink" title="3.1. 责任链模式"></a>3.1. 责任链模式</h3><p>顾名思义，责任链模式（Chain of Responsibility Pattern）为请求创建了一个接收者对象的链。这种模式给予请求的类型，对请求的发送者和接收者进行解耦。这种类型的设计模式属于行为型模式。</p>
<p>在这种模式中，通常每个接收者都包含对另一个接收者的引用。如果一个对象不能处理该请求，那么它会把相同的请求传给下一个接收者，依此类推。</p>
<p><strong>意图</strong>：避免请求发送者与接收者耦合在一起，让多个对象都有可能接收请求，将这些对象连接成一条链，并且沿着这条链传递请求，直到有对象处理它为止。</p>
<p><strong>主要解决</strong>：职责链上的处理者负责处理请求，客户只需要将请求发送到职责链上即可，无须关心请求的处理细节和请求的传递，所以职责链将请求的发送者和请求的处理者解耦了。</p>
<p><strong>何时使用</strong>：在处理消息的时候以过滤很多道。</p>
<p><strong>如何解决</strong>：拦截的类都实现统一接口。</p>
<p><strong>关键代码</strong>：Handler 里面聚合它自己，在 HanleRequest 里判断是否合适，如果没达到条件则向下传递，向谁传递之前 set 进去。</p>
<p><strong>应用实例</strong>：</p>
<ol>
<li>红楼梦中的”击鼓传花”。 </li>
<li>JS 中的事件冒泡。 </li>
<li>AVA WEB 中 Apache Tomcat 对 Encoding 的处理，Struts2 的拦截器，jsp servlet 的 Filter。</li>
</ol>
<p><strong>优点</strong>：</p>
<ol>
<li>降低耦合度。它将请求的发送者和接收者解耦。</li>
<li>简化了对象。使得对象不需要知道链的结构。</li>
<li>增强给对象指派职责的灵活性。通过改变链内的成员或者调动它们的次序，允许动态地新增或者删除责任。</li>
<li>增加新的请求处理类很方便。</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>不能保证请求一定被接收。</li>
<li>系统性能将受到一定影响，而且在进行代码调试时不太方便，可能会造成循环调用。</li>
<li>可能不容易观察运行时的特征，有碍于除错。</li>
</ol>
<p><strong>使用场景</strong>：</p>
<ol>
<li>有多个对象可以处理同一个请求，具体哪个对象处理该请求由运行时刻自动确定。</li>
<li>在不明确指定接收者的情况下，向多个对象中的一个提交一个请求</li>
<li>可动态指定一组对象处理请求。</li>
</ol>
<p><strong>注意事项</strong>：<br> 在 JAVA WEB 中遇到很多应用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLogger</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> INFO = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> DEBUG = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> ERROR = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> level;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 责任链中的下一个元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> AbstractLogger nextLogger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNextLogger</span><span class="params">(AbstractLogger nextLogger)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nextLogger = nextLogger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logMessage</span><span class="params">(<span class="keyword">int</span> level, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.level &lt;= level) &#123;</span><br><span class="line">            write(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nextLogger != <span class="keyword">null</span>) &#123;</span><br><span class="line">            nextLogger.logMessage(level, message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String message)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsoleLogger</span> <span class="keyword">extends</span> <span class="title">AbstractLogger</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConsoleLogger</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Standard Console::Logger: "</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DebugLogger</span> <span class="keyword">extends</span> <span class="title">AbstractLogger</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DebugLogger</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Debug::Logger: "</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorLogger</span> <span class="keyword">extends</span> <span class="title">AbstractLogger</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorLogger</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Error Console::Logger: "</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainPatternDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AbstractLogger <span class="title">getChainOfLoggers</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        AbstractLogger errorLogger = <span class="keyword">new</span> ErrorLogger(AbstractLogger.ERROR);</span><br><span class="line">        AbstractLogger debugLogger = <span class="keyword">new</span> DebugLogger(AbstractLogger.DEBUG);</span><br><span class="line">        AbstractLogger consoleLogger = <span class="keyword">new</span> ConsoleLogger(AbstractLogger.INFO);</span><br><span class="line"></span><br><span class="line">        errorLogger.setNextLogger(debugLogger);</span><br><span class="line">        debugLogger.setNextLogger(consoleLogger);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> errorLogger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AbstractLogger loggerChain = getChainOfLoggers();</span><br><span class="line"></span><br><span class="line">        loggerChain.logMessage(AbstractLogger.INFO,</span><br><span class="line">                <span class="string">"This is an information."</span>);</span><br><span class="line"></span><br><span class="line">        loggerChain.logMessage(AbstractLogger.DEBUG,</span><br><span class="line">                <span class="string">"This is an debug level information."</span>);</span><br><span class="line"></span><br><span class="line">        loggerChain.logMessage(AbstractLogger.ERROR,</span><br><span class="line">                <span class="string">"This is an error information."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-命令模式"><a href="#3-2-命令模式" class="headerlink" title="3.2. 命令模式"></a>3.2. 命令模式</h3><p>命令模式（Command Pattern）是一种数据驱动的设计模式，它属于行为型模式。请求以命令的形式包裹在对象中，并传给调用对象。调用对象寻找可以处理该命令的合适的对象，并把该命令传给相应的对象，该对象执行命令。</p>
<p><strong>意图</strong>：将一个请求封装成一个对象，从而使您可以用不同的请求对客户进行参数化。</p>
<p><strong>主要解决</strong>：在软件系统中，行为请求者与行为实现者通常是一种紧耦合的关系，但某些场合，比如需要对行为进行记录、撤销或重做、事务等处理时，这种无法抵御变化的紧耦合的设计就不太合适。</p>
<p><strong>何时使用</strong>：在某些场合，比如要对行为进行”记录、撤销/重做、事务”等处理，这种无法抵御变化的紧耦合是不合适的。在这种情况下，如何将”行为请求者”与”行为实现者”解耦？将一组行为抽象为对象，可以实现二者之间的松耦合。</p>
<p><strong>如何解决</strong>：通过调用者调用接受者执行命令，顺序：调用者→接受者→命令。</p>
<p><strong>关键代码</strong>：定义三个角色：1、received 真正的命令执行对象 2、Command 3、invoker 使用命令对象的入口</p>
<p><strong>应用实例</strong>：struts 1 中的 action 核心控制器 ActionServlet 只有一个，相当于 Invoker，而模型层的类会随着不同的应用有不同的模型类，相当于具体的 Command。</p>
<p><strong>优点</strong>：</p>
<ol>
<li>降低了系统耦合度。</li>
<li>新的命令可以很容易添加到系统中去。</li>
</ol>
<p><strong>缺点</strong>：使用命令模式可能会导致某些系统有过多的具体命令类。</p>
<p><strong>使用场景</strong>：认为是命令的地方都可以使用命令模式，比如： 1、GUI 中每一个按钮都是一条命令。 2、模拟 CMD。</p>
<p><strong>注意事项</strong>：系统需要支持命令的撤销(Undo)操作和恢复(Redo)操作，也可以考虑使用命令模式，见命令模式的扩展。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">"ABC"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> quantity = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Stock [ Name: "</span> + name + <span class="string">",Quantity:"</span> + quantity + <span class="string">" ]bought "</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sell</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Stock [ Name: "</span> + name + <span class="string">",Quantity:"</span> + quantity + <span class="string">" ]sold "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyStock</span> <span class="keyword">implements</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Stock abcStock;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BuyStock</span><span class="params">(Stock abcStock)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.abcStock = abcStock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        abcStock.buy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SellStock</span> <span class="keyword">implements</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Stock abcStock;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SellStock</span><span class="params">(Stock abcStock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.abcStock = abcStock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        abcStock.sell();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Broker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Order&gt; orderList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeOrder</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">        orderList.add(order);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">placeOrders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Order order : orderList) &#123;</span><br><span class="line">            order.execute();</span><br><span class="line">        &#125;</span><br><span class="line">        orderList.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandPatternDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Stock abcStock = <span class="keyword">new</span> Stock();</span><br><span class="line"></span><br><span class="line">        BuyStock buyStockOrder = <span class="keyword">new</span> BuyStock(abcStock);</span><br><span class="line">        SellStock sellStockOrder = <span class="keyword">new</span> SellStock(abcStock);</span><br><span class="line"></span><br><span class="line">        Broker broker = <span class="keyword">new</span> Broker();</span><br><span class="line">        broker.takeOrder(buyStockOrder);</span><br><span class="line">        broker.takeOrder(sellStockOrder);</span><br><span class="line"></span><br><span class="line">        broker.placeOrders();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-解释器模式"><a href="#3-3-解释器模式" class="headerlink" title="3.3. 解释器模式"></a>3.3. 解释器模式</h3><p>解释器模式（Interpreter Pattern）提供了评估语言的语法或表达式的方式，它属于行为型模式。这种模式实现了一个表达式接口，该接口解释一个特定的上下文。这种模式被用在 SQL 解析、符号处理引擎等。</p>
<p><strong>意图</strong>：给定一个语言，定义它的文法表示，并定义一个解释器，这个解释器使用该标识来解释语言中的句子。</p>
<p><strong>主要解决</strong>：对于一些固定文法构建一个解释句子的解释器。</p>
<p><strong>何时使用</strong>：如果一种特定类型的问题发生的频率足够高，那么可能就值得将该问题的各个实例表述为一个简单语言中的句子。这样就可以构建一个解释器，该解释器通过解释这些句子来解决该问题。</p>
<p><strong>如何解决</strong>：构件语法树，定义终结符与非终结符。</p>
<p><strong>关键代码</strong>：构件环境类，包含解释器之外的一些全局信息，一般是 HashMap。</p>
<p><strong>应用实例</strong>：编译器、运算表达式计算。</p>
<p><strong>优点</strong>：</p>
<ol>
<li>可扩展性比较好。</li>
<li>增加了新的解释表达式的方式。</li>
<li>易于实现简单文法。</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>可利用场景比较少。</li>
<li>对于复杂的文法比较难维护。</li>
<li>解释器模式会引起类膨胀。</li>
<li>解释器模式采用递归调用方法。</li>
</ol>
<p><strong>使用场景</strong>：</p>
<ol>
<li>可以将一个需要解释执行的语言中的句子表示为一个抽象语法树。</li>
<li>一些重复出现的问题可以用一种简单的语言来进行表达。</li>
<li>一个简单语法需要解释的场景。</li>
</ol>
<p><strong>注意事项</strong>：可利用场景比较少，JAVA 中如果碰到可以用 expression4J 代替。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Expression</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">interpret</span><span class="params">(String context)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TerminalExpression</span> <span class="keyword">implements</span> <span class="title">Expression</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TerminalExpression</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">interpret</span><span class="params">(String context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (context.contains(data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrExpression</span> <span class="keyword">implements</span> <span class="title">Expression</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Expression expr1 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Expression expr2 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrExpression</span><span class="params">(Expression expr1, Expression expr2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.expr1 = expr1;</span><br><span class="line">        <span class="keyword">this</span>.expr2 = expr2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">interpret</span><span class="params">(String context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> expr1.interpret(context) || expr2.interpret(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AndExpression</span> <span class="keyword">implements</span> <span class="title">Expression</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Expression expr1 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Expression expr2 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AndExpression</span><span class="params">(Expression expr1, Expression expr2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.expr1 = expr1;</span><br><span class="line">        <span class="keyword">this</span>.expr2 = expr2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">interpret</span><span class="params">(String context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> expr1.interpret(context) &amp;&amp; expr2.interpret(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterpreterPatternDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 规则：Robert 和 John 是男性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Expression <span class="title">getMaleExpression</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Expression robert = <span class="keyword">new</span> TerminalExpression(<span class="string">"Robert"</span>);</span><br><span class="line">        Expression john = <span class="keyword">new</span> TerminalExpression(<span class="string">"John"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OrExpression(robert, john);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 规则：Julie 是一个已婚的女性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Expression <span class="title">getMarriedWomanExpression</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Expression julie = <span class="keyword">new</span> TerminalExpression(<span class="string">"Julie"</span>);</span><br><span class="line">        Expression married = <span class="keyword">new</span> TerminalExpression(<span class="string">"Married"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AndExpression(julie, married);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Expression isMale = getMaleExpression();</span><br><span class="line">        Expression isMarriedWoman = getMarriedWomanExpression();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"John is male? "</span> + isMale.interpret(<span class="string">"John"</span>));</span><br><span class="line">        System.out.println(<span class="string">"Julie is a married women? "</span></span><br><span class="line">                + isMarriedWoman.interpret(<span class="string">"Married Julie"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-迭代器模式"><a href="#3-4-迭代器模式" class="headerlink" title="3.4. 迭代器模式"></a>3.4. 迭代器模式</h3><p>迭代器模式（Iterator Pattern）是 Java 和 .Net 编程环境中非常常用的设计模式。这种模式用于顺序访问集合对象的元素，不需要知道集合对象的底层表示。</p>
<p>迭代器模式属于行为型模式。</p>
<p><strong>意图</strong>：提供一种方法顺序访问一个聚合对象中各个元素, 而又无须暴露该对象的内部表示。</p>
<p><strong>主要解决</strong>：不同的方式来遍历整个整合对象。</p>
<p><strong>何时使用</strong>：遍历一个聚合对象。</p>
<p><strong>如何解决</strong>：把在元素之间游走的责任交给迭代器，而不是聚合对象。</p>
<p><strong>关键代码</strong>：定义接口：hasNext, next。</p>
<p><strong>应用实例</strong>：JAVA 中的 iterator。</p>
<p><strong>优点</strong>：</p>
<ol>
<li>它支持以不同的方式遍历一个聚合对象。</li>
<li>迭代器简化了聚合类。</li>
<li>在同一个聚合上可以有多个遍历。</li>
<li>在迭代器模式中，增加新的聚合类和迭代器类都很方便，无须修改原有代码。</li>
</ol>
<p><strong>缺点</strong>：由于迭代器模式将存储数据和遍历数据的职责分离，增加新的聚合类需要对应增加新的迭代器类，类的个数成对增加，这在一定程度上增加了系统的复杂性。</p>
<p><strong>使用场景</strong>：</p>
<ol>
<li>访问一个聚合对象的内容而无须暴露它的内部表示。</li>
<li>需要为聚合对象提供多种遍历方式。 </li>
<li>为遍历不同的聚合结构提供一个统一的接口。</li>
</ol>
<p><strong>注意事项</strong>：迭代器模式就是分离了集合对象的遍历行为，抽象出一个迭代器类来负责，这样既可以做到不暴露集合的内部结构，又可让外部代码透明地访问集合内部的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">getIterator</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NameRepository</span> <span class="keyword">implements</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String[] names = &#123;<span class="string">"Robert"</span>, <span class="string">"John"</span>, <span class="string">"Julie"</span>, <span class="string">"Lora"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">getIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NameIterator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NameIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (index &lt; names.length) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">return</span> names[index++];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IteratorPatternDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NameRepository namesRepository = <span class="keyword">new</span> NameRepository();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Iterator iter = namesRepository.getIterator(); iter.hasNext(); ) &#123;</span><br><span class="line">            String name = (String) iter.next();</span><br><span class="line">            System.out.println(<span class="string">"Name : "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-5-中介者模式"><a href="#3-5-中介者模式" class="headerlink" title="3.5. 中介者模式"></a>3.5. 中介者模式</h3><p>中介者模式（Mediator Pattern）是用来降低多个对象和类之间的通信复杂性。这种模式提供了一个中介类，该类通常处理不同类之间的通信，并支持松耦合，使代码易于维护。中介者模式属于行为型模式。</p>
<p><strong>意图</strong>：用一个中介对象来封装一系列的对象交互，中介者使各对象不需要显式地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互。</p>
<p><strong>主要解决</strong>：对象与对象之间存在大量的关联关系，这样势必会导致系统的结构变得很复杂，同时若一个对象发生改变，我们也需要跟踪与之相关联的对象，同时做出相应的处理。</p>
<p><strong>何时使用</strong>：多个类相互耦合，形成了网状结构。</p>
<p><strong>如何解决</strong>：将上述网状结构分离为星型结构。</p>
<p><strong>关键代码</strong>：对象 Colleague 之间的通信封装到一个类中单独处理。</p>
<p><strong>应用实例</strong>： </p>
<ol>
<li>中国加入 WTO 之前是各个国家相互贸易，结构复杂，现在是各个国家通过 WTO 来互相贸易。</li>
<li>机场调度系统。 </li>
<li>MVC 框架，其中C（控制器）就是 M（模型）和 V（视图）的中介者。</li>
</ol>
<p><strong>优点</strong>：</p>
<ol>
<li>降低了类的复杂度，将一对多转化成了一对一。</li>
<li>各个类之间的解耦。</li>
<li>符合迪米特原则。</li>
</ol>
<p><strong>缺点</strong>：中介者会庞大，变得复杂难以维护。</p>
<p><strong>使用场景</strong>：</p>
<ol>
<li>系统中对象之间存在比较复杂的引用关系，导致它们之间的依赖关系结构混乱而且难以复用该对象。</li>
<li>想通过一个中间类来封装多个类中的行为，而又不想生成太多的子类。</li>
</ol>
<p><strong>注意事项</strong>：不应当在职责混乱的时候使用。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChatRoom</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showMessage</span>(<span class="params">User user, String message</span>) </span>&#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="keyword">new</span> Date().toString()</span><br><span class="line">                + <span class="string">" ["</span> + user.getName() + <span class="string">"] : "</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MediatorPatternDemo</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] args</span>) </span>&#123;</span><br><span class="line">        User robert = <span class="keyword">new</span> User(<span class="string">"Robert"</span>);</span><br><span class="line">        User john = <span class="keyword">new</span> User(<span class="string">"John"</span>);</span><br><span class="line"></span><br><span class="line">        robert.sendMessage(<span class="string">"Hi! John!"</span>);</span><br><span class="line">        john.sendMessage(<span class="string">"Hello! Robert!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span>(<span class="params">String name</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span>(<span class="params">String name</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span>(<span class="params">String message</span>) </span>&#123;</span><br><span class="line">        ChatRoom.showMessage(<span class="keyword">this</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-6-备忘录模式"><a href="#3-6-备忘录模式" class="headerlink" title="3.6. 备忘录模式"></a>3.6. 备忘录模式</h3><p>备忘录模式（Memento Pattern）保存一个对象的某个状态，以便在适当的时候恢复对象。备忘录模式属于行为型模式。</p>
<p><strong>意图</strong>：在不破坏封装性的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态。</p>
<p><strong>主要解决</strong>：所谓备忘录模式就是在不破坏封装的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态，这样可以在以后将对象恢复到原先保存的状态。</p>
<p><strong>何时使用</strong>：很多时候我们总是需要记录一个对象的内部状态，这样做的目的就是为了允许用户取消不确定或者错误的操作，能够恢复到他原先的状态，使得他有”后悔药”可吃。</p>
<p><strong>如何解决</strong>：通过一个备忘录类专门存储对象状态。</p>
<p><strong>关键代码</strong>：客户不与备忘录类耦合，与备忘录管理类耦合。</p>
<p><strong>应用实例</strong>： </p>
<ol>
<li>后悔药。</li>
<li>打游戏时的存档。</li>
<li>Windows 里的 ctri + z。</li>
<li>IE 中的后退。</li>
<li>数据库的事务管理。</li>
</ol>
<p><strong>优点</strong>：</p>
<ol>
<li>给用户提供了一种可以恢复状态的机制，可以使用户能够比较方便地回到某个历史的状态。</li>
<li>实现了信息的封装，使得用户不需要关心状态的保存细节。</li>
</ol>
<p><strong>缺点</strong>：消耗资源。如果类的成员变量过多，势必会占用比较大的资源，而且每一次保存都会消耗一定的内存。</p>
<p><strong>使用场景</strong>：</p>
<ol>
<li>需要保存/恢复数据的相关状态场景。 </li>
<li>提供一个可回滚的操作。</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>为了符合迪米特原则，还要增加一个管理备忘录的类。</li>
<li>为了节约内存，可使用原型模式+备忘录模式。</li>
</ol>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">public class Memento &#123;</span><br><span class="line">    private String <span class="keyword">state</span>;</span><br><span class="line"></span><br><span class="line">    public Memento(String <span class="keyword">state</span>) &#123;</span><br><span class="line">        this.<span class="keyword">state</span> = <span class="keyword">state</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getState() &#123;</span><br><span class="line">        return <span class="keyword">state</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Originator &#123;</span><br><span class="line">    private String <span class="keyword">state</span>;</span><br><span class="line"></span><br><span class="line">    public void <span class="built_in">set</span>State(String <span class="keyword">state</span>) &#123;</span><br><span class="line">        this.<span class="keyword">state</span> = <span class="keyword">state</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getState() &#123;</span><br><span class="line">        return <span class="keyword">state</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Memento saveStateToMemento() &#123;</span><br><span class="line">        return new Memento(<span class="keyword">state</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void getStateFromMemento(Memento Memento) &#123;</span><br><span class="line">        <span class="keyword">state</span> = Memento.getState();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class CareTaker &#123;</span><br><span class="line">    private List<span class="variable">&lt;Memento&gt;</span> mementoList = new ArrayList<span class="variable">&lt;Memento&gt;</span>();</span><br><span class="line"></span><br><span class="line">    public void add(Memento <span class="keyword">state</span>) &#123;</span><br><span class="line">        mementoList.add(<span class="keyword">state</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Memento get(int index) &#123;</span><br><span class="line">        return mementoList.get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class MementoPatternDemo &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Originator originator = new Originator();</span><br><span class="line">        CareTaker careTaker = new CareTaker();</span><br><span class="line">        originator.<span class="built_in">set</span>State(<span class="string">"State #1"</span>);</span><br><span class="line">        originator.<span class="built_in">set</span>State(<span class="string">"State #2"</span>);</span><br><span class="line">        careTaker.add(originator.saveStateToMemento());</span><br><span class="line">        originator.<span class="built_in">set</span>State(<span class="string">"State #3"</span>);</span><br><span class="line">        careTaker.add(originator.saveStateToMemento());</span><br><span class="line">        originator.<span class="built_in">set</span>State(<span class="string">"State #4"</span>);</span><br><span class="line"></span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">"Current State: "</span> + originator.getState());</span><br><span class="line">        originator.getStateFromMemento(careTaker.get(<span class="number">0</span>));</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">"First saved State: "</span> + originator.getState());</span><br><span class="line">        originator.getStateFromMemento(careTaker.get(<span class="number">1</span>));</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">"Second saved State: "</span> + originator.getState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-7-观察者模式"><a href="#3-7-观察者模式" class="headerlink" title="3.7. 观察者模式"></a>3.7. 观察者模式</h3><p>当对象间存在一对多关系时，则使用观察者模式（Observer Pattern）。比如，当一个对象被修改时，则会自动通知它的依赖对象。观察者模式属于行为型模式。</p>
<p><strong>意图</strong>：定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。</p>
<p><strong>主要解决</strong>：一个对象状态改变给其他对象通知的问题，而且要考虑到易用和低耦合，保证高度的协作。</p>
<p><strong>何时使用</strong>：一个对象（目标对象）的状态发生改变，所有的依赖对象（观察者对象）都将得到通知，进行广播通知。</p>
<p><strong>如何解决</strong>：使用面向对象技术，可以将这种依赖关系弱化。</p>
<p><strong>关键代码</strong>：在抽象类里有一个 ArrayList 存放观察者们。</p>
<p><strong>应用实例</strong>： </p>
<ol>
<li>拍卖的时候，拍卖师观察最高标价，然后通知给其他竞价者竞价。</li>
<li>西游记里面悟空请求菩萨降服红孩儿，菩萨洒了一地水招来一个老乌龟，这个乌龟就是观察者，他观察菩萨洒水这个动作。</li>
</ol>
<p><strong>优点</strong>：</p>
<ol>
<li>观察者和被观察者是抽象耦合的。</li>
<li>建立一套触发机制。</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>如果一个被观察者对象有很多的直接和间接的观察者的话，将所有的观察者都通知到会花费很多时间。</li>
<li>如果在观察者和观察目标之间有循环依赖的话，观察目标会触发它们之间进行循环调用，可能导致系统崩溃。</li>
<li>观察者模式没有相应的机制让观察者知道所观察的目标对象是怎么发生变化的，而仅仅只是知道观察目标发生了变化。</li>
</ol>
<p><strong>使用场景</strong>：</p>
<ol>
<li>一个抽象模型有两个方面，其中一个方面依赖于另一个方面。将这些方面封装在独立的对象中使它们可以各自独立地改变和复用。</li>
<li>一个对象的改变将导致其他一个或多个对象也发生改变，而不知道具体有多少对象将发生改变，可以降低对象之间的耦合度。</li>
<li>一个对象必须通知其他对象，而并不知道这些对象是谁。</li>
<li>需要在系统中创建一个触发链，A对象的行为将影响B对象，B对象的行为将影响C对象……，可以使用观察者模式创建一种链式触发机制。</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>JAVA 中已经有了对观察者模式的支持类。 </li>
<li>避免循环引用。</li>
<li>如果顺序执行，某一观察者错误会导致系统卡壳，一般采用异步方式。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Observer&gt; observers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">        notifyAllObservers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Observer observer)</span> </span>&#123;</span><br><span class="line">        observers.add(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyAllObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Observer observer : observers) &#123;</span><br><span class="line">            observer.update();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Subject subject;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinaryObserver</span> <span class="keyword">extends</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BinaryObserver</span><span class="params">(Subject subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">        <span class="keyword">this</span>.subject.attach(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Binary String: "</span></span><br><span class="line">                + Integer.toBinaryString(subject.getState()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OctalObserver</span> <span class="keyword">extends</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OctalObserver</span><span class="params">(Subject subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">        <span class="keyword">this</span>.subject.attach(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Octal String: "</span></span><br><span class="line">                + Integer.toOctalString(subject.getState()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HexaObserver</span> <span class="keyword">extends</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HexaObserver</span><span class="params">(Subject subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">        <span class="keyword">this</span>.subject.attach(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Hex String: "</span></span><br><span class="line">                + Integer.toHexString(subject.getState()).toUpperCase());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverPatternDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subject subject = <span class="keyword">new</span> Subject();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> HexaObserver(subject);</span><br><span class="line">        <span class="keyword">new</span> OctalObserver(subject);</span><br><span class="line">        <span class="keyword">new</span> BinaryObserver(subject);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"First state change: 15"</span>);</span><br><span class="line">        subject.setState(<span class="number">15</span>);</span><br><span class="line">        System.out.println(<span class="string">"Second state change: 10"</span>);</span><br><span class="line">        subject.setState(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-8-状态模式"><a href="#3-8-状态模式" class="headerlink" title="3.8. 状态模式"></a>3.8. 状态模式</h3><p>在状态模式（State Pattern）中，类的行为是基于它的状态改变的。这种类型的设计模式属于行为型模式。</p>
<p>在状态模式中，我们创建表示各种状态的对象和一个行为随着状态对象改变而改变的 context 对象。</p>
<p><strong>意图</strong>：允许对象在内部状态发生改变时改变它的行为，对象看起来好像修改了它的类。</p>
<p><strong>主要解决</strong>：对象的行为依赖于它的状态（属性），并且可以根据它的状态改变而改变它的相关行为。</p>
<p><strong>何时使用</strong>：代码中包含大量与对象状态有关的条件语句。</p>
<p><strong>如何解决</strong>：将各种具体的状态类抽象出来。</p>
<p><strong>关键代码</strong>：通常命令模式的接口中只有一个方法。而状态模式的接口中有一个或者多个方法。而且，状态模式的实现类的方法，一般返回值，或者是改变实例变量的值。也就是说，状态模式一般和对象的状态有关。实现类的方法有不同的功能，覆盖接口中的方法。状态模式和命令模式一样，也可以用于消除 if…else 等条件选择语句。</p>
<p><strong>应用实例</strong>： </p>
<ol>
<li>打篮球的时候运动员可以有正常状态、不正常状态和超常状态。</li>
<li>曾侯乙编钟中，’钟是抽象接口’,’钟A’等是具体状态，’曾侯乙编钟’是具体环境（Context）。</li>
</ol>
<p><strong>优点</strong>：</p>
<ol>
<li>封装了转换规则。 </li>
<li>枚举可能的状态，在枚举状态之前需要确定状态种类。</li>
<li>将所有与某个状态有关的行为放到一个类中，并且可以方便地增加新的状态，只需要改变对象状态即可改变对象的行为。</li>
<li>允许状态转换逻辑与状态对象合成一体，而不是某一个巨大的条件语句块。</li>
<li>可以让多个环境对象共享一个状态对象，从而减少系统中对象的个数。</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>状态模式的使用必然会增加系统类和对象的个数。</li>
<li>态模式的结构与实现都较为复杂，如果使用不当将导致程序结构和代码的混乱。 </li>
<li>状态模式对”开闭原则”的支持并不太好，对于可以切换状态的状态模式，增加新的状态类需要修改那些负责状态转换的源代码，否则无法切换到新增状态，而且修改某个状态类的行为也需修改对应类的源代码。</li>
</ol>
<p><strong>使用场景</strong>：</p>
<ol>
<li>行为随状态改变而改变的场景。</li>
<li>条件、分支语句的代替者。</li>
</ol>
<p><strong>注意事项</strong>：在行为受状态约束的时候使用状态模式，而且状态不超过 5 个。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction</span><span class="params">(Context context)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> State state;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Context</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        state = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Player is in start state"</span>);</span><br><span class="line">        context.setState(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Start State"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StopState</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAction</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Player is in stop state"</span>);</span><br><span class="line">        context.setState(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Stop State"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-9-空对象模式"><a href="#3-9-空对象模式" class="headerlink" title="3.9. 空对象模式"></a>3.9. 空对象模式</h3><p>在空对象模式（Null Object Pattern）中，一个空对象取代 NULL 对象实例的检查。Null 对象不是检查空值，而是反应一个不做任何动作的关系。这样的 Null 对象也可以在数据不可用的时候提供默认的行为。</p>
<p>在空对象模式中，我们创建一个指定各种要执行的操作的抽象类和扩展该类的实体类，还创建一个未对该类做任何实现的空对象类，该空对象类将无缝地使用在需要检查空值的地方。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractCustomer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isNil</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RealCustomer</span> <span class="keyword">extends</span> <span class="title">AbstractCustomer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RealCustomer</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNil</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NullCustomer</span> <span class="keyword">extends</span> <span class="title">AbstractCustomer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Not Available in Customer Database"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNil</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NullPatternDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        AbstractCustomer customer1 = CustomerFactory.getCustomer(<span class="string">"Rob"</span>);</span><br><span class="line">        AbstractCustomer customer2 = CustomerFactory.getCustomer(<span class="string">"Bob"</span>);</span><br><span class="line">        AbstractCustomer customer3 = CustomerFactory.getCustomer(<span class="string">"Julie"</span>);</span><br><span class="line">        AbstractCustomer customer4 = CustomerFactory.getCustomer(<span class="string">"Laura"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Customers"</span>);</span><br><span class="line">        System.out.println(customer1.getName());</span><br><span class="line">        System.out.println(customer2.getName());</span><br><span class="line">        System.out.println(customer3.getName());</span><br><span class="line">        System.out.println(customer4.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] names = &#123;<span class="string">"Rob"</span>, <span class="string">"Joe"</span>, <span class="string">"Julie"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AbstractCustomer <span class="title">getCustomer</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; names.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (names[i].equalsIgnoreCase(name)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> RealCustomer(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NullCustomer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-10-策略模式"><a href="#3-10-策略模式" class="headerlink" title="3.10. 策略模式"></a>3.10. 策略模式</h3><p>在策略模式（Strategy Pattern）中，一个类的行为或其算法可以在运行时更改。这种类型的设计模式属于行为型模式。</p>
<p>在策略模式中，我们创建表示各种策略的对象和一个行为随着策略对象改变而改变的 context 对象。策略对象改变 context 对象的执行算法。</p>
<p><strong>意图</strong>：定义一系列的算法,把它们一个个封装起来, 并且使它们可相互替换。</p>
<p><strong>主要解决</strong>：在有多种算法相似的情况下，使用 if…else 所带来的复杂和难以维护。</p>
<p><strong>何时使用</strong>：一个系统有许多许多类，而区分它们的只是他们直接的行为。</p>
<p><strong>如何解决</strong>：将这些算法封装成一个一个的类，任意地替换。</p>
<p><strong>关键代码</strong>：实现同一个接口。</p>
<p><strong>应用实例</strong>： </p>
<ol>
<li>诸葛亮的锦囊妙计，每一个锦囊就是一个策略。</li>
<li>旅行的出游方式，选择骑自行车、坐汽车，每一种旅行方式都是一个策略。</li>
<li>JAVA AWT 中的 LayoutManager。</li>
</ol>
<p><strong>优点</strong>：</p>
<ol>
<li>算法可以自由切换。</li>
<li>避免使用多重条件判断。</li>
<li>扩展性良好。</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>策略类会增多。</li>
<li>所有策略类都需要对外暴露。</li>
</ol>
<p><strong>使用场景</strong>：</p>
<ol>
<li>如果在一个系统里面有许多类，它们之间的区别仅在于它们的行为，那么使用策略模式可以动态地让一个对象在许多行为中选择一种行为。</li>
<li>一个系统需要动态地在几种算法中选择一种。 3、如果一个对象有很多的行为，如果不用恰当的模式，这些行为就只好使用多重的条件选择语句来实现。</li>
</ol>
<p><strong>注意事项</strong>：如果一个系统的策略多于四个，就需要考虑使用混合模式，解决策略类膨胀的问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doOperation</span><span class="params">(<span class="keyword">int</span> num1, <span class="keyword">int</span> num2)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperationAdd</span> <span class="keyword">implements</span> <span class="title">Strategy</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doOperation</span><span class="params">(<span class="keyword">int</span> num1, <span class="keyword">int</span> num2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> num1 + num2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperationSubstract</span> <span class="keyword">implements</span> <span class="title">Strategy</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doOperation</span><span class="params">(<span class="keyword">int</span> num1, <span class="keyword">int</span> num2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> num1 - num2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperationMultiply</span> <span class="keyword">implements</span> <span class="title">Strategy</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doOperation</span><span class="params">(<span class="keyword">int</span> num1, <span class="keyword">int</span> num2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> num1 * num2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> State state;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Context</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        state = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Strategy strategy;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Context</span><span class="params">(Strategy strategy)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.strategy = strategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeStrategy</span><span class="params">(<span class="keyword">int</span> num1, <span class="keyword">int</span> num2)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> strategy.doOperation(num1, num2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StrategyPatternDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Context context = <span class="keyword">new</span> Context(<span class="keyword">new</span> OperationAdd());</span><br><span class="line">        System.out.println(<span class="string">"10 + 5 = "</span> + context.executeStrategy(<span class="number">10</span>, <span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">        context = <span class="keyword">new</span> Context(<span class="keyword">new</span> OperationSubstract());</span><br><span class="line">        System.out.println(<span class="string">"10 - 5 = "</span> + context.executeStrategy(<span class="number">10</span>, <span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">        context = <span class="keyword">new</span> Context(<span class="keyword">new</span> OperationMultiply());</span><br><span class="line">        System.out.println(<span class="string">"10 * 5 = "</span> + context.executeStrategy(<span class="number">10</span>, <span class="number">5</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-11-模板模式"><a href="#3-11-模板模式" class="headerlink" title="3.11. 模板模式"></a>3.11. 模板模式</h3><p>在模板模式（Template Pattern）中，一个抽象类公开定义了执行它的方法的方式/模板。它的子类可以按需要重写方法实现，但调用将以抽象类中定义的方式进行。这种类型的设计模式属于行为型模式。</p>
<p><strong>意图</strong>：定义一个操作中的算法的骨架，而将一些步骤延迟到子类中。模板方法使得子类可以不改变一个算法的结构即可重定义该算法的某些特定步骤。</p>
<p><strong>主要解决</strong>：一些方法通用，却在每一个子类都重新写了这一方法。</p>
<p><strong>何时使用</strong>：有一些通用的方法。</p>
<p><strong>如何解决</strong>：将这些通用算法抽象出来。</p>
<p><strong>关键代码</strong>：在抽象类实现，其他步骤在子类实现。</p>
<p><strong>应用实例</strong>： </p>
<ol>
<li>在造房子的时候，地基、走线、水管都一样，只有在建筑的后期才有加壁橱加栅栏等差异。</li>
<li>西游记里面菩萨定好的 81 难，这就是一个顶层的逻辑骨架。</li>
<li>spring 中对 Hibernate 的支持，将一些已经定好的方法封装起来，比如开启事务、获取 Session、关闭 Session 等，程序员不重复写那些已经规范好的代码，直接丢一个实体就可以保存。</li>
</ol>
<p><strong>优点</strong>：</p>
<ol>
<li>封装不变部分，扩展可变部分。</li>
<li>提取公共代码，便于维护。</li>
<li>行为由父类控制，子类实现。</li>
</ol>
<p><strong>缺点</strong>：每一个不同的实现都需要一个子类来实现，导致类的个数增加，使得系统更加庞大。</p>
<p><strong>使用场景</strong>：</p>
<ol>
<li>有多个子类共有的方法，且逻辑相同。</li>
<li>重要的、复杂的方法，可以考虑作为模板方法。</li>
</ol>
<p><strong>注意事项</strong>：为防止恶意操作，一般模板方法都加上 final 关键词。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Game</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">startPlay</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">endPlay</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模板</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化游戏</span></span><br><span class="line">        initialize();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始游戏</span></span><br><span class="line">        startPlay();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//结束游戏</span></span><br><span class="line">        endPlay();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cricket</span> <span class="keyword">extends</span> <span class="title">Game</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">endPlay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Cricket Game Finished!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Cricket Game Initialized! Start playing."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startPlay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Cricket Game Started. Enjoy the game!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Football</span> <span class="keyword">extends</span> <span class="title">Game</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">endPlay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Football Game Finished!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Football Game Initialized! Start playing."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startPlay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Football Game Started. Enjoy the game!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemplatePatternDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Game game = <span class="keyword">new</span> Cricket();</span><br><span class="line">        game.play();</span><br><span class="line">        System.out.println();</span><br><span class="line">        game = <span class="keyword">new</span> Football();</span><br><span class="line">        game.play();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-12-访问者模式"><a href="#3-12-访问者模式" class="headerlink" title="3.12. 访问者模式"></a>3.12. 访问者模式</h3><p>在访问者模式（Visitor Pattern）中，我们使用了一个访问者类，它改变了元素类的执行算法。通过这种方式，元素的执行算法可以随着访问者改变而改变。这种类型的设计模式属于行为型模式。根据模式，元素对象已接受访问者对象，这样访问者对象就可以处理元素对象上的操作。</p>
<p><strong>意图</strong>：主要将数据结构与数据操作分离。</p>
<p><strong>主要解决</strong>：稳定的数据结构和易变的操作耦合问题。</p>
<p><strong>何时使用</strong>：需要对一个对象结构中的对象进行很多不同的并且不相关的操作，而需要避免让这些操作”污染”这些对象的类，使用访问者模式将这些封装到类中。</p>
<p><strong>如何解决</strong>：在被访问的类里面加一个对外提供接待访问者的接口。</p>
<p><strong>关键代码</strong>：在数据基础类里面有一个方法接受访问者，将自身引用传入访问者。</p>
<p><strong>应用实例</strong>：您在朋友家做客，您是访问者，朋友接受您的访问，您通过朋友的描述，然后对朋友的描述做出一个判断，这就是访问者模式。</p>
<p><strong>优点</strong>：</p>
<ol>
<li>符合单一职责原则。</li>
<li>优秀的扩展性。</li>
<li>灵活性。</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>具体元素对访问者公布细节，违反了迪米特原则。</li>
<li>具体元素变更比较困难。</li>
<li>违反了依赖倒置原则，依赖了具体类，没有依赖抽象。</li>
</ol>
<p><strong>使用场景</strong>：</p>
<ol>
<li>对象结构中对象对应的类很少改变，但经常需要在此对象结构上定义新的操作。</li>
<li>需要对一个对象结构中的对象进行很多不同的并且不相关的操作，而需要避免让这些操作”污染”这些对象的类，也不希望在增加新操作时修改这些类。</li>
</ol>
<p><strong>注意事项</strong>：访问者可以对功能进行统一，可以做报表、UI、拦截器与过滤器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ComputerPart</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(ComputerPartVisitor computerPartVisitor)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ComputerPartVisitor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Computer computer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Mouse mouse)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Keyboard keyboard)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Monitor monitor)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Keyboard</span> <span class="keyword">implements</span> <span class="title">ComputerPart</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(ComputerPartVisitor computerPartVisitor)</span> </span>&#123;</span><br><span class="line">        computerPartVisitor.visit(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Monitor</span> <span class="keyword">implements</span> <span class="title">ComputerPart</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(ComputerPartVisitor computerPartVisitor)</span> </span>&#123;</span><br><span class="line">        computerPartVisitor.visit(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mouse</span> <span class="keyword">implements</span> <span class="title">ComputerPart</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(ComputerPartVisitor computerPartVisitor)</span> </span>&#123;</span><br><span class="line">        computerPartVisitor.visit(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Computer</span> <span class="keyword">implements</span> <span class="title">ComputerPart</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ComputerPart[] parts;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Computer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        parts = <span class="keyword">new</span> ComputerPart[]&#123;<span class="keyword">new</span> Mouse(), <span class="keyword">new</span> Keyboard(), <span class="keyword">new</span> Monitor()&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(ComputerPartVisitor computerPartVisitor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parts.length; i++) &#123;</span><br><span class="line">            parts[i].accept(computerPartVisitor);</span><br><span class="line">        &#125;</span><br><span class="line">        computerPartVisitor.visit(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComputerPartDisplayVisitor</span> <span class="keyword">implements</span> <span class="title">ComputerPartVisitor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Computer computer)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Displaying Computer."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Mouse mouse)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Displaying Mouse."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Keyboard keyboard)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Displaying Keyboard."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Monitor monitor)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Displaying Monitor."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VisitorPatternDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ComputerPart computer = <span class="keyword">new</span> Computer();</span><br><span class="line">        computer.accept(<span class="keyword">new</span> ComputerPartDisplayVisitor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2017/10/09/Git学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/09/Git学习/" itemprop="url">Git学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-09T17:50:00+08:00">
                2017-10-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/09/Git学习/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/10/09/Git学习/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://git-scm.com/book/zh/v2" target="_blank" rel="noopener">Git中文文档</a></p>
<h1 id="Git-起步"><a href="#Git-起步" class="headerlink" title="Git 起步"></a>Git 起步</h1><h2 id="1-Git历史"><a href="#1-Git历史" class="headerlink" title="1.Git历史"></a>1.Git历史</h2><p>同生活中的许多伟大事物一样，Git 诞生于一个极富纷争大举创新的年代。<br>Linux 内核开源项目有着为数众广的参与者。 绝大多数的 Linux</p>
<p>内核维护工作都花在了提交补丁和保存归档的繁琐事务上（1991－2002年间）。 到 2002 年，整个项目组开始启用一个专有的分布式版本控制系统 BitKeeper 来管理和维护代码。</p>
<p>到了 2005 年，开发 BitKeeper 的商业公司同 Linux 内核开源社区的合作关系结束，他们收回了 Linux 内核社区免费使用 BitKeeper 的权力。 这就迫使 Linux 开源社区（特别是 Linux 的缔造者 Linus Torvalds）基于使用 BitKeeper 时的经验教训，开发出自己的版本系统。 他们对新的系统制订了若干目标：</p>
<ul>
<li><p>速度</p>
</li>
<li><p>简单的设计</p>
</li>
<li><p>对非线性开发模式的强力支持（允许成千上万个并行开发的分支）</p>
</li>
<li><p>完全分布式</p>
</li>
</ul>
<p>有能力高效管理类似 Linux 内核一样的超大规模项目（速度和数据量）</p>
<p>自诞生于 2005 年以来，Git 日臻成熟完善，在高度易用的同时，仍然保留着初期设定的目标。 它的速度飞快，极其适合管理大项目，有着令人难以置信的非线性分支管理系统。</p>
<h2 id="2-Git机制"><a href="#2-Git机制" class="headerlink" title="2.Git机制"></a>2.Git机制</h2><h3 id="2-1-Git-保证完整性"><a href="#2-1-Git-保证完整性" class="headerlink" title="2.1. Git 保证完整性"></a>2.1. Git 保证完整性</h3><p>Git 中所有数据在存储前都计算校验和，然后以校验和来引用。 这意味着不可能在 Git 不知情时更改任何文件内容或目录内容。 这个功能建构在 Git 底层，是构成 Git 哲学不可或缺的部分。 若你在传送过程中丢失信息或损坏文件，Git 就能发现。</p>
<p>Git 用以计算校验和的机制叫做 SHA-1 散列（hash，哈希）。 这是一个由 40 个十六进制字符（0-9 和 a-f）组成字符串，基于 Git 中文件的内容或目录结构计算出来。 SHA-1 哈希看起来是这样：</p>
<pre><code>24b9da6552252987aa493b52f8696cd6d3b00373
</code></pre><p>Git 中使用这种哈希值的情况很多，你将经常看到这种哈希值。 实际上，Git 数据库中保存的信息都是以文件内容的哈希值来索引，而不是文件名。</p>
<h3 id="2-2-三种状态"><a href="#2-2-三种状态" class="headerlink" title="2.2. 三种状态"></a>2.2. 三种状态</h3><p> Git 有三种状态，你的文件可能处于其中之一：已提交（committed）、已修改（modified）和已暂存（staged）。 已提交表示数据已经安全的保存在本地数据库中。 已修改表示修改了文件，但还没保存到数据库中。 已暂存表示对一个已修改文件的当前版本做了标记，使之包含在下次提交的快照中。</p>
<p>由此引入 Git 项目的三个工作区域的概念：<strong>Git 仓库</strong>、<strong>工作目录</strong> 以及<strong>暂存区域</strong>。<br><img src="https://git-scm.com/book/en/v2/images/areas.png" alt="此处输入图片的描述"></p>
<h3 id="2-3-Git-仓库、工作目录-、暂存区域"><a href="#2-3-Git-仓库、工作目录-、暂存区域" class="headerlink" title="2.3. Git 仓库、工作目录 、暂存区域"></a>2.3. Git 仓库、工作目录 、暂存区域</h3><p>  <strong>Git 仓库目录</strong> 是 Git 用来保存项目的元数据和对象数据库的地方。 这是 Git 中最重要的部分，从其它计算机克隆仓库时，拷贝的就是这里的数据。</p>
<p><strong>工作目录</strong> 是对项目的某个版本独立提取出来的内容。 这些从 Git 仓库的压缩数据库中提取出来的文件，放在磁盘上供你使用或修改。</p>
<p><strong>暂存区域</strong> 是一个文件，保存了下次将提交的文件列表信息，一般在 Git 仓库目录中。 有时候也被称作`‘索引’’，不过一般说法还是叫暂存区域。</p>
<p>基本的 Git 工作流程如下：</p>
<p>在工作目录中修改文件。</p>
<p>暂存文件，将文件的快照放入暂存区域。</p>
<p>提交更新，找到暂存区域的文件，将快照永久性存储到 Git 仓库目录。</p>
<p>如果 Git 目录中保存着的特定版本文件，就属于已提交状态。 如果作了修改并已放入暂存区域，就属于已暂存状态。 如果自上次取出后，作了修改但还没有放到暂存区域，就是已修改状态。</p>
<h2 id="3-初次运行-Git-前的配置"><a href="#3-初次运行-Git-前的配置" class="headerlink" title="3.初次运行 Git 前的配置"></a>3.初次运行 Git 前的配置</h2><p>Git 自带一个 <code>git config</code> 的工具来帮助设置控制 Git 外观和行为的配置变量。 这些变量存储在三个不同的位置：</p>
<p><code>/etc/gitconfig</code> 文件: 包含系统上每一个用户及他们仓库的通用配置。 如果使用带有 <code>--system</code> 选项的 <code>git config</code> 时，它会从此文件读写配置变量。</p>
<p><code>~/.gitconfig</code> 或 <code>~/.config/git/config</code> 文件：只针对当前用户。 可以传递 <code>--global</code> 选项让 Git 读写此文件。</p>
<p>当前使用仓库的 Git 目录中的 config 文件（就是 <code>.git/config</code>）：针对该仓库。</p>
<p>每一个级别覆盖上一级别的配置，所以 <code>.git/config</code> 的配置变量会覆盖 <code>/etc/gitconfig</code> 中的配置变量。</p>
<p>在 Windows 系统中，Git 会查找 <code>$HOME</code> 目录下（一般情况下是 <code>C:\Users\$USER</code>）的 .gitconfig 文件。 Git 同样也会寻找 <code>/etc/gitconfig</code> 文件，但只限于 MSys 的根目录下，即安装 Git 时所选的目标位置。</p>
<h3 id="3-1-用户配置"><a href="#3-1-用户配置" class="headerlink" title="3.1. 用户配置"></a>3.1. 用户配置</h3><p>当安装完 Git 应该做的第一件事就是设置你的用户名称与邮件地址。 这样做很重要，因为每一个 Git 的提交都会使用这些信息，并且它会写入到你的每一次提交中，不可更改：</p>
<pre><code>$ git config --global user.name &quot;John Doe&quot;
</code></pre><p>$ git config –global user.email <a href="mailto:johndoe@example.com" target="_blank" rel="noopener">johndoe@example.com</a></p>
<p>再次强调，如果使用了 <code>--global</code> 选项，那么该命令只需要运行一次，因为之后无论你在该系统上做任何事情， Git 都会使用那些信息。 当你想针对特定项目使用不同的用户名称与邮件地址时，可以在那个项目目录下运行没有 <code>--global</code> 选项的命令来配置。</p>
<p>很多 GUI 工具都会在第一次运行时帮助你配置这些信息。</p>
<h3 id="3-2-文本编辑器"><a href="#3-2-文本编辑器" class="headerlink" title="3.2. 文本编辑器"></a>3.2. 文本编辑器</h3><p>既然用户信息已经设置完毕，你可以配置默认文本编辑器了，当 Git 需要你输入信息时会调用它。 如果未配置，Git 会使用操作系统默认的文本编辑器，通常是 <code>Vim</code>。 如果你想使用不同的文本编辑器，例如 <code>Emacs</code>，可以这样做：</p>
<pre><code>$ git config --global core.editor emacs
Warning
</code></pre><p><code>Vim</code> 和 <code>Emacs</code> 是像 Linux 与 Mac 等基于 Unix 的系统上开发者经常使用的流行的文本编辑器。 如果你对这些编辑器都不是很了解或者你使用的是 Windows 系统，那么可能需要搜索如何在 Git 中配置你最常用的编辑器。 如果你不设置编辑器并且不知道 <code>Vim</code> 或 <code>Emacs</code> 是什么，当它们运行起来后你可能会被弄糊涂、不知所措。</p>
<h3 id="3-3-检查配置信息"><a href="#3-3-检查配置信息" class="headerlink" title="3.3. 检查配置信息"></a>3.3. 检查配置信息</h3><p>如果想要检查你的配置，可以使用 <code>git config --list</code> 命令来列出所有 Git 当时能找到的配置。</p>
<pre><code>$ git config --list
user.name=John Doe
user.email=johndoe@example.com
color.status=auto
color.branch=auto
color.interactive=auto
color.diff=auto
...
</code></pre><p>你可能会看到重复的变量名，因为 Git 会从不同的文件中读取同一个配置（例如：<code>/etc/gitconfig</code> 与 <code>~/.gitconfig</code>）。 这种情况下，Git 会使用它找到的每一个变量的最后一个配置。</p>
<p>你可以通过输入 <code>git config &lt;key&gt;：</code> 来检查 Git 的某一项配置</p>
<pre><code>$ git config user.name
John Doe
</code></pre><h1 id="Git-基础"><a href="#Git-基础" class="headerlink" title="Git 基础"></a>Git 基础</h1><h2 id="1-获取-Git-仓库"><a href="#1-获取-Git-仓库" class="headerlink" title="1.获取 Git 仓库"></a>1.获取 Git 仓库</h2><p>在现有目录中初始化仓库<br>如果你打算使用 Git 来对现有的项目进行管理，你只需要进入该项目目录并输入：</p>
<pre><code>$ git init
</code></pre><p>$ git add *.c<br>    $ git add LICENSE<br>$ git commit -m ‘initial project version’</p>
<h2 id="2-克隆现有的仓库"><a href="#2-克隆现有的仓库" class="headerlink" title="2.克隆现有的仓库"></a>2.克隆现有的仓库</h2><pre><code>$ git clone https://github.com/libgit2/libgit2
$ git clone https://github.com/libgit2/libgit2 mylibgit
</code></pre><p>这将执行与上一个命令相同的操作，不过在本地创建的仓库名字变为 mylibgit。</p>
<h2 id="3-记录每次更新到仓库"><a href="#3-记录每次更新到仓库" class="headerlink" title="3.记录每次更新到仓库"></a>3.记录每次更新到仓库</h2><p><img src="https://git-scm.com/book/en/v2/images/lifecycle.png" alt="文件的状态变化周期"></p>
<h3 id="2-1-检查当前文件状态"><a href="#2-1-检查当前文件状态" class="headerlink" title="2.1. 检查当前文件状态"></a>2.1. 检查当前文件状态</h3><pre><code>$ git status
On branch master
nothing to commit, working directory clean
</code></pre><p>现在，让我们在项目下创建一个新的 README 文件。 如果之前并不存在这个文件，使用 git status 命令，你将看到一个新的未跟踪文件：</p>
<pre><code>$ echo &apos;My Project&apos; &gt; README
</code></pre><p>$ git status<br>    On branch master<br>    Untracked files:<br>      (use “git add <file>…” to include in what will be committed)</file></p>
<pre><code>    README

nothing added to commit but untracked files present (use &quot;git add&quot; to track)
</code></pre><p>在状态报告中可以看到新建的 README 文件出现在 <code>Untracked files</code> 下面。 未跟踪的文件意味着 Git 在之前的快照（提交）中没有这些文件；Git 不会自动将之纳入跟踪范围，除非你明明白白地告诉它“我需要跟踪该文件”， 这样的处理让你不必担心将生成的二进制文件或其它不想被跟踪的文件包含进来。 不过现在的例子中，我们确实想要跟踪管理 README 这个文件。</p>
<h3 id="2-2-跟踪新文件"><a href="#2-2-跟踪新文件" class="headerlink" title="2.2. 跟踪新文件"></a>2.2. 跟踪新文件</h3><p>使用命令 <code>git add</code> 开始跟踪一个文件。 所以，要跟踪 README 文件，运行：</p>
<pre><code>$ git add README
</code></pre><p>此时再运行 git status 命令，会看到 README 文件已被跟踪，并处于暂存状态：</p>
<pre><code>$ git status
On branch master
Changes to be committed:
  (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)

    new file:   README
</code></pre><p>只要在 <code>Changes to be committed</code> 这行下面的，就说明是已暂存状态。 如果此时提交，那么该文件此时此刻的版本将被留存在历史记录中。 你可能会想起之前我们使用 <code>git init</code> 后就运行了 <code>git add (files)</code> 命令，开始跟踪当前目录下的文件。 <code>git add</code> 命令使用文件或目录的路径作为参数；如果参数是目录的路径，该命令将递归地跟踪该目录下的所有文件。</p>
<h3 id="2-3-暂存已修改文件"><a href="#2-3-暂存已修改文件" class="headerlink" title="2.3. 暂存已修改文件"></a>2.3. 暂存已修改文件</h3><p>现在我们来修改一个已被跟踪的文件。 如果你修改了一个名为 <code>CONTRIBUTING.md</code> 的已被跟踪的文件，然后运行 <code>git status</code> 命令，会看到下面内容：</p>
<pre><code>$ git status
On branch master
Changes to be committed:
  (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)

    new file:   README

Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

    modified:   CONTRIBUTING.md
</code></pre><p>文件 <code>CONTRIBUTING.md</code> 出现在 <code>Changes not staged for commit</code> 这行下面，说明已跟踪文件的内容发生了变化，但还没有放到暂存区。 要暂存这次更新，需要运行 <code>git add</code> 命令。 这是个多功能命令：可以用它开始跟踪新文件，或者把已跟踪的文件放到暂存区，还能用于合并时把有冲突的文件标记为已解决状态等。 将这个命令理解为“添加内容到下一次提交中”而不是“将一个文件添加到项目中”要更加合适。 现在让我们运行 <code>git add</code> 将”<code>CONTRIBUTING.md</code>“放到暂存区，然后再看看 <code>git status</code> 的输出：</p>
<pre><code>$ git add CONTRIBUTING.md
</code></pre><p>$ git status<br>    On branch master<br>    Changes to be committed:<br>      (use “git reset HEAD <file>…” to unstage)</file></p>
<pre><code>new file:   README
modified:   CONTRIBUTING.md
</code></pre><p>现在两个文件都已暂存，下次提交时就会一并记录到仓库。 假设此时，你想要在 <code>CONTRIBUTING.md</code> 里再加条注释， 重新编辑存盘后，准备好提交。 不过且慢，再运行 <code>git status</code> 看看：</p>
<pre><code>$ vim CONTRIBUTING.md
</code></pre><p>$ git status<br>    On branch master<br>    Changes to be committed:<br>      (use “git reset HEAD <file>…” to unstage)</file></p>
<pre><code>    new file:   README
    modified:   CONTRIBUTING.md

Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

    modified:   CONTRIBUTING.md
</code></pre><p>怎么回事？ 现在 <code>CONTRIBUTING.md</code> 文件同时出现在暂存区和非暂存区。 这怎么可能呢？ 好吧，实际上 Git 只不过暂存了你运行 <code>git add</code> 命令时的版本， 如果你现在提交<code>，CONTRIBUTING.md</code> 的版本是你最后一次运行 <code>git add</code> 命令时的那个版本，而不是你运行 <code>git commit</code> 时，在工作目录中的当前版本。 所以，运行了 <code>git add</code> 之后又作了修订的文件，需要重新运行 <code>git add</code> 把最新版本重新暂存起来：</p>
<pre><code>$ git add CONTRIBUTING.md
</code></pre><p>$ git status<br>    On branch master<br>    Changes to be committed:<br>      (use “git reset HEAD <file>…” to unstage)</file></p>
<pre><code>new file:   README
modified:   CONTRIBUTING.md
</code></pre><h3 id="2-4-状态简览"><a href="#2-4-状态简览" class="headerlink" title="2.4. 状态简览"></a>2.4. 状态简览</h3><p><code>git status</code> 命令的输出十分详细，但其用语有些繁琐。 如果你使用 <code>git status -s</code> 命令或 <code>git status --short</code> 命令，你将得到一种更为紧凑的格式输出。 运行 <code>git status -s</code> ，状态报告输出如下：</p>
<pre><code>$ git status -s
M README
MM Rakefile
A  lib/git.rb
M  lib/simplegit.rb
?? LICENSE.txt
</code></pre><p>新添加的未跟踪文件前面有 <code>??</code> 标记，新添加到暂存区中的文件前面有 <code>A</code> 标记，修改过的文件前面有 <code>M</code> 标记。 你可能注意到了 <code>M</code> 有两个可以出现的位置，出现在右边的 <code>M</code> 表示该文件被修改了但是还没放入暂存区，出现在靠左边的 <code>M</code> 表示该文件被修改了并放入了暂存区。 例如，上面的状态报告显示： README 文件在工作区被修改了但是还没有将修改后的文件放入暂存区,<code>lib/simplegit.rb</code> 文件被修改了并将修改后的文件放入了暂存区。 而 Rakefile 在工作区被修改并提交到暂存区后又在工作区中被修改了，所以在暂存区和工作区都有该文件被修改了的记录。</p>
<h3 id="2-5-忽略文件"><a href="#2-5-忽略文件" class="headerlink" title="2.5. 忽略文件"></a>2.5. 忽略文件</h3><p>一般我们总会有些文件无需纳入 Git 的管理，也不希望它们总出现在未跟踪文件列表。 通常都是些自动生成的文件，比如日志文件，或者编译过程中创建的临时文件等。 在这种情况下，我们可以创建一个名为 <code>.gitignore</code> 的文件，列出要忽略的文件模式。 来看一个实际的例子：</p>
<pre><code>$ cat .gitignore
*.[oa]
*~
</code></pre><p>第一行告诉 Git 忽略所有以 <code>.o</code> 或 <code>.a</code> 结尾的文件。一般这类对象文件和存档文件都是编译过程中出现的。 第二行告诉 Git 忽略所有以波浪符（~）结尾的文件，许多文本编辑软件（比如 <code>Emacs</code>）都用这样的文件名保存副本。 此外，你可能还需要忽略 <code>log</code>，<code>tmp</code> 或者 <code>pid</code> 目录，以及自动生成的文档等等。 要养成一开始就设置好 <code>.gitignore</code> 文件的习惯，以免将来误提交这类无用的文件。</p>
<p>文件 <code>.gitignore</code> 的格式规范如下：</p>
<ul>
<li>列表项</li>
<li>所有空行或者以 ＃ 开头的行都会被 Git 忽略。</li>
<li>可以使用标准的 glob 模式匹配。</li>
<li>匹配模式可以以（/）开头防止递归。</li>
<li>匹配模式可以以（/）结尾指定目录。</li>
<li>要忽略指定模式以外的文件或目录，可以在模式前加上惊叹号（!）取反。</li>
</ul>
<p>所谓的 <code>glob</code> 模式是指 <code>shell</code> 所使用的简化了的正则表达式。 星号<code>（*）</code>匹配零个或多个任意字符；<code>[abc]</code> 匹配任何一个列在方括号中的字符（这个例子要么匹配一个 a，要么匹配一个 b，要么匹配一个 c）；问号<code>（?）</code>只匹配一个任意字符；如果在方括号中使用短划线分隔两个字符，表示所有在这两个字符范围内的都可以匹配（比如 <code>[0-9]</code> 表示匹配所有 0 到 9 的数字）。 使用两个星号<code>（*)</code> 表示匹配任意中间目录，比如<code>a/**/z</code> 可以匹配 <code>a/z</code>, <code>a/b/z</code> 或 <code>a/b/c/z</code>等。</p>
<h3 id="2-6-查看已暂存和未暂存的修改"><a href="#2-6-查看已暂存和未暂存的修改" class="headerlink" title="2.6. 查看已暂存和未暂存的修改"></a>2.6. 查看已暂存和未暂存的修改</h3><p>如果 <code>git status</code> 命令的输出对于你来说过于模糊，你想知道具体修改了什么地方，可以用 <code>git diff</code> 命令。<code>git diff</code> 将通过文件补丁的格式显示具体哪些行发生了改变。</p>
<p>假如再次修改 <code>README</code> 文件后暂存，然后编辑 <code>CONTRIBUTING.md</code> 文件后先不暂存， 运行 <code>status</code> 命令将会看到：</p>
<pre><code>$ git status
On branch master
Changes to be committed:
  (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)

    modified:   README

Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

    modified:   CONTRIBUTING.md
</code></pre><p>要查看尚未暂存的文件更新了哪些部分，不加参数直接输入 <code>git diff</code>：</p>
<pre><code>$ git diff
diff --git a/CONTRIBUTING.md b/CONTRIBUTING.md
index 8ebb991..643e24f 100644
--- a/CONTRIBUTING.md
+++ b/CONTRIBUTING.md
@@ -65,7 +65,8 @@ branch directly, things can get messy.
 Please include a nice description of your changes when you submit your PR;
 if we have to read the whole diff to figure out why you&apos;re contributing
 in the first place, you&apos;re less likely to get feedback and have your change
-merged in.
+merged in. Also, split your changes into comprehensive chunks if your patch is
+longer than a dozen lines.

 If you are starting to work on a particular area, feel free to submit a PR
 that highlights your work in progress (and note in the PR title that it&apos;s
</code></pre><p>此命令比较的是工作目录中当前文件和暂存区域快照之间的差异， 也就是修改之后还没有暂存起来的变化内容。</p>
<p>若要查看已暂存的将要添加到下次提交里的内容，可以用 <code>git diff --cached</code> 命令。（<code>Git 1.6.1</code> 及更高版本还允许使用 <code>git diff --staged</code>，效果是相同的，但更好记些。）</p>
<pre><code>$ git diff --staged
diff --git a/README b/README
new file mode 100644
index 0000000..03902a1
--- /dev/null
+++ b/README
@@ -0,0 +1 @@
+My Project
</code></pre><p>请注意，<code>git diff</code> 本身只显示尚未暂存的改动，而不是自上次提交以来所做的所有改动。 所以有时候你一下子暂存了所有更新过的文件后，运行 <code>git diff</code> 后却什么也没有，就是这个原因。</p>
<p>像之前说的，暂存 <code>CONTRIBUTING.md</code> 后再编辑，运行 <code>git status</code> 会看到暂存前后的两个版本。 如果我们的环境（终端输出）看起来如下：</p>
<pre><code>$ git add CONTRIBUTING.md
</code></pre><p>$ echo ‘# test line’ &gt;&gt; CONTRIBUTING.md<br>    $ git status<br>    On branch master<br>    Changes to be committed:<br>      (use “git reset HEAD <file>…” to unstage)</file></p>
<pre><code>    modified:   CONTRIBUTING.md

Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

    modified:   CONTRIBUTING.md
</code></pre><p>现在运行 <code>git diff</code> 看暂存前后的变化：</p>
<pre><code>$ git diff
diff --git a/CONTRIBUTING.md b/CONTRIBUTING.md
index 643e24f..87f08c8 100644
--- a/CONTRIBUTING.md
+++ b/CONTRIBUTING.md
@@ -119,3 +119,4 @@ at the
 ## Starter Projects

 See our [projects list](https://github.com/libgit2/libgit2/blob/development/PROJECTS.md).
+# test line
</code></pre><p>然后用 <code>git diff --cached</code> 查看已经暂存起来的变化：（<code>--staged</code> 和 <code>--cached</code> 是同义词）</p>
<pre><code>$ git diff --cached
diff --git a/CONTRIBUTING.md b/CONTRIBUTING.md
index 8ebb991..643e24f 100644
--- a/CONTRIBUTING.md
+++ b/CONTRIBUTING.md
@@ -65,7 +65,8 @@ branch directly, things can get messy.
 Please include a nice description of your changes when you submit your PR;
 if we have to read the whole diff to figure out why you&apos;re contributing
 in the first place, you&apos;re less likely to get feedback and have your change
-merged in.
+merged in. Also, split your changes into comprehensive chunks if your patch is
+longer than a dozen lines.

 If you are starting to work on a particular area, feel free to submit a PR
 that highlights your work in progress (and note in the PR title that it&apos;s
Note
</code></pre><p><code>Git Diff</code> 的插件版本<br>在本书中，我们使用 <code>git diff</code> 来分析文件差异。 但是，如果你喜欢通过图形化的方式或其它格式输出方式的话，可以使用 <code>git difftool</code> 命令来用 <code>Araxis</code> ，<code>emerge</code> 或 <code>vimdiff</code> 等软件输出 <code>diff</code> 分析结果。 使用 <code>git difftool --tool-help</code> 命令来看你的系统支持哪些 <code>Git Diff</code> 插件。</p>
<h3 id="2-7-提交更新"><a href="#2-7-提交更新" class="headerlink" title="2.7. 提交更新"></a>2.7. 提交更新</h3><p>现在的暂存区域已经准备妥当可以提交了。 在此之前，请一定要确认还有什么修改过的或新建的文件还没有 <code>git add</code> 过，否则提交的时候不会记录这些还没暂存起来的变化。 这些修改过的文件只保留在本地磁盘。 所以，每次准备提交前，先用 <code>git status</code> 看下，是不是都已暂存起来了， 然后再运行提交命令 <code>git commit</code>：</p>
<pre><code>$ git commit
</code></pre><p>这种方式会启动文本编辑器以便输入本次提交的说明。 (默认会启用 <code>shell</code> 的环境变量 <code>$EDITOR</code> 所指定的软件，一般都是 <code>vim</code> 或 <code>emacs</code>。当然也可以按照 起步 介绍的方式，使用 <code>git config --global core.editor</code> 命令设定你喜欢的编辑软件。）</p>
<p>编辑器会显示类似下面的文本信息（本例选用 Vim 的屏显方式展示）：</p>
<pre><code># Please enter the commit message for your changes. Lines starting
# with &apos;#&apos; will be ignored, and an empty message aborts the commit.
# On branch master
# Changes to be committed:
#    new file:   README
#    modified:   CONTRIBUTING.md
#
~
~
~
&quot;.git/COMMIT_EDITMSG&quot; 9L, 283C
</code></pre><p>可以看到，默认的提交消息包含最后一次运行 <code>git status</code> 的输出，放在注释行里，另外开头还有一空行，供你输入提交说明。 你完全可以去掉这些注释行，不过留着也没关系，多少能帮你回想起这次更新的内容有哪些。 (如果想要更详细的对修改了哪些内容的提示，可以用 <code>-v</code> 选项，这会将你所做的改变的 <code>diff</code> 输出放到编辑器中从而使你知道本次提交具体做了哪些修改。） 退出编辑器时，Git 会丢掉注释行，用你输入提交附带信息生成一次提交。</p>
<p>另外，你也可以在 <code>commit</code> 命令后添加 <code>-m</code> 选项，将提交信息与命令放在同一行，如下所示：</p>
<pre><code>$ git commit -m &quot;Story 182: Fix benchmarks for speed&quot;
[master 463dc4f] Story 182: Fix benchmarks for speed
 2 files changed, 2 insertions(+)
 create mode 100644 README
</code></pre><p>好，现在你已经创建了第一个提交！ 可以看到，提交后它会告诉你，当前是在哪个分支（<code>master</code>）提交的，本次提交的完整 <code>SHA-1</code> 校验和是什么（<code>463dc4f</code>），以及在本次提交中，有多少文件修订过，多少行添加和删改过。</p>
<p>请记住，提交时记录的是放在暂存区域的快照。 任何还未暂存的仍然保持已修改状态，可以在下次提交时纳入版本管理。 每一次运行提交操作，都是对你项目作一次快照，以后可以回到这个状态，或者进行比较。</p>
<h3 id="2-8-跳过使用暂存区域"><a href="#2-8-跳过使用暂存区域" class="headerlink" title="2.8. 跳过使用暂存区域"></a>2.8. 跳过使用暂存区域</h3><p>尽管使用暂存区域的方式可以精心准备要提交的细节，但有时候这么做略显繁琐。 Git 提供了一个跳过使用暂存区域的方式， 只要在提交的时候，给 <code>git commit</code> 加上 <code>-a</code> 选项，Git 就会自动把所有已经跟踪过的文件暂存起来一并提交，从而跳过 <code>git add</code> 步骤：</p>
<pre><code>$ git status
On branch master
Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

    modified:   CONTRIBUTING.md

no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)
$ git commit -a -m &apos;added new benchmarks&apos;
[master 83e38c7] added new benchmarks
 1 file changed, 5 insertions(+), 0 deletions(-)
</code></pre><h3 id="2-9-移除文件"><a href="#2-9-移除文件" class="headerlink" title="2.9. 移除文件"></a>2.9. 移除文件</h3><p>要从 Git 中移除某个文件，就必须要从已跟踪文件清单中移除（确切地说，是从暂存区域移除），然后提交。 可以用 <code>git rm</code> 命令完成此项工作，并连带从工作目录中删除指定的文件，这样以后就不会出现在未跟踪文件清单中了。</p>
<p>如果只是简单地从工作目录中手工删除文件，运行 <code>git status</code> 时就会在 <code>“Changes not staged for commit”</code> 部分（也就是 未暂存清单）看到：</p>
<pre><code>$ rm PROJECTS.md
</code></pre><p>$ git status<br>    On branch master<br>    Your branch is up-to-date with ‘origin/master’.<br>    Changes not staged for commit:<br>      (use “git add/rm <file>…” to update what will be committed)<br>      (use “git checkout – <file>…” to discard changes in working directory)</file></file></p>
<pre><code>        deleted:    PROJECTS.md

no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)
</code></pre><p>然后再运行 <code>git rm</code> 记录此次移除文件的操作：</p>
<pre><code>$ git rm PROJECTS.md
</code></pre><p>rm ‘PROJECTS.md’<br>$ git status<br>    On branch master<br>    Changes to be committed:<br>      (use “git reset HEAD <file>…” to unstage)</file></p>
<pre><code>deleted:    PROJECTS.md
</code></pre><p>下一次提交时，该文件就不再纳入版本管理了。 如果删除之前修改过并且已经放到暂存区域的话，则必须要用强制删除选项 <code>-f</code>（译注：即 <code>force</code> 的首字母）。 这是一种安全特性，用于防止误删还没有添加到快照的数据，这样的数据不能被 Git 恢复。</p>
<p><strong>另外一种情况是，我们想把文件从 Git 仓库中删除（亦即从暂存区域移除），但仍然希望保留在当前工作目录中。 换句话说，你想让文件保留在磁盘，但是并不想让 Git 继续跟踪。 当你忘记添加 <code>.gitignore</code> 文件，不小心把一个很大的日志文件或一堆 <code>.a</code> 这样的编译生成文件添加到暂存区时，这一做法尤其有用。 为达到这一目的，使用 <code>--cached</code> 选项</strong>：</p>
<pre><code>$ git rm --cached README
</code></pre><p><code>git rm</code> 命令后面可以列出文件或者目录的名字，也可以使用 <code>glob</code> 模式。 比方说：</p>
<pre><code>$ git rm log/\*.log
</code></pre><p>注意到星号 <code>*</code> 之前的反斜杠 <code>\</code>， 因为 Git 有它自己的文件模式扩展匹配方式，所以我们不用 <code>shell</code> 来帮忙展开。 此命令删除 <code>log/</code> 目录下扩展名为 <code>.log</code> 的所有文件。 类似的比如：</p>
<pre><code>$ git rm \*~
</code></pre><p>该命令为删除以 <code>~</code> 结尾的所有文件。</p>
<h3 id="2-10-移动文件"><a href="#2-10-移动文件" class="headerlink" title="2.10. 移动文件"></a>2.10. 移动文件</h3><p>不像其它的 <code>VCS</code> 系统，Git 并不显式跟踪文件移动操作。 如果在 Git 中重命名了某个文件，仓库中存储的元数据并不会体现出这是一次改名操作。 不过 Git 非常聪明，它会推断出究竟发生了什么，至于具体是如何做到的，我们稍后再谈。</p>
<p>既然如此，当你看到 Git 的 <code>mv</code> 命令时一定会困惑不已。 要在 Git 中对文件改名，可以这么做：</p>
<pre><code>$ git mv file_from file_to
</code></pre><p>它会恰如预期般正常工作。 实际上，即便此时查看状态信息，也会明白无误地看到关于重命名操作的说明：</p>
<pre><code>$ git mv README.md README
</code></pre><p>$ git status<br>    On branch master<br>    Changes to be committed:<br>      (use “git reset HEAD <file>…” to unstage)</file></p>
<pre><code>renamed:    README.md -&gt; README
</code></pre><p>其实，运行 <code>git mv</code> 就相当于运行了下面三条命令：</p>
<pre><code>$ mv README.md README
</code></pre><p>$ git rm README.md<br>    $ git add README</p>
<p>如此分开操作，Git 也会意识到这是一次改名，所以不管何种方式结果都一样。 两者唯一的区别是，<code>mv</code> 是一条命令而另一种方式需要三条命令，直接用 <code>git mv</code> 轻便得多。 不过有时候用其他工具批处理改名的话，要记得在提交前删除老的文件名，再添加新的文件名。</p>
<h2 id="3-查看提交历史"><a href="#3-查看提交历史" class="headerlink" title="3.查看提交历史"></a>3.查看提交历史</h2><h3 id="3-1-查看提交历史"><a href="#3-1-查看提交历史" class="headerlink" title="3.1. 查看提交历史"></a>3.1. 查看提交历史</h3><p>在提交了若干更新，又或者克隆了某个项目之后，你也许想回顾下提交历史。 完成这个任务最简单而又有效的工具是 <code>git log</code> 命令。</p>
<p>接下来的例子会用我专门用于演示的 <code>simplegit</code> 项目， 运行下面的命令获取该项目源代码：</p>
<pre><code>git clone https://github.com/schacon/simplegit-progit
</code></pre><p>然后在此项目中运行 <code>git log</code>，应该会看到下面的输出：</p>
<pre><code>$ git log
commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

    changed the version number

commit 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Sat Mar 15 16:40:33 2008 -0700

    removed unnecessary test

commit a11bef06a3f659402fe7563abf99ad00de2209e6
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Sat Mar 15 10:31:28 2008 -0700

    first commit
</code></pre><p>默认不用任何参数的话，<code>git log</code> 会按提交时间列出所有的更新，最近的更新排在最上面。 正如你所看到的，这个命令会列出每个提交的 <code>SHA-1</code> 校验和、作者的名字和电子邮件地址、提交时间以及提交说明。</p>
<p><code>git log</code> 有许多选项可以帮助你搜寻你所要找的提交， 接下来我们介绍些最常用的。</p>
<p>一个常用的选项是 <code>-p</code>，用来显示每次提交的内容差异。 你也可以加上 <code>-2</code> 来仅显示最近两次提交：</p>
<pre><code>$ git log -p -2
commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

    changed the version number

diff --git a/Rakefile b/Rakefile
index a874b73..8f94139 100644
--- a/Rakefile
+++ b/Rakefile
@@ -5,7 +5,7 @@ require &apos;rake/gempackagetask&apos;
 spec = Gem::Specification.new do |s|
     s.platform  =   Gem::Platform::RUBY
     s.name      =   &quot;simplegit&quot;
-    s.version   =   &quot;0.1.0&quot;
+    s.version   =   &quot;0.1.1&quot;
     s.author    =   &quot;Scott Chacon&quot;
     s.email     =   &quot;schacon@gee-mail.com&quot;
     s.summary   =   &quot;A simple gem for using Git in Ruby code.&quot;

commit 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Sat Mar 15 16:40:33 2008 -0700

    removed unnecessary test

diff --git a/lib/simplegit.rb b/lib/simplegit.rb
index a0a60ae..47c6340 100644
--- a/lib/simplegit.rb
+++ b/lib/simplegit.rb
@@ -18,8 +18,3 @@ class SimpleGit
     end

 end
-
-if $0 == __FILE__
-  git = SimpleGit.new
-  puts git.show
-end
\ No newline at end of file
</code></pre><p>该选项除了显示基本信息之外，还附带了每次 <code>commit</code> 的变化。 当进行代码审查，或者快速浏览某个搭档提交的 <code>commit</code> 所带来的变化的时候，这个参数就非常有用了。 你也可以为 <code>git log</code> 附带一系列的总结性选项。 比如说，如果你想看到每次提交的简略的统计信息，你可以使用 –stat 选项：</p>
<pre><code>$ git log --stat
commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

    changed the version number

 Rakefile | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

commit 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Sat Mar 15 16:40:33 2008 -0700

    removed unnecessary test

 lib/simplegit.rb | 5 -----
 1 file changed, 5 deletions(-)

commit a11bef06a3f659402fe7563abf99ad00de2209e6
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Sat Mar 15 10:31:28 2008 -0700

    first commit

 README           |  6 ++++++
 Rakefile         | 23 +++++++++++++++++++++++
 lib/simplegit.rb | 25 +++++++++++++++++++++++++
 3 files changed, 54 insertions(+)
</code></pre><p>正如你所看到的，<code>--stat</code> 选项在每次提交的下面列出所有被修改过的文件、有多少文件被修改了以及被修改过的文件的哪些行被移除或是添加了。 在每次提交的最后还有一个总结。</p>
<p>另外一个常用的选项是 <code>--pretty</code>。 这个选项可以指定使用不同于默认格式的方式展示提交历史。 这个选项有一些内建的子选项供你使用。 比如用 <code>oneline</code> 将每个提交放在一行显示，查看的提交数很大时非常有用。 另外还有 <code>short</code>，<code>full</code> 和 <code>fuller</code> 可以用，展示的信息或多或少有些不同，请自己动手实践一下看看效果如何。</p>
<pre><code>$ git log --pretty=oneline
ca82a6dff817ec66f44342007202690a93763949 changed the version number
085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7 removed unnecessary test
a11bef06a3f659402fe7563abf99ad00de2209e6 first commit
</code></pre><p>但最有意思的是 <code>format</code>，可以定制要显示的记录格式。 这样的输出对后期提取分析格外有用 — 因为你知道输出的格式不会随着 Git 的更新而发生改变：</p>
<pre><code>$ git log --pretty=format:&quot;%h - %an, %ar : %s&quot;
ca82a6d - Scott Chacon, 6 years ago : changed the version number
085bb3b - Scott Chacon, 6 years ago : removed unnecessary test
a11bef0 - Scott Chacon, 6 years ago : first commit
</code></pre><p><code>git log --pretty=format</code> 常用的选项 列出了常用的格式占位符写法及其代表的意义。</p>
<p><code>git log --pretty=format</code> 常用的选项：</p>
<p>|—————–+————|<br>| 选项        | 说明   |<br>|—————–|:———–|<br>| %H     | 提交对象（commit）的完整哈希字串 |<br>| %h        |   提交对象的简短哈希字串   |<br>| %T        |    树对象（tree）的完整哈希字串    |<br>| %t     | 树对象的简短哈希字串 |<br>| %P        |   父对象（parent）的完整哈希字串   |<br>| %p        |    父对象的简短哈希字串    |<br>| %an     | 作者（author）的名字|<br>| %ae       |   作者的电子邮件地址   |<br>| %ad        |    作者修订日期（可以用 –date= 选项定制格式）    |<br>| %ar     | 作者修订日期，按多久以前的方式显示 |<br>| %cn        |  提交者（committer）的名字   |<br>| %ce        |    提交者的电子邮件地址    |<br>| %cd     | 提交日期 |<br>| %cr        |   提交日期，按多久以前的方式显示   |<br>| %s       |    提交说明    |<br>|—————–+————|</p>
<p>你一定奇怪 作者 和 提交者 之间究竟有何差别， 其实作者指的是实际作出修改的人，提交者指的是最后将此工作成果提交到仓库的人。 所以，当你为某个项目发布补丁，然后某个核心成员将你的补丁并入项目时，你就是作者，而那个核心成员就是提交者。 我们会在 分布式 Git 再详细介绍两者之间的细微差别。</p>
<p>当 <code>oneline</code> 或 <code>format</code> 与另一个 <code>log</code> 选项 <code>--graph</code> 结合使用时尤其有用。 这个选项添加了一些<code>ASCII</code>字符串来形象地展示你的分支、合并历史：</p>
<pre><code>$ git log --pretty=format:&quot;%h %s&quot; --graph
* 2d3acf9 ignore errors from SIGCHLD on trap
*  5e3ee11 Merge branch &apos;master&apos; of git://github.com/dustin/grit
|\
| * 420eac9 Added a method for getting the current branch.
* | 30e367c timeout code and tests
* | 5a09431 add timeout protection to grit
* | e1193f8 support for heads with slashes in them
|/
* d6016bc require time for xmlschema
*  11d191e Merge branch &apos;defunkt&apos; into local
</code></pre><p>以上只是简单介绍了一些 <code>git log</code> 命令支持的选项。 <code>git log</code> 的常用选项 列出了我们目前涉及到的和没涉及到的选项，以及它们是如何影响 <code>log</code> 命令的输出的：<br><code>git log</code> 的常用选项：</p>
<p>|—————–+————|<br>| 选项        | 说明   |<br>|—————–|:———–|<br>| -p     | 按补丁格式显示每个更新之间的差异 |<br>| –stat        |   显示每次更新的文件修改统计信息   |<br>| –shortstat        |    只显示 –stat 中最后的行数修改添加移除统计    |<br>| –name-only     | 仅在提交信息后显示已修改的文件清单 |<br>| –name-status        |   显示新增、修改、删除的文件清单   |<br>| –abbrev-commit        |    仅显示 SHA-1 的前几个字符，而非所有的 40 个字符    |<br>| –relative-date     | 使用较短的相对时间显示（比如，“2 weeks ago”）|<br>| –graph       |   显示 ASCII 图形表示的分支合并历史   |<br>| –pretty        |    使用其他格式显示历史提交信息。可用的选项包括 oneline，short，full，fuller 和 format（后跟指定格式））    |<br>|—————–+————|</p>
<h3 id="3-2-限制输出长度"><a href="#3-2-限制输出长度" class="headerlink" title="3.2. 限制输出长度"></a>3.2. 限制输出长度</h3><p>除了定制输出格式的选项之外，<code>git log</code> 还有许多非常实用的限制输出长度的选项，也就是只输出部分提交信息。 之前你已经看到过 <code>-2</code> 了，它只显示最近的两条提交， 实际上，这是 <code>-&lt;n&gt;</code> 选项的写法，其中的 <code>n</code> 可以是任何整数，表示仅显示最近的若干条提交。 不过实践中我们是不太用这个选项的，Git 在输出所有提交时会自动调用分页程序，所以你一次只会看到一页的内容。</p>
<p>另外还有按照时间作限制的选项，比如 <code>--since</code> 和 <code>--until</code> 也很有用。 例如，下面的命令列出所有最近两周内的提交：</p>
<pre><code>$ git log --since=2.weeks
</code></pre><p>这个命令可以在多种格式下工作，比如说具体的某一天 “2008-01-15”，或者是相对地多久以前 “2 years 1 day 3 minutes ago”。</p>
<p>还可以给出若干搜索条件，列出符合的提交。 用 <code>--author</code> 选项显示指定作者的提交，用 <code>--grep</code> 选项搜索提交说明中的关键字。 （请注意，如果要得到同时满足这两个选项搜索条件的提交，就必须用 <code>--all-match</code> 选项。否则，满足任意一个条件的提交都会被匹配出来）</p>
<p>另一个非常有用的筛选选项是 <code>-S</code>，可以列出那些添加或移除了某些字符串的提交。 比如说，你想找出添加或移除了某一个特定函数的引用的提交，你可以这样使用：</p>
<pre><code>$ git log -Sfunction_name
</code></pre><p>最后一个很实用的 <code>git log</code> 选项是路径（<code>path</code>）， 如果只关心某些文件或者目录的历史提交，可以在 <code>git log</code> 选项的最后指定它们的路径。 因为是放在最后位置上的选项，所以用两个短划线（<code>--</code>）隔开之前的选项和后面限定的路径名。</p>
<p>在 限制 <code>git log</code> 输出的选项 中列出了常用的选项：</p>
<p>|—————–+————|<br>| 选项        | 说明   |<br>|—————–|:———–|<br>| -(n)     | 仅显示最近的 n 条提交 |<br>| –since, –after        |   仅显示指定时间之后的提交   |<br>| –until, –before        |    仅显示指定时间之前的提交    |<br>| –author     | 仅显示指定作者相关的提交 |<br>| –committer        |   仅显示指定提交者相关的提交   |<br>| –grep        |    仅显示含指定关键字的提交    |<br>| -S     | 仅显示添加或移除了某个关键字的提交 |<br>|—————–+————|</p>
<p>来看一个实际的例子，如果要查看 Git 仓库中，2008 年 10 月期间，Junio Hamano 提交的但未合并的测试文件，可以用下面的查询命令：</p>
<pre><code>$ git log --pretty=&quot;%h - %s&quot; --author=gitster --since=&quot;2008-10-01&quot; \
   --before=&quot;2008-11-01&quot; --no-merges -- t/
5610e3b - Fix testcase failure when extended attributes are in use
acd3b9e - Enhance hold_lock_file_for_{update,append}() API
f563754 - demonstrate breakage of detached checkout with symbolic link HEAD
d1a43f2 - reset --hard/read-tree --reset -u: remove unmerged new paths
51a94af - Fix &quot;checkout --track -b newbranch&quot; on detached HEAD
b0ad11e - pull: allow &quot;git pull origin $something:$current_branch&quot; into an unborn branch
</code></pre><p>在近 40000 条提交中，上面的输出仅列出了符合条件的 6 条记录。</p>
<h2 id="4-撤消操作"><a href="#4-撤消操作" class="headerlink" title="4.撤消操作"></a>4.撤消操作</h2><h3 id="4-1-撤消操作"><a href="#4-1-撤消操作" class="headerlink" title="4.1. 撤消操作"></a>4.1. 撤消操作</h3><p>在任何一个阶段，你都有可能想要撤消某些操作。 这里，我们将会学习几个撤消你所做修改的基本工具。 注意，有些撤消操作是不可逆的。 这是在使用 Git 的过程中，会因为操作失误而导致之前的工作丢失的少有的几个地方之一。</p>
<p>有时候我们提交完了才发现漏掉了几个文件没有添加，或者提交信息写错了。 此时，可以运行带有 <code>--amend</code> 选项的提交命令尝试重新提交：</p>
<pre><code>$ git commit --amend
</code></pre><p>这个命令会将暂存区中的文件提交。 如果自上次提交以来你还未做任何修改（例如，在上次提交后马上执行了此命令），那么快照会保持不变，而你所修改的只是提交信息。</p>
<p>文本编辑器启动后，可以看到之前的提交信息。 编辑后保存会覆盖原来的提交信息。</p>
<p>例如，你提交后发现忘记了暂存某些需要的修改，可以像下面这样操作：</p>
<pre><code>$ git commit -m &apos;initial commit&apos;
</code></pre><p>$ git add forgotten_file<br>    $ git commit –amend</p>
<p>最终你只会有一个提交 - 第二次提交将代替第一次提交的结果。</p>
<p>取消暂存的文件<br>接下来的两个小节演示如何操作暂存区域与工作目录中已修改的文件。 这些命令在修改文件状态的同时，也会提示如何撤消操作。 例如，你已经修改了两个文件并且想要将它们作为两次独立的修改提交，但是却意外地输入了 <code>git add *</code> 暂存了它们两个。 如何只取消暂存两个中的一个呢？ <code>git status</code> 命令提示了你：</p>
<pre><code>$ git add *
</code></pre><p>$ git status<br>    On branch master<br>    Changes to be committed:<br>      (use “git reset HEAD <file>…” to unstage)</file></p>
<pre><code>renamed:    README.md -&gt; README
modified:   CONTRIBUTING.md
</code></pre><p>在 “<code>Changes to be committed</code>” 文字正下方，提示使用 <code>git reset HEAD &lt;file&gt;...</code> 来取消暂存。 所以，我们可以这样来取消暂存 <code>CONTRIBUTING.md</code> 文件：</p>
<pre><code>$ git reset HEAD CONTRIBUTING.md
Unstaged changes after reset:
M    CONTRIBUTING.md
</code></pre><p>$ git status<br>    On branch master<br>    Changes to be committed:<br>      (use “git reset HEAD <file>…” to unstage)</file></p>
<pre><code>    renamed:    README.md -&gt; README

Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

    modified:   CONTRIBUTING.md
</code></pre><p>这个命令有点儿奇怪，但是起作用了。 <code>CONTRIBUTING.md</code> 文件已经是修改未暂存的状态了。</p>
<p>Note<br>虽然在调用时加上 <code>--hard</code> 选项可以令 <code>git reset</code> 成为一个危险的命令（译注：可能导致工作目录中所有当前进度丢失！），但本例中工作目录内的文件并不会被修改。 不加选项地调用 <code>git reset</code> 并不危险 — 它只会修改暂存区域。</p>
<p>到目前为止这个神奇的调用就是你需要对 <code>git reset</code> 命令了解的全部。我们将会在 重置揭密 中了解 <code>reset</code> 的更多细节以及如何掌握它做一些真正有趣的事。</p>
<h3 id="4-2-撤消对文件的修改"><a href="#4-2-撤消对文件的修改" class="headerlink" title="4.2. 撤消对文件的修改"></a>4.2. 撤消对文件的修改</h3><p>如果你并不想保留对 <code>CONTRIBUTING.md</code> 文件的修改怎么办？ 你该如何方便地撤消修改 - 将它还原成上次提交时的样子（或者刚克隆完的样子，或者刚把它放入工作目录时的样子）？ 幸运的是，<code>git status</code> 也告诉了你应该如何做。 在最后一个例子中，未暂存区域是这样：</p>
<pre><code>Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

    modified:   CONTRIBUTING.md
</code></pre><p>它非常清楚地告诉了你如何撤消之前所做的修改。 让我们来按照提示执行：</p>
<pre><code>$ git checkout -- CONTRIBUTING.md
</code></pre><p>$ git status<br>    On branch master<br>    Changes to be committed:<br>      (use “git reset HEAD <file>…” to unstage)</file></p>
<pre><code>renamed:    README.md -&gt; README
</code></pre><p>可以看到那些修改已经被撤消了。</p>
<p>Important<br>你需要知道 <code>git checkout -- [file]</code> 是一个危险的命令，这很重要。 你对那个文件做的任何修改都会消失 - 你只是拷贝了另一个文件来覆盖它。 除非你确实清楚不想要那个文件了，否则不要使用这个命令。</p>
<p>如果你仍然想保留对那个文件做出的修改，但是现在仍然需要撤消，我们将会在 Git 分支 介绍保存进度与分支；这些通常是更好的做法。</p>
<p>记住，在 Git 中任何 已提交的 东西几乎总是可以恢复的。 甚至那些被删除的分支中的提交或使用 <code>--amend</code> 选项覆盖的提交也可以恢复（阅读 数据恢复 了解数据恢复）。 然而，任何你未提交的东西丢失后很可能再也找不到了。</p>
<h2 id="5-远程仓库的使用"><a href="#5-远程仓库的使用" class="headerlink" title="5.远程仓库的使用"></a>5.远程仓库的使用</h2><h3 id="5-1-远程仓库的使用"><a href="#5-1-远程仓库的使用" class="headerlink" title="5.1. 远程仓库的使用"></a>5.1. 远程仓库的使用</h3><p>为了能在任意 Git 项目上协作，你需要知道如何管理自己的远程仓库。 远程仓库是指托管在因特网或其他网络中的你的项目的版本库。 你可以有好几个远程仓库，通常有些仓库对你只读，有些则可以读写。 与他人协作涉及管理远程仓库以及根据需要推送或拉取数据。 管理远程仓库包括了解如何添加远程仓库、移除无效的远程仓库、管理不同的远程分支并定义它们是否被跟踪等等。</p>
<p>查看远程仓库<br>如果想查看你已经配置的远程仓库服务器，可以运行 <code>git remote</code> 命令。 它会列出你指定的每一个远程服务器的简写。 如果你已经克隆了自己的仓库，那么至少应该能看到 <code>origin -</code> 这是 Git 给你克隆的仓库服务器的默认名字：</p>
<pre><code>$ git clone https://github.com/schacon/ticgit
Cloning into &apos;ticgit&apos;...
remote: Reusing existing pack: 1857, done.
remote: Total 1857 (delta 0), reused 0 (delta 0)
Receiving objects: 100% (1857/1857), 374.35 KiB | 268.00 KiB/s, done.
Resolving deltas: 100% (772/772), done.
Checking connectivity... done.
</code></pre><p>$ cd ticgit<br>    $ git remote<br>    origin</p>
<p>你也可以指定选项 <code>-v</code>，会显示需要读写远程仓库使用的 Git 保存的简写与其对应的 URL。</p>
<pre><code>$ git remote -v
origin    https://github.com/schacon/ticgit (fetch)
origin    https://github.com/schacon/ticgit (push)
</code></pre><p>如果你的远程仓库不止一个，该命令会将它们全部列出。 例如，与几个协作者合作的，拥有多个远程仓库的仓库看起来像下面这样：</p>
<pre><code>$ cd grit
</code></pre><p>$ git remote -v<br>    bakkdoor  <a href="https://github.com/bakkdoor/grit" target="_blank" rel="noopener">https://github.com/bakkdoor/grit</a> (fetch)<br>    bakkdoor  <a href="https://github.com/bakkdoor/grit" target="_blank" rel="noopener">https://github.com/bakkdoor/grit</a> (push)<br>    cho45     <a href="https://github.com/cho45/grit" target="_blank" rel="noopener">https://github.com/cho45/grit</a> (fetch)<br>    cho45     <a href="https://github.com/cho45/grit" target="_blank" rel="noopener">https://github.com/cho45/grit</a> (push)<br>    defunkt   <a href="https://github.com/defunkt/grit" target="_blank" rel="noopener">https://github.com/defunkt/grit</a> (fetch)<br>    defunkt   <a href="https://github.com/defunkt/grit" target="_blank" rel="noopener">https://github.com/defunkt/grit</a> (push)<br>    koke      git://github.com/koke/grit.git (fetch)<br>    koke      git://github.com/koke/grit.git (push)<br>    origin    <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:mojombo/grit.git (fetch)<br>    origin    <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:mojombo/grit.git (push)</p>
<p>这样我们可以轻松拉取其中任何一个用户的贡献。 此外，我们大概还会有某些远程仓库的推送权限，虽然我们目前还不会在此介绍。</p>
<p>注意这些远程仓库使用了不同的协议；我们将会在 在服务器上搭建 Git 中了解关于它们的更多信息。</p>
<h3 id="5-2-添加远程仓库"><a href="#5-2-添加远程仓库" class="headerlink" title="5.2. 添加远程仓库"></a>5.2. 添加远程仓库</h3><p>我在之前的章节中已经提到并展示了如何添加远程仓库的示例，不过这里将告诉你如何明确地做到这一点。 运行 <code>git remote add &lt;shortname&gt; &lt;url&gt;</code> 添加一个新的远程 Git 仓库，同时指定一个你可以轻松引用的简写：</p>
<pre><code>$ git remote origin
</code></pre><p>$ git remote add pb <a href="https://github.com/paulboone/ticgit" target="_blank" rel="noopener">https://github.com/paulboone/ticgit</a><br>    $ git remote -v<br>    origin    <a href="https://github.com/schacon/ticgit" target="_blank" rel="noopener">https://github.com/schacon/ticgit</a> (fetch)<br>    origin    <a href="https://github.com/schacon/ticgit" target="_blank" rel="noopener">https://github.com/schacon/ticgit</a> (push)<br>    pb    <a href="https://github.com/paulboone/ticgit" target="_blank" rel="noopener">https://github.com/paulboone/ticgit</a> (fetch)<br>    pb    <a href="https://github.com/paulboone/ticgit" target="_blank" rel="noopener">https://github.com/paulboone/ticgit</a> (push)</p>
<p>现在你可以在命令行中使用字符串 <code>pb</code> 来代替整个 URL。 例如，如果你想拉取 <code>Paul</code> 的仓库中有但你没有的信息，可以运行 <code>git fetch pb</code>：</p>
<pre><code>$ git fetch pb
remote: Counting objects: 43, done.
remote: Compressing objects: 100% (36/36), done.
remote: Total 43 (delta 10), reused 31 (delta 5)
Unpacking objects: 100% (43/43), done.
From https://github.com/paulboone/ticgit
 * [new branch]      master     -&gt; pb/master
 * [new branch]      ticgit     -&gt; pb/ticgit
</code></pre><p>现在 <code>Paul</code> 的 <code>master</code> 分支可以在本地通过 <code>pb/master</code> 访问到 - 你可以将它合并到自己的某个分支中，或者如果你想要查看它的话，可以检出一个指向该点的本地分支。 </p>
<h3 id="5-3-从远程仓库中抓取与拉取"><a href="#5-3-从远程仓库中抓取与拉取" class="headerlink" title="5.3. 从远程仓库中抓取与拉取"></a>5.3. 从远程仓库中抓取与拉取</h3><p>就如刚才所见，从远程仓库中获得数据，可以执行：</p>
<pre><code>$ git fetch [remote-name]
</code></pre><p>这个命令会访问远程仓库，从中拉取所有你还没有的数据。 执行完成后，你将会拥有那个远程仓库中所有分支的引用，可以随时合并或查看。</p>
<p>如果你使用 <code>clone</code> 命令克隆了一个仓库，命令会自动将其添加为远程仓库并默认以 <code>“origin”</code> 为简写。 所以，<code>git fetch origin</code> 会抓取克隆（或上一次抓取）后新推送的所有工作。 必须注意 <code>git fetch</code> 命令会将数据拉取到你的本地仓库 - 它并不会自动合并或修改你当前的工作。 当准备好时你必须手动将其合并入你的工作。</p>
<p>如果你有一个分支设置为跟踪一个远程分支，可以使用 <code>git pull</code> 命令来自动的抓取然后合并远程分支到当前分支。 这对你来说可能是一个更简单或更舒服的工作流程；默认情况下，<code>git clone</code> 命令会自动设置本地 <code>master</code> 分支跟踪克隆的远程仓库的 <code>master</code> 分支（或不管是什么名字的默认分支）。 运行 <code>git pull</code> 通常会从最初克隆的服务器上抓取数据并自动尝试合并到当前所在的分支。</p>
<p>推送到远程仓库<br>当你想分享你的项目时，必须将其推送到上游。 这个命令很简单：<code>git push [remote-name] [branch-name]</code>。 当你想要将 <code>master</code> 分支推送到 <code>origin</code> 服务器时（再次说明，克隆时通常会自动帮你设置好那两个名字），那么运行这个命令就可以将你所做的备份到服务器：</p>
<pre><code>$ git push origin master
</code></pre><p>只有当你有所克隆服务器的写入权限，并且之前没有人推送过时，这条命令才能生效。 当你和其他人在同一时间克隆，他们先推送到上游然后你再推送到上游，你的推送就会毫无疑问地被拒绝。 你必须先将他们的工作拉取下来并将其合并进你的工作后才能推送。</p>
<h3 id="5-4-查看远程仓库"><a href="#5-4-查看远程仓库" class="headerlink" title="5.4. 查看远程仓库"></a>5.4. 查看远程仓库</h3><p>如果想要查看某一个远程仓库的更多信息，可以使用 <code>git remote show [remote-name]</code> 命令。 如果想以一个特定的缩写名运行这个命令，例如 <code>origin</code>，会得到像下面类似的信息：</p>
<pre><code>$ git remote show origin
* remote origin
  Fetch URL: https://github.com/schacon/ticgit
  Push  URL: https://github.com/schacon/ticgit
  HEAD branch: master
  Remote branches:
    master                               tracked
    dev-branch                           tracked
  Local branch configured for &apos;git pull&apos;:
    master merges with remote master
  Local ref configured for &apos;git push&apos;:
    master pushes to master (up to date)
</code></pre><p>它同样会列出远程仓库的 URL 与跟踪分支的信息。 这些信息非常有用，它告诉你正处于 <code>master</code> 分支，并且如果运行 <code>git pull</code>，就会抓取所有的远程引用，然后将远程 <code>master</code> 分支合并到本地 <code>master</code> 分支。 它也会列出拉取到的所有远程引用。</p>
<p>这是一个经常遇到的简单例子。 如果你是 Git 的重度使用者，那么还可以通过 <code>git remote show</code> 看到更多的信息。</p>
<pre><code>$ git remote show origin
* remote origin
  URL: https://github.com/my-org/complex-project
  Fetch URL: https://github.com/my-org/complex-project
  Push  URL: https://github.com/my-org/complex-project
  HEAD branch: master
  Remote branches:
    master                           tracked
    dev-branch                       tracked
    markdown-strip                   tracked
    issue-43                         new (next fetch will store in remotes/origin)
    issue-45                         new (next fetch will store in remotes/origin)
    refs/remotes/origin/issue-11     stale (use &apos;git remote prune&apos; to remove)
  Local branches configured for &apos;git pull&apos;:
    dev-branch merges with remote dev-branch
    master     merges with remote master
  Local refs configured for &apos;git push&apos;:
    dev-branch                     pushes to dev-branch                     (up to date)
    markdown-strip                 pushes to markdown-strip                 (up to date)
    master                         pushes to master                         (up to date)
</code></pre><p>这个命令列出了当你在特定的分支上执行 <code>git push</code> 会自动地推送到哪一个远程分支。 它也同样地列出了哪些远程分支不在你的本地，哪些远程分支已经从服务器上移除了，还有当你执行 <code>git pull</code> 时哪些分支会自动合并。</p>
<p>远程仓库的移除与重命名<br>如果想要重命名引用的名字可以运行 <code>git remote rename</code> 去修改一个远程仓库的简写名。 例如，想要将 <code>pb</code> 重命名为 <code>paul</code>，可以用 git remote rename 这样做：</p>
<pre><code>$ git remote rename pb paul
</code></pre><p>$ git remote<br>    origin<br>    paul</p>
<p>值得注意的是这同样也会修改你的远程分支名字。 那些过去引用 <code>pb/master</code> 的现在会引用 <code>paul/master</code>。</p>
<p>如果因为一些原因想要移除一个远程仓库 - 你已经从服务器上搬走了或不再想使用某一个特定的镜像了，又或者某一个贡献者不再贡献了 - 可以使用 <code>git remote rm</code> ：</p>
<pre><code>$ git remote rm paul
$ git remote
origin
</code></pre><h2 id="6-打标签"><a href="#6-打标签" class="headerlink" title="6.打标签"></a>6.打标签</h2><h3 id="6-1-列出标签"><a href="#6-1-列出标签" class="headerlink" title="6.1. 列出标签"></a>6.1. 列出标签</h3><p>在 Git 中列出已有的标签是非常简单直观的。 只需要输入 <code>git tag</code>：</p>
<pre><code>$ git tag
v0.1
v1.3
</code></pre><p>这个命令以字母顺序列出标签；但是它们出现的顺序并不重要。</p>
<p>你也可以使用特定的模式查找标签。 例如，Git 自身的源代码仓库包含标签的数量超过 500 个。 如果只对 1.8.5 系列感兴趣，可以运行：</p>
<pre><code>$ git tag -l &apos;v1.8.5*&apos;
v1.8.5
v1.8.5-rc0
v1.8.5-rc1
v1.8.5-rc2
v1.8.5-rc3
v1.8.5.1
v1.8.5.2
v1.8.5.3
v1.8.5.4
v1.8.5.5
</code></pre><h3 id="6-2-创建标签"><a href="#6-2-创建标签" class="headerlink" title="6.2. 创建标签"></a>6.2. 创建标签</h3><p>Git 使用两种主要类型的标签：轻量标签（<code>lightweight</code>）与附注标签（<code>annotated</code>）。</p>
<p>一个轻量标签很像一个不会改变的分支 - 它只是一个特定提交的引用。</p>
<p>然而，附注标签是存储在 Git 数据库中的一个完整对象。 它们是可以被校验的；其中包含打标签者的名字、电子邮件地址、日期时间；还有一个标签信息；并且可以使用 <code>GNU Privacy Guard</code> （<code>GPG</code>）签名与验证。 通常建议创建附注标签，这样你可以拥有以上所有信息；但是如果你只是想用一个临时的标签，或者因为某些原因不想要保存那些信息，轻量标签也是可用的。</p>
<h3 id="6-3-附注标签"><a href="#6-3-附注标签" class="headerlink" title="6.3. 附注标签"></a>6.3. 附注标签</h3><p>在 Git 中创建一个附注标签是很简单的。 最简单的方式是当你在运行 <code>tag</code> 命令时指定 <code>-a</code> 选项：</p>
<pre><code>$ git tag -a v1.4 -m &apos;my version 1.4&apos;
</code></pre><p>$ git tag<br>    v0.1<br>    v1.3<br>    v1.4</p>
<p><code>-m</code> 选项指定了一条将会存储在标签中的信息。 如果没有为附注标签指定一条信息，Git 会运行编辑器要求你输入信息。</p>
<p>通过使用 <code>git show</code> 命令可以看到标签信息与对应的提交信息：</p>
<pre><code>$ git show v1.4
tag v1.4
Tagger: Ben Straub &lt;ben@straub.cc&gt;
Date:   Sat May 3 20:19:12 2014 -0700

my version 1.4

commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

    changed the version number
</code></pre><p>输出显示了打标签者的信息、打标签的日期时间、附注信息，然后显示具体的提交信息。</p>
<h3 id="6-4-轻量标签"><a href="#6-4-轻量标签" class="headerlink" title="6.4. 轻量标签"></a>6.4. 轻量标签</h3><p>另一种给提交打标签的方式是使用轻量标签。 轻量标签本质上是将提交校验和存储到一个文件中 - 没有保存任何其他信息。 创建轻量标签，不需要使用 <code>-a</code>、<code>-s</code> 或 <code>-m</code> 选项，只需要提供标签名字：</p>
<pre><code>$ git tag v1.4-lw
</code></pre><p>$ git tag<br>    v0.1<br>    v1.3<br>    v1.4<br>    v1.4-lw<br>    v1.5</p>
<p>这时，如果在标签上运行 <code>git show</code>，你不会看到额外的标签信息。 命令只会显示出提交信息：</p>
<pre><code>$ git show v1.4-lw
commit ca82a6dff817ec66f44342007202690a93763949
Author: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Mar 17 21:52:11 2008 -0700

changed the version number
</code></pre><h3 id="6-5-后期打标签"><a href="#6-5-后期打标签" class="headerlink" title="6.5. 后期打标签"></a>6.5. 后期打标签</h3><p>你也可以对过去的提交打标签。 假设提交历史是这样的：</p>
<pre><code>$ git log --pretty=oneline
15027957951b64cf874c3557a0f3547bd83b3ff6 Merge branch &apos;experiment&apos;
a6b4c97498bd301d84096da251c98a07c7723e65 beginning write support
0d52aaab4479697da7686c15f77a3d64d9165190 one more thing
6d52a271eda8725415634dd79daabbc4d9b6008e Merge branch &apos;experiment&apos;
0b7434d86859cc7b8c3d5e1dddfed66ff742fcbc added a commit function
4682c3261057305bdd616e23b64b0857d832627b added a todo file
166ae0c4d3f420721acbb115cc33848dfcc2121a started write support
9fceb02d0ae598e95dc970b74767f19372d61af8 updated rakefile
964f16d36dfccde844893cac5b347e7b3d44abbc commit the todo
8a5cbc430f1a9c3d00faaeffd07798508422908a updated readme
</code></pre><p>现在，假设在 <code>v1.2</code> 时你忘记给项目打标签，也就是在 “<code>updated rakefile</code>” 提交。 你可以在之后补上标签。 要在那个提交上打标签，你需要在命令的末尾指定提交的校验和（或部分校验和）:</p>
<pre><code>$ git tag -a v1.2 9fceb02
</code></pre><p>可以看到你已经在那次提交上打上标签了：</p>
<pre><code>$ git tag
v0.1
v1.2
v1.3
v1.4
v1.4-lw
v1.5

$ git show v1.2
tag v1.2
Tagger: Scott Chacon &lt;schacon@gee-mail.com&gt;
Date:   Mon Feb 9 15:32:16 2009 -0800

version 1.2
commit 9fceb02d0ae598e95dc970b74767f19372d61af8
Author: Magnus Chacon &lt;mchacon@gee-mail.com&gt;
Date:   Sun Apr 27 20:43:35 2008 -0700

    updated rakefile
...
</code></pre><h3 id="6-6-共享标签"><a href="#6-6-共享标签" class="headerlink" title="6.6. 共享标签"></a>6.6. 共享标签</h3><p>默认情况下，<code>git push</code> 命令并不会传送标签到远程仓库服务器上。 在创建完标签后你必须显式地推送标签到共享服务器上。 这个过程就像共享远程分支一样 - 你可以运行 g<code>it push origin [tagname]</code>。</p>
<pre><code>$ git push origin v1.5
Counting objects: 14, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (12/12), done.
Writing objects: 100% (14/14), 2.05 KiB | 0 bytes/s, done.
Total 14 (delta 3), reused 0 (delta 0)
To git@github.com:schacon/simplegit.git
 * [new tag]         v1.5 -&gt; v1.5
</code></pre><p>如果想要一次性推送很多标签，也可以使用带有 <code>--tags</code> 选项的 <code>git push</code> 命令。 这将会把所有不在远程仓库服务器上的标签全部传送到那里。</p>
<pre><code>$ git push origin --tags
Counting objects: 1, done.
Writing objects: 100% (1/1), 160 bytes | 0 bytes/s, done.
Total 1 (delta 0), reused 0 (delta 0)
To git@github.com:schacon/simplegit.git
 * [new tag]         v1.4 -&gt; v1.4
 * [new tag]         v1.4-lw -&gt; v1.4-lw
</code></pre><p>现在，当其他人从仓库中克隆或拉取，他们也能得到你的那些标签。</p>
<p>检出标签<br>在 Git 中你并不能真的检出一个标签，因为它们并不能像分支一样来回移动。 如果你想要工作目录与仓库中特定的标签版本完全一样，可以使用 <code>git checkout -b [branchname] [tagname]</code> 在特定的标签上创建一个新分支：</p>
<pre><code>$ git checkout -b version2 v2.0.0
Switched to a new branch &apos;version2&apos;
</code></pre><p>当然，如果在这之后又进行了一次提交，<code>version2</code> 分支会因为改动向前移动了，那么 <code>version2</code> 分支就会和 <code>v2.0.0</code> 标签稍微有些不同，这时就应该当心了。</p>
<h2 id="7-Git-别名"><a href="#7-Git-别名" class="headerlink" title="7.Git 别名"></a>7.Git 别名</h2><p>在我们结束本章 Git 基础之前，正好有一个小技巧可以使你的 Git 体验更简单、容易、熟悉：别名。 我们不会在之后的章节中引用到或假定你使用过它们，但是你大概应该知道如何使用它们。</p>
<p>Git 并不会在你输入部分命令时自动推断出你想要的命令。 如果不想每次都输入完整的 Git 命令，可以通过 <code>git config</code> 文件来轻松地为每一个命令设置一个别名。 这里有一些例子你可以试试：</p>
<pre><code>$ git config --global alias.co checkout
</code></pre><p>$ git config –global alias.br branch<br>    $ git config –global alias.ci commit<br>$ git config –global alias.st status</p>
<p>这意味着，当要输入 <code>git commit</code> 时，只需要输入 <code>git ci</code>。 随着你继续不断地使用 Git，可能也会经常使用其他命令，所以创建别名时不要犹豫。</p>
<p>在创建你认为应该存在的命令时这个技术会很有用。 例如，为了解决取消暂存文件的易用性问题，可以向 Git 中添加你自己的取消暂存别名：</p>
<pre><code>$ git config --global alias.unstage &apos;reset HEAD --&apos;
</code></pre><p>这会使下面的两个命令等价：</p>
<pre><code>$ git unstage fileA
</code></pre><p>$ git reset HEAD – fileA</p>
<p>这样看起来更清楚一些。 通常也会添加一个 <code>last</code> 命令，像这样：</p>
<pre><code>$ git config --global alias.last &apos;log -1 HEAD&apos;
</code></pre><p>这样，可以轻松地看到最后一次提交：</p>
<pre><code>$ git last
commit 66938dae3329c7aebe598c2246a8e6af90d04646
Author: Josh Goebel &lt;dreamer3@example.com&gt;
Date:   Tue Aug 26 19:48:51 2008 +0800

    test for current head

    Signed-off-by: Scott Chacon &lt;schacon@example.com&gt;
</code></pre><p>可以看出，Git 只是简单地将别名替换为对应的命令。 然而，你可能想要执行外部命令，而不是一个 Git 子命令。 如果是那样的话，可以在命令前面加入 ! 符号。 如果你自己要写一些与 Git 仓库协作的工具的话，那会很有用。 我们现在演示将 <code>git visual</code> 定义为 <code>gitk</code> 的别名：</p>
<pre><code>$ git config --global alias.visual &apos;!gitk&apos;
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/dinghuang.png"
                alt="强壮的病猫" />
            
              <p class="site-author-name" itemprop="name">强壮的病猫</p>
              <p class="site-description motion-element" itemprop="description">学习、生活、闲谈、足球</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/dinghuang" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">强壮的病猫</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://dinghuang-1.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
